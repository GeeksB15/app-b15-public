import{ck as r,aN as R,co as x,Y as D,ci as oo,c0 as b,cn as h,Z as E,cs as X,cp as Y,be as ao}from"./index.f43b7a81.js";import{c as O}from"./compactarValidarNFe.6cd5db9e.js";import{c as to}from"./codigosANP.a6c1a264.js";var lo={calculaTotais(o,a,s,e=!0){var c,n,t,u,l,S,v,C,f,m,I,P,d,F,_,g;this.metadados=s;const i={vBC:0,vBCST:0,vICMS:0,vICMSDeson:0,vFCPUFDest:null,vICMSUFDest:null,vICMSUFRemet:null,vFCP:0,vST:0,vICMSST:null,vICMSSTRet:null,vFCPST:0,vFCPSTRet:0,vProd:0,vFrete:0,vSeg:0,vDesc:0,vII:0,vIPI:0,vIPIDevol:0,vPIS:0,vCOFINS:0,vOutro:0,vNF:0,noXml_vTribFed:0,noXml_vTribEst:0,noXml_vTribMun:0,vTotTrib:0};for(const T in o.det){const p=o.det[T],U=p.imposto.escolhas.valor_escolha,A=p.imposto.escolhas[U].ICMS.escolhas.valor_escolha,w=p.imposto.escolhas[U].ICMS.escolhas[A];if(this.calculaVCredICMSSN(w,p),e&&(this.distribuiDadosICMS(p,o),this.distribuiDadosPIS(p),this.distribuiDadosCOFINS(p),this.distribuiDadosIPI(p)),a.automatico.dados_trib&&(p.prod.qTrib=p.prod.qCom,p.prod.uTrib=p.prod.uCom,p.prod.vUnTrib=p.prod.vUnCom,p.prod.cEANTrib=p.prod.cEAN),a.automatico.totais){const B=r(p.prod.qCom,4),Z=r(p.prod.vUnCom,4),J=r(p.prod.qTrib,4),y=r(p.prod.vUnTrib,4),Q=r(B*Z,2),W=r(p.prod.vFrete,2),q=r(p.prod.vSeg,2),G=r(p.prod.vOutro,2),$=r(p.prod.vDesc,2),H=a.automatico.incluiDespesasNaBC===!1?0:G,z=r(J*y+q+H-$,2);if(p.prod.vProd=r(Q,2),p.prod.indTot==="1"&&(i.vProd+=Q),i.vIPIDevol+=((n=(c=p.impostoDevol)==null?void 0:c.IPI)==null?void 0:n.vIPIDevol)||0,i.vFrete+=W,i.vSeg+=q,i.vOutro+=G,i.vDesc+=$,this.calculaICMS_ISSQN_IPI_II(p,o,a,i,z,B),this.calculaPIS_COFINS("PIS",p,a,i,z,B,o),this.calculaPIS_COFINS("COFINS",p,a,i,z,B,o),this.calculaIBPT(p,a,i),(u=(t=p.imposto)==null?void 0:t.ICMSUFDest)!=null&&u.visivel){const K=(v=(S=(l=p.impostoDevol)==null?void 0:l.IPI)==null?void 0:S.vIPIDevol)!=null?v:0,j=(C=p.imposto.noXml_vIPI)!=null?C:0,V=r(J*y+q+W+H-$+K+j,2),k=p.imposto.ICMSUFDest.pICMSUFDest,L=p.imposto.ICMSUFDest.pICMSInter;p.imposto.ICMSUFDest.vBCUFDest=V,k&&L&&k>L&&(p.imposto.ICMSUFDest.vICMSUFDest=r(V*((k-L)/100),2))}}this.resumeDadosICMS(p),(m=(f=p.imposto)==null?void 0:f.ICMSUFDest)!=null&&m.visivel&&(i.vICMSUFDest||(i.vICMSUFDest=0),i.vFCPUFDest||(i.vFCPUFDest=0),i.vICMSUFDest+=(d=(P=(I=p.imposto)==null?void 0:I.ICMSUFDest)==null?void 0:P.vICMSUFDest)!=null?d:0,i.vFCPUFDest+=(g=(_=(F=p.imposto)==null?void 0:F.ICMSUFDest)==null?void 0:_.vFCPUFDest)!=null?g:0)}if(a.automatico.totais){const T=o.total.ICMSTot;if(a.calculaTotais){i.vST=i.vICMSST+i.vST,i.vNF=i.vProd+i.vFrete+i.vSeg+i.vOutro+i.vST+i.vFCPST+i.vIPI+i.vIPIDevol-i.vDesc;for(const p in i)i[p]!=null&&(T[p]=r(i[p],2))}if(o.pag.detPag.length){if(o.pag.detPag.length===1){const p=o.pag.detPag[0];p.tPag==="90"?p.vPag=0:p.vPag=r(i.vNF)}}else{const p=O.executa(R.infNFe.pag.detPag.lista,{});p.tPag="99",p.xPag="",p.vPag=r(i.vNF),o.pag.detPag.push(p)}}},calculaIBPT(o,a,s){const e=Number(o.prod.vProd)-Number(o.prod.vDesc);o.imposto.noXml_vTribFed=["1","6","7"].includes(o.imposto.noXml_orig)?r(Number(o.imposto.noXml_pTribImp)*e/100):r(Number(o.imposto.noXml_pTribFed)*e/100),s.noXml_vTribFed=r(s.noXml_vTribFed+o.imposto.noXml_vTribFed,2),o.imposto.noXml_vTribEst=r(Number(o.imposto.noXml_pTribEst)*e/100),s.noXml_vTribEst=r(s.noXml_vTribEst+o.imposto.noXml_vTribEst),o.imposto.noXml_vTribMun=r(Number(o.imposto.noXml_pTribMun)*e/100),s.noXml_vTribMun=r(s.noXml_vTribMun+o.imposto.noXml_vTribMun),o.imposto.vTotTrib=r(o.imposto.noXml_vTribFed+o.imposto.noXml_vTribEst+o.imposto.noXml_vTribMun),s.vTotTrib=r(s.vTotTrib+o.imposto.vTotTrib)},distribuiDadosICMS(o,a){const s=o.imposto.noXml_CSOSN||"",e=o.imposto.noXml_CST||"",i=o.imposto.escolhas.opcao1.ICMS.escolhas;if(s||e){o.imposto.escolhas.valor_escolha="opcao1";const n=this.metadados.infNFe.det.lista.imposto.escolhas.opcao1.ICMS.escolhas;for(const t in i)t==="valor_escolha"||t==="ICMSPart"||t==="ICMSST"||t.endsWith("_erro")||(a.emit.CRT==="3"?"CST"in i[t]&&n[t].CST._enumeration.find(S=>S.valor===e)&&(i.valor_escolha=t,i[t].CST=e):"CSOSN"in i[t]&&n[t].CSOSN._enumeration.find(S=>S.valor===s)&&(i.valor_escolha=t,i[t].CSOSN=s))}const c=i[i.valor_escolha];c&&o.imposto.escolhas.valor_escolha==="opcao1"&&(o.imposto.noXml_orig&&this.atualizaCampoRecursivo(c,"orig",o.imposto.noXml_orig),o.imposto.noXml_pICMS&&!["201","202"].includes(s)&&(this.atualizaCampoRecursivo(c,"pICMS",o.imposto.noXml_pICMS),o.imposto.noXml_pICMS=0),o.imposto.noXml_pRedBC&&(this.atualizaCampoRecursivo(c,"pRedBC",o.imposto.noXml_pRedBC),o.imposto.noXml_pRedBC=0),o.imposto.noXml_pFCP&&!["201","202"].includes(s)&&(this.atualizaCampoRecursivo(c,"pFCP",o.imposto.noXml_pFCP),o.imposto.noXml_pFCP=0))},resumeDadosICMS(o){const a=o.imposto.escolhas;if(a.valor_escolha==="opcao1"||!a.valor_escolha){a.valor_escolha="opcao1";const s=a.opcao1.ICMS.escolhas,e=s.valor_escolha,i=s[e];i&&("CST"in i?o.imposto.noXml_CST=i.CST:"CSOSN"in i&&(o.imposto.noXml_CSOSN=i.CSOSN),o.imposto.noXml_orig=this.buscaRecursivo(i,"orig"))}},distribuiDadosPIS(o){const a=o.imposto.noXml_CSTPis||"";if(a){const s=this.metadados.infNFe.det.lista.imposto.PIS.escolhas,e=o.imposto.PIS.escolhas;for(const c in e)c==="valor_escolha"||c.endsWith("_erro")||"CST"in e[c]&&s[c].CST._enumeration.find(u=>u.valor===a)&&(e.valor_escolha=c,e[c].CST=a);const i=e[e.valor_escolha];!!i&&!!o.imposto.noXml_pPIS&&this.atualizaCampoRecursivo(i,"pPIS",o.imposto.noXml_pPIS)}},distribuiDadosCOFINS(o){const a=o.imposto.noXml_CSTCofins||"";if(a){const s=this.metadados.infNFe.det.lista.imposto.COFINS.escolhas,e=o.imposto.COFINS.escolhas;for(const c in e)c==="valor_escolha"||c.endsWith("_erro")||"CST"in e[c]&&s[c].CST._enumeration.find(u=>u.valor===a)&&(e.valor_escolha=c,e[c].CST=a);const i=e[e.valor_escolha];!!i&&!!o.imposto.noXml_pCOFINS&&this.atualizaCampoRecursivo(i,"pCOFINS",o.imposto.noXml_pCOFINS)}},distribuiDadosIPI(o){const a=o.imposto.noXml_CSTIpi||"";if(a){o.imposto.escolhas.valor_escolha="opcao1";const s=o.imposto.escolhas.opcao1.IPI;s.visivel=!0,s.cEnq=o.imposto.noXml_cEnqIpi,this.metadados.infNFe.det.lista.imposto.escolhas.opcao1.IPI.escolhas.IPITrib.CST._enumeration.find(c=>c.valor===a)?(s.escolhas.valor_escolha="IPITrib",s.escolhas.IPITrib.CST=a,s.escolhas.IPITrib.escolhas.valor_escolha="opcao1",s.escolhas.IPITrib.escolhas.opcao1.pIPI=s.escolhas.IPITrib.escolhas.opcao1.pIPI||o.imposto.noXml_pIPI||0):(s.escolhas.valor_escolha="IPINT",s.escolhas.IPINT.CST=a)}},calculaPIS_COFINS(o,a,s,e,i,c,n){let t=null;switch(a.imposto[o].escolhas.valor_escolha){case o+"Aliq":t=a.imposto[o].escolhas[o+"Aliq"],this.calculaImpostoPercentagem(o,t,"vBC","p"+o,t,"v"+o,e,s,i,a,n);break;case o+"Qtde":t=a.imposto[o].escolhas[o+"Qtde"],this.calculaImpostoQuantidade(o,t,"qBCProd","vAliqProd",t,"v"+o,e,s,c);break;case o+"NT":break;case o+"Outr":t=a.imposto[o].escolhas[o+"Outr"],t.escolhas.valor_escolha==="opcao1"?this.calculaImpostoPercentagem(o,t.escolhas.opcao1,"vBC","p"+o,t,"v"+o,e,s,i,a,n):t.escolhas.valor_escolha==="opcao2"&&this.calculaImpostoQuantidade(o,t.escolhas.opcao2,"qBCProd","vAliqProd",t,"v"+o,e,s,c);break}a.imposto[o+"ST"].visivel&&(t=a.imposto[o+"ST"],t.escolhas.valor_escolha==="opcao1"?this.calculaImpostoPercentagem(o,t.escolhas.opcao1,"vBC","p"+o,t,"v"+o,e,s,i):t.escolhas.valor_escolha==="opcao2"&&this.calculaImpostoQuantidade(o,t.escolhas.opcao2,"qBCProd","vAliqProd",t,"v"+o,e,s,c))},calculaICMS_ISSQN_IPI_II(o,a,s,e,i,c){switch(o.imposto.escolhas.valor_escolha){case"opcao1":this.calculaIPI(o.imposto.escolhas.opcao1.IPI,s,e,i,c,o,a),this.calculaICMS(o,a,s,e,i),this.calculaII(o.imposto.escolhas.opcao1.II,s,e,i);break;case"opcao2":this.calculaISSQN(o.imposto.escolhas.opcao2.ISSQN,s,e,i),this.calculaIPI(o.imposto.escolhas.opcao2.IPI,s,e,i,c,o,a);break}},calculaIPI(o,a,s,e,i,c,n){let t=null;if(o.visivel)switch(o.escolhas.valor_escolha){case"IPITrib":t=o.escolhas.IPITrib,t.escolhas.valor_escolha==="opcao1"?this.calculaImpostoPercentagem("IPI",t.escolhas.opcao1,"vBC","pIPI",t,"vIPI",s,a,e,c,n):t.escolhas.valor_escolha==="opcao2"&&this.calculaImpostoQuantidade("IPI",t.escolhas.opcao2,"qUnid","vUnid",t,"vIPI",s,a,i);break;case"IPINT":t=o.escolhas.IPINT;break}},calculaII(o,a,s,e){o.visivel&&(s.vII+=Number(o.vII))},calculaISSQN(o,a,s,e){this.calculaImpostoPercentagem("ISSQN",o,"vBC","vAliq",o,"vISSQN",s,a,e)},calculaICMS(o,a,s,e,i){const c=o.imposto.escolhas.opcao1.ICMS,n=o.imposto;let t=null;switch(c.escolhas.valor_escolha){case"ICMS00":t=c.escolhas.ICMS00,s.automatico.calculaBC&&(t.modBC="3"),this.calculaImpostoPercentagem("ICMS",t,"vBC","pICMS",t,"vICMS",e,s,i,o,a),t.opcional.visivel&&this.calculaImpostoPercentagem("FCP",t.opcional,"vBCFCP","pFCP",t.opcional,"vFCP",e,s,i,o,a);break;case"ICMS10":t=c.escolhas.ICMS10,s.automatico.calculaBC&&(t.modBC="3"),this.calculaImpostoPercentagem("ICMS",t,"vBC","pICMS",t,"vICMS",e,s,i,o,a),t.opcional.visivel&&this.calculaImpostoPercentagem("FCP",t.opcional,"vBCFCP","pFCP",t.opcional,"vFCP",e,s,i,o,a),t.opcional2.visivel&&this.calculaImpostoFCPST("FCPST",t.opcional2,"vBCFCPST","pFCPST",t.opcional2,"vFCPST",e,s,Number(t.vBCST)||0,Number(t.opcional.vFCP)||0,o),this.calculaImpostoST("ICMSST",t,"vBCST","pICMSST","pMVAST","vICMS",t,"vICMSST",e,s,i,o,a);break;case"ICMS20":t=c.escolhas.ICMS20,this.calculaImpostoPercentagemComReducaoBc("ICMS","vBC","pICMS","pRedBC","vICMS",t,e,s,i,o,a),t.opcional.visivel&&this.calculaImpostoPercentagem("FCP",t.opcional,"vBCFCP","pFCP",t.opcional,"vFCP",e,s,i,o,a);break;case"ICMS30":t=c.escolhas.ICMS30,t.opcional.visivel&&this.calculaImpostoFCPST("FCPST",t.opcional,"vBCFCPST","pFCPST",t.opcional,"vFCPST",e,s,Number(t.vBCST)||0,Number(t.opcional.vFCP)||0,o),this.calculaImpostoST("ICMSST",t,"vBCST","pICMSST","pMVAST","vICMS",t,"vICMSST",e,s,i,o,a);break;case"ICMS40":t=c.escolhas.ICMS40;break;case"ICMS51":t=c.escolhas.ICMS51,this.calculaImpostoPercentagemComReducaoBc("ICMS","vBC","pICMS","pRedBC","vICMS",t,e,s,i,o,a),t.opcional.visivel&&this.calculaImpostoPercentagem("FCP",t.opcional,"vBCFCP","pFCP",t.opcional,"vFCP",e,s,i,o,a);break;case"ICMS60":t=c.escolhas.ICMS60,t.opcional.visivel&&this.calculaImpostoPercentagem("ICMSSTRet",t.opcional,"vBCSTRet","pST",t.opcional,"vICMSSTRet",e,s,i,o,a),t.opcional2.visivel&&this.calculaImpostoPercentagem("FCPSTRet",t.opcional2,"vBCFCPSTRet","pFCPSTRet",t.opcional2,"vFCPSTRet",e,s,i,o,a);break;case"ICMS70":t=c.escolhas.ICMS70,this.calculaImpostoPercentagemComReducaoBc("ICMS","vBC","pICMS","pRedBC","vICMS",t,e,s,i,o,a),t.opcional.visivel&&this.calculaImpostoPercentagem("FCP",t.opcional,"vBCFCP","pFCP",t.opcional,"vFCP",e,s,i,o,a),t.opcional2.visivel&&this.calculaImpostoFCPST("FCPST",t.opcional2,"vBCFCPST","pFCPST",t.opcional2,"vFCPST",e,s,Number(t.vBCST)||0,Number(t.opcional.vFCP)||0,o),this.calculaImpostoST("ICMSST",t,"vBCST","pICMSST","pMVAST","vICMS",t,"vICMSST",e,s,i,o,a);break;case"ICMS90":t=c.escolhas.ICMS90;let u=0;t.opcional.visivel&&(this.calculaImpostoPercentagemComReducaoBc("ICMS","vBC","pICMS","pRedBC","vICMS",t.opcional,e,s,i,o,a),t.opcional.opcional.visivel&&(this.calculaImpostoPercentagem("FCP",t.opcional.opcional,"vBCFCP","pFCP",t.opcional.opcional,"vFCP",e,s,i,o,a),u=Number(t.opcional.opcional.vFCP)||0)),t.opcional2.visivel&&(t.opcional2.vICMS=t.opcional.vICMS,t.opcional2.opcional.visivel&&this.calculaImpostoFCPST("FCPST",t.opcional2.opcional,"vBCFCPST","pFCPST",t.opcional2.opcional,"vFCPST",e,s,Number(t.opcional2.vBCST)||0,u,o),this.calculaImpostoST("ICMSST",t.opcional2,"vBCST","pICMSST","pMVAST","vICMS",t.opcional2,"vICMSST",e,s,i,o,a));break;case"ICMSPart":t=c.escolhas.ICMSPart;break;case"ICMSST":t=c.escolhas.ICMSST;break;case"ICMSSN101":t=c.escolhas.ICMSSN101,this.calculaImpostoST_CSOSN_101_102(t,n,e,o,a,s,i);break;case"ICMSSN102":t=c.escolhas.ICMSSN102;break;case"ICMSSN201":t=c.escolhas.ICMSSN201,this.calculaImpostoST_CSOSN_201_202(t,n,e,o,a,s,i);break;case"ICMSSN202":t=c.escolhas.ICMSSN202,this.calculaImpostoST_CSOSN_201_202(t,n,e,o,a,s,i);break;case"ICMSSN500":t=c.escolhas.ICMSSN500,t.opcional.visivel&&this.calculaImpostoPercentagem("ICMSSTRet",t.opcional,"vBCSTRet","pST",t.opcional,"vICMSSTRet",e,s,i,o,a),t.opcional2.visivel&&this.calculaImpostoPercentagem("FCPSTRet",t.opcional2,"vBCFCPSTRet","pFCPSTRet",t.opcional2,"vFCPSTRet",e,s,i,o,a);break;case"ICMSSN900":t=c.escolhas.ICMSSN900,t.opcional.visivel&&this.calculaImpostoPercentagemComReducaoBc("ICMS","vBC","pICMS","pRedBC","vICMS",t.opcional,e,s,i,o,a),t.opcional2.visivel&&(t.opcional2.vICMS=t.opcional.vICMS,t.opcional2.opcional.visivel&&this.calculaImpostoFCPST("FCPST",t.opcional2.opcional,"vBCFCPST","pFCPST",t.opcional2.opcional,"vFCPST",e,s,Number(t.opcional2.vBCST)||0,Number(t.opcional2.vFCP)||0,o),this.calculaImpostoST("ICMSST",t.opcional2,"vBCST","pICMSST","pMVAST","vICMS",t.opcional2,"vICMSST",e,s,i,o,a));break}},calculaImpostoPercentagem(o,a,s,e,i,c,n,t,u,l,S){if(s in a||console.error("totalEImpostos: Campo "+s+" n\xE3o consta em objetoImposto "),e in a||console.error("totalEImpostos: Campo "+e+" n\xE3o consta em objetoImposto "),c in i||console.error("totalEImpostos: Campo "+c+" n\xE3o consta em objetoImposto "),c in n||console.error("totalEImpostos: Campo "+c+" n\xE3o consta em total"),o==="ICMSSTRet"&&l.imposto.noXml_ICMSSTRet){i.pST=l.imposto.noXml_ICMSSTRet.pST,i.vBCSTRet=l.imposto.noXml_ICMSSTRet.vBCSTRet,i.vICMSSTRet=l.imposto.noXml_ICMSSTRet.vICMSSTRet,i.vICMSSubstituto=l.imposto.noXml_ICMSSTRet.vICMSSubstituto,l.infAdProd=`Base ICMS ST Ret: ${$filters.numero(i.vBCSTRet,2)} / `,l.infAdProd+=`Al\xEDquota ICMS ST Ret: ${$filters.numero(i.pST,2)} / `,l.infAdProd+=`Valor ICMS ST Ret: ${$filters.numero(i.vICMSSTRet,2)} / `,l.infAdProd+=`Valor ICMS Pr\xF3prio (Substituto): ${$filters.numero(i.vICMSSubstituto,2)}`;return}if(~["PIS","COFINS"].indexOf(o)&&(u-=l.imposto.noXml_vICMS),o==="ICMS"&&S.ide.indFinal==="1"&&(u+=l.imposto.noXml_vIPI),o==="ICMS"){const v=S.transp.modFrete==="0",C=l.prod.vFrete;u=u+(v?C:0)}if(u===0||!t.automatico.calculaBC?u=Number(a[s]):u=this.atualizaBC(a,s,t,u),t.calculaTotais){const v=this.atualizaAliquota(a,e,t),C=this.atualizaValorImposto(i,c,u*v/100);n[c]+=C,o==="IPI"&&(l.imposto.noXml_vIPI=C),(o==="ICMS"||o==="ICMSST")&&(s in n||console.error("totalEImpostos: Campo "+s+" n\xE3o consta em total"),n[s]+=u),o==="ICMS"&&(l.imposto.noXml_vICMS=C)}},calculaImpostoST(o,a,s,e,i,c,n,t,u,l,S,v,C){var P,d,F,_;s in a||console.error("totalEImpostos: Campo "+s+" n\xE3o consta em objetoImposto "),e in a||console.error("totalEImpostos: Campo "+e+" n\xE3o consta em objetoImposto "),i in a||console.error("totalEImpostos: Campo "+i+" n\xE3o consta em objetoImposto "),t in n||console.error("totalEImpostos: Campo "+t+" n\xE3o consta em objetoImposto "),t in u||console.error("totalEImpostos: Campo "+t+" n\xE3o consta em total");const f=Number(a[i])||0,m=Number(a[c])||0,I=Number(a[e])||0;if(S===0||!l.automatico.calculaBC)S=Number(a[s])||0;else{const g=C.transp.modFrete==="0",T=C.transp.modFrete==="1",p=v.prod.vFrete,U=C.ide.indFinal==="1";let A=0;Number((P=v==null?void 0:v.imposto)==null?void 0:P.noXml_orig)===1&&Number((d=v==null?void 0:v.imposto)==null?void 0:d.noXml_CST)===10&&(A=(_=(F=v==null?void 0:v.imposto)==null?void 0:F.noXml_vIPI)!=null?_:0);const w=r(S+A+(g||!U&&T?p:0))*(1+f/100);S=this.atualizaBC(a,s,l,w)}l.calculaTotais&&(n[t]=r(S*I/100-m,2),t==="vICMSST"&&(n[t]+=v.imposto.noXml_vFCPST||0),u[t]+=n[t],(o==="ICMS"||o==="ICMSST")&&(s in u||console.error("totalEImpostos: Campo "+s+" n\xE3o consta em total"),u[s]+=S))},calculaVCredICMSSN(o,a){const s=o!=null?o:{};"pCredSN"in s&&"vCredICMSSN"in s&&(o.vCredICMSSN=$utils.arredondar(o.pCredSN/100*Number(a.prod.vProd),2))},calculaImpostoST_CSOSN_101_102(o,a,s,e,i,c,n){!c.automatico.calculaBC||(o.pCredSN=$utils.arredondar(Number(c==null?void 0:c.aliquotaSimples),2),this.calculaVCredICMSSN(o,e))},calculaImpostoST_CSOSN_201_202(o,a,s,e,i,c,n){let t,u,l;if(n===0||!c.automatico.calculaBC)n=Number(a.noXml_vBC)||0,u=Number(a.noXml_vBCFCP)||0,t=Number(o.vBCST)||0,l=Number(o.opcional.vBCFCPST)||0;else{u=n;const S=i.transp.modFrete==="0",v=i.transp.modFrete==="1",C=e.prod.vFrete,f=i.ide.indFinal==="1",m=Number(o.pMVAST)||0;t=r((n+(S||!f&&v?C:0))*(1+m/100)),l=t,a.noXml_vBC=n,a.noXml_vBCFCP=u,o.vBCST=t,o.opcional.vBCFCPST=l}if(c.calculaTotais){const S=Number(a.noXml_pICMS)||0,v=Number(a.noXml_pFCP)||0,C=Number(o.pICMSST)||0,f=Number(o.opcional.pFCPST)||0,m=r(n*S/100,2),I=r(u*v/100,2),P=r(t*C/100-m,2),d=r(l*f/100-I,2);a.noXml_vICMS=m,a.noXml_vFCP=I,o.vICMSST=P,o.opcional.vFCPST=d,a.noXml_vFCPST=d,s.vICMSST+=P,s.vFCPST+=d,s.vBCST+=t}},calculaImpostoFCPST(o,a,s,e,i,c,n,t,u,l,S){s in a||console.error("totalEImpostos: Campo "+s+" n\xE3o consta em objetoImposto "),e in a||console.error("totalEImpostos: Campo "+e+" n\xE3o consta em objetoImposto "),c in i||console.error("totalEImpostos: Campo "+c+" n\xE3o consta em objetoImposto "),c in n||console.error("totalEImpostos: Campo "+c+" n\xE3o consta em total");const v=Number(a[e])||0;u===0||!t.automatico.calculaBC?u=Number(a[s]):u=this.atualizaBC(a,s,t,u),t.calculaTotais&&(i[c]=r(u*v/100-l,2),n[c]+=i[c],c==="vFCPST"&&(S.imposto.noXml_vFCPST=i[c]))},calculaImpostoPercentagemComReducaoBc(o,a,s,e,i,c,n,t,u,l,S){a in c||console.error("totalEImpostos: Campo "+a+" n\xE3o consta em objetoImposto "),s in c||console.error("totalEImpostos: Campo "+s+" n\xE3o consta em objetoImposto "),e in c||console.error("totalEImpostos: Campo "+e+" n\xE3o consta em objetoImposto "),i in c||console.error("totalEImpostos: Campo "+i+" n\xE3o consta em objetoImposto "),i in n||console.error("totalEImpostos: Campo "+i+" n\xE3o consta em total");const v=Number(c[s]),C=Number(c[e]);if(u===0||!t.automatico.calculaBC?u=Number(c[a]):(!!C&&!!v&&(u=r(u-u*(C/100),2)),c[a]=u),t.calculaTotais){const f=r(u*v/100,2);c[i]=f,n[i]+=f,(o==="ICMS"||o==="ICMSST")&&(a in n||console.error("totalEImpostos: Campo "+a+" n\xE3o consta em total"),n[a]+=u)}},calculaImpostoQuantidade(o,a,s,e,i,c,n,t,u){s in a||console.log("Campo "+s+" n\xE3o consta em objetoImposto "),e in a||console.log("Campo "+e+" n\xE3o consta em objetoImposto "),c in i||console.log("Campo "+c+" n\xE3o consta em objetoImposto "),c in n||console.log("Campo "+c+" n\xE3o consta em total");const l=this.atualizaBCquantidade(a,s,u,t),S=this.atualizaAliquotaQuantidade(a,e,t),v=this.atualizaValorImposto(i,c,l*S);n[c]+=v},atualizaBC(o,a,s,e){return s.automatico.calculaBC?o[a]=r(e,2):e=Number(o[a]),e},atualizaAliquota(o,a,s){let e=0;return e=Number(o[a]),e},atualizaValorImposto(o,a,s){return o[a]=r(s,2),r(s,2)},atualizaBCquantidade(o,a,s,e){let i=0;return e.automatico.calculaBC?(i=s,o[a]=r(i,4)):i=Number(o[a]),i},atualizaAliquotaQuantidade(o,a,s){let e=0;return e=Number(o[a]),e},atualizaCampoRecursivo(o,a,s){a in o&&(o[a]=s);for(const e in o){const i=o[e];!!i&&i.constructor===Object&&this.atualizaCampoRecursivo(i,a,s)}},atualizaCampoVisivelRecursivo(o,a,s){a in o&&"visivel"in o&&(o.visivel=s);for(const e in o){const i=o[e];!!i&&i.constructor===Object&&this.atualizaCampoVisivelRecursivo(i,a,s)}},buscaRecursivo(o,a){if(a in o)return o[a];for(const s in o){const e=o[s];if(!!e&&e.constructor===Object){const i=this.buscaRecursivo(e,a);if(i)return i}}return 0}};async function io(o){var i;const{idItem:a}=o!=null?o:{};let s,e;if(!!a)return s=await $erp().item.get(a),e=JSON.parse((i=s==null?void 0:s.json)!=null?i:null),e==null?void 0:e.icmsSTRet}function M(o,a,s){s in o&&(o[s]=a[s]);for(const e in o){const i=o[e];!!i&&i.constructor===Object&&M(i,a,s)}}function N(o,a,s){s in o&&"visivel"in o&&(o.visivel=!!a[s+"Visivel"]);for(const e in o){const i=o[e];!!i&&i.constructor===Object&&N(i,a,s)}}async function ro({infNFe:o,det:a,descricaoProduto:s,item:e,documentoItem:i,cfop:c,empresa:n,destinatario:t,outrosNFe:u},l){var d,F;o.ide.idDest=o.emit.enderEmit.UF===o.dest.enderDest.UF||!o.emit.enderEmit.UF||!o.dest.enderDest.UF||o.ide.mod==="65"?"1":o.dest.enderDest.UF==="EX"?"3":"2";let S=e.ncm||"";S=S.length===8?S:x(S);const v={emitente:{regime:o.emit.CRT,uf:o.emit.enderEmit.UF,tributacaoSetor:n.tributacaoSetor,tributacao:n.tributacao},destinatario:{regime:t.regime==="SimplesNacional"?"1":t.regime==="Normal"?"3":void 0,uf:o.dest.enderDest.UF,pessoa:{CPF:"PF",CNPJ:"PJ",idEstrangeiro:"Estrangeiro"}[o.dest.enderDest.UF==="EX"?"idEstrangeiro":o.dest.escolhas.valor_escolha]||void 0,tributacaoSetor:t.tributacaoSetor,tributacao:t.tributacao,indicadorIE:o.dest.indIEDest,consumidor:o.ide.indFinal==="0"?"N":o.ide.indFinal==="1"?"S":void 0,destino:o.ide.idDest},ncm:S,idItem:e.id,cfop:String(c||""),cest:e.cest,origemMercadoria:String(e.codigoOrigem||""),produto:e.descricao},C=await D.configuracaoImposto.pesquisa(v,l);if(!C||!C.ordem||!C.saida)return;v.emitente.uf!==v.destinatario.uf&&~["2","9"].indexOf(v.destinatario.indicadorIE)&&(a.imposto.ICMSUFDest.visivel=!0,a.imposto.ICMSUFDest.pFCPUFDest=Number(C.saida.icmsInterestadual.pFCPUFDest||0),a.imposto.ICMSUFDest.pICMSInter=String(Number(C.saida.pICMS).toFixed(2)),a.imposto.ICMSUFDest.pICMSInterPart=Number(C.saida.icmsInterestadual.pICMSInterPart||0),a.imposto.ICMSUFDest.pICMSUFDest=Number(C.saida.icmsInterestadual.pICMSUFDest||0),a.imposto.ICMSUFDest.pRedBCSTInter=Number(C.saida.icmsInterestadual.pRedBCSTInter||0));const f=a.prod,m=a.imposto,I=oo(C.saida);f.CFOP=C.entrada.cfop,m.noXml_orig=C.entrada.origemMercadoria,m.noXml_CST=I.cstCsosn,m.noXml_CSOSN=I.cstCsosn,m.noXml_pICMS=I.pICMS||0,m.noXml_pRedBC=(d=Number(C.saida.icmsInterestadual.pRedBC))!=null?d:0,m.noXml_pFCP=I.pFCP||0,I.pMVAST=I.pMVAST||0,I.pRedBC=(F=Number(C.saida.icmsInterestadual.pRedBC))!=null?F:0,M(m,I,"modBC"),M(m,I,"modBCST"),M(m,I,"pFCP"),M(m,I,"pFCPST"),M(m,I,"pFCPST"),M(m,I,"pFCPSTRet"),M(m,I,"pICMS"),M(m,I,"pICMSEfet"),M(m,I,"pICMSST"),M(m,I,"pMVAST"),M(m,I,"pRedBC"),M(m,I,"pST"),N(m,I,"pFCP"),N(m,I,"pFCPST"),N(m,I,"pFCPSTRet"),N(m,I,"pICMSEfet"),N(m,I,"pST"),m.noXml_ICMSSTRet=await io({idItem:f.noXml_id}),m.noXml_CSTPis=I.pisCst,m.noXml_pPIS=I.pPIS||0,m.noXml_CSTCofins=I.cofinsCst,m.noXml_pCOFINS=I.pCOFINS||0,C.entrada.cest&&(f.opcional.visivel=!0,f.opcional.CEST=x(C.entrada.cest)),u.observacoesNFe||(u.observacoesNFe={});const P=(C.saida.observacaoNFe||"").trim();(e==null?void 0:e.id)&&!u.observacoesNFe[e.id]&&P&&(u.observacoesNFe[e.id]=P),I.ipiVisivel&&(m.noXml_CSTIpi=o.ide.tpNF==="1"?I.ipiCstEntrada:I.ipiCstSaida,m.noXml_pIPI=f.noXml_pIPI||I.pIPI||0,m.noXml_cEnqIpi=I.ipiCEnq||0)}async function no(o,a){const s=(await D.configuracoes.leValorComFiltroEmpresa("nfe.autorizadoDownloadXml",a)).split(" ");for(const e of s){const i=O.executa(R.infNFe.autXML.lista,{},this.tipo),c=x(e);c.length===14?(i.escolhas.valor_escolha="CNPJ",i.escolhas.CNPJ=c,o.autXML.push(i)):c.length===11&&(i.escolhas.valor_escolha="CPF",i.escolhas.CPF=c,o.autXML.push(i))}}async function uo(o,a){o.ide.serie=String(await D.configuracoes.leValorNumericoComFiltroEmpresa(this.serie,a,1)),o.ide.nNF=String(await D.documentoFiscalEletronico.proximoNumero(o.ide.tpAmb,o.emit.escolhas.valor_escolha==="CPF"?o.emit.escolhas.CPF:o.emit.escolhas.CNPJ,o.ide.mod,o.ide.serie,a))}async function So(o,a){b.log("gerarJsonBaseD","obterConfiguracaoImposto"),o.descricaoProduto=`Produto '${o.documentoItem.descricaoItem||""}'`,h(!o.item.ncm,`${o.descricaoProduto} sem cadastro de NCM`);let s;o.outrosNFe.cfop?(s=await E().cfop.where({cfop:Number(o.outrosNFe.cfop)}).first(),h(!s,"CFOP inv\xE1lido")):(h(!o.documentoItem.idCfop,`${o.descricaoProduto} sem CFOP definido`),s=await E().cfop.get(o.documentoItem.idCfop),h(!s,`${o.descricaoProduto} com CFOP inv\xE1lido`)),o.cfop=s.cfop,await this.gerarConfiguracaoImposto(o,a)}async function Co(o){var a;if(b.log("gerarJsonBaseD","obterFatura"),o.documentoFatura=await $db.hibrido.le({table:"documento",id:o.idDocumento}),h(!o.documentoFatura,"N\xE3o foi poss\xEDvel carregar a fatura/venda"),o.documentosAdicionais=await $db.hibrido.lista({table:"documento",where:{idDocumentoAdicional:o.idDocumento}}),o.documentosVendas=await $db.hibrido.lista({table:"documento",where:{idFatura:o.idDocumento}}),o.idsDocumentos=[o.idDocumento,...o.documentosAdicionais.map(s=>s.id),...o.documentosVendas.map(s=>s.id)],b.log("gerarJsonBaseD",{documentoFatura:o.documentoFatura,documentosAdicionais:o.documentosAdicionais,documentosVendas:o.documentosVendas}),o.totalDesconto=r((o.documentoFatura.totalDesconto||0)+X(o.documentosVendas,"totalDesconto")),o.documentoFatura.tipo==="Venda")o.totalFrete=r(o.documentoFatura.valorFrete||0),o.tipoFrete=o.documentoFatura.tipoFrete;else{o.totalFrete=r(X(o.documentosVendas,"valorFrete")),o.tipoFrete=(a=o.documentosVendas[0])==null?void 0:a.tipoFrete;for(const s of o.documentosVendas)h(o.tipoFrete!==s.tipoFrete,"Diverg\xEAncia de frete entre as vendas, favor emitir a nota individualmente (por venda)")}o.tipoFrete==="FOB"?o.infNFe.transp.modFrete="1":o.infNFe.transp.modFrete=r(o.totalFrete)===0?"9":o.tipoFrete==="CIF"?"0":o.tipoFrete==="FOB"?"1":"9",o.tipo!=="NFe"&&(o.totalFrete=0),o.infNFe.ide.natOp=o.outrosNFe.operacao?o.outrosNFe.operacao:o.infNFe.ide.finNFe==="4"?"Devolu\xE7\xE3o":"Venda",this.tipo==="NFCe"&&(o.infNFe.infAdic.visivel=!0,o.infNFe.infAdic.infCpl=Y(await D.configuracoes.leValorComFiltroEmpresa("cupom.mensagem",o.documentoFatura.idEmpresa,"Obrigado e Volte Sempre!")),await D.configuracoes.leValorNumerico("nfce.offline")===1&&(o.infNFe.ide.tpEmis="9",o.infNFe.ide.opcional.visivel=!0,o.infNFe.ide.opcional.dhCont=ao.formatarDataNFe(new Date),o.infNFe.ide.opcional.xJust="Internet indisponivel")),o.outrosNFe.idDocumento=o.idDocumento}function po(o={}){var s;const a=[];for(const e in((s=o.outrosNFe)==null?void 0:s.observacoesNFe)||{}){const i=o.outrosNFe.observacoesNFe[e];let c=a.find(n=>n.msg===i);c||(c={msg:i},a.push(c))}o.outrosNFe.observacoesNFe="";for(const e of a)o.outrosNFe.observacoesNFe&&(o.outrosNFe.observacoesNFe+=" "),o.outrosNFe.observacoesNFe+=e.msg}function vo(o={}){const a=o.infNFe.total.ICMSTot.vProd-o.infNFe.total.ICMSTot.vDesc;o.outrosNFe.textoValorAproximadosTributos="[Valores aproximados dos tributos: R$ "+$utils.formatarNumero(o.infNFe.total.ICMSTot.vTotTrib,2)+" ("+$utils.formatarNumero(100*o.infNFe.total.ICMSTot.vTotTrib/a,2)+"%)  Federais: R$ "+$utils.formatarNumero(o.infNFe.total.ICMSTot.noXml_vTribFed,2)+" ("+$utils.formatarNumero(100*o.infNFe.total.ICMSTot.noXml_vTribFed/a,2)+"%)  Estaduais: R$ "+$utils.formatarNumero(o.infNFe.total.ICMSTot.noXml_vTribEst,2)+" ("+$utils.formatarNumero(100*o.infNFe.total.ICMSTot.noXml_vTribEst/a,2)+"%)  Municipais: R$ "+$utils.formatarNumero(o.infNFe.total.ICMSTot.noXml_vTribMun,2)+" ("+$utils.formatarNumero(100*o.infNFe.total.ICMSTot.noXml_vTribMun/a,2)+"%) Fonte: IBPT.] "}async function mo(o){var n,t,u;if(b.log("gerarJsonBaseD","obterFormasPagamento"),o.documentosPagamento=await $db.hibrido.lista({table:"documentoCondicaoPagamento",where:{idDocumento:o.idDocumento}}),o.documentosPagamento.length===0&&o.documentoFatura.tipo==="Venda"){h(!o.documentoFatura.idFatura,"A venda n\xE3o tem pagamento e n\xE3o pertence a uma fatura");const l=await $db.hibrido.le({table:"documento",id:o.documentoFatura.idFatura});h(!l,"N\xE3o foi poss\xEDvel carregar a fatura da venda"),o.documentosPagamento=await $db.hibrido.lista({table:"documentoCondicaoPagamento",where:{idDocumento:l.id}}),o.vendaSemPagamento=!0}h(!o.documentosPagamento.length&&!o.vendaSemPagamento,"N\xE3o h\xE1 pagamentos"),b.log("gerarJsonBaseD","documentosPagamento",o.documentosPagamento);const a=[];for(const l of o.documentosPagamento){const S=await this.obterMeioPagamento(o,l.idFormaPagamento),v=await $erp().formaPagamento.get(l.idFormaPagamento);let C=a.find(f=>f.tPag===S&&f.card.cAut===l.autorizacao);if(C)C.vPag=r(C.vPag+l.valor);else{if(C=O.executa(R.infNFe.pag.detPag.lista,{},this.tipo),C.tPag=S,C.vPag=r(l.valor),["03","04"].includes(S)){let f;v.idContatoOperadoraCartao&&(f=await $erp().contato.get(v.idContatoOperadoraCartao),f&&(f.numeroDocumentoNacional=(n=f.numeroDocumentoNacional)==null?void 0:n.replace(/\D/g,""))),C.card.visivel=!0,C.card.tpIntegra="2",((t=f==null?void 0:f.numeroDocumentoNacional)==null?void 0:t.length)===14&&(C.card.CNPJ=f.numeroDocumentoNacional),C.card.cAut=l.autorizacao}S==="99"&&(C.xPag=$utils.removerCaracteresEspeciais(((u=v==null?void 0:v.descricao)!=null?u:"").trim())),a.push(C)}}h(a.length===0&&!o.vendaSemPagamento,"N\xE3o h\xE1 pagamentos"),o.totalProdutos=r(o.totalProdutos);const s=await E().financeiroTitulo.where({idFatura:o.idDocumento}).toArray(),e=r(X(a,"vPag"));r(X(s,"valorTotal")+o.totalServicos);const i=r(o.totalProdutos+o.totalFrete+o.totalDevolucao-o.totalDesconto-a.reduce((l,S)=>S.tPag==="90"?S.vPag:0,0));for(const l of a)l.tPag!=="99"&&delete l.xPag,l.tPag==="90"&&(l.vPag=0);if(e>0&&e!==i){for(const S of a)S.vPag=r(S.vPag*i/e);const l=r(X(a,"vPag"));for(const S of a)S.tPag!=="90"&&(S.vPag=r(S.vPag+i-l))}const c=r(-o.totalDevolucao);c>0&&o.totalProdutos>0&&a.push({tPag:"99",xPag:"Credito de Devolucao",vPag:c}),o.infNFe.pag.detPag=a}async function Io(o){if(o.totalFrete>0){const a=[];for(const e of o.infNFe.det){const i=e.prod;a.push({id:i.noXml_idDocumentoItem,valor:i.qCom*i.vUnCom-i.vDesc})}const s=$utils.ratear({itens:a,saldo:o.totalFrete});for(const e of o.infNFe.det){const i=e.prod,c=s.find(n=>n.id===i.noXml_idDocumentoItem);i.vFrete=(c==null?void 0:c.parcela)||0}}}async function fo(o,a){b.log("gerarJsonBaseD","obterItens");const s=await E().documentoItem.where("idDocumento").anyOf(o.idsDocumentos).sortBy("dataHoraEmissao"),e=await $db.hibrido.lista({table:"documento",whereIn:{id:o.idsDocumentos}});h(!s,"N\xE3o foi poss\xEDvel carregar os produtos"),b.log("gerarJsonBaseD","documentosItens",s);const i=await D.configuracoes.leValorNumericoComFiltroEmpresa(this.usadesconto,o.outrosNFe.idContatoEmitente,1),c=await D.configuracoes.leValorNumerico("imposto.versao"),n=[];for(const l of s){let S=r(l.total||0);if(r(S)===0||!l.idItem)continue;if(["Servi\xE7o"].includes(l.tipoItem)){o.totalServicos+=S;continue}if(o.infNFe.ide.finNFe==="4"){if(!(S<0)){o.totalDevolucao+=S;continue}}else if(S<0){o.totalDevolucao+=S;continue}const v=r(l.quantidade||1,4);let C=r(l.valorItem||0,4),f=r(l.descontoItem||0,4),m=r((l.descontoTotalRateado||0)+(l.descontoFaturaRateado||0),4);if(b.log("gerarJsonBaseD",{quantidade:v,valorUnitarioItem:C,descontoUnitarioItem:f,descontoRateadoItem:m,valorUnitarioItemComDesconto:C-f-m/v,valorUnitarioItemComDescontoA:r(C-f-m/v,4),totalItem:S,tipoItem:l.tipoItem,idItem:l.idItem,descricaoItem:l.descricaoItem}),["TLOE","TLOD"].includes(l.tipoItem))continue;if(["LOE","LOD"].includes(l.tipoItem)){const g=s.filter(T=>["TLOE","TLOD"].includes(T.tipoItem)&&T.idDocumentoItemPai===l.id);b.log("gerarJsonBaseD","tratamentos",g);for(const T of g)f+=r(T.descontoItem||0,4),m+=r((T.descontoTotalRateado||0)+(T.descontoFaturaRateado||0),4),C=r(C+T.valorItem||0,4),S+=T.total||0}let I=r(f*v+m);i===0&&(C=r(C-f-m/v,4),I=0),o.totalProdutos+=S,o.documentoItem=l,o.item=await E().item.get(l.idItem),h(!o.item,"N\xE3o foi poss\xEDvel carregar o cadastro do produto"),o.det=O.executa(R.infNFe.det.lista,{},this.tipo);const P=o.det.prod;let d=String(o.item.codigoBarras||"").padStart(13,"0");if(d.startsWith("999")&&(d="SEM GTIN"),P.cProd=String(o.item.referencia||o.item.codigoItem||"0").trim(),P.cEAN=d,P.xProd=Y(l.descricaoItem).substr(0,120).trim(),P.NCM=String(o.item.ncm||""),P.uCom=String(o.item.unidade||"UN").trim(),P.qCom=v||0,P.vUnCom=C||0,P.vDesc=I||0,o.infNFe.ide.finNFe==="4"&&(P.vUnCom=-P.vUnCom,P.vDesc=-P.vDesc),P.noXml_id=l.idItem,P.noXml_idDocumentoItem=l.id,l.loteEmpresa&&l.dataValidadeLote&&l.dataFabricacaoLote&&P.rastro.push({nLote:l.loteEmpresa,qLote:l.quantidade,dFab:new Date(l.dataFabricacaoLote).toISOString().slice(0,10),dVal:new Date(l.dataValidadeLote).toISOString().slice(0,10)}),o.item.codigoANP){P.escolhas.valor_escolha="comb",P.escolhas.comb.cProdANP=o.item.codigoANP;let g=to.tabelaANP.find(T=>T.value===o.item.codigoANP);g&&(P.escolhas.comb.descANP=g.label),g||(P.escolhas.comb.descANP="C\xF3digo n\xE3o encontrado na tabela da ANP."),o.infNFe.dest.enderDest.UF&&(P.escolhas.comb.UFCons=o.infNFe.dest.enderDest.UF)}const F=Math.abs(l.valorRealTotal),_=Math.abs(l.valorIpi);F&&_&&(P.noXml_pIPI=r(_/F*100)),o.pesoL=r((o.pesoL||0)+Number(o.item.peso||0)*Number(v||1),3),o.pesoB=r((o.pesoB||0)+Number(o.item.pesoBruto||0)*Number(v||1),3),c===2?await this.obterConfiguracaoImpostoV2(o,a):await this.obterConfiguracaoImposto(o),n.push(o.det)}if(o.infNFe.ide.finNFe==="4")h(n.length===0,"N\xE3o h\xE1 produtos para devolu\xE7\xE3o");else if(h(n.length===0,"N\xE3o h\xE1 produtos vendidos"),o.outrosNFe.operacao!=="Remessa")for(const l of n)await this.obterAliquotasTributosIbpt(o,l);const t=O.executa(R.infNFe.transp.vol.lista,{},this.tipo),u=e.reduce((l,S)=>l+(Number(S.numeroVolumeTransporte)||0),0);t.esp="",u>0&&(t.esp=u===1?"VOLUME":"VOLUMES"),t.qVol=String(u||""),t.pesoL=o.pesoL,t.pesoB=o.pesoB,o.infNFe.transp.vol.push(t),b.log("gerarJsonBaseD","itens",n),o.infNFe.det=n}export{no as a,uo as b,Co as c,po as d,vo as e,mo as f,ro as g,Io as h,fo as i,So as o,lo as t};
