import{_ as B,c2 as f,$ as h,b$ as p,o as t,d as l,i as S,w as g,e as C,bf as A,V as x,x as c,f as d,Q as w,aA as b,F as $,r as q,aE as k,D as v,cy as y,t as P}from"./index.5f3d4c88.js";const z={components:{},data(){return{filtro:"",idsClienteSistemaSelecionados:[],operacao:"",plataformaPercentagem:"0 %",clienteSistemasFiltrado:[],erroAcoes:[{label:"Retomar",handler:this.atualizar}]}},methods:{async abrirSistema(){this.operacao="redirecionando",this.$router.push({name:"Home"})},async atualizar(){$utils.gconsole.log("AutenticacaoBancos","atualizar()");try{if($q.loading.show(),!navigator.onLine){this.operacao="semConexao";return}const o=JSON.parse(localStorage.getItem("clienteSistemaBaixados")||"[]").map(e=>e.idClienteSistema),n=e=>""+(99-Number(e.padrao))+Number(!o.includes(e.idClienteSistema))+e.sistema+e.bancoDeDados;if(await $db.usuario.inicializaLogado(),navigator.onLine){const e=await $utils.geeksApi({clienteSistemas:{funcao:"50BD6521-7654-4455-A161-BDFFCC1AA3A9"}},{bancoDeDados:"GeeksPlat15A"});this.sistemas=e.data.clienteSistemas.sort((m,s)=>n(m).localeCompare(n(s)))}else this.sistemas=$db.usuario.logado.sistemas.sort((e,m)=>n(e).localeCompare(n(m)));if(!(await f.getDatabaseNames()).includes("plataforma"))return this.$q.notifyError("O banco principal n\xE3o foi encontrado."),this.desconectar();if(!Array.isArray(this.sistemas))return this.$q.notifyError("N\xE3o foi poss\xEDvel obter os bancos de dados."),this.desconectar();if(this.sistemas.length<=0)return this.$q.notifyError("Este usu\xE1rio n\xE3o possui direito de acesso a nenhum sistema."),this.desconectar();const i=this.sistemas.filter(e=>e.versao==="19A");if(this.operacao==="selecionar"){$utils.gconsole.log("AutenticacaoBancos","aguardando selecionar sistemas/bancos"),this.idsClienteSistemaSelecionados=o,this.clienteSistemasFiltrado=this.sistemas;return}if(!localStorage.getItem("clienteSistema")){i.length<=1&&this.sistemas.length<=10?($utils.gconsole.log("AutenticacaoBancos","menos de 10 sistemas online e 1 banco offline"),this.idsClienteSistemaSelecionados=this.sistemas.map(e=>e.idClienteSistema),this.adicionarBancos()):($utils.gconsole.log("AutenticacaoBancos","aguardando selecionar sistemas/bancos"),this.idsClienteSistemaSelecionados=o,this.clienteSistemasFiltrado=this.sistemas,this.operacao="selecionar");return}return localStorage.getItem("sincronismoPlat")!=="ok"?this.sincronismoInicial():($utils.gconsole.log("abrirSistema","via atualizar"),this.abrirSistema())}catch(a){this.$q.notifyError("Erro na opera\xE7\xE3o",a)}finally{$q.loading.hide()}},obterDispositivo(){let a=localStorage.getItem("dispositivoCliente");return a||(a=$utils.uuid(),localStorage.setItem("dispositivoCliente",a)),{id:a,detalhe:JSON.stringify({navigator:navigator?{platform:navigator.platform,vendor:navigator.vendor,appVersion:navigator.appVersion,userAgent:navigator.userAgent,deviceMemory:navigator.deviceMemory,connection_downlink:(navigator.connection||{}).downlink}:{},screen:screen?{width:screen.width,height:screen.height}:{},usuario:{id:$db.usuario.logado.id,nome:$db.usuario.logado.nome},dataHora:$utils.dataAtual()})}},async adicionarBancos(){if($utils.gconsole.log("AutenticacaoBancos","adicionarBancos()"),!this.idsClienteSistemaSelecionados.length)return this.operacao="selecionar",this.$q.notifyError("Banco de dados n\xE3o selecionado");this.operacao="adicionandoBancoDeDados";const a=JSON.parse(localStorage.getItem("clienteSistema")||"null"),o=this.sistemas.filter(s=>this.idsClienteSistemaSelecionados.includes(s.idClienteSistema)),n=a&&this.idsClienteSistemaSelecionados.includes(a.id)?a:o[0],u=this.obterDispositivo(),i=o.filter(s=>s.versao==="19A"),r=$utils.unicos(i,"bancoDeDados"),e=await h.sincronismo.toArray();$db.cache.setJson("clienteSistemaBaixados",o),$db.cache.setJson("clienteSistema",n),$db.cache.set("bancoDeDados",n.bancoDeDados),localStorage.setItem("sincronismoPlat","sincronizando"),localStorage.setItem("versaoPlataforma",""),$db.cache.setJson("sincronismoPlataforma",{});for(const s of h.tables)s.name!=="login"&&await s.clear();(await f.getDatabaseNames()).filter(s=>s!=="plataforma"&&!r.includes(s)).forEach(s=>{$erp(s,"delete")});for(const s of r){const _=e.find(D=>D.bancoDeDados===s)||{bancoDeDados:s};await h.sincronismo.put(_),await $db.dispositivoCliente.grava(u,s)}return await p.atualizarStatus(),this.plataformaPercentagem="0 %",this.sincronismoInicial()},desconectar(){$utils.gconsole.log("AutenticacaoBancos","desconectar()"),$db.usuario.desconecta(),this.$router.push({name:"Autenticacao"})},async sincronismoInicial(){$utils.gconsole.log("AutenticacaoBancos","sincronismoInicial()"),p.descarregarPlataforma(),p.descarregarErp(),this.operacao="sincronizando"},sincronismoPlataformaPercentagem(a){this.plataformaPercentagem=a,a==="100 %"&&a&&this.operacao!=="selecionar"&&this.abrirSistema()}},watch:{filtro(a){$utils.gconsole.log("AutenticacaoBancos","filtro",a),a?this.clienteSistemasFiltrado=this.sistemas.filter(o=>o.bancoDeDados.toUpperCase().includes(a.toUpperCase())):this.clienteSistemasFiltrado=this.sistemas}},async created(){this.operacao=this.$route.params.operacao},async mounted(){await this.atualizar(),$utils.emitter.on("sincronismoPlataformaPercentagem",this.sincronismoPlataformaPercentagem,this)},beforeUnmount(){$utils.emitter.off("sincronismoPlataformaPercentagem",this.sincronismoPlataformaPercentagem)}},I={class:"AutenticacaoBancos"},E=c("p",null,"Selecione os bancos de dados que deseja disponibilizar nesta m\xE1quina:",-1),F={class:"AutenticacaoBancos-bancos"},N={class:"actions q-mt-lg"},V={key:2,class:"q-mt-md text-white"},Q=c("div",{class:"text-body2 q-mt-sm"},"Aguarde, sincronizando...",-1),J={class:"text-caption q-mt-sm text-light"},L={key:3,class:"q-mt-md text-white"},O=c("div",{class:"text-body2 q-mt-sm"},"Redirecionando...",-1),R=[O],U={key:4,class:"q-mt-md text-white"},M=c("div",{class:"text-body2 q-mt-sm"},"Adicionado bancos de dados...",-1),H={key:5,class:"q-mt-md text-white"},T=c("div",{class:"text-body2 q-mt-sm"},"Carregando...",-1),j=[T];function G(a,o,n,u,i,r){return t(),l("div",I,[i.operacao==="semConexao"?(t(),S(A,{key:0,actions:i.erroAcoes,detail:"Tente novamente em instantes.",type:"negative"},{default:g(()=>[C(" Erro ao estabelecer conex\xE3o. ")]),_:1},8,["actions"])):i.operacao==="selecionar"?(t(),l("form",{key:1,class:"text-white",onSubmit:o[2]||(o[2]=x((...e)=>r.adicionarBancos&&r.adicionarBancos(...e),["prevent"]))},[E,c("div",F,[d(b,{"error-label":"Informe uma senha v\xE1lida.",class:"q-px-sm"},{default:g(()=>[d(w,{modelValue:i.filtro,"onUpdate:modelValue":o[0]||(o[0]=e=>i.filtro=e),filled:"",dark:"",dense:"",label:"Filtro"},null,8,["modelValue"])]),_:1}),(t(!0),l($,null,q(i.clienteSistemasFiltrado,(e,m)=>(t(),S(b,{key:m},{default:g(()=>[d(k,{modelValue:i.idsClienteSistemaSelecionados,"onUpdate:modelValue":o[1]||(o[1]=s=>i.idsClienteSistemaSelecionados=s),label:e.sistema+" - "+e.bancoDeDados,val:e.idClienteSistema,dark:"",color:"primary"},null,8,["modelValue","label","val"])]),_:2},1024))),128))]),c("div",N,[d(v,{color:"transparent",label:"Desconectar",size:"md","text-color":"primary",onClick:r.desconectar},null,8,["onClick"]),d(v,{autofocus:"",class:"q-ml-md",color:"white",label:"Continuar","text-color":"primary",type:"submit",disable:!i.idsClienteSistemaSelecionados.length},null,8,["disable"])])],32)):i.operacao==="sincronizando"?(t(),l("div",V,[d(y,{color:"white",size:35}),Q,c("div",J," plataforma: "+P(i.plataformaPercentagem),1)])):i.operacao==="redirecionando"?(t(),l("div",L,R)):i.operacao==="adicionandoBancoDeDados"?(t(),l("div",U,[d(y,{color:"white",size:35}),M])):(t(),l("div",H,j))])}var W=B(z,[["render",G]]);export{W as default};
