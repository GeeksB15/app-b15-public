import{_ as O,a as j,be as q,p as D,o as v,d as V,f as i,w as n,C as F,i as N,aj as y,ak as u,j as C,e as p,L as k,l as _,x as E,Q as L,ai as A,F as T,r as M,ah as w,t as x,k as R,D as $,aF as U,am as J,s as I,B as X,E as Q,aK as H,z as B,U as Z,y as G}from"./index.3c3f23f2.js";import{x as z}from"./xlsx.902f1db5.js";import{l as K}from"./listaV2.b244283b.js";import{n as W}from"./Nfse.4940340d.js";import{J as Y}from"./JsonViewer.2a85f7ec.js";import"./QBreadcrumbs.83441348.js";import"./optionsNfse.22979934.js";const aa={components:{lista:K,nfse:W,JsonViewer:Y},data(){return{lista:[],buscaCampo:"",checkboxModel:!0,im:"",dialogoSincronizarLote:{visivel:!1,listaEmpresas:[],empresa:null,periodoInicial:null,periodoFinal:null},filtros:{emitente:null,destinatario:null,numeroRps:null,numeroNfse:null,dataEmissaoNfseDe:null,dataEmissaoNfseAte:null,dataCriacaoRpsDe:null,dataCriacaoRpsAte:null},paginacao:{atual:1,maximo:1,total:1,limite:25},tabSelecionada:{valor:"Rascunho"},tabs:[{rotulo:"Rascunho",value:"Rascunho"},{rotulo:"Protocoladas",value:"Protocolada"},{rotulo:"Enviadas",value:"Enviada"},{rotulo:"Canceladas",value:"Cancelada"},{rotulo:"Todos",value:"Todos"}]}},methods:{async selecionarEmpresa(){let o;const a={ativo:!0,empresas:!0},e=await $g.promptContato.show({filtro:a,placeholder:"Selecione"});if(!e)throw new Error("Nenhum contato selecionado");e.nome||(o="\xC9 preciso informar a Raz\xE3o Social do Prestador"),!o&&!e.numeroDocumentoMunicipal&&(o="\xC9 preciso informar a inscri\xE7\xE3o municipal");const t=!e.numeroDocumentoNacional||e.numeroDocumentoNacional.length<14;if(!o&&t&&(o="\xC9 preciso informar o CNPJ do Prestador"),o)throw $q.notifyError(o),new Error(o);return e},async mostrarNfse(o){this.$router.replace({params:{id:o}}),await this.$refs.modalNfse.show(o)},async criarRps(){var o;try{const a=await this.selecionarEmpresa(),e=(await $db.empresa.le({idContato:a.id}))[0],t=await $db.contatoEndereco.leEnderecoPrincipal(a.id),s={documento:a.numeroDocumentoNacional.match(/\d+/g).join(""),nome:a.nome,inscricaoMunicipal:a.numeroDocumentoMunicipal,nfseOptanteSimples:(e==null?void 0:e.nfseOptanteSimples)||"",nfseIncentivadorCultural:(e==null?void 0:e.nfseIncentivadorCultural)||"",nfseNaturezaOperacao:(e==null?void 0:e.nfseNaturezaOperacao)||"",nfseRegimeTributario:(e==null?void 0:e.nfseRegimeTributario)||"",nfseDescricaoServico:(e==null?void 0:e.nfseDescricaoServico)||"",nfseCodigoServico:(e==null?void 0:e.nfseCodigoServico)||"",nfseAliquotaIss:e==null?void 0:e.nfseAliquotaIss,nfseItensListaDeServico:JSON.parse(e==null?void 0:e.nfseItensListaDeServico)||"",ibgeCod:(t==null?void 0:t.ibgeCod)||"",cidadeUf:(t==null?void 0:t.municipio)+"-"+(t==null?void 0:t.uf)};this.im=(o=a==null?void 0:a.numeroDocumentoMunicipal)!=null?o:"";const l=await this.obterNFSeRPSMaisRecente();$utils.gconsole.log("NfseLista",{im:this.im,nfseRPSMaisRecente:l}),this.$refs.modalNfse.show(null,s,l)}catch(a){console.log(a.message)}},async obterNFSeRPSMaisRecente(){var o,a;if($db.hibrido.isOnline()){const e=await $utils.geeksApi({listaNfse:{funcao:"C79B2497-0D9C-4971-8656-2C04FF41F247",where:{inscricaoMunicipal:this.im},limit:1,page:1,sort:["JSON_VALUE(json, '$.rps.identificacaoRps.numero')"],dir:["desc"]}}),{data:t}=e.data.listaNfse;return(o=t[0])!=null?o:null}else{let e;e=await $db.hibrido.lista({table:"documentoFiscalEletronico",where:{tipo:"NFSe"}}),this.im&&(e=e.filter(s=>JSON.parse(s.json).rps.inscricaoMunicipal===this.im)),e.sort((s,l)=>{var d,h,f,g,r,b,S,P;const c=Number((g=(f=(h=JSON.parse((d=s.json)!=null?d:null))==null?void 0:h.rps)==null?void 0:f.identificacaoRps)==null?void 0:g.numero),m=Number((P=(S=(b=JSON.parse((r=l.json)!=null?r:null))==null?void 0:b.rps)==null?void 0:S.identificacaoRps)==null?void 0:P.numero);return c>m?-1:1});const t=(a=e[0])!=null?a:null;return t!=null&&t.json&&(t.rps=JSON.parse(t.json).rps),t}},async atualizar(o){var e,t;const a=$utils.logarIni("NfseLista");await $tryLoading(async()=>$db.hibrido.isOnline()?this.atualizarOnline(o):this.atualizarOffline(o)),$utils.logarFim(a,(t=(e=this.paginacao)==null?void 0:e.total)!=null?t:1)},async atualizarOffline(o){this.documentos=await $db.hibrido.lista({table:"documentoFiscalEletronico",where:{tipo:"NFSe"}});for(const a of this.documentos){const{rps:e}=JSON.parse(a.json);a.rps=e,a.showPreviewDetail=this.showPreviewDetail}if(this.documentos.sort((a,e)=>{var t,s;return Number((t=a==null?void 0:a.rps.identificacaoRps)==null?void 0:t.numero)<Number((s=e==null?void 0:e.rps.identificacaoRps)==null?void 0:s.numero)?1:-1}),(o==null?void 0:o.id)&&(o==null?void 0:o.situacaoNfse)==="Enviada"){await this.aplicarFiltrosEPaginacao(o);return}await this.aplicarFiltrosEPaginacao()},async atualizarOnline(o){this.filtros.situacao=this.tabSelecionada.valor==="Todos"?null:this.tabSelecionada.valor;const a=await $utils.geeksApi({listaNfse:{funcao:"C79B2497-0D9C-4971-8656-2C04FF41F247",where:this.filtros,limit:this.paginacao.limite,page:this.paginacao.atual,sort:["dataHoraEmissao"],dir:["desc"]}}),{data:e,total:t,totalPages:s}=a.data.listaNfse;for(const l of e)l.showPreviewDetail=this.showPreviewDetail;this.lista=e,this.paginacao.total=t,this.paginacao.maximo=s},async aplicarFiltrosEPaginacao(o){if(this.aplicarFiltroPelaTab({situacaoNfse:o==null?void 0:o.situacaoNfse}),o!=null&&o.id&&(this.buscaCampo=o==null?void 0:o.id),/^[A-F|0-9]{8}-[A-F|0-9]{4}-[A-F|0-9]{4}-[A-F|0-9]{4}-[A-F|0-9]{12}$/.test(this.buscaCampo)){this.paginacao.atual=1,this.paginacao.maximo=1,this.paginacao.total=1,this.listaTmp=this.listaTmp.filter(t=>t.id===this.buscaCampo),this.lista=this.listaTmp;return}if(this.filtros.emitente){const t=new RegExp(this.filtros.emitente,"i");this.listaTmp=this.listaTmp.filter(s=>t.test(s.xNomeEmitente))}if(this.filtros.destinatario||this.buscaCampo){const t=this.buscaCampo||this.filtros.destinatario,s=new RegExp(t,"i");this.listaTmp=this.listaTmp.filter(l=>s.test(l.xNomeDestinatario))}if(this.filtros.numeroRps){const t=new RegExp(this.filtros.numeroRps);this.listaTmp=this.listaTmp.filter(s=>t.test(s.rps.identificacaoRps.numero))}if(this.filtros.numeroNfse&&(this.listaTmp=this.listaTmp.filter(t=>t.rps.numero===this.filtros.numeroNfse)),this.filtros.dataEmissaoNfseDe&&this.filtros.dataEmissaoNfseDe.length===10){const t=this.filtros.dataEmissaoNfseDe.split("/"),s=new Date(Number(t[2]),Number(t[1])-1,Number(t[0]));this.listaTmp=this.listaTmp.filter(l=>new Date(new Date(l.rps.dataEmissao).toDateString())>=s)}if(this.filtros.dataEmissaoNfseAte&&this.filtros.dataEmissaoNfseAte.length===10){const t=this.filtros.dataEmissaoNfseAte.split("/"),s=new Date(Number(t[2]),Number(t[1])-1,Number(t[0]));this.listaTmp=this.listaTmp.filter(l=>new Date(new Date(l.rps.dataEmissao).toDateString())<=s)}if(this.filtros.dataCriacaoRpsDe&&this.filtros.dataCriacaoRpsDe.length===10){const t=this.filtros.dataCriacaoRpsDe.split("/"),s=new Date(Number(t[2]),Number(t[1])-1,Number(t[0]));this.listaTmp=this.listaTmp.filter(l=>new Date(new Date(l.rps.dataHoraCriacao).toDateString())>=s)}if(this.filtros.dataCriacaoRpsAte&&this.filtros.dataCriacaoRpsAte.length===10){const t=this.filtros.dataCriacaoRpsAte.split("/"),s=new Date(Number(t[2]),Number(t[1])-1,Number(t[0]));this.listaTmp=this.listaTmp.filter(l=>new Date(new Date(l.rps.dataHoraCriacao).toDateString())<=s)}this.setupPaginacao();const a=this.paginacao.atual*this.paginacao.limite-this.paginacao.limite,e=this.paginacao.atual*this.paginacao.limite;this.lista=this.listaTmp.slice(a,e)},aplicarFiltroPelaTab(o){if(o!=null&&o.situacaoNfse&&(this.tabSelecionada={valor:o.situacaoNfse}),this.tabSelecionada.valor==="Todos"){this.listaTmp=this.documentos;return}const a=this.tabSelecionada.valor;this.listaTmp=this.documentos.filter(e=>e.situacao===a)},setupPaginacao(){const o=Math.ceil(this.listaTmp.length/this.paginacao.limite);this.paginacao.atual=this.paginacao.atual>o?o:this.paginacao.atual,this.paginacao.total=this.listaTmp.length,this.paginacao.maximo=o},toogleTodosPreview(){this.showPreviewDetail=!this.showPreviewDetail;for(const o of this.lista)o.showPreviewDetail=this.showPreviewDetail},async limparFiltros_click(){this.filtros={emitente:null,destinatario:null,numeroRps:null,numeroNfse:null},await this.atualizar()},async exportarXLSX_click(){try{$q.loading.show();const o=$utils.eliminarVazios(this.filtros);delete o.ativo,this.tabSelecionada.valor==="Ativos"&&(o.ativo=!0),this.tabSelecionada.valor==="Excluidos"&&(o.ativo=!1);const a=await $db.item.leRefatorado({filtros:o,limit:999999,page:1,sort:"descricao"}),e=z.utils.book_new(),t=z.utils.json_to_sheet(a.data,{header:Object.keys(a.data[0])});z.utils.book_append_sheet(e,t,"itens"),z.writeFile(e,"itens.xlsx")}catch(o){$q.notifyError("Erro iniciar",o)}finally{$q.loading.hide()}},abrirModalDeCancelamento(o){$q.dialog({title:"Cancelar NFS-e",message:"Qual o motivo do cancelamento?",prompt:{model:"",isValid:a=>!!a},cancel:!0,persistent:!0}).onOk(async a=>{const{rps:e}=o,t={numero:e.numero,motivoCancelamento:a,inscricaoMunicipal:e.prestador.inscricaoMunicipal,cnpj:e.prestador.documento,codigoMunicipio:e.servico.municipioPrestacaoServico,codigoCancelamento:5};await this.cancelarNfse(t,o)})},async cancelarNfse(o,a){var e,t,s,l,c;this.$q.loading.show();try{if((e=a.rps)!=null&&e.plugNotasConsulta){console.log("cancelamento via plugNotas");const m={motivo:o.motivoCancelamento},d=await $api.plugnotas.nfse.solicitarCancelamentoNFSe((t=a.rps.plugNotasConsulta)==null?void 0:t.id,m);if((d==null?void 0:d.message)==="Cancelamento em processamento"&&((s=d==null?void 0:d.data)==null?void 0:s.protocol))if((await $api.plugnotas.nfse.consultarCancelamentoNFSe((l=d==null?void 0:d.data)==null?void 0:l.protocol)).data.status==="CONCLUIDO"){a.rps.motivoCancelamento=o.motivoCancelamento,a.rps.status="2";const f={...a,situacao:"Cancelada",json:JSON.stringify({rps:a.rps})};await $db.documentoFiscalEletronico.grava({atual:f,original:a});let g={};f.id&&(g=(await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:f.id}}))[0],await $db.documentoFiscalEletronicoXml.grava({atual:{...g,situacao:f.situacao},original:g})),$q.notifyPositive("NFS-e cancelada!")}else $q.notifyError("N\xE3o foi poss\xEDvel realizar o cancelamento, por favor tente novamente!")}if(!((c=a.rps)!=null&&c.plugNotasConsulta))if((await j.post("https://api.b15.com.br/integradorjs/nfse/cancelar",{jsonParaXML:o})).data.xmlPassou){$q.notifyPositive("NFS-e cancelada!"),a.rps.motivoCancelamento=o.motivoCancelamento,a.rps.status="2";const d={...a,situacao:"Cancelada",json:JSON.stringify({rps:a.rps})};await $db.documentoFiscalEletronico.grava({atual:d,original:a});let h={};d.id&&(h=(await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:d.id}}))[0],await $db.documentoFiscalEletronicoXml.grava({atual:{...h,situacao:d.situacao},original:h}))}else $q.notifyError("N\xE3o foi poss\xEDvel realizar o cancelamento, por favor tente novamente!")}catch{$q.notifyError("Falha ao enviar XML")}await this.atualizar(),this.$q.loading.hide()},confirmarExclusaoNfse(o){$q.dialog({title:"Remover NFS-e",message:"Deseja remover esta NFS-e?",cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(async()=>{try{await $db.documentoFiscalEletronico.remove(o),$q.notifyPositive("NFS-e removida com sucesso")}catch{$q.notifyError("Falha ao remover NFS-e")}this.atualizar()})},async downloadPDF(o){var t;let a=await $db.hibrido.le({table:"documentoFiscalEletronico",id:o}),e=JSON.parse((t=a==null?void 0:a.json)!=null?t:null);try{$q.loading.show({message:"Solicitando URL...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"}),e.rps.pdf=await $db.nfse.solicitarURLImpressao(o);let s=document.createElement("a");s.href=e.rps.pdf,s.download=`nfse-${e.rps.identificacaoRps.numero}.pdf`,s.click()}catch(s){console.error(s.message)}finally{$q.loading.hide()}},async solicitarURLImpressao(o){var s,l,c;let a=await $db.hibrido.le({table:"documentoFiscalEletronico",id:o}),e=JSON.parse((s=a==null?void 0:a.json)!=null?s:null),t;try{$q.loading.show({message:"Solicitando URL...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"}),t=await $db.nfse.solicitarURLImpressao(o),(l=e==null?void 0:e.rps)!=null&&l.plugNotasConsulta&&window.open("","_blank").document.write(`<iframe width='100%' height='100%' src='${t}'></iframe>`),(c=e==null?void 0:e.rps)!=null&&c.plugNotasConsulta||window.open(t,"_blank"),await this.atualizar()}catch(m){let d=m.message.replace("db.nfse.sincronizarLote: ","");d.length!==m.message&&$q.notifyError(d),d.length===m.message&&console.error(m.message)}finally{$q.loading.hide()}},async solicitarURLImpressaoEmLote(){var a;const o=$utils.clonarV2(this.lista.filter(e=>e.situacao==="Enviada"));o.sort((e,t)=>{var c,m,d,h,f,g,r,b;const s=(h=(d=(m=JSON.parse((c=e.json)!=null?c:null))==null?void 0:m.rps)==null?void 0:d.identificacaoRps)==null?void 0:h.numero,l=(b=(r=(g=JSON.parse((f=t.json)!=null?f:null))==null?void 0:g.rps)==null?void 0:r.identificacaoRps)==null?void 0:b.numero;return s>l?1:-1});for(const e of o)try{let t=await $db.hibrido.le({table:"documentoFiscalEletronico",id:e.id}),s=JSON.parse((a=t==null?void 0:t.json)!=null?a:null),l;l=await $db.nfse.solicitarURLImpressao(e.id)}catch(t){console.log(t.message)}},async baixarXml(o){var t,s;let{xml:a}=o.rps;if((!a||/^https:\/\/.+$/.test(a))&&((s=(t=o.rps)==null?void 0:t.plugNotasConsulta)==null?void 0:s.xml)){const l=o.rps.plugNotasConsulta.xml;a=await $api.plugnotas.nfse.baixarXmlNFSe(l,o)}if(a){const l=document.createElement("a");var e=new Blob([a],{type:"text/plain"});l.setAttribute("href",window.URL.createObjectURL(e)),l.setAttribute("download",`${o.rps.identificacaoRps.numero}.xml`),l.dataset.downloadurl=["text/plain",l.download,l.href].join(":"),l.click()}a||this.$q.notifyError("N\xE3o foi poss\xEDvel recuperar o XML")},async recarregarPDF(o){var s,l,c;let a=await $db.hibrido.le({table:"documentoFiscalEletronico",id:o}),e=$utils.clonarV2(a),t=JSON.parse((s=a==null?void 0:a.json)!=null?s:null);(l=t.rps.plugNotasConsulta)!=null&&l.pdf&&((c=t.rps.plugNotasConsulta)==null||delete c.pdf),t.rps.pdf&&delete t.rps.pdf,a.json=t,await $db.documentoFiscalEletronico.grava({atual:a,original:e}),this.solicitarURLImpressao(o)},async enviarEmailNfse(o){var a,e;try{if(this.$q.loading.show(),!o.cpfCnpjDestinatario||!o.id)return;const t=await $db.hibrido.le({table:"documentoFiscalEletronico",id:o.id});if(!(t!=null&&t.id))return;const l=(await $db.contato.ler({filtros:{termoBusca:t.cpfCnpjDestinatario,ativo:!0}})).data.find(f=>{var g;return((g=f.numeroDocumentoNacional)!=null?g:"").replace(/\D/g,"")===t.cpfCnpjDestinatario}),c=(e=JSON.parse((a=t.json)!=null?a:null))==null?void 0:e.rps;if(!c)return;let m;this.$q.loading.hide();try{m=await new Promise((f,g)=>{var r;$q.dialog({title:"Informe o e-mail",message:"E-mail do destinat\xE1rio",prompt:{model:(r=l==null?void 0:l.email)!=null?r:"",isValid:b=>/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(b.toLowerCase()),type:"text"},cancel:!0,persistent:!1}).onOk(b=>{f(b)}).onCancel(()=>{g("Cancelado pelo usu\xE1rio")}).onDismiss(()=>{g("Cancelado pelo usu\xE1rio")})}).catch(f=>{throw new Error(f)})}catch(f){console.log(f.message);return}this.$q.loading.show();const d=[{name:"nfse.xml",content:c.xml}];c.link&&d.push({name:"nfse.pdf",url:c.link,method:"url2pdf"});const h={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",to:m,subject:`Nota Fiscal Eletr\xF4nica de Servi\xE7os N\xBA ${c.numero}`,text:`Voc\xEA est\xE1 recebendo os arquivos digitais NFS-e (Nota Fiscal Eletr\xF4nica de Servi\xE7os) da empresa ${t.xNomeEmitente}`,attachments:d};await j({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:h}),this.$q.notifyPositive("E-mail enviado com sucesso")}catch{this.$q.notifyError("Erro ao enviar email")}finally{this.$q.loading.hide()}},async enviarLote(){var o,a;try{$q.loading.show({message:"Preparando envio do lote...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const e=$utils.clonarV2(this.lista.filter(t=>t.situacao==="Rascunho"));e.sort((t,s)=>{var m,d,h,f,g,r,b,S;const l=(f=(h=(d=JSON.parse((m=t.json)!=null?m:null))==null?void 0:d.rps)==null?void 0:h.identificacaoRps)==null?void 0:f.numero,c=(S=(b=(r=JSON.parse((g=s.json)!=null?g:null))==null?void 0:r.rps)==null?void 0:b.identificacaoRps)==null?void 0:S.numero;return l>c?1:-1});for(const t of e){const s=(await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:t.id}}))[0],l=(o=JSON.parse(t.json))==null?void 0:o.rps;l!=null&&l.dataEmissao||(l.dataEmissao=$utils.dataAtual()),$q.loading.show({message:`Enviando...
                <br /><br />
                <strong>Lote</strong> ${l.numeroLote}<br />
                <strong>RPS</strong> ${l.identificacaoRps.numero}<br />
                <strong>S\xE9rie</strong> ${l.identificacaoRps.serie}<br />
                <br />
                ${l.tomador.razaoSocial}`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const{nfse:c,situacao:m}=await $db.nfse.emitir({nfse:l,aguardarRetorno:!1}),d={id:t.id,tipo:"NFSe",tpAmb:"2",situacao:m,mod:"",serie:"",nNF:"",chNFe:"",vNF:0,dhEmi:q.formatarDataNFe(new Date((a=this.nfse)==null?void 0:a.dataEmissao)),cpfCnpjEmitente:c.prestador.documento,xNomeEmitente:c.prestador.razaoSocial,cpfCnpjDestinatario:c.tomador.documento,xNomeDestinatario:c.tomador.razaoSocial,dataHoraEmissao:c==null?void 0:c.dataEmissao,dataHoraCriacao:t.dataHoraCriacao||$utils.dataAtual(),json:JSON.stringify({rps:c})},h={id:(s==null?void 0:s.id)||$utils.uuid(),tipo:d.tipo,situacao:m,tpAmb:d.tpAmb,dataHoraEnvio:c==null?void 0:c.dataEmissao,cpfCnpjEmitente:c.prestador.documento,xmlEnvio:c.xml,idDocumentoFiscalEletronico:d.id};await $db.documentoFiscalEletronico.grava({atual:d,original:t}),await $db.documentoFiscalEletronicoXml.grava({atual:h,original:s})}this.atualizar()}catch(e){console.log(e.message)}finally{$q.loading.hide()}},async protocolarLote(){var o,a;try{$q.loading.show({message:"Preparando envio do lote...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const e=$utils.clonarV2(this.lista.filter(t=>t.situacao==="Protocolada"));e.sort((t,s)=>{var m,d,h,f,g,r,b,S;const l=(f=(h=(d=JSON.parse((m=t.json)!=null?m:null))==null?void 0:d.rps)==null?void 0:h.identificacaoRps)==null?void 0:f.numero,c=(S=(b=(r=JSON.parse((g=s.json)!=null?g:null))==null?void 0:r.rps)==null?void 0:b.identificacaoRps)==null?void 0:S.numero;return l>c?1:-1});for(const t of e){const s=(await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:t.id}}))[0],l=(o=JSON.parse(t.json))==null?void 0:o.rps;l!=null&&l.dataEmissao||(l.dataEmissao=$utils.dataAtual()),$q.loading.show({message:`Enviando...
                <br /><br />
                <strong>Lote</strong> ${l.numeroLote}<br />
                <strong>RPS</strong> ${l.identificacaoRps.numero}<br />
                <strong>S\xE9rie</strong> ${l.identificacaoRps.serie}<br />
                <br />
                ${l.tomador.razaoSocial}`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const{nfse:c,situacao:m}=await $db.nfse.emitir({nfse:l,aguardarRetorno:!1}),d={id:t.id,tipo:"NFSe",tpAmb:"2",situacao:m,mod:"",serie:"",nNF:"",chNFe:"",vNF:0,dhEmi:q.formatarDataNFe(new Date((a=this.nfse)==null?void 0:a.dataEmissao)),cpfCnpjEmitente:c.prestador.documento,xNomeEmitente:c.prestador.razaoSocial,cpfCnpjDestinatario:c.tomador.documento,xNomeDestinatario:c.tomador.razaoSocial,dataHoraEmissao:c==null?void 0:c.dataEmissao,dataHoraCriacao:t.dataHoraCriacao||$utils.dataAtual(),json:JSON.stringify({rps:c})},h={id:(s==null?void 0:s.id)||$utils.uuid(),tipo:d.tipo,situacao:m,tpAmb:d.tpAmb,dataHoraEnvio:c==null?void 0:c.dataEmissao,cpfCnpjEmitente:c.prestador.documento,xmlEnvio:c.xml,idDocumentoFiscalEletronico:d.id};await $db.documentoFiscalEletronico.grava({atual:d,original:t}),await $db.documentoFiscalEletronicoXml.grava({atual:h,original:s})}this.atualizar()}catch(e){console.log(e.message)}finally{$q.loading.hide()}},async abrirDialogoSincronizarLote(){const o=new Date,a=(await $db.contato.ler({filtros:{ativo:!0,empresas:!0}})).data;this.dialogoSincronizarLote.listaEmpresas=a.map(e=>({value:e.id,label:e.nome+" - "+e.numeroDocumentoNacional,cnpj:e.numeroDocumentoNacional,inscricaoMunicipal:e.numeroDocumentoMunicipal})),this.dialogoSincronizarLote.empresa=this.dialogoSincronizarLote.listaEmpresas[0],this.dialogoSincronizarLote.periodoInicial=o,this.dialogoSincronizarLote.periodoFinal=o,this.dialogoSincronizarLote.visivel=!0},async sincronizarLote(){try{$q.loading.show({message:"Obtendo dados do servidor...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"}),await $db.nfse.sincronizarLote({inscricaoMunicipal:this.dialogoSincronizarLote.empresa.inscricaoMunicipal,cnpj:this.dialogoSincronizarLote.empresa.cnpj,periodo:{inicial:this.dialogoSincronizarLote.periodoInicial,final:this.dialogoSincronizarLote.periodoFinal}},(o,a)=>$q.loading.show({message:`${a}...
                <br /><br />
                <strong>Lote</strong> ${o.numeroLote}<br />
                <strong>RPS</strong> ${o.identificacaoRps.numero}<br />
                <strong>S\xE9rie</strong> ${o.identificacaoRps.serie}<br />
                <br />
                ${o.tomador.razaoSocial}`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})),this.dialogoSincronizarLote.visivel=!1,this.atualizar()}catch(o){let a=o.message.replace("db.nfse.sincronizarLote: ","");a.length!==o.message&&$q.notifyError(a),a.length===o.message&&console.error(o.message)}finally{$q.loading.hide()}},async mostrarJsonViewer(){await this.$refs.jsonViewer.show(this)}},mounted(){this.$route.params.id&&this.$route.params.id.length&&this.mostrarNfse(this.$route.params.id),this.atualizar()}},oa=E("div",{class:"q-mt-md"},"Data de emiss\xE3o NFS-e",-1),ta={class:"row q-col-gutter-x-sm"},ea=E("div",{class:"q-mt-md"},"Data de cria\xE7\xE3o RPS",-1),ia={class:"row q-col-gutter-x-sm"},sa={class:"text-tertiary q-col-gutter-xs"},la={class:"row full-width"},ra={class:"col-12"},na={class:"col"},ca=E("div",{class:"col-auto",style:{"align-items":"center",display:"flex"}},[E("label",null,"at\xE9")],-1),da={class:"col"},ua={class:"q-mt-lg text-right"};function ma(o,a,e,t,s,l){const c=D("campo"),m=D("badge"),d=D("lista"),h=D("nfse"),f=D("JsonViewer"),g=D("row");return v(),V("div",null,[i(d,{titulo:"NFS-e",checkboxModel:s.checkboxModel,"onUpdate:checkboxModel":a[13]||(a[13]=r=>s.checkboxModel=r),buscaCampo:s.buscaCampo,"onUpdate:buscaCampo":a[14]||(a[14]=r=>s.buscaCampo=r),onCriar_click:l.criarRps,onFiltro_change:l.atualizar,onLimparFiltros_click:l.limparFiltros_click,onAbrirTodosPreview:l.toogleTodosPreview,onExportarXLSX_click:l.exportarXLSX_click,lista:s.lista,tabs:s.tabs,tabSelecionada:s.tabSelecionada,paginacao:s.paginacao,filtros:s.filtros,permissaoExtras:!0,exportarXLSXVisible:!1,checkboxVisible:!1,removerTodosVisible:!1,showQuickAdd:!1},{menuExtras:n(()=>[F((v(),N(y,{clickable:"",onClick:a[0]||(a[0]=r=>l.enviarLote())},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"mdi-file-replace",size:"sm"})]),_:1}),i(u,null,{default:n(()=>[p("Enviar Lote")]),_:1})]),_:1})),[[k]]),F((v(),N(y,{clickable:"",onClick:a[1]||(a[1]=r=>l.protocolarLote())},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"mdi-file-replace",size:"sm"})]),_:1}),i(u,null,{default:n(()=>[p("Protocolar Lote")]),_:1})]),_:1})),[[k]]),F((v(),N(y,{clickable:"",onClick:a[2]||(a[2]=r=>l.solicitarURLImpressaoEmLote())},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"mdi-file-replace",size:"sm"})]),_:1}),i(u,null,{default:n(()=>[p("Solicitar PDF Lote")]),_:1})]),_:1})),[[k]]),F((v(),N(y,{clickable:"",onClick:a[3]||(a[3]=r=>l.abrirDialogoSincronizarLote())},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"mdi-file-replace",size:"sm"})]),_:1}),i(u,null,{default:n(()=>[p("Sincronizar Lote")]),_:1})]),_:1})),[[k]]),o.$db.usuario.desenvolvedor()?F((v(),N(y,{key:0,clickable:"",onClick:a[4]||(a[4]=r=>l.mostrarJsonViewer())},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"mdi-file-replace",size:"sm"})]),_:1}),i(u,null,{default:n(()=>[p("Ver Objeto")]),_:1})]),_:1})),[[k]]):_("",!0)]),filtroCampos:n(()=>[i(c,{modelValue:s.filtros.emitente,"onUpdate:modelValue":a[5]||(a[5]=r=>s.filtros.emitente=r),rotulo:"Emitente",dense:""},null,8,["modelValue"]),i(c,{modelValue:s.filtros.destinatario,"onUpdate:modelValue":a[6]||(a[6]=r=>s.filtros.destinatario=r),rotulo:"Destinat\xE1rio",dense:""},null,8,["modelValue"]),i(c,{modelValue:s.filtros.numeroRps,"onUpdate:modelValue":a[7]||(a[7]=r=>s.filtros.numeroRps=r),rotulo:"Numero RPS",dense:""},null,8,["modelValue"]),i(c,{modelValue:s.filtros.numeroNfse,"onUpdate:modelValue":a[8]||(a[8]=r=>s.filtros.numeroNfse=r),rotulo:"Numero NFS-e",dense:""},null,8,["modelValue"]),oa,E("div",ta,[i(L,{class:"col-12 col-md-6",modelValue:s.filtros.dataEmissaoNfseDe,"onUpdate:modelValue":a[9]||(a[9]=r=>s.filtros.dataEmissaoNfseDe=r),mask:"##/##/####",label:"De",dense:""},null,8,["modelValue"]),i(L,{class:"col-12 col-md-6",modelValue:s.filtros.dataEmissaoNfseAte,"onUpdate:modelValue":a[10]||(a[10]=r=>s.filtros.dataEmissaoNfseAte=r),mask:"##/##/####",label:"At\xE9",dense:""},null,8,["modelValue"])]),ea,E("div",ia,[i(L,{class:"col-12 col-md-6",modelValue:s.filtros.dataCriacaoRpsDe,"onUpdate:modelValue":a[11]||(a[11]=r=>s.filtros.dataCriacaoRpsDe=r),mask:"##/##/####",label:"De",dense:""},null,8,["modelValue"]),i(L,{class:"col-12 col-md-6",modelValue:s.filtros.dataCriacaoRpsAte,"onUpdate:modelValue":a[12]||(a[12]=r=>s.filtros.dataCriacaoRpsAte=r),mask:"##/##/####",label:"At\xE9",dense:""},null,8,["modelValue"])])]),itemLista:n(()=>[s.lista.length>0?(v(),N(A,{key:0,bordered:"",class:"bg-white q-mb-xs rounded-borders",style:{"min-height":"calc(100vh - 200px)"}},{default:n(()=>[(v(!0),V(T,null,M(s.lista,r=>(v(),V("div",{key:r},[i(y,null,{default:n(()=>[i(u,{top:"",class:"col-2 gt-sm"},{default:n(()=>[i(w,null,{default:n(()=>[p(x(r.rps.identificacaoRps.numero)+" ",1),i(R,null,{default:n(()=>[p(" RPS (Recibo provis\xF3rio) ")]),_:1})]),_:2},1024),i(w,{caption:""},{default:n(()=>[p(x(r.rps.numero)+" ",1),i(R,null,{default:n(()=>[p(" N\xBA Nota ")]),_:1})]),_:2},1024)]),_:2},1024),i(u,{top:"",class:"col-5 gt-sm"},{default:n(()=>[i(w,null,{default:n(()=>[p(x(r.xNomeDestinatario),1)]),_:2},1024),i(w,{caption:""},{default:n(()=>[p(x(r.cpfCnpjDestinatario),1)]),_:2},1024)]),_:2},1024),i(u,null,{default:n(()=>[r.rps.mensagemDeRetorno?(v(),N(C,{key:0,name:"report",size:"sm",color:"red"},{default:n(()=>[i(R,null,{default:n(()=>[p(x(r.rps.mensagemDeRetorno),1)]),_:2},1024)]),_:2},1024)):_("",!0)]),_:2},1024),i(u,null,{default:n(()=>[i(w,{lines:"1"},{default:n(()=>[i(C,{name:"event",class:"text-tertiary"}),p(" "+x(o.$filters.data(r.rps.dataEmissao))+" ",1),i(R,null,{default:n(()=>[p("Data/Hora da emiss\xE3o: "+x(o.$filters.dataHora(r.rps.dataEmissao)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024),i(u,{avatar:""},{default:n(()=>[i(m,{class:"q-mr-sm",escuro:"",cor:"tertiary"},{default:n(()=>[p(x(r.situacao),1)]),_:2},1024)]),_:2},1024),i(u,null,{default:n(()=>[i(u,{caption:"",class:"text-right text-tertiary"},{default:n(()=>[E("span",null,[p(x(o.$filters.numero(r.rps.servico.valores.valorServicos,2))+" ",1),i(R,null,{default:n(()=>[p("Valor dos Servi\xE7os")]),_:1})])]),_:2},1024)]),_:2},1024),i(u,{side:"",center:""},{default:n(()=>[E("div",sa,[i($,{icon:r!=null&&r.showPreviewDetail?"keyboard_arrow_up":"keyboard_arrow_down",class:"gt-xs",clickable:"",color:"tertiary",dense:"",flat:"",round:"",size:"12px",onClick:b=>r.showPreviewDetail=!(r!=null&&r.showPreviewDetail)},null,8,["icon","onClick"]),i($,{class:"gt-xs",color:"tertiary",dense:"",flat:"",icon:"edit",round:"",size:"12px",onClick:b=>l.mostrarNfse(r.id)},null,8,["onClick"]),r.situacao==="Rascunho"?(v(),N($,{key:0,class:"gt-xs",color:"tertiary",icon:"delete",size:"12px",onClick:b=>l.confirmarExclusaoNfse(r.id),dense:"",flat:"",round:""},null,8,["onClick"])):_("",!0),r.situacao==="Enviada"?(v(),N($,{key:1,dense:"",flat:"",icon:"more_vert",round:"",size:"12px"},{default:n(()=>[i(U,null,{default:n(()=>[F((v(),N(A,{link:"",separator:""},{default:n(()=>{var b;return[i(y,{clickable:"",onClick:S=>l.solicitarURLImpressao(r.id)},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"print"})]),_:1}),i(u,null,{default:n(()=>[i(w,null,{default:n(()=>[p("Imprimir")]),_:1})]),_:1})]),_:2},1032,["onClick"]),(b=r.rps)!=null&&b.plugNotasConsulta?(v(),N(y,{key:0,clickable:"",onClick:S=>l.downloadPDF(r.id)},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"download_for_offline"})]),_:1}),i(u,null,{default:n(()=>[i(w,null,{default:n(()=>[p("Download PDF")]),_:1})]),_:1})]),_:2},1032,["onClick"])):_("",!0),i(y,{clickable:"",onClick:S=>l.recarregarPDF(r.id)},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"download_for_offline"})]),_:1}),i(u,null,{default:n(()=>[i(w,null,{default:n(()=>[p("Recarregar PDF")]),_:1})]),_:1})]),_:2},1032,["onClick"]),r.rps.numero&&r.situacao==="Enviada"?(v(),N(y,{key:1,clickable:"",onClick:S=>l.abrirModalDeCancelamento(r)},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"delete"})]),_:1}),i(u,null,{default:n(()=>[i(w,null,{default:n(()=>[p("Cancelar")]),_:1})]),_:1})]),_:2},1032,["onClick"])):_("",!0),r.rps.xml?(v(),N(y,{key:2,clickable:"",onClick:S=>l.baixarXml(r)},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"mdi-download"})]),_:1}),i(u,null,{default:n(()=>[i(w,null,{default:n(()=>[p("Baixar XML")]),_:1})]),_:1})]),_:2},1032,["onClick"])):_("",!0),r.rps.xml?(v(),N(y,{key:3,clickable:"",onClick:S=>l.enviarEmailNfse(r)},{default:n(()=>[i(u,{avatar:""},{default:n(()=>[i(C,{name:"mail"})]),_:1}),i(u,null,{default:n(()=>[i(w,null,{default:n(()=>[p("Enviar por email")]),_:1})]),_:1})]),_:2},1032,["onClick"])):_("",!0)]}),_:2},1024)),[[k]])]),_:2},1024)]),_:2},1024)):_("",!0)])]),_:2},1024)]),_:2},1024),r!=null&&r.showPreviewDetail?(v(),N(y,{key:0,align:"left",class:"collumnOnMobile q-px-md q-py-xs"},{default:n(()=>[E("div",la,[i(u,null,{default:n(()=>[i(w,{caption:"",class:"text-tertiary"},{default:n(()=>[p("Emitente")]),_:1}),i(w,{class:"text-tertiary"},{default:n(()=>[p(x(r.xNomeEmitente),1)]),_:2},1024)]),_:2},1024),i(u,{avatar:""},{default:n(()=>[i(C,{name:"event",class:"text-h5 text-tertiary"})]),_:1}),i(u,null,{default:n(()=>[i(w,{caption:"",class:"text-tertiary"},{default:n(()=>[p("Cria\xE7\xE3o RPS")]),_:1}),i(w,{class:"text-tertiary"},{default:n(()=>[p(x(o.$filters.dataHora(r.rps.dataHoraCriacao)),1)]),_:2},1024)]),_:2},1024),i(u,{avatar:""},{default:n(()=>[i(C,{name:"today",class:"text-h5 text-tertiary"})]),_:1}),i(u,null,{default:n(()=>[i(w,{caption:"",class:"text-tertiary"},{default:n(()=>[p("Emiss\xE3o NFS-e")]),_:1}),i(w,{class:"text-tertiary"},{default:n(()=>[p(x(o.$filters.dataHora(r.rps.dataEmissao)),1)]),_:2},1024)]),_:2},1024)])]),_:2},1024)):_("",!0),i(J,{spaced:""})]))),128))]),_:1})):_("",!0)]),_:1},8,["checkboxModel","buscaCampo","onCriar_click","onFiltro_change","onLimparFiltros_click","onAbrirTodosPreview","onExportarXLSX_click","lista","tabs","tabSelecionada","paginacao","filtros"]),i(h,{ref:"modalNfse",onAtualizar:l.atualizar},null,8,["onAtualizar"]),i(f,{ref:"jsonViewer"},null,512),i(G,{modelValue:s.dialogoSincronizarLote.visivel,"onUpdate:modelValue":a[18]||(a[18]=r=>s.dialogoSincronizarLote.visivel=r),"content-css":{minWidth:"50vw"}},{default:n(()=>[i(I,null,{default:n(()=>[i(X,{class:"bg-primary text-white"},{default:n(()=>[i(Q,null,{default:n(()=>[p("Sincronizar Lote")]),_:1}),F(i($,{dense:"",flat:"",icon:"close",round:""},null,512),[[k]])]),_:1}),i(H,null,{default:n(()=>[i(B,{onSubmit:l.sincronizarLote},{default:n(()=>[i(g,{class:"q-col-gutter-md"},{default:n(()=>[E("div",ra,[i(Z,{modelValue:s.dialogoSincronizarLote.empresa,"onUpdate:modelValue":a[15]||(a[15]=r=>s.dialogoSincronizarLote.empresa=r),label:"Empresa",options:s.dialogoSincronizarLote.listaEmpresas,"option-value":"id","option-label":"label","emit-value":"","map-options":""},null,8,["modelValue","options"])]),E("div",na,[i(c,{modelValue:s.dialogoSincronizarLote.periodoInicial,"onUpdate:modelValue":a[16]||(a[16]=r=>s.dialogoSincronizarLote.periodoInicial=r),tipo:"data",dense:"",outlined:""},null,8,["modelValue"])]),ca,E("div",da,[i(c,{modelValue:s.dialogoSincronizarLote.periodoFinal,"onUpdate:modelValue":a[17]||(a[17]=r=>s.dialogoSincronizarLote.periodoFinal=r),tipo:"data",dense:"",outlined:""},null,8,["modelValue"])])]),_:1}),E("div",ua,[F(i($,{color:"tertiary",flat:"",label:"Cancelar"},null,512),[[k]]),i($,{color:"primary",class:"q-ml-sm no-shadow",unelevated:"",label:"Sincronizar",type:"submit"})])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var Na=O(aa,[["render",ma]]);export{Na as default};
