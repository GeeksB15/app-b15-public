import{_ as Va,M as Oa,p as S,o as x,d as U,f as l,w as c,x as F,B as na,E as ca,e as O,t as V,i as k,bc as Wa,l as I,j as J,k as ga,D as H,v as Xa,aF as Aa,C as ya,ai as Ba,F as ua,r as xa,aj as la,ak as K,ah as da,L as _a,am as Ya,s as Sa,aK as ja,z as La,aQ as Ha,y as Ma,n as ao,a as oo,cL as L,cS as to,cT as eo,cU as io,cV as no,K as ro,A as so,G as lo,H as co,I as uo,a$ as mo}from"./index.d6ce7622.js";import{D as fo,C as po}from"./DocumentosFiscais.5bfd38c5.js";import{e as vo}from"./emitirNFe.3ad8673b.js";import{V as ho}from"./VendaCard.3d6509ed.js";const Co={components:{Avatar:Oa},computed:{mostrarMenuTresPontos(){return this.mostrarOpcaoMigrarFatura}},data(){return{titulo:{},tituloOriginal:{},detalhes:!1,contatos:{},documento:{},fatura:{},faturasAbertas:[],mostrarOpcaoMigrarFatura:!1,visibilidade:{botao:{remover:!1,editar:!1}},modalEditar:{visivel:!1,campos:{valorMulta:0},rules:[]},tema:["TituloCard","bg-white","rounded-borders"]}},emits:["executar"],methods:{irParaAtendimentoFatura(t){this.$router.push({name:"AtendimentoFatura",params:{id:t}})},async migrarFatura(t){try{await new Promise((o,s)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar esta venda para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{o()}).onCancel(()=>{s()})})}catch{return}if(!t&&this.titulo.idContato&&this.titulo.idEmpresa){const o=await $erp().contato.get(this.titulo.idContato)||{};let s=await $erp().contatoEndereco.where({idContato:this.titulo.idContato}).toArray(),f=await $erp().contatoTelefone.where({idContato:this.titulo.idContato}).toArray();s=s.find(_=>(_.grupo||"").trim().toLowerCase()==="Principal")||s[0]||{},f=f.find(_=>(_.tipoTelefone||"").trim().toLowerCase()==="Principal")||f[0]||{};const a=await $erp().contato.get(this.titulo.idEmpresa)||{};let v=await $erp().contatoEndereco.where({idContato:this.titulo.idEmpresa}).toArray();v=v.find(_=>_.grupo.trim().toLowerCase()==="Principal")||v[0]||{},t=$db.fatura.criar({idEmpresa:a.id,idEmpresaEndereco:v.id||"",descricaoEmpresa:a.nome||"",numeroDocumentoEmpresa:a.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:a.numeroDocumentoMunicipal||"",optanteSimplesNacional:a.regime==="SimplesNacional"?"1":"0",idContato:o.id,idContatoEndereco:s.id||"",numeroDocumentoContato:o.numeroDocumentoNacional||"",descricaoContato:o.nome||"",descricaoContatoEndereco:"".concat(s.logradouro||"",", ",s.numero||""," ",s.complemento||""," - ",s.bairro||""," - ",s.cep||""," - ",s.municipio||"","/",s.uf||""),telefoneContato:f.telefone||"",emailContato:o.email||"",regimeContato:o.regime||"",observacaoFaturamento:""}),await $db.fatura.grava({fatura:t})}t.id?(await $db.financeiroTitulo.grava({atual:{id:this.titulo.id,idFatura:t.id},original:this.titulo}),localStorage.setItem("idFatura",t.id),this.titulo.idContato&&(this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(this.titulo.idContato))):this.$q.notify("N\xE3o foi poss\xEDvel realizar a opera\xE7\xE3o")},async salvar(){if(this.titulo.valorDesconto===this.tituloOriginal.valorDesconto){this.modalEditar.visivel=!1;return}try{await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.tituloOriginal=$utils.clonar(this.titulo),this.modalEditar.visivel=!1,this.$q.notifyPositive("T\xEDtulo salvo."),this.$emit("executar","recalcular")}catch{this.$q.notifyPositive("N\xE3o foi poss\xEDvel salvar o t\xEDtulo. Por favor, tente novamente.")}},editar(){const t=Number(this.titulo.diasEmAtraso)||0;let o=0;t>0&&(o=Number(this.titulo.valorMulta)||0),this.modalEditar={visivel:!0,campos:{valorMulta:o},rules:[]}},async permissaoEditar(){return await $db.permissao.objeto("Diretiva_Caixa_DescontoTitulo")},cancelarDesconto(){this.titulo=$utils.clonar(this.tituloOriginal),this.modalEditar.visivel=!1},async desconto(){const t=this.titulo.valorDesconto;let o=0,s=0,f=0,a=Number(this.titulo.diasEmAtraso)||0;if(a<0&&(a=0),a>0&&(s=Number(this.titulo.valorMulta)||0,o=Number(this.titulo.valorJuros)||0,f=$utils.arredondar(s+o*a)),t<0||t>f){this.modalEditar.rules=[()=>"Desconto n\xE3o permitido"];return}this.modalEditar.rules=[()=>!0];const v=Number(this.titulo.valor)||0,_=$utils.arredondar(v-t+s+o*a),C=$utils.arredondar(t*100/(v||1));this.titulo.valorTotal=_,this.titulo.valorARealizar=_,this.titulo.percentualDesconto=C},alternarDetalhes(){this.detalhes=!this.detalhes},async remover(){try{await new Promise((t,o)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este t\xEDtulo da fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{t()}).onCancel(()=>{o()})})}catch{return}this.titulo.idFatura="",await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.visibilidade.botao.remover=!1,this.$q.notifyPositive("T\xEDtulo removido da fatura."),this.$emit("executar","remover")}},props:{dados:{required:!0,type:Object}},async mounted(){const t=new Date(this.dados.dataVencimento).setHours(0,0,0,0),o=new Date().setHours(0,0,0,0);t<o?this.tema.push("vencido"):this.tema=$lodash.remove(this.tema,f=>f!=="vencido"),this.tituloOriginal=$utils.clonar(this.dados),this.titulo=$utils.clonar(this.dados),this.titulo.documentoId&&(this.documento=await $db.hibrido.le({table:"documento",id:this.titulo.documentoId})),this.visibilidade.botao.remover=!1,this.permissaoEditar().then(f=>this.visibilidade.botao.editar=f&&!this.tituloOriginal.valorRealizado),this.contatos={};const s={};if(this.titulo.idContato){const f=await $db.contato.le({id:this.titulo.idContato});f&&(s[this.titulo.idContato]=f)}if(this.titulo.idEmpresa){const f=await $db.contato.le({id:this.titulo.idEmpresa});f&&(s[this.titulo.idEmpresa]=f)}this.contatos=s,this.mostrarOpcaoMigrarFatura=!0,this.titulo.idFatura&&$db.fatura.leNew({id:this.titulo.idFatura}).then(f=>{this.fatura=f,f.status==="Aberta"&&$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(a=>{a.data.find(_=>_.id===this.titulo.idEmpresa)&&(this.visibilidade.botao.remover=!0)})})}},go={class:"col-12 col-md-6 q-pl-none"},bo=F("br",null,null,-1),$o={class:"col-4 col-md"},Fo={key:0,class:"q-my-none"},Do={class:"q-my-none"},wo={class:"q-my-none"},Eo={class:"col-4 col-md text-right"},To={class:"col-4 col-md text-right"},Po={class:"col-12 col-md"},qo={class:"text-right text-h5 text-positive text-weight-bold q-my-none"},yo={class:"text-right text-weight-normal text-tertiary text-body2 q-my-none"},xo={class:"col-6"},_o={class:"text-body2"},Mo={class:"col-6 text-right"},Vo={class:"col-12 col-md-6"},Io={class:"text-body2 q-my-none q-mb-md"},zo={class:"col-12 col-sm-4 col-md-2"},No={class:"text-left q-my-none"},ko={class:"col-6 col-md-1"},Ro={class:"text-left q-my-none"},Oo={class:"col-6 col-md-1"},Ao={class:"text-left q-my-none"},Bo={class:"col-12 col-sm-4 col-md-2 text-right"},So=F("p",{class:"text-subtitle1 text-weight-bold q-ma-none"}," Desconto ",-1),jo={class:"q-ma-none"},Lo={class:"q-mt-xs"},Ho=F("small",{class:"block text-caption"},"Multa",-1),Uo={class:"q-mt-xs"},Qo=F("small",{class:"block text-caption"},"Juros",-1),Jo={class:"q-mt-lg text-right q-gutter-md"};function Go(t,o,s,f,a,v){const _=S("avatar"),C=S("row"),T=S("campo");return x(),U("div",{class:ao([a.tema,"extratoItem bg-white q-pa-sm no-shadow"])},[l(C,{class:"items-center q-mx-none q-px-none q-mb-sm text-tertiary"},{default:c(()=>{var w;return[F("div",go,[l(na,{class:"q-pa-none"},{default:c(()=>[l(_,{imagem:(a.contatos[a.titulo.idContato]||{}).imagem,rotulo:(a.contatos[a.titulo.idContato]||{}).apelido,tamanho:"30"},null,8,["imagem","rotulo"]),l(ca,null,{default:c(()=>[O(V((a.contatos[a.titulo.idContato]||{}).apelido)+" ",1),bo]),_:1}),a.titulo.parcela?(x(),k(Wa,{key:0,rounded:"",color:"tertiary",small:""},{default:c(()=>[O(V(a.titulo.parcela),1)]),_:1})):I("",!0)]),_:1})]),F("div",$o,[a.titulo.documentoCodigo?(x(),U("p",Fo,V(a.titulo.documentoTipo)+" #"+V((w=a.documento)==null?void 0:w.numero),1)):I("",!0),F("p",Do,V(a.titulo.formaDePagamento),1),F("p",wo,V(a.titulo.descricaoPlanoConta),1)]),F("div",Eo,[a.titulo.dataVencimentoOriginal?(x(),k(J,{key:0,name:"mdi-calendar-today"})):I("",!0),O(" "+V(t.$filters.data(a.titulo.dataVencimentoOriginal))+" ",1),l(ga,null,{default:c(()=>[O("Vencimento original")]),_:1})]),F("div",To,[a.titulo.dataVencimento?(x(),k(J,{key:0,name:"mdi-calendar-check"})):I("",!0),O(" "+V(t.$filters.data(a.titulo.dataVencimento))+" ",1),l(ga,null,{default:c(()=>[O("Vencimento")]),_:1})]),F("div",Po,[F("p",qo,V(t.$filters.numero(a.titulo.valorTotal,2)),1),F("p",yo,V(t.$filters.numero(a.titulo.valor,2)),1)])]}),_:1}),l(C,{class:"items-center justify-end"},{default:c(()=>[F("div",xo,[F("div",_o,V(a.titulo.descricao),1)]),F("div",Mo,[l(H,{rounded:"",dense:"",flat:"",icon:`keyboard_arrow_${a.detalhes?"up":"down"}`,color:"tertiary",onClick:v.alternarDetalhes},null,8,["icon","onClick"]),a.visibilidade.botao.editar?(x(),k(H,{key:0,rounded:"",dense:"",flat:"",icon:"edit",color:"primary",onClick:v.editar},null,8,["onClick"])):I("",!0),a.visibilidade.botao.remover?(x(),k(H,{key:1,rounded:"",dense:"",flat:"",icon:"clear",color:"tertiary",onClick:v.remover},{default:c(()=>[l(ga,null,{default:c(()=>[O(" Remover da Fatura #"+V(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):I("",!0),Xa(t.$slots,"default"),v.mostrarMenuTresPontos?(x(),k(H,{key:2,rounded:"",dense:"",flat:"",icon:"more_vert",color:"tertiary"},{default:c(()=>[l(Aa,null,{default:c(()=>[ya((x(),k(Ba,{link:"",separator:""},{default:c(()=>[a.mostrarOpcaoMigrarFatura?(x(),U(ua,{key:0},[(x(!0),U(ua,null,xa(a.faturasAbertas,w=>(x(),k(la,{clickable:"",key:w.id,onClick:B=>v.migrarFatura(w)},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"mdi-folder-move"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O(V("Migrar para fatura #"+(w.numero||w.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),l(la,{clickable:"",onClick:o[0]||(o[0]=w=>v.migrarFatura())},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"mdi-folder-move"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O("Migrar para nova fatura")]),_:1})]),_:1})]),_:1})],64)):I("",!0)]),_:1})),[[_a]])]),_:1})]),_:1})):I("",!0)])]),_:3}),a.detalhes?(x(),k(Ya,{key:0,class:"hideondesktop q-my-sm"})):I("",!0),a.detalhes?(x(),k(C,{key:1,class:"items-start q-mx-none q-px-none q-mt-md"},{default:c(()=>[F("div",Vo,[l(na,{class:"u-autoHeight q-pa-none",color:"none",dark:""},{default:c(()=>[l(J,{name:"business"}),l(ca,null,{default:c(()=>[O(V((a.contatos[a.titulo.idEmpresa]||{}).apelido),1)]),_:1})]),_:1}),F("p",Io,V(a.titulo.observacao),1)]),F("div",zo,[F("p",No,V(a.titulo.descricaoCentroCusto),1)]),F("div",ko,[F("p",Ro,[a.titulo.dataEmissao?(x(),k(J,{key:0,name:"mdi-calendar-check"})):I("",!0),O(" "+V(t.$filters.data(a.titulo.dataEmissao))+" ",1),l(ga,null,{default:c(()=>[O("Emiss\xE3o")]),_:1})])]),F("div",Oo,[F("p",Ao,[a.titulo.dataCompetencia?(x(),k(J,{key:0,name:"mdi-calendar-check"})):I("",!0),O(" "+V(t.$filters.data(a.titulo.dataCompetencia))+" ",1),l(ga,null,{default:c(()=>[O("Compet\xEAncia")]),_:1})])]),F("div",Bo,[So,F("p",jo,V(t.$filters.numero(a.titulo.valorDesconto||0,2)),1),a.titulo.diasEmAtraso?(x(),U(ua,{key:0},[F("div",Lo,[Ho,F("strong",null,V(t.$filters.numero(a.titulo.valorMulta||0,2))+" ("+V(t.$filters.numero(a.titulo.percentualMulta||0,2))+"%) ",1)]),F("div",Uo,[Qo,F("strong",null,V(t.$filters.numero(a.titulo.valorTotalJuros||0,2))+" ("+V(t.$filters.numero(a.titulo.percentualJuros||0,2))+"% dia) ",1)])],64)):I("",!0)])]),_:1})):I("",!0),l(Ma,{modelValue:a.modalEditar.visivel,"onUpdate:modelValue":o[7]||(o[7]=w=>a.modalEditar.visivel=w),onKeyup:Ha(v.cancelarDesconto,["esc"]),persistent:""},{default:c(()=>[l(Sa,{style:{"min-width":"30vw"}},{default:c(()=>[l(na,{class:"bg-primary text-white"},{default:c(()=>[l(ca,null,{default:c(()=>[O("Editar T\xEDtulo")]),_:1})]),_:1}),l(ja,null,{default:c(()=>[l(La,{onSubmit:v.salvar,class:"q-pa-lg q-gutter-md"},{default:c(()=>[l(T,{modelValue:a.titulo.valor,"onUpdate:modelValue":o[1]||(o[1]=w=>a.titulo.valor=w),rotulo:"Valor",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),l(T,{modelValue:a.titulo.diasEmAtraso,"onUpdate:modelValue":o[2]||(o[2]=w=>a.titulo.diasEmAtraso=w),rotulo:"Dias em Atraso",tipo:"decimal",decimals:"0",zerosDireita:"0",zeros:"","somente-leitura":"",outlined:""},null,8,["modelValue"]),l(T,{modelValue:a.modalEditar.campos.valorMulta,"onUpdate:modelValue":o[3]||(o[3]=w=>a.modalEditar.campos.valorMulta=w),ajuda:`Multa de R$ ${t.$filters.numero(a.titulo.valorMulta,2)}`,rotulo:"Multa",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),l(T,{modelValue:a.titulo.valorTotalJuros,"onUpdate:modelValue":o[4]||(o[4]=w=>a.titulo.valorTotalJuros=w),ajuda:`Juros ao ${a.titulo.tipoJuros} de R$ ${t.$filters.numero(a.titulo.valorJuros,2)}`,rotulo:"Juros",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),l(T,{modelValue:a.titulo.valorDesconto,"onUpdate:modelValue":[o[5]||(o[5]=w=>a.titulo.valorDesconto=w),v.desconto],rotulo:"Desconto",tipo:"decimal",decimals:"2",rules:a.modalEditar.rules,outlined:""},null,8,["modelValue","onUpdate:modelValue","rules"]),l(T,{modelValue:a.titulo.valorTotal,"onUpdate:modelValue":o[6]||(o[6]=w=>a.titulo.valorTotal=w),rotulo:"Total",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),F("div",Jo,[l(H,{color:"tertiary",flat:"",unelevated:"",label:"Cancelar",onClick:v.cancelarDesconto},null,8,["onClick"]),l(H,{color:"primary",unelevated:"",label:"Salvar",type:"submit"})])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])],2)}var Ko=Va(Co,[["render",Go]]),Zo={async enviar(t,o){var s,f;try{const a=o.nome.replace("enviaemail.fatura.",""),v=(s=o.valor)!=null?s:"Impresso",_=(f=o.texto)!=null?f:`Voc\xEA est\xE1 recebendo o ${v} da empresa ${t.descricaoEmpresa}.`,C=await $db.contato.le({id:t.idContato}),T=await $utils.impressaoObterHtml(a,t),w={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:String(C==null?void 0:C.email).trim().toLowerCase(),assunto:`${v}`,mensagem:`${_}`},B=`${v} enviado para ${w.para}, com sucesso!.`,D=`Erro ao enviar e-mail. ${v} n\xE3o enviado.`;$q.loading.show({message:`Enviando ${v} por e-mail...`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const M=[{name:`${v}.pdf`,content:T,method:"html2pdf"}],i={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:w.de,to:w.para,subject:w.assunto,text:w.mensagem,attachments:M},z=await oo({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:i});$q.notifyPositive((z==null?void 0:z.status)===200&&B?B:z.data.message)}catch(a){$q.notifyError(errorMsg||"Erro ao enviar e-mail",a)}finally{$q.loading.hide()}}},Wo={async finalizar(t,o){var v,_,C,T,w,B,D,M;const s=(v=o==null?void 0:o.tef)!=null?v:!1,{cpfCnpjNoCupom:f,valorDinheiro:a}=o!=null?o:{};try{if($utils.verificarErro(this.erroCalculo,"Erro de c\xE1lculo encontrado."),!t&&!s)try{await new Promise((e,n)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar esta fatura",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{e()}).onCancel(()=>{n()})})}catch{return!1}this.$q.loading.show({message:"Processando..."});const i=$utils.clonar(this.fatura),z=$utils.clonar(this.vendas),y=$utils.clonar(this.carnes);if(y.length>0){const e=y.reduce((n,m)=>(m.idFinanceiroBoleto&&m.codigoFinanceiroTitulo&&(n+=String(m.codigoFinanceiroTitulo)+";"),n),"");if(e)try{$q.loading.show({message:"Baixando boletos..."});const n=`exec sp_Financeiro_BoletoBaixar '${e.slice(0,-1)}'`,m=await $utils.executarSql(n)}catch(n){$q.notifyError("N\xE3o foi poss\xEDvel baixar boletos",n);return}finally{$q.loading.hide()}}const u=t?i.dataHoraFinalizado:$utils.dataAtual(),g=u,r=await $db.hibrido.le({table:"documento",id:this.$refs.faturamento.idDocumentoCaixa});if(this.documentoStatus=[],s){let e,n;if(e=await $erp().caixa.where({idEmpresa:i.idEmpresa}).toArray(),n=e.some(m=>m.ativo),n&&!(r!=null&&r.id)){$q.notify({message:"Opera\xE7\xE3o negada. \xC9 necess\xE1rio abertura de caixa.",type:"negative"});return}if(await this.$refs.faturamento.checarCaixa(),this.fatura.totalDocumento-a<0){$q.notify({message:"Opera\xE7\xE3o negada. Valor em dinheiro acima do total do documento.",type:"negative"});return}if(a<0){$q.notify({message:"Opera\xE7\xE3o negada. Valor em dinheiro n\xE3o permitido.",type:"negative"});return}if(e=await L.oper("crt",{idTransacao:`1${this.fatura.id}`,idLoja:(_=this.fatura.numeroDocumentoEmpresa)==null?void 0:_.replace(/\D/g,""),idAutomacao:$utils.sistemaPai()==="b15"?"07660198000189":"09492015000199",valorTransacao:$utils.arredondar(this.fatura.totalDocumento-a,2).toLocaleString("pt-BR",{minimumFractionDigits:2}),nroDocFiscal:(C=this.fatura.numero)!=null?C:this.fatura.id.replace(/\D/g,"").slice(-6)}),!(e!=null&&e.fileContent))return;if(e!=null&&e.fileContent){let m,h,P,p,E=!1;if(m=L.extrairCampo("mensagemOperador",e.fileContent),h=L.extrairComprovante(e.fileContent),P=L.extrairCampo("codigoAutorizacao",e.fileContent),p=L.extrairCampo("nsu",e.fileContent),E=h&&P&&p,m&&$q.notify({message:m,type:E?"positive":"negative"}),!E)return;E&&await this.$refs.faturamento.tef({fatura:i,tefRetorno:e.fileContent,valorDinheiro:a})}}await this.$refs.faturamento.validar();let d=$lodash.orderBy(this.$refs.faturamento.condicaoPagamento.filter(e=>e.valor),["idFormaPagamento","autorizacao","dataVencimento"]);$utils.verificarErro(z.find(e=>!e.dataHoraFinalizado),"Existe pedido de venda sem data de finaliza\xE7\xE3o.");const N=$utils.arredondar(this.carnes.reduce((e,n)=>e+(n.valorARealizar||0),0)),A=$utils.arredondar(d.reduce((e,n)=>e+(n.valor||0),0));let ra=0;if(t&&(d=d.filter(e=>!this.$refs.faturamento.condicaoPagamentoOriginal.find(n=>n.id===e.id))),i.totalDocumento>=0){if(this.carnes.length){if(A<N)return this.$q.notify("Valor pago menor que a soma dos t\xEDtulos \xE0 faturar!"),!1;if(!await $db.permissao.objeto("Diretiva_Caixa_PagarCarneCartao")){const n=d.reduce((m,h)=>{const P=`${h.autorizacao||""}${h.documento||""}${h.idFormaPagamento}`;return m[P]||(m[P]={parcelas:0,formaPagamento:h.formaPagamento}),m[P].parcelas++,m},{});for(const m in n)if(n[m].parcelas>this.carnes.length)return this.$q.notify(`Quantidade de parcelas da forma de pagamento ${n[m].formaPagamento} acima do permitido.`),!1}}A<i.totalDocumento&&(ra=1)}let Z=ra===1?"Aguardando Pagamento":"Finalizada";if(!t){this.documentoStatus.push({id:$utils.uuid(),idDocumento:i.id,operacao:"Fatura",statusOriginal:i.status,statusFinalizado:Z,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:r.id||""}),i.status=Z,i.dataHoraFinalizado=u;let e=0;for(const E of z)e=(await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:E.id}})).reduce((q,$)=>($.total>0&&(q+=$.total),q),e);e=$utils.arredondar(e),Z="Faturado";const n=parseInt(await $db.configuracoes.leValorComFiltroEmpresa("vendas.usaExpedicao",i.idEmpresa,0))||0;let m=0,h=0,P=!1,p=!0;n&&(this.$q.loading.hide(),await new Promise((E,b)=>{this.$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},message:"Gostaria de dar baixa na(s) venda(s), removendo-a(s) do processo de expedi\xE7\xE3o?",noRefocus:!0,preventClose:!0,persistent:!0,title:"Confirma?"}).onOk(()=>{p=!0,E()}).onCancel(()=>{p=!1,E()})}),this.$q.loading.show({message:"Processando..."}));for(const E of z)h+=(await $db.hibrido.lista({table:"documento",where:{tipo:"Envelope",documentoId:E.id,documentoTipo:"Venda"}})||[]).filter(q=>q.status!=="Entregue").length;if(h){let E="Nesta Fatura h\xE1 1 envelope aguardando entrega, deseja mudar o status deste para Entregue?";h>1&&(E=`Nesta Fatura h\xE1 ${h} envelopes aguardando entrega, deseja mudar o status destes para Entregue?`),this.$q.loading.hide();try{await new Promise((b,q)=>{this.$q.dialog({cancel:"N\xE3o",message:E,noRefocus:!0,ok:"Sim",preventClose:!0,title:"Confirma?"}).onOk(()=>{P=!0,b()}).onCancel(()=>{q()})})}catch{}this.$q.loading.show({message:"Processando..."})}for(const E of z){Z=p?"Faturado":E.status,p&&this.documentoStatus.push({id:$utils.uuid(),idDocumento:E.id,operacao:"Venda de Mercadoria",statusOriginal:E.status,statusFinalizado:Z,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:r.id||""}),E.status=Z;const b=await $db.hibrido.lista({table:"documento",where:{tipo:"Envelope",documentoId:E.id,documentoTipo:"Venda"}});if(this.envelopesOriginal=this.envelopesOriginal.concat($utils.clonar(b)),P)for(const $ of b.filter(j=>j.status!=="Entregue"))this.documentoStatus.push({id:$utils.uuid(),idDocumento:$.id,operacao:"Envelope",statusOriginal:$.status,statusFinalizado:"Entregue",dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),$.status="Entregue",$.dataHoraFinalizado=$utils.dataAtual();this.envelopes=this.envelopes.concat(b);const q=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:E.id}});this.documentoItensOriginal=this.documentoItensOriginal.concat($utils.clonar(q));for(const $ of q)if($.status=Z,$.total>0){$.quantidade=$.quantidade||1,$.valorItem=$.valorItem||0,$.descontoItem=$.descontoItem||0,$.descontoTotalRateado=$.descontoTotalRateado||0;let j=($.valorItem-$.descontoItem)*$.quantidade-$.descontoTotalRateado;const X=$utils.arredondar((i.totalDesconto||0)*j/(e||1)||0);$.descontoFaturaRateado=$utils.arredondar(X),$.valorRealTotal=$utils.arredondar(j-X),$.valorReal=$utils.arredondar($.valorRealTotal/$.quantidade),m+=X}this.documentoItens=this.documentoItens.concat(q)}if(i.totalDesconto!==$utils.arredondar(m)){const E=$utils.arredondar((i.totalDesconto||0)-(m||0));let b,q=0;for(const $ of this.documentoItens)$.total>q&&(q=$.total,b=$);if(b){const $=(b.descontoFaturaRateado||0)+(E||0),j=((b.valorItem||0)-(b.descontoItem||0))*(b.quantidade||1)-(b.descontoTotalRateado||0)-($||0),X=(j||0)/(b.quantidade||1);b.descontoFaturaRateado=$utils.arredondar($),b.valorReal=$utils.arredondar(X),b.valorRealTotal=$utils.arredondar(j)}}}const wa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.renegociacao"}))[0].valor),ea=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:wa}),ma=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatareceber"}))[0].valor);let Y=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ma});const ba=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatapagar"}))[0].valor),aa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ba}),fa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cheque"}))[0].valor),pa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:fa}),Ea=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.faturamentogeral"}))[0].valor),Q=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ea}),Ua=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0].valor),Ia=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ua}),Qa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.frete"}))[0].valor),za=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Qa}),Ja=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cmv"}))[0].valor),$a=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ja}),Ga=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.creditoclientes"}))[0].valor),Ka=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ga}),Za=await $db.formaPagamento.le(),Ta=(T=this.contatos[i.idContato])==null?void 0:T.descontoCondicionadoPercentual;let va=$utils.arredondar(z.reduce((e,n)=>e+n.totalDocumento,0));va=$utils.arredondar(va-i.totalDesconto);let ia=i.totalDocumento,W=[];const R=[],Na=[],Fa=[],ka=[];let ha=1,Pa="",Da=1,oa="";for(const e of d.filter(n=>!n.sinal)){e.sinal=e.sinal||ra;const n=Za.filter(m=>m.id===e.idFormaPagamento)[0];if(ia<0)oa=$utils.uuid(),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Q.id,dataEmissao:u,valorCredito:0,valorDebito:$utils.arredondar(ia*-1),descricao:Q.descricao,observacao:`Movimenta\xE7\xE3o de d\xE9bito da devolu\xE7\xE3o de clientes no(s) pedido(s) da fatura c\xF3digo (${i.id})`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Ka.id,dataEmissao:u,valorCredito:$utils.arredondar(ia*-1),valorDebito:0,descricao:`Cr\xE9dito proveniente de produtos devolvidos no(s) pedido(s) da fatura c\xF3digo (${i.id})`,observacao:"Movimenta\xE7\xE3o de cr\xE9dito na conta de clientes",automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id});else{if(Pa!==e.idFormaPagamento+e.autorizacao&&(Pa=e.idFormaPagamento+e.autorizacao,ha=1,Da=d.reduce((m,h)=>h.idFormaPagamento+h.autorizacao===Pa?m+1:m,0)),n.tipoFinanceiro==="T\xEDtulo Liquidado"&&(oa=$utils.uuid()),N>0){const m=$utils.uuid(),h=$utils.arredondar(e.valor*(N/ia));let P=0,p=0,E=0,b=0;if(n.tipo===5){let q=(await $erp().financeiroBanco.toArray()).find($=>$.codigoBanco===122);q&&(p=q.percentualMulta||0,b=q.percentualJuros||0,P=$utils.arredondar(p/100*h),E=$utils.arredondar(b/100*h))}W.push({id:m,idFinanceiroPlanoConta:ea.id,idContato:i.idContato,dataEmissao:u,dataCompetencia:g,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:h,valorTotal:h,valorARealizar:h,valorMulta:P,percentualMulta:p,valorJuros:E,percentualJuros:b,documentoId:i.id,documentoTipo:"Fatura",parcela:ha+"/"+Da,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${e.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:n.descricao,carne:n.tipo===5?1:0,dataEmissaoCarne:n.tipo===5?u:"",idDocumentoCaixa:r.id,idFinanceiroMovimentacaoAgrupamento:n.tipoFinanceiro==="T\xEDtulo Liquidado"?oa:""}),e.idFinanceiroTitulo=m,n.tipo===2&&Fa.push({idTitulo:m,idDocumentoCondicaoPagamento:e.id,valor:h,dataVencimento:e.dataVencimento,idBanco:e.idBanco,agencia:e.agencia,conta:e.conta,numeroCheque:e.numeroCheque,formaPagamento:n}),ka.push({idTitulo:m,valor:h,desconto:0})}if(va>0){const m=$utils.uuid(),h=$utils.arredondar(e.valor*(va/ia));let P=0,p=0,E=0,b=0;if(n.tipo===5){let q=(await $erp().financeiroBanco.toArray()).find($=>$.codigoBanco===122);q&&(p=q.percentualMulta||0,b=q.percentualJuros||0,P=$utils.arredondar(p/100*h),E=$utils.arredondar(b/100*h))}W.push({id:m,idFinanceiroPlanoConta:Q.id,idContato:i.idContato,dataEmissao:u,dataCompetencia:g,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:h,valorTotal:h,valorARealizar:h,valorMulta:P,percentualMulta:p,valorJuros:E,percentualJuros:b,documentoId:i.id,documentoTipo:"Fatura",parcela:ha+"/"+Da,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${e.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:n.descricao,carne:n.tipo===5?1:0,dataEmissaoCarne:n.tipo===5?u:"",idDocumentoCaixa:r.id,idFinanceiroMovimentacaoAgrupamento:n.tipoFinanceiro==="T\xEDtulo Liquidado"?oa:"",descontoCondicionadoValor:Ta>0?Ta/100*h:0,descontoCondicionadoPercentual:Ta}),e.idFinanceiroTitulo=m,n.tipo===2&&Fa.push({idTitulo:m,idDocumentoCondicaoPagamento:e.id,valor:h,dataVencimento:e.dataVencimento,idBanco:e.idBanco,agencia:e.agencia,conta:e.conta,numeroCheque:e.numeroCheque,formaPagamento:n})}if(n.tipoFinanceiro==="T\xEDtulo Liquidado"&&va>=0){R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:Y.id,idFinanceiroTitulo:e.idFinanceiroTitulo,dataEmissao:u,valorCredito:e.valor,valorDebito:0,descricao:Y.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id});let m=n.idFinanceiroPlanoConta;n.tipo===1&&(r||{}).idFinanceiroPlanoContaCaixa&&(m=r.idFinanceiroPlanoContaCaixa);let h=await $db.financeiroPlanoConta.le({id:m});R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:h.id,idFinanceiroTitulo:e.idFinanceiroTitulo,dataEmissao:u,valorCredito:0,valorDebito:e.valor,descricao:h.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id});for(const P of W)P.idFinanceiroMovimentacaoAgrupamento===oa&&(P.valorRealizado=P.valorARealizar,P.dataPagamento=e.dataVencimento,P.dataMovimento=e.dataVencimento,P.idDocumentoCaixaLiquidacao=r.id)}if(n.aliquota){const m=$utils.uuid(),h=$utils.arredondar(e.valor*(n.aliquota/100));if(W.push({id:m,idFinanceiroPlanoConta:n.idFinanceiroPlanoContaAliquota,idContato:n.idContatoOperadoraCartao,dataEmissao:u,dataCompetencia:g,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:h,valorTotal:h,valorARealizar:h,valorMulta:0,percentualJuros:0,documentoId:i.id,documentoTipo:"Fatura",parcela:ha+"/"+Da,descricao:`T\xEDtulo referente a al\xEDquota da forma de pagamento: ${n.descricao}`,observacao:`T\xEDtulo referente a al\xEDquota. ${this.$refs.faturamento.observacaoFaturamento||""} ${e.observacao||""}`.trim(),documentoVinculado:1,receberPagar:0,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:n.descricao,idDocumentoCaixa:r.id}),e.idFinanceiroTituloPagar=m,n.tipoFinanceiro==="T\xEDtulo Liquidado"){const P=$utils.uuid();R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:P,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:u,valorCredito:0,valorDebito:h,descricao:aa.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:m,idContato:n.idContatoOperadoraCartao,idDocumentoCaixa:r.id});let p=n.idFinanceiroPlanoConta;n.tipo===1&&(r||{}).idFinanceiroPlanoContaCaixa&&(p=r.idFinanceiroPlanoContaCaixa);let E=await $db.financeiroPlanoConta.le({id:p});R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:P,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:E.id,dataEmissao:u,valorCredito:h,valorDebito:0,descricao:E.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:m,idContato:n.idContatoOperadoraCartao,idDocumentoCaixa:r.id});for(const b of W)b.id===m&&(b.idFinanceiroMovimentacaoAgrupamento=P,b.valorRealizado=h,b.dataPagamento=e.dataVencimento,b.dataMovimento=e.dataVencimento,b.idDocumentoCaixaLiquidacao=r.id)}}ha++}}const Ra=[];for(const e of Fa){const n=$utils.uuid(),m=$utils.uuid();for(const P of W)P.id===e.idTitulo&&(P.idFinanceiroMovimentacaoAgrupamento=m,P.valorRealizado=P.valorARealizar,P.dataPagamento=u,P.dataMovimento=u,P.dataVencimento=u,P.dataVencimentoOriginal=u,P.idDocumentoCaixaLiquidacao=r.id);if(Ra.includes(e.idDocumentoCondicaoPagamento))continue;Ra.push(e.idDocumentoCondicaoPagamento);const h=$utils.arredondar(Fa.reduce((P,p)=>p.idDocumentoCondicaoPagamento===e.idDocumentoCondicaoPagamento?P+(p.valor||0):P,0));W.push({id:n,idFinanceiroPlanoConta:pa.id,idContato:i.idContato,dataEmissao:u,dataCompetencia:g,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:h,valorTotal:h,valorARealizar:h,valorMulta:0,percentualJuros:0,receberPagar:1,valorDesconto:0,percentualDesconto:0,documentoId:i.id,documentoTipo:"Fatura",idEmpresa:i.idEmpresa,formaDePagamento:e.formaPagamento.descricao,idDocumentoCaixa:r.id,cheque:1,idBanco:e.idBanco,agencia:e.agencia,conta:e.conta,numeroCheque:e.numeroCheque,observacao:`Liquida\xE7\xE3o de Cheques da Fatura #${i.id} - C\xF3digoN #${m}`,descricao:"Cheque"}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:m,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:pa.id,idFinanceiroTitulo:n,dataEmissao:u,valorCredito:0,valorDebito:h,descricao:"Cheque - Cr\xE9dito de t\xEDtulos a receber",observacao:"Cr\xE9dito de t\xEDtulos a receber",automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,idFinanceiroCheque:n,idDocumentoCaixa:r.id,documentoId:i.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:m,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:Y.id,idFinanceiroTitulo:n,dataEmissao:u,valorCredito:h,valorDebito:0,descricao:Y.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,idFinanceiroCheque:n,idDocumentoCaixa:r.id,documentoId:i.id})}if(N>0){const e=$utils.uuid();R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:Y.id,dataEmissao:u,valorCredito:N,valorDebito:0,descricao:Y.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:1,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:ea.id,dataEmissao:u,valorCredito:0,valorDebito:N,descricao:ea.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica - Complemento",automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,documentoTipo:"Renegocia\xE7\xE3o",documentoId:e,idDocumentoCaixa:r.id});for(const n of ka)Na.push({idFinanceiroMovimentacaoN:e,idFinanceiroTitulo:n.idTitulo,dataVencimento:u,valorOriginal:n.valor,valorDesconto:n.desconto,valorTotal:$utils.arredondar(n.valor-n.desconto)});for(const n of y){if(n.idFinanceiroMovimentacaoAgrupamento=e,n.idDocumentoCaixaLiquidacao=r.id,n.dataPagamento=u,n.dataMovimento=u,n.renegociado=1,n.cheque===1){n.valorRealizado=n.valor;continue}if(!n.valorARealizar){n.valorRealizado=n.valorTotal;continue}n.valorRealizado=n.valorARealizar}W=W.concat(y)}if(ra===0){let e=$utils.uuid();const n=i.valorFrete||0;let m=0,h=0;const P=[];if(n>0&&(R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Q.id,dataEmissao:u,valorCredito:0,valorDebito:n,descricao:Q.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:za.id,dataEmissao:u,valorCredito:n,valorDebito:0,descricao:za.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id})),!t){e=$utils.uuid();for(const p of this.documentoItens){let E="",b={},q="",$={},j="",X={};const sa=await $db.item.leNew({id:p.idItem});if(E=p.idPlanoContaEstoque,!E){const G=await $db.perfilContabilItem.le({idPerfilContabil:sa.idPerfilContabil,idCfop:p.idCfop,and:{idPerfilContabil:sa.idPerfilContabil,idCfop:p.idCfop}});G.length&&G[0].idPlanoContaEstoque&&(E=G[0].idPlanoContaEstoque)}if(!E&&Ia.id&&(E=Ia.id),!E&&p.idCfop&&(E=(await $db.cfop.le({id:p.idCfop})).idPlanoContaEstoque),b=await $db.financeiroPlanoConta.le({id:E}),!b.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Estoque.");return}if(q="",!q){const G=await $db.perfilContabilItem.le({idPerfilContabil:sa.idPerfilContabil,idCfop:p.idCfop,and:{idPerfilContabil:sa.idPerfilContabil,idCfop:p.idCfop}});G.length&&G[0].idPlanoContaDespesa&&(q=G[0].idPlanoContaDespesa)}if(!q&&$a.id&&(q=$a.id),!q&&p.idCfop&&(q=(await $db.cfop.le({id:p.idCfop})).idPlanoContaDestino),$=await $db.financeiroPlanoConta.le({id:q}),!$.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Despesa.");return}const qa=$utils.arredondar(p.total-(p.descontoTotalRateado||0)-(p.descontoFaturaRateado||0)),Ca=$utils.arredondar(p.valorCustoMedio*p.quantidade);if(Ca){if(p.operacaoFator<0?(R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:b.id,dataEmissao:p.dataHoraFinalizado||u,valorCredito:Ca,valorDebito:0,descricao:b.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${p.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:$.id,dataEmissao:p.dataHoraFinalizado||u,valorCredito:0,valorDebito:Ca,descricao:$.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${p.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:r.id})):(R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:b.id,dataEmissao:p.dataHoraFinalizado||u,valorCredito:0,valorDebito:Ca,descricao:b.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${p.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:$.id,dataEmissao:p.dataHoraFinalizado||u,valorCredito:Ca,valorDebito:0,descricao:$.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${p.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:r.id})),j=p.idPlanoContaDestino,!j){const ta=await $db.perfilContabilItem.le({idPerfilContabil:sa.idPerfilContabil,idCfop:p.idCfop,and:{idPerfilContabil:sa.idPerfilContabil,idCfop:p.idCfop}});ta.length&&ta[0].idPlanoContaDespesa&&(j=ta[0].idPlanoContaDespesa)}if(!j&&$a.id&&(j=$a.id),!j&&p.idCfop&&(j=(await $db.cfop.le({id:p.idCfop})).idPlanoContaDestino),X=await $db.financeiroPlanoConta.le({id:j}),!X.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Receita.");return}let G=!0;for(const ta of P)if(ta.idPlanoContaDestino===X.id&&ta.idPlanoContaEstoque===b.id){ta.valor=$utils.arredondar(ta.valor+qa),G=!1;break}G&&P.push({idPlanoContaDestino:X.id,idPlanoContaEstoque:b.id,valor:qa}),m+=qa}}for(const p of P)p.valor<0&&(h+=p.valor);for(const p of P)if(p.valor>0){const E=await $db.financeiroPlanoConta.le({id:p.idPlanoContaDestino}),b=$utils.arredondar(h*(p.valor/(m||1)));if(b>0){R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Q.id,dataEmissao:u,valorCredito:0,valorDebito:b,descricao:Q.descricao,observacao:`Lan\xE7amento entrada faturamento geral da devolu\xE7\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:E.id,dataEmissao:u,valorCredito:b,valorDebito:0,descricao:E.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de destino referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id});for(const q of d)R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Q.id,dataEmissao:u,valorCredito:0,valorDebito:$utils.arredondar((p.valor-b)*(q.valor/(ia||1))),descricao:Q.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:E.id,dataEmissao:u,valorCredito:$utils.arredondar((p.valor-b)*(q.valor/(ia||1))),valorDebito:0,descricao:E.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id})}else for(const q of d){const $=$utils.arredondar(p.valor*(q.valor/(ia||1)));R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Q.id,dataEmissao:u,valorCredito:0,valorDebito:$,descricao:Q.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:E.id,dataEmissao:u,valorCredito:$,valorDebito:0,descricao:E.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:g,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id})}}}}if(this.financeiroTitulo=W,this.financeiroMovimentacao=R,this.financeiroRenegociacao=Na,this.fatura=i,this.vendas=z,this.carnes=y,!t){await this.salvarFatura(),$utils.emitter.emit("desativarBotoesFaturaModal");try{let n,m,h,P;if(n=await $db.configuracoes.porNome("integracao.bten.business"),m=(B=(w=n[0])==null?void 0:w.valor)!=null?B:!1,n=await $db.configuracoes.porNome("integracao.bten.authorization"),h=(M=(D=n[0])==null?void 0:D.valor)!=null?M:!1,P=m&&h,P){const p=[],E=this.contatos[i.idContato],b=await $api.bten.send(E,i);for(let q=0;q<b.length;q++){const $=b[q];$.status?p.push($.telefone):this.$q.notifyError(`Falha ao enviar NPS para ${$.telefone}!`)}p.length&&this.$q.notifyPositive(`NPS enviado para ${p.join(",")}!`)}}catch(n){n.name==="GeeksException"&&this.$q.notifyAlert(`N\xE3o foi poss\xEDvel enviar NPS: ${n.message}`),n.name!=="GeeksException"&&this.$q.notifyError("N\xE3o foi possivel enviar NPS para o contato.",n)}let e;if(r!=null&&r.idCaixa){const n=await $erp().caixa.get(r==null?void 0:r.idCaixa);n!=null&&n.id&&(e=$db.caixa.tiposCaixa[Number(n.tipo)])}if(this.vendas.length&&~["SAT","NFCe"].indexOf(e))try{const n=s;await this.$refs.documentosFiscais.emitirCupom(this.fatura.id,n)}catch(n){console.error(n)}finally{if(s){const n=[];for(const m of this.$refs.faturamento.condicaoPagamento)!m.tefRetorno||n.some(h=>h.tefRetorno===m.tefRetorno)||n.push(m);for(const m of n){let h;!m.tefRetorno||(h=L.extrairComprovante(m.tefRetorno),h&&await L.oper("print",{content:h,opts:{txt:!0}}))}}}if(this.$q.notifyPositive("Fatura finalizada"),this.fatura.status==="Finalizada"){const n=await $db.configuracoes.le({prefixoNome:"enviaemail.fatura"});let m=n.find(h=>h.idEmpresa===this.fatura.idEmpresa);console.log("filtroEnviaEmail 1: ",m),m||(m=n.find(h=>!h.idEmpresa),console.log("filtroEnviaEmail 2: ",m)),m&&(console.log("enviando..."),await Zo.enviar(this.fatura,m))}}return!0}catch(i){this.$q.notifyError("N\xE3o foi poss\xEDvel finalizar a fatura",i)}finally{this.$q.loading.hide()}}};const Xo={components:{Avatar:Oa,DocumentoCodigo:to,DocumentoMetas:eo,DocumentosFiscais:fo,Faturamento:io,TituloCard:Ko,VendaCard:ho},computed:{config(){return $db.configuracoes.valores},descontoSomenteLeitura(){let t=!1;return t=this.fatura.status==="Aberta",t||(t=this.fatura.status==="Aguardando Pagamento"&&this.permissaoDescontoFaturaSinal),!t}},data(){return{contatos:{},faturaOriginal:{},fatura:{totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0},vendas:[],vendasOriginal:[],envelopes:[],envelopesOriginal:[],documentoItens:[],documentoItensOriginal:[],carnes:[],carnesOriginal:[],documentoStatus:[],erroCalculo:!1,erroCalculoMsg:"",sistemaPai:"",configImpressaoCarne:[],configImpressaoConvenio:[],configImpressaoFatura:[],configImpressaoEnvelope:[],permissaoDesconto:!1,permissaoDescontoFaturaSinal:!1,pesoTotal:null,pesoBrutoTotal:null,metroCubicoTotal:null}},emits:["executar"],mixins:[vo],methods:{async calcularPesoTotal(){var v,_;const t=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),o=[],s={};let f=0,a=0;for(const C of t){const T=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:C.id}});for(const w of T)o.push(w)}for(const C of o)if(C.operacaoFator===-1){if(C.idItem&&!s[C.idItem]){const T=await $erp().item.get(C.idItem);T&&(s[C.idItem]=T)}f+=(((v=s[C.idItem])==null?void 0:v.peso)||0)*(C.quantidade||0),a+=(((_=s[C.idItem])==null?void 0:_.pesoBruto)||0)*(C.quantidade||0)}f=$utils.arredondar(f,4),a=$utils.arredondar(a,4),this.pesoTotal=f?$filters.numeroZerosDireita(f,4,2):null,this.pesoBrutoTotal=a?$filters.numeroZerosDireita(a,4,2):null},async calcularMetroCubicoTotal(){var a,v,_;const t=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),o=[],s={};let f=0;for(const C of t){const T=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:C.id}});for(const w of T)o.push(w)}for(const C of o){if(C.operacaoFator!==-1||C.tipoItem!=="Produto")continue;if(C.idItem&&!s[C.idItem]){const B=await $erp().item.get(C.idItem);B&&(s[C.idItem]=B)}const T=((a=s[C.idItem])==null?void 0:a.altura)*((v=s[C.idItem])==null?void 0:v.largura)*((_=s[C.idItem])==null?void 0:_.comprimento)||0,w=C.quantidade||0;f+=T>0?T*w:0}f=$utils.arredondar(f,4),this.metroCubicoTotal=f?$filters.numeroZerosDireita(f,4,2):null},atualizarDocumentoMetas(){!this.$refs.documentoMetas||(this.$refs.documentoMetas.documento=$utils.clonarV2(this.fatura))},...Wo,async atualizar(){let t=!1;if(this.permissaoDesconto=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura"),this.permissaoDescontoFaturaSinal=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura_Sinal"),this.vendas=[],this.envelopes=[],this.envelopesOriginal=[],this.documentoItens=[],this.documentoitensOriginal=[],this.carnes=[],this.carnesOriginal=[],this.documentoStatus=[],this.contatos={},this.erroCalculo=!1,this.erroCalculoMsg="",this.prop.id){const o=await $db.fatura.leCompleto(this.prop.id);this.faturaOriginal=$utils.clonar(o.fatura),this.fatura=o.fatura,this.$refs.faturamento&&(this.$refs.faturamento.condicaoPagamentoOriginal=$utils.clonar(o.condicaoPagamento),this.$refs.faturamento.condicaoPagamento=o.condicaoPagamento),this.vendasOriginal=$utils.clonar(o.vendas),this.vendas=o.vendas.sort((f,a)=>new Date(f.dataHoraFinalizado)<new Date(a.dataHoraFinalizado)?-1:1),this.receberTitulo.id&&!o.carnes.find(f=>f.id===this.receberTitulo.id)&&(o.carnes.push(await $db.financeiroTitulo.le({id:this.receberTitulo.id})),t=!0),this.carnesOriginal=$utils.clonar(o.carnes),this.carnes=o.carnes.sort((f,a)=>new Date(f.dataVencimento)<new Date(a.dataVencimento)?-1:1);const s={};if(o.fatura.idContato){const f=o.fatura.idContato;s[f]||(s[f]=await $db.contato.le({id:f}))}this.configuraImpressaoCarne(o.fatura.idEmpresa),this.configuraImpressaoConvenio(o.fatura.idEmpresa),this.configuraImpressaoEnvelope(o.fatura.idEmpresa),this.configuraImpressaoFatura(o.fatura.idEmpresa),this.contatos=s,await this.atualizarDocumentoMetas(),await this.calculaTotais(),await this.calcularPesoTotal(),await this.calcularMetroCubicoTotal(),t&&await this.salvarFatura()}},async executar(t){if(t==="recalcular"){if(this.prop.id){const o=await $db.fatura.leCompleto(this.prop.id);this.carnesOriginal=$utils.clonar(o.carnes),this.carnes=o.carnes,await this.calculaTotais()}}else await this.atualizar(),this.$emit("executar",t)},async calculaTotais(t){const o=$utils.arredondar(this.vendas.reduce((f,a)=>f+a.totalDocumento||0,0)),s=$utils.arredondar(this.carnes.reduce((f,a)=>f+a.valorARealizar||0,0));t||(this.fatura.subTotal=$utils.arredondar(o+s),t="desconto"),t==="descontoPercentual"&&(this.fatura.totalDesconto=$utils.arredondar((this.fatura.totalPercentualDesconto||0)/100*this.fatura.subTotal)),t==="desconto"&&(this.fatura.totalPercentualDesconto=$utils.arredondar((this.fatura.totalDesconto||0)/this.fatura.subTotal*100)),this.fatura.totalDocumento=$utils.arredondar(this.fatura.subTotal-(this.fatura.totalDesconto||0)),this.erroCalculo=!1,this.erroCalculoMsg="",this.fatura.totalDesconto!==0&&(o===0&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto n\xE3o permitido para fatura sem venda"),o>0&&this.fatura.totalDesconto>o&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto maior que o total das vendas")),this.fatura.totalDesconto!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculo=!0);try{await this.$refs.faturamento.resumeCondicaoPagamento(),await this.$refs.faturamento.atualizaValorRestante(),await this.$refs.faturamento.redefinirCampos()}catch{}},async configuraImpressaoConvenio(t){const o=await $db.configuracoes.porNome("impressao.convenio",t);this.configImpressaoConvenio=[...o.length?o.map(s=>({texto:"Imprimir Conv\xEAnio",...s})):[{valor:"convenio",texto:"Imprimir Conv\xEAnio"}]]},async configuraImpressaoCarne(t){const o=await $db.configuracoes.porNome("impressao.carne",t);this.configImpressaoCarne=[...o.length?o.map(s=>({texto:"Imprimir Carn\xEA",...s})):[{valor:"carne-crediario",texto:"Reimprimir carn\xEA e notas promiss\xF3rias da fatura"}]]},async configuraImpressaoEnvelope(t){const o=await $db.configuracoes.porNome("impressao.envelope",t);this.configImpressaoEnvelope=[...o.length?o.map(s=>({texto:"Imprimir Envelope",...s})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoFatura(t){const o=await $db.configuracoes.porNome("impressao.fatura",t);this.configImpressaoFatura=[...o.length?o.map(s=>({texto:"Imprimir Fatura",...s})):[{valor:"invoice",texto:"Fatura (Invoice)"},{valor:"fatura-recibo",texto:"Recibo"},this.sistemaPai==="optisoul"?{valor:"termoGarantia",texto:"Termo de Garantia"}:{}]]},async reabrir(t){var o;if(!((o=this.fatura)!=null&&o.id)){this.$q.notifyError("N\xE3o foi poss\xEDvel encontrar o ID da fatura");return}if(!t)try{$q.loading.show(),await no({idDocumento:this.fatura.id})}catch(s){this.$q.notifyError(s.message);return}finally{$q.loading.hide()}if(!t)try{await new Promise((s,f)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 reabrir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{s()}).onCancel(()=>{f()})})}catch{return}try{this.$q.loading.show({message:"Processando..."});const s=$utils.clonar(this.fatura),f=$utils.clonar(this.vendas),a=$utils.clonar(this.envelopes),v=$utils.clonar(this.documentoItens),_=this.$refs.faturamento.condicaoPagamento.filter(D=>D.valor);if(!t){const D=[];_.reduce((M,i)=>(i.idDocumentoCaixa&&!M[i.idDocumentoCaixa]&&(M[i.idDocumentoCaixa]=!0,D.push($db.hibrido.le({table:"documento",id:i.idDocumentoCaixa}))),M),{});for await(const M of D)if(M.status!=="Aberto")return this.$q.notify({message:"N\xE3o \xE9 poss\xEDvel reabrir fatura de caixas fechados!"}),!1}try{await $db.fatura.checarTitulosLiquidados({condicoesPagamento:this.$refs.faturamento.condicaoPagamentoOriginal})}catch(D){$q.notifyError(D.message);return}let C=[],T=[],w=[];if(!t){C=await $db.financeiroTitulo.le({documentoId:s.id});for(const r of C)if(r.idFinanceiroBoleto){const d=await $erp().financeiroBoleto.get(r.idFinanceiroBoleto),N=await $db.financeiroBanco.le({id:d.idFinanceiroBanco}),A=await $db.banco.le({id:N.idBanco}),ra=d.revisao,Z=A.baixa,wa=A.registro;if(d.remessaOperacao!==Z){const ea=r.idFinanceiroBoleto,ma=$utils.uuid(),Y={id:ma,idFinanceiroBanco:d.idFinanceiroBanco,nossoNumero:d.nossoNumero,nossoNumeroDv:d.nossoNumeroDv,revisao:ra+1,idEmpresa:d.idEmpresa,idContato:d.idContato,empresaNome:d.empresaNome,empresaNumeroDocumento:d.empresaNumeroDocumento,contatoNome:d.contatoNome,contatoNumeroDocumento:d.contatoNumeroDocumento,contatoLogradouro:d.contatoLogradouro,contatoCEP:d.contatoCEP,contatoBairro:d.contatoBairro,contatoCidade:d.contatoCidade,contatoUF:d.contatoUF,dataEmissao:$utils.dataAtual(),dataVencimento:d.dataVencimento,dataImpressao:d.dataImpressao,valor:d.valor,valorJuros:d.valorJuros,tipoJuros:d.tipoJuros,valorMulta:d.valorMulta,valorDesconto:d.valorDesconto,valorTotal:d.valorTotal,codigoBarras:d.codigoBarras,linhaDigitavel:d.linhaDigitavel,mensagem1:d.mensagem1,mensagem2:d.mensagem2,mensagem3:d.mensagem3,mensagem4:d.mensagem4,mensagem5:d.mensagem5,gerarRemessa:1,remessaOperacao:Z};await $db.financeiroBoleto.grava({atual:Y});let ba=[];ea&&(ba=await $db.financeiroTitulo.le({idFinanceiroBoleto:ea}));for(const aa of ba){const fa=$utils.clonar(aa);aa.idFinanceiroBoleto=ma;let pa=[];ea&&(pa=await $db.financeiroBoletoTitulo.le({idFinanceiroBoleto:ea}));for(const Ea of pa){const Q={id:$utils.uuid(),idFinanceiroBoleto:ma,idFinanceiroTitulo:Ea.idFinanceiroTitulo};await $db.financeiroBoletoTitulo.grava({atual:Q})}await $db.financeiroTitulo.grava({atual:aa,original:fa})}if(d.remessaOperacao===wa&&d.gerarRemessa===1)for(const aa of[d,Y]){const fa={...aa,gerarRemessa:0};await $db.financeiroBoleto.grava({original:aa,atual:fa})}}}let D=[];this.$refs.faturamento.idDocumentoCaixa&&(D=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa})),C=await $db.financeiroTitulo.le({idFatura:s.id});let M=await $db.financeiroTitulo.le({idFatura:s.id});for(const r of $utils.clonar(C)){if(!r.idFinanceiroMovimentacaoAgrupamento)continue;const d=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento});for(const N of d){const A=await $db.financeiroTitulo.le({id:N.idFinanceiroTitulo});A.idDocumentoCaixa===this.$refs.faturamento.idDocumentoCaixa&&(C=C.concat(A))}}let i=!1;for(const r of _){const d=await $db.financeiroTitulo.le({id:r.idFinanceiroTitulo});if(Object.keys(d).length){let N=[];N=D.filter(A=>A.idFinanceiroMovimentacaoN===d.idFinanceiroMovimentacaoAgrupamento),T=T.concat(N),N=D.filter(A=>A.idFinanceiroTitulo===d.id),T=T.concat(N),N=D.filter(A=>A.idFinanceiroCheque===d.id),T=T.concat(N),C=C.concat(d)}r.idFinanceiroTitulo="",r.sinal===1&&(i=!0)}M=await $db.financeiroTitulo.le({idFatura:s.id,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const r of M){if(!r.idFinanceiroMovimentacaoAgrupamento)continue;const d=await $db.financeiroMovimentacao.le({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento});T=T.concat(d);const N=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento});w=w.concat(N)}if(M=await $db.financeiroTitulo.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:s.id}),C=C.concat(M),s.id){let r=await $db.financeiroMovimentacao.lerV2({documentoTipo:"Devolu\xE7\xE3o",documentoId:s.id});T=T.concat(r),r=await $db.financeiroMovimentacao.lerV2({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:s.id}),T=T.concat(r),r=await $db.financeiroMovimentacao.lerV2({documentoId:s.id});for(const d of r)(await $db.financeiroTitulo.le({id:d.idFinanceiroTitulo})).id||(T=T.concat(d))}const z=await $db.hibrido.lista({table:"documento",where:{idFatura:s.id}});for(const r of z){const d=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:r.id});T=T.concat(d)}let y=[];for(const r in C){const d=C[r].id;y.includes(d)?delete C[r]:y.push(d)}C=C.filter(r=>r),y=[];for(const r in T){const d=T[r].id;y.includes(d)?delete T[r]:y.push(d)}T=T.filter(r=>r),y=[];for(const r in w){const d=w[r].id;y.includes(d)?delete w[r]:y.push(d)}w=w.filter(r=>r);let u=$utils.dataAtual(),g=i?"Aguardando Pagamento":"Aberta";this.documentoStatus=[{id:$utils.uuid(),idDocumento:s.id,operacao:"Fatura",statusOriginal:s.status,statusFinalizado:g,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}],s.status=g,g==="Aberta"&&(s.dataHoraFinalizado=""),g=i?"Aguardando Pagamento":"Aguardando Faturamento";for(const r of f)this.documentoStatus.push({id:$utils.uuid(),idDocumento:r.id,operacao:"Venda de Mercadoria",statusOriginal:r.status,statusFinalizado:g,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),r.status=g;for(const r of v)r.status=g;this.fatura=s,this.vendas=f,this.envelopes=a,this.documentoItens=v}if(this.$q.loading.hide(),t&&await this.finalizar(t),this.$q.loading.show({message:"Processando..."}),t){let D=[],M=[],i=[],z=[],y=[],u=[];D=this.$refs.faturamento.condicaoPagamento.map(g=>g.id),M=this.$refs.faturamento.condicaoPagamentoOriginal.filter(g=>!D.includes(g.id));for(const g of M)if(g.idFinanceiroTitulo&&i.push(g.idFinanceiroTitulo),g.idFormaPagamento){let r;r=await $erp().formaPagamento.get(g.idFormaPagamento),(r||{}).aliquota&&(g.idFinanceiroTituloPagar?i.push(g.idFinanceiroTituloPagar):this.$q.notify("N\xE3o foi poss\xEDvel excluir as movimenta\xE7\xF5es referentes \xE0 aliquota. Exclua-as manualmente."))}for(const g of i){let r;if(r=await $erp().financeiroTitulo.get(g),r.id&&z.push(r),r.idFinanceiroMovimentacaoAgrupamento){let d,N;if(d=await $erp().financeiroMovimentacao.where({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento}).toArray(),N=(d.find(A=>A.idFinanceiroCheque)||{}).idFinanceiroCheque,N){let A=await $erp().financeiroTitulo.get(N);A.id&&z.push(A)}y.push(...d)}}for(let g of this.carnes){if(!g.id||(g=await $erp().financeiroTitulo.get(g.id),!(g||{}).idFinanceiroMovimentacaoAgrupamento))continue;let r,d;r=await $erp().financeiroMovimentacao.where({idFinanceiroMovimentacaoN:g.idFinanceiroMovimentacaoAgrupamento}).toArray(),d=await $erp().financeiroRenegociacao.where({idFinanceiroMovimentacaoN:g.idFinanceiroMovimentacaoAgrupamento}).toArray(),y.push(...r),u.push(...d)}await $db.financeiroTitulo.remove(z),await $db.financeiroMovimentacao.remove(y),await $db.financeiroRenegociacao.remove(u)}else{await $db.financeiroTitulo.remove(C.filter(D=>!(D.carne&&D.idFatura===s.id))),await $db.financeiroMovimentacao.remove(T),await $db.financeiroRenegociacao.remove(w);for(const D of C.filter(M=>M.carne&&M.idFatura===s.id))await $db.financeiroTitulo.grava({original:D,atual:{valorRealizado:0,receberPagar:1,dataPagamento:""}})}const B=[];for(const D of _)!D.tefRetorno||B.some(M=>M.tefRetorno===D.tefRetorno)||B.push(D);for(const D of B){let M,i,z;if(M=L.extrairCampo("valorTransacao",D.tefRetorno),i=L.extrairCampo("dataTransacao",D.tefRetorno),z=L.extrairCampo("nsu",D.tefRetorno),M&&i&&z){const y=await L.oper("cnc",{idTransacao:`2${this.fatura.id}`,tefRetorno:D.tefRetorno});let u,g,r,d=!1;if(u=L.extrairCampo("mensagemOperador",y.fileContent),g=L.extrairComprovante(y.fileContent),r=L.extrairCampo("codigoAutorizacao",y.fileContent),z=L.extrairCampo("nsu",y.fileContent),d=g&&r&&z,u&&$q.notify({message:u,type:d?"positive":"negative"}),!d)return;d&&(this.$refs.faturamento.condicaoPagamento=[],await L.oper("print",{content:g,opts:{txt:!0}}))}}return await this.salvarFatura(),await this.atualizar(),t?this.$q.notifyPositive("Fatura corrigida."):this.$q.notifyPositive("Fatura reaberta."),!0}catch{this.$q.notify("N\xE3o foi poss\xEDvel reabrir a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async corrigir(){let t,o,s,f;if(t=this.$refs.faturamento.condicaoPagamentoOriginal,o=this.$refs.faturamento.condicaoPagamento,f=$utils.arredondar(this.fatura.totalDocumento||0),s=$utils.arredondar(o.reduce((a,v)=>a+v.valor||0,0)),s!==f){this.$q.notify("Total das condi\xE7\xF5es de pagamento difere do total da fatura");return}if(t.length){let a=!1;o.length||(a=!0);for(const v of o)if(!t.find(_=>_.id===v.id)){a=!0;break}if(!a){this.$q.notify("N\xE3o h\xE1 corre\xE7\xE3o a ser realizada");return}}try{return await new Promise((a,v)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 corrigir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{v()})}),await this.reabrir(!0),!0}catch{return!1}},async salvarFatura(){try{this.$q.loading.show({message:"Processando..."});let t=$utils.clonar(this.$refs.faturamento.condicaoPagamento.filter(s=>s.valor));for(let s in t)delete t[s].idDocumentoCondicaoPagamento,delete t[s].parcelas,delete t[s].formaPagamento,delete t[s].edicao,delete t[s].codigoDocumento,delete t[s].codigoDocumentoCaixa;this.fatura.observacaoFaturamento=this.$refs.faturamento.observacaoFaturamento;const o=(this.carnesOriginal||[]).filter(s=>(this.financeiroTitulo||[]).find(f=>f.id===s.id));if(await $db.fatura.grava({faturaOriginal:this.faturaOriginal,fatura:this.fatura,vendasOriginal:this.vendasOriginal,vendas:this.vendas,envelopesOriginal:this.envelopesOriginal,envelopes:this.envelopes,documentoItensOriginal:this.documentoItensOriginal,documentoItens:this.documentoItens,condicaoPagamentoOriginal:this.$refs.faturamento.condicaoPagamentoOriginal,condicaoPagamento:t,documentoStatus:this.documentoStatus,financeiroTitulo:this.financeiroTitulo,financeiroTituloOriginal:o,financeiroMovimentacao:this.financeiroMovimentacao,financeiroRenegociacao:this.financeiroRenegociacao}),this.receberTitulo.id){let s=this.carnes.find(f=>f.id===this.receberTitulo.id);s.id&&await $db.financeiroTitulo.grava({original:s,atual:{idFatura:this.fatura.id}})}}catch{this.$q.notify("N\xE3o foi poss\xEDvel salvar a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}}},props:{prop:{default:()=>({}),required:!0,type:Object},receberTitulo:{default:()=>({}),type:Object}},mounted(){this.sistemaPai=$utils.sistemaPai(),this.atualizar()}},Yo={class:"Fatura round-borders bg-grey-2 q-pb-sm"},at={class:"row items-center"},ot={class:"col q-ma-sm q-title"},tt=F("div",{class:"text-h5"},null,-1),et={class:"bg-grey-2"},it={class:"q-ma-sm"},nt={key:0,class:"q-item-label",style:{color:"#0c0c0c"}},rt={key:1,class:"q-item-label q-mt-md",style:{color:"#0c0c0c"}},st={class:"col-12 col-md-4 border-1 q-ma-md"},lt=F("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Subtotal",-1),dt={class:"col-8 text-right"},ct=F("div",{class:"col-4 col-lg-3",style:{"line-height":"50px"}},"Desconto",-1),ut={class:"col-3"},mt={class:"col-5"},ft=F("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Total",-1),pt={class:"col-8 q-mt-sm text-right"},vt=F("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Total",-1),ht={class:"col-8 q-mt-sm text-right"},Ct=F("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Bruto Total",-1),gt={class:"col-8 q-mt-sm text-right"},bt=F("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Metro C\xFAbico Total",-1),$t={class:"col-8 q-mt-sm text-right"},Ft={class:"Fatura-faturamento round-borders q-ma-sm q-pa-md"},Dt={class:"round-borders q-ma-sm q-pa-md"};function wt(t,o,s,f,a,v){const _=S("avatar"),C=S("documento-codigo"),T=S("documento-metas"),w=S("venda-card"),B=S("titulo-card"),D=S("row"),M=S("campo"),i=S("faturamento"),z=S("documentos-fiscais");return x(),U("div",Yo,[l(na,{class:"Fatura-barra bg-grey-2 q-py-md",color:"black",dark:""},{default:c(()=>[l(ca,null,{default:c(()=>[F("div",at,[l(_,{imagem:(a.contatos[a.fatura.idContato]||{}).imagem,rotulo:a.fatura.descricaoContato,tamanho:"60"},null,8,["imagem","rotulo"]),F("div",ot,V(a.fatura.descricaoContato),1)]),tt]),_:1}),a.fatura.id?(x(),k(C,{key:0,documento:a.fatura},null,8,["documento"])):I("",!0),l(H,{color:"tertiary",flat:"",icon:"more_vert",round:""},{default:c(()=>[l(Aa,null,{default:c(()=>[l(Ba,{link:"",separator:""},{default:c(()=>[a.fatura.id?(x(),k(la,{key:0,clickable:"",onClick:o[0]||(o[0]=y=>t.$refs.documentosFiscais.emitirCupom(a.fatura.id))},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O("Emitir cupom")]),_:1})]),_:1})]),_:1})):I("",!0),a.fatura.id&&t.$utils.mapearStatus(a.fatura).permiteNota?(x(),U(ua,{key:1},[l(la,{clickable:"",onClick:o[1]||(o[1]=y=>t.emitirNFeV2({idFatura:a.fatura.id},1,"Venda"))},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O("NFe de Sa\xEDda/Venda")]),_:1})]),_:1})]),_:1}),l(la,{clickable:"",onClick:o[2]||(o[2]=y=>t.emitirNFeV2({idFatura:a.fatura.id},0,"Devolu\xE7\xE3o"))},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O("NFe de Entrada/Devolu\xE7\xE3o")]),_:1})]),_:1})]),_:1}),l(la,{clickable:"",onClick:o[3]||(o[3]=y=>t.emitirNFeV2({idFatura:a.fatura.id},1,"Remessa"))},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O("NFe de Remessa")]),_:1})]),_:1})]),_:1})],64)):I("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),F("div",et,[l(T,{ref:"documentoMetas"},null,512)]),F("div",it,[a.vendas.length>0?(x(),U("p",nt,[l(J,{name:"shopping_cart",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),O(" Vendas ")])):I("",!0),(x(!0),U(ua,null,xa(a.vendas,y=>(x(),U("div",{key:y.id,class:"bg-white q-mt-sm round-borders"},[l(w,{id:y.id,onAtualizar:v.atualizar,onExecutar:v.executar},null,8,["id","onAtualizar","onExecutar"])]))),128)),a.carnes.length>0?(x(),U("p",rt,[l(J,{name:"attach_money",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),O(" Carn\xEAs ")])):I("",!0),(x(!0),U(ua,null,xa(a.carnes,y=>(x(),U("div",{key:y.id,class:"bg-white q-mt-sm round-borders"},[l(B,{dados:y,class:"q-mt-md",onExecutar:v.executar},null,8,["dados","onExecutar"])]))),128))]),l(D,{class:"justify-end"},{default:c(()=>[F("div",st,[l(D,{class:"q-col-gutter-md q-mb-sm"},{default:c(()=>[lt,F("strong",dt,V(t.$filters.numero(a.fatura.subTotal,2)),1)]),_:1}),a.permissaoDesconto?(x(),k(D,{key:0,class:"q-col-gutter-x-sm"},{default:c(()=>[ct,F("div",ut,[l(M,{modelValue:a.fatura.totalPercentualDesconto,"onUpdate:modelValue":[o[4]||(o[4]=y=>a.fatura.totalPercentualDesconto=y),o[5]||(o[5]=y=>v.calculaTotais("descontoPercentual"))],tipo:"decimal",decimals:"2",suffix:"%","somente-leitura":v.descontoSomenteLeitura,error:a.erroCalculo},null,8,["modelValue","somente-leitura","error"])]),F("div",mt,[l(M,{modelValue:a.fatura.totalDesconto,"onUpdate:modelValue":[o[6]||(o[6]=y=>a.fatura.totalDesconto=y),o[7]||(o[7]=y=>v.calculaTotais("desconto"))],tipo:"decimal",decimals:"2","somente-leitura":v.descontoSomenteLeitura,error:a.erroCalculo,errorMessage:a.erroCalculoMsg},null,8,["modelValue","somente-leitura","error","errorMessage"])])]),_:1})):I("",!0),l(D,{class:"q-col-gutter-x-sm q-mt-sm"},{default:c(()=>[ft,F("strong",pt,V(t.$filters.numero(a.fatura.totalDocumento,2)),1)]),_:1}),a.pesoTotal?(x(),k(D,{key:1,class:"q-col-gutter-x-sm q-mt-sm"},{default:c(()=>[vt,F("span",ht,V(a.pesoTotal),1)]),_:1})):I("",!0),a.pesoBrutoTotal?(x(),k(D,{key:2,class:"q-col-gutter-x-sm q-mt-sm"},{default:c(()=>[Ct,F("span",gt,V(a.pesoBrutoTotal),1)]),_:1})):I("",!0),a.metroCubicoTotal?(x(),k(D,{key:3,class:"q-col-gutter-x-sm q-mt-sm"},{default:c(()=>[bt,F("span",$t,V(a.metroCubicoTotal),1)]),_:1})):I("",!0)])]),_:1}),F("div",Ft,[l(i,{documento:a.fatura,ref:"faturamento"},null,8,["documento"])]),F("div",Dt,[l(z,{ref:"documentosFiscais",idFatura:a.fatura.id},null,8,["idFatura"])])])}var Et=Va(Xo,[["render",wt]]);const Tt={components:{CpfCnpjNoCupom:po,Fatura:Et},data(){return{fatura:{},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:"",tipoCaixa:""},dinheiroTef:{mostrar:!1,valor:0},permissaoTef:!1,visivel:!1,visibilidade:{botao:{finalizar:!1,reabrir:!1,corrigir:!1}},temPermissaoCorrigir:!1}},emits:["executar"],methods:{async atualizar(){let t;try{t=setTimeout(()=>{$q.loading.show({message:"Carregando informa\xE7\xF5es...",boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})},500);let o=await $db.hibrido.le({table:"documento",id:this.id});this.fatura=o,await this.verificarPermissoes(),this.desativarBotoes(),o.status==="Aberta"&&(this.visibilidade.botao.salvar=!0),o.status==="Finalizada"||o.status!=="Aguardando Pagamento"&&o.dataHoraFinalizado?this.visibilidade.botao.reabrir=!0:this.visibilidade.botao.finalizar=!0,await $db.contato.exibirCondutaObservacao(o.idContato,$q.notify)}finally{clearTimeout(t),$q.loading.hide()}},desativarBotoes(){this.visibilidade.botao.finalizar=!1,this.visibilidade.botao.reabrir=!1,this.visibilidade.botao.salvar=!1},desativarEsc(){this.lockEsc=!0},reativarEsc(){this.lockEsc=!1},async reabrir(){await this.$refs.fatura.reabrir(),await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"))},voltar(t){t.stopPropagation(),!this.lockEsc&&this.fechar()},async finalizarTef(t){t==="dinheiro"&&(this.dinheiroTef.valor=0,this.dinheiroTef.mostrar=!0),t==="cpfCnpj"&&(this.dinheiroTef.mostrar=!1,this.cpfCnpjNoCupom={visivel:!0,incluirCpfCnpjNoCupom:!1,idEmpresa:this.fatura.idEmpresa,cpfCnpj:this.fatura.numeroDocumentoContato,nomeCliente:this.fatura.descricaoContato,tipoCaixa:""})},async finalizar(t){var a;const{tef:o}=t!=null?t:{},s=!1,f={tef:o,cpfCnpjNoCupom:this.cpfCnpjNoCupom,valorDinheiro:(a=this.dinheiroTef.valor)!=null?a:0};if(this.lockEsc=!0,!await this.$refs.fatura.finalizar(s,f)){this.lockEsc=!1;return}this.$emit("executar","finalizar"),this.fechar()},async executar(t){switch(t){case"finalizar":if(!await this.$refs.fatura.finalizar())return;break;case"retornarOrcamento":case"remover":await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"));return}this.$emit("executar",t),this.fechar()},fechar(){this.visivel=!1},async mostrar(t={}){this.id=t.id,await this.atualizar(),this.visivel=!0},onHide(){this.fatura={},this.visibilidade={botao:{finalizar:!1,reabrir:!1,corrigir:!1}},this.temPermissaoCorrigir=!1,this.runOnHide.forEach(t=>t()),this.runOnHide=[]},async salvar(){try{await new Promise((t,o)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 salvar esta fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{t()}).onCancel(()=>{o()})})}catch{return}await this.$refs.fatura.salvarFatura(),this.$emit("executar","atualizar"),this.fechar()},corrigir(){this.$refs.fatura.corrigir().then(()=>{this.$emit("executar","atualizar"),this.fechar()})},async verificarPermissoes(){const t=await $erp().formaPagamento.toArray();this.temPermissaoCorrigir=await $db.permissao.objeto("caixa/tesouraria"),this.permissaoTef=t.some(o=>o.idContatoEmpresa===this.fatura.idEmpresa&&o.ativo&&o.tef)}},props:{receberTitulo:{default:()=>({}),type:Object}},created(){this.runOnHide=[]},mounted(){$utils.emitter.on("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.on("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.on("reativarVoltarEscModal",this.reativarEsc)},beforeUnmount(){$utils.emitter.off("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.off("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.off("reativarVoltarEscModal",this.reativarEsc)}};function Pt(t,o,s,f,a,v){const _=S("fatura"),C=S("campo"),T=S("g-col"),w=S("g-row"),B=S("CpfCnpjNoCupom");return x(),U("div",null,[l(Ma,{modelValue:a.visivel,"onUpdate:modelValue":o[1]||(o[1]=D=>a.visivel=D),onKeyup:Ha(v.voltar,["esc"]),onHide:v.onHide,maximized:"",persistent:""},{default:c(()=>[l(ro,{view:"hHh LpR fFf",container:"",class:"bg-grey-4"},{default:c(()=>[l(so,null,{default:c(()=>[l(na,null,{default:c(()=>[ya(l(H,{icon:"arrow_back",round:"",flat:"",dense:""},null,512),[[_a]]),l(ca,null,{default:c(()=>[O("Fatura")]),_:1}),a.visibilidade.botao.salvar?(x(),k(H,{key:0,onClick:v.salvar,label:"Salvar",color:"white","text-color":"primary",unelevated:""},null,8,["onClick"])):I("",!0),a.visibilidade.botao.reabrir&&a.temPermissaoCorrigir?(x(),k(H,{key:1,onClick:v.corrigir,label:"Corrigir",color:"white","text-color":"negative",unelevated:""},null,8,["onClick"])):I("",!0)]),_:1})]),_:1}),l(lo,null,{default:c(()=>[l(co,{class:"u-container q-py-md"},{default:c(()=>[a.fatura.id?(x(),k(_,{key:0,onExecutar:v.executar,prop:{id:a.fatura.id},receberTitulo:s.receberTitulo,ref:"fatura"},null,8,["onExecutar","prop","receberTitulo"])):I("",!0)]),_:1})]),_:1}),l(uo,{class:"bg-light",bordered:""},{default:c(()=>[l(na,{class:"q-pa-sm u-container"},{default:c(()=>[l(mo),a.visibilidade.botao.reabrir?(x(),k(H,{key:0,onClick:v.reabrir,label:"Reabrir",color:"negative",flat:"",class:"q-ml-sm"},null,8,["onClick"])):I("",!0),a.visibilidade.botao.reabrir?I("",!0):(x(),k(H,{key:1,onClick:v.finalizar,disabled:!a.visibilidade.botao.finalizar,label:"Finalizar",color:"primary",dark:"",unelevated:"",class:"q-ml-sm"},null,8,["onClick","disabled"])),!a.visibilidade.botao.reabrir&&a.permissaoTef?(x(),k(H,{key:2,onClick:o[0]||(o[0]=D=>v.finalizarTef("dinheiro")),dark:"",unelevated:"",disabled:!a.visibilidade.botao.finalizar,label:"Finalizar TEF",color:"primary",class:"q-ml-sm"},null,8,["disabled"])):I("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup","onHide"]),l(Ma,{modelValue:a.dinheiroTef.mostrar,"onUpdate:modelValue":o[4]||(o[4]=D=>a.dinheiroTef.mostrar=D)},{default:c(()=>[l(Sa,{style:{width:"425px"}},{default:c(()=>[l(na,{class:"bg-primary text-white"},{default:c(()=>[l(ca,null,{default:c(()=>[O("Dinheiro")]),_:1})]),_:1}),l(ja,{class:"no-padding"},{default:c(()=>[l(La,{onSubmit:o[3]||(o[3]=D=>v.finalizarTef("cpfCnpj"))},{default:c(()=>[l(w,{gutter:"md"},{default:c(()=>[l(T,{col:"12",class:"q-my-lg"},{default:c(()=>[l(C,{modelValue:a.dinheiroTef.valor,"onUpdate:modelValue":o[2]||(o[2]=D=>a.dinheiroTef.valor=D),before:[{icon:"attach_money"}],rotulo:"Valor",tipo:"decimal",decimals:"2"},null,8,["modelValue"])]),_:1}),l(T,{col:"12",text:"right",bordered:"top"},{default:c(()=>[ya(l(H,{label:"Cancelar",color:"tertiary",flat:"",class:"q-ml-sm"},null,512),[[_a]]),l(H,{type:"submit",label:"Ok",color:"primary",unelevated:"",class:"q-ml-sm q-px-xl"})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(B,{modelValue:a.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":o[5]||(o[5]=D=>a.cpfCnpjNoCupom.visivel=D),onConfirmar:o[6]||(o[6]=D=>v.finalizar({tef:!0})),dados:a.cpfCnpjNoCupom},null,8,["modelValue","dados"])])}var Mt=Va(Tt,[["render",Pt]]);export{Mt as F,Ko as T};
