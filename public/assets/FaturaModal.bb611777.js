import{_ as Va,M as Ra,p as L,o as E,d as Q,f as l,w as m,x as c,B as na,E as ra,e as R,t as x,i as N,bb as Ka,l as V,j as J,k as ga,D as H,v as Za,aF as Aa,C as _a,ai as Ba,F as sa,r as xa,aj as ca,ak as K,ah as ua,L as Ta,am as Wa,s as Sa,z as La,y as Ma,n as Xa,cL as j,cS as Ya,cT as ao,cU as oo,cV as to,K as io,A as eo,G as no,I as ro,aQ as so,aK as lo}from"./index.1304e793.js";import{D as co,C as uo}from"./DocumentosFiscais.500741bb.js";import{e as mo}from"./emitirNFe.de0f28dd.js";import{V as fo}from"./VendaCard.b035029e.js";const po={components:{Avatar:Ra},computed:{mostrarMenuTresPontos(){return this.mostrarOpcaoMigrarFatura}},data(){return{titulo:{},tituloOriginal:{},detalhes:!1,contatos:{},documento:{},fatura:{},faturasAbertas:[],mostrarOpcaoMigrarFatura:!1,visibilidade:{botao:{remover:!1,editar:!1}},modalEditar:{visivel:!1,erroCalculo:!1,rules:[]},tema:["TituloCard","bg-white","rounded-borders"]}},emits:["executar"],methods:{irParaAtendimentoFatura(t){this.$router.push({name:"AtendimentoFatura",params:{id:t}})},async migrarFatura(t){try{await new Promise((i,s)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar esta venda para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{i()}).onCancel(()=>{s()})})}catch{return}if(!t&&this.titulo.idContato&&this.titulo.idEmpresa){const i=await $erp().contato.get(this.titulo.idContato)||{};let s=await $erp().contatoEndereco.where({idContato:this.titulo.idContato}).toArray(),h=await $erp().contatoTelefone.where({idContato:this.titulo.idContato}).toArray();s=s.find(M=>(M.grupo||"").trim().toLowerCase()==="Principal")||s[0]||{},h=h.find(M=>(M.tipoTelefone||"").trim().toLowerCase()==="Principal")||h[0]||{};const a=await $erp().contato.get(this.titulo.idEmpresa)||{};let F=await $erp().contatoEndereco.where({idContato:this.titulo.idEmpresa}).toArray();F=F.find(M=>M.grupo.trim().toLowerCase()==="Principal")||F[0]||{},t=$db.fatura.criar({idEmpresa:a.id,idEmpresaEndereco:F.id||"",descricaoEmpresa:a.nome||"",numeroDocumentoEmpresa:a.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:a.numeroDocumentoMunicipal||"",optanteSimplesNacional:a.regime==="SimplesNacional"?"1":"0",idContato:i.id,idContatoEndereco:s.id||"",numeroDocumentoContato:i.numeroDocumentoNacional||"",descricaoContato:i.nome||"",descricaoContatoEndereco:"".concat(s.logradouro||"",", ",s.numero||""," ",s.complemento||""," - ",s.bairro||""," - ",s.cep||""," - ",s.municipio||"","/",s.uf||""),telefoneContato:h.telefone||"",emailContato:i.email||"",regimeContato:i.regime||"",observacaoFaturamento:""}),await $db.fatura.grava({fatura:t})}t.id?(await $db.financeiroTitulo.grava({atual:{id:this.titulo.id,idFatura:t.id},original:this.titulo}),localStorage.setItem("idFatura",t.id),this.titulo.idContato&&(this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(this.titulo.idContato))):this.$q.notify("N\xE3o foi poss\xEDvel realizar a opera\xE7\xE3o")},async salvar(){if(!this.titulo.valorDesconto){this.modalEditar.visivel=!1;return}try{await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.tituloOriginal=$utils.clonar(this.titulo),this.modalEditar.visivel=!1,this.$q.notifyPositive("T\xEDtulo salvo."),this.$emit("executar","recalcular")}catch{this.$q.notifyPositive("N\xE3o foi poss\xEDvel salvar o t\xEDtulo. Por favor, tente novamente.")}},editar(){this.modalEditar.visivel=!0},async permissaoEditar(){return await $db.permissao.objeto("Diretiva_Caixa_DescontoTitulo")},async desconto(){const t=$utils.arredondar((this.titulo.valorMulta||0)+(this.titulo.valorJuros||0)*(this.titulo.diasEmAtraso||0));if(this.titulo.valorDesconto<0||this.titulo.valorDesconto>t){this.modalEditar.rules=[()=>"Desconto n\xE3o permitido"],this.modalEditar.erroCalculo=!0,this.titulo.valorTotal=this.tituloOriginal.valorTotal,this.titulo.valorARealizar=this.tituloOriginal.valorARealizar,this.titulo.percentualDesconto=this.tituloOriginal.percentualDesconto;return}this.modalEditar.rules=[()=>!0],this.titulo.valorTotal=$utils.arredondar((this.titulo.valor||0)-(this.titulo.valorDesconto||0)+(this.titulo.valorMulta||0)+(this.titulo.valorJuros||0)*(this.titulo.diasEmAtraso||0)),this.titulo.valorARealizar=this.titulo.valorTotal,this.titulo.percentualDesconto=$utils.arredondar((this.titulo.valorDesconto||0)*100/(this.titulo.valor||1)),this.modalEditar.erroCalculo=!1},alternarDetalhes(){this.detalhes=!this.detalhes},async remover(){try{await new Promise((t,i)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este t\xEDtulo da fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{t()}).onCancel(()=>{i()})})}catch{return}this.titulo.idFatura="",await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.visibilidade.botao.remover=!1,this.$q.notifyPositive("T\xEDtulo removido da fatura."),this.$emit("executar","remover")}},props:{dados:{required:!0,type:Object}},async mounted(){const t=new Date(this.dados.dataVencimento).setHours(0,0,0,0),i=new Date().setHours(0,0,0,0);t<i?this.tema.push("vencido"):this.tema=$lodash.remove(this.tema,h=>h!=="vencido"),this.tituloOriginal=$utils.clonar(this.dados),this.titulo=$utils.clonar(this.dados),this.titulo.documentoId&&(this.documento=await $erp().documento.get(this.titulo.documentoId)),this.visibilidade.botao.remover=!1,this.permissaoEditar().then(h=>this.visibilidade.botao.editar=h&&!this.tituloOriginal.valorRealizado),this.contatos={};const s={};if(this.titulo.idContato){const h=await $db.contato.le({id:this.titulo.idContato});h&&(s[this.titulo.idContato]=h)}if(this.titulo.idEmpresa){const h=await $db.contato.le({id:this.titulo.idEmpresa});h&&(s[this.titulo.idEmpresa]=h)}this.contatos=s,this.mostrarOpcaoMigrarFatura=!0,this.titulo.idFatura&&$db.fatura.leNew({id:this.titulo.idFatura}).then(h=>{this.fatura=h,h.status==="Aberta"&&$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(a=>{a.data.find(M=>M.id===this.titulo.idEmpresa)&&(this.visibilidade.botao.remover=!0)})})}},ho={class:"col-12 col-md-6 q-pl-none"},vo=c("br",null,null,-1),Co={class:"col-4 col-md"},go={key:0,class:"q-my-none"},bo={class:"q-my-none"},$o={class:"q-my-none"},Fo={class:"col-4 col-md text-right"},Do={class:"col-4 col-md text-right"},_o={class:"col-12 col-md"},To={class:"text-right text-h5 text-positive text-weight-bold q-my-none"},wo={class:"text-right text-weight-normal text-tertiary text-body2 q-my-none"},Po={class:"col-6"},qo={class:"text-body2"},Eo={class:"col-6 text-right"},yo={class:"col-12 col-md-6"},xo={class:"text-body2 q-my-none q-mb-md"},Mo={class:"col-12 col-sm-4 col-md-2"},Vo={class:"text-left q-my-none"},Io={class:"col-6 col-md-1"},zo={class:"text-left q-my-none"},No={class:"col-6 col-md-1"},ko={class:"text-left q-my-none"},Oo={class:"col-12 col-sm-4 col-md-2 text-right"},Ro=c("p",{class:"text-subtitle1 text-weight-bold q-ma-none"}," Desconto ",-1),Ao={class:"q-ma-none"},Bo={class:"q-mt-xs"},So=c("small",{class:"block text-caption"},"Multa",-1),Lo={class:"q-mt-xs"},jo=c("small",{class:"block text-caption"},"Juros",-1),Ho={class:"layout-padding"},Qo={class:"horizontal"},Uo=c("dt",{style:{"text-align":"left"}},"Valor",-1),Jo={class:"text-right"},Go={class:"horizontal"},Ko=c("dt",{style:{"text-align":"left"}},"Dias em Atraso",-1),Zo={class:"text-right"},Wo={class:"horizontal"},Xo=c("dt",{style:{"text-align":"left"}},"Multa",-1),Yo={class:"text-right"},at={class:"horizontal"},ot=c("dt",{style:{"text-align":"left"}},"Juros",-1),tt={class:"text-right"},it={class:"horizontal"},et=c("dt",{style:{"text-align":"left"}},"Desconto",-1),nt={class:"text-right"},rt={class:"horizontal"},st=c("dt",{style:{"text-align":"left"}},"Total",-1),lt={class:"text-right"},dt={class:"q-mt-lg text-right"};function ct(t,i,s,h,a,F){const M=L("avatar"),b=L("row"),w=L("campo");return E(),Q("div",{class:Xa([a.tema,"extratoItem bg-white q-pa-sm no-shadow"])},[l(b,{class:"items-center q-mx-none q-px-none q-mb-sm text-tertiary"},{default:m(()=>{var y;return[c("div",ho,[l(na,{class:"q-pa-none"},{default:m(()=>[l(M,{imagem:(a.contatos[a.titulo.idContato]||{}).imagem,rotulo:(a.contatos[a.titulo.idContato]||{}).apelido,tamanho:"30"},null,8,["imagem","rotulo"]),l(ra,null,{default:m(()=>[R(x((a.contatos[a.titulo.idContato]||{}).apelido)+" ",1),vo]),_:1}),a.titulo.parcela?(E(),N(Ka,{key:0,rounded:"",color:"tertiary",small:""},{default:m(()=>[R(x(a.titulo.parcela),1)]),_:1})):V("",!0)]),_:1})]),c("div",Co,[a.titulo.documentoCodigo?(E(),Q("p",go,x(a.titulo.documentoTipo)+" #"+x((y=a.documento)==null?void 0:y.numero),1)):V("",!0),c("p",bo,x(a.titulo.formaDePagamento),1),c("p",$o,x(a.titulo.descricaoPlanoConta),1)]),c("div",Fo,[a.titulo.dataVencimentoOriginal?(E(),N(J,{key:0,name:"mdi-calendar-today"})):V("",!0),R(" "+x(t.$filters.data(a.titulo.dataVencimentoOriginal))+" ",1),l(ga,null,{default:m(()=>[R("Vencimento original")]),_:1})]),c("div",Do,[a.titulo.dataVencimento?(E(),N(J,{key:0,name:"mdi-calendar-check"})):V("",!0),R(" "+x(t.$filters.data(a.titulo.dataVencimento))+" ",1),l(ga,null,{default:m(()=>[R("Vencimento")]),_:1})]),c("div",_o,[c("p",To,x(t.$filters.numero(a.titulo.valorTotal,2)),1),c("p",wo,x(t.$filters.numero(a.titulo.valor,2)),1)])]}),_:1}),l(b,{class:"items-center justify-end"},{default:m(()=>[c("div",Po,[c("div",qo,x(a.titulo.descricao),1)]),c("div",Eo,[l(H,{rounded:"",dense:"",flat:"",icon:`keyboard_arrow_${a.detalhes?"up":"down"}`,color:"tertiary",onClick:F.alternarDetalhes},null,8,["icon","onClick"]),a.visibilidade.botao.editar?(E(),N(H,{key:0,rounded:"",dense:"",flat:"",icon:"edit",color:"primary",onClick:F.editar},null,8,["onClick"])):V("",!0),a.visibilidade.botao.remover?(E(),N(H,{key:1,rounded:"",dense:"",flat:"",icon:"clear",color:"tertiary",onClick:F.remover},{default:m(()=>[l(ga,null,{default:m(()=>[R(" Remover da Fatura #"+x(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):V("",!0),Za(t.$slots,"default"),F.mostrarMenuTresPontos?(E(),N(H,{key:2,rounded:"",dense:"",flat:"",icon:"more_vert",color:"tertiary"},{default:m(()=>[l(Aa,null,{default:m(()=>[_a((E(),N(Ba,{link:"",separator:""},{default:m(()=>[a.mostrarOpcaoMigrarFatura?(E(),Q(sa,{key:0},[(E(!0),Q(sa,null,xa(a.faturasAbertas,y=>(E(),N(ca,{clickable:"",key:y.id,onClick:k=>F.migrarFatura(y)},{default:m(()=>[l(K,{avatar:""},{default:m(()=>[l(J,{name:"mdi-folder-move"})]),_:1}),l(K,null,{default:m(()=>[l(ua,null,{default:m(()=>[R(x("Migrar para fatura #"+(y.numero||y.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),l(ca,{clickable:"",onClick:i[0]||(i[0]=y=>F.migrarFatura())},{default:m(()=>[l(K,{avatar:""},{default:m(()=>[l(J,{name:"mdi-folder-move"})]),_:1}),l(K,null,{default:m(()=>[l(ua,null,{default:m(()=>[R("Migrar para nova fatura")]),_:1})]),_:1})]),_:1})],64)):V("",!0)]),_:1})),[[Ta]])]),_:1})]),_:1})):V("",!0)])]),_:3}),a.detalhes?(E(),N(Wa,{key:0,class:"hideondesktop q-my-sm"})):V("",!0),a.detalhes?(E(),N(b,{key:1,class:"items-start q-mx-none q-px-none q-mt-md"},{default:m(()=>[c("div",yo,[l(na,{class:"u-autoHeight q-pa-none",color:"none",dark:""},{default:m(()=>[l(J,{name:"business"}),l(ra,null,{default:m(()=>[R(x((a.contatos[a.titulo.idEmpresa]||{}).apelido),1)]),_:1})]),_:1}),c("p",xo,x(a.titulo.observacao),1)]),c("div",Mo,[c("p",Vo,x(a.titulo.descricaoCentroCusto),1)]),c("div",Io,[c("p",zo,[a.titulo.dataEmissao?(E(),N(J,{key:0,name:"mdi-calendar-check"})):V("",!0),R(" "+x(t.$filters.data(a.titulo.dataEmissao))+" ",1),l(ga,null,{default:m(()=>[R("Emiss\xE3o")]),_:1})])]),c("div",No,[c("p",ko,[a.titulo.dataCompetencia?(E(),N(J,{key:0,name:"mdi-calendar-check"})):V("",!0),R(" "+x(t.$filters.data(a.titulo.dataCompetencia))+" ",1),l(ga,null,{default:m(()=>[R("Compet\xEAncia")]),_:1})])]),c("div",Oo,[Ro,c("p",Ao,x(t.$filters.numero(a.titulo.valorDesconto||0,2)),1),a.titulo.diasEmAtraso?(E(),Q(sa,{key:0},[c("div",Bo,[So,c("strong",null,x(t.$filters.numero(a.titulo.valorMulta||0,2))+" ("+x(t.$filters.numero(a.titulo.percentualMulta||0,2))+"%) ",1)]),c("div",Lo,[jo,c("strong",null,x(t.$filters.numero(a.titulo.valorTotalJuros||0,2))+" ("+x(t.$filters.numero(a.titulo.percentualJuros||0,2))+"% dia) ",1)])],64)):V("",!0)])]),_:1})):V("",!0),l(Ma,{modelValue:a.modalEditar.visivel,"onUpdate:modelValue":i[2]||(i[2]=y=>a.modalEditar.visivel=y),"content-css":{minWidth:"30vw"}},{default:m(()=>[l(Sa,{class:"q-dialog-plugin"},{default:m(()=>[l(na,{class:"bg-primary text-white"},{default:m(()=>[l(ra,null,{default:m(()=>[R("Editar T\xEDtulo")]),_:1}),_a(l(H,{dense:"",flat:"",icon:"close",round:""},null,512),[[Ta]])]),_:1}),c("div",Ho,[l(La,{onSubmit:F.salvar,class:"q-pa-md q-gutter-md"},{default:m(()=>[c("dl",Qo,[Uo,c("dd",Jo,x(t.$filters.numero(a.titulo.valor,2)),1)]),c("dl",Go,[Ko,c("dd",Zo,x(t.$filters.numero(a.titulo.diasEmAtraso,0)),1)]),c("dl",Wo,[Xo,c("dd",Yo,x(t.$filters.numero(a.titulo.valorMulta,2)),1)]),c("dl",at,[ot,c("dd",tt,x(t.$filters.numero(a.titulo.valorTotalJuros,2)),1)]),c("dl",it,[et,c("dd",nt,[l(w,{modelValue:a.titulo.valorDesconto,"onUpdate:modelValue":[i[1]||(i[1]=y=>a.titulo.valorDesconto=y),F.desconto],dense:"",tipo:"decimal",decimals:"2",rules:a.modalEditar.rules},null,8,["modelValue","onUpdate:modelValue","rules"])])]),c("dl",rt,[st,c("dd",lt,x(t.$filters.numero(a.titulo.valorTotal,2)),1)]),c("div",dt,[l(H,{color:"primary",unelevated:"",label:"Salvar",type:"submit"})])]),_:1},8,["onSubmit"])])]),_:1})]),_:1},8,["modelValue"])],2)}var ut=Va(po,[["render",ct]]),mt={async finalizar(t,i){var F,M,b,w,y,k,P,I;const s=(F=i==null?void 0:i.tef)!=null?F:!1,{cpfCnpjNoCupom:h,valorDinheiro:a}=i!=null?i:{};try{if($utils.verificarErro(this.erroCalculo,"Erro de c\xE1lculo encontrado."),!t&&!s)try{await new Promise((o,n)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar esta fatura",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{o()}).onCancel(()=>{n()})})}catch{return!1}this.$q.loading.show({message:"Processando..."});const e=$utils.clonar(this.fatura),A=$utils.clonar(this.vendas),q=$utils.clonar(this.carnes);if(q.length>0){const o=q.reduce((n,p)=>(p.idFinanceiroBoleto&&p.codigoFinanceiroTitulo&&(n+=String(p.codigoFinanceiroTitulo)+";"),n),"");if(o)try{$q.loading.show({message:"Baixando boletos..."});const n=`exec sp_Financeiro_BoletoBaixar '${o.slice(0,-1)}'`,p=await $utils.executarSql(n)}catch(n){$q.notifyError("N\xE3o foi poss\xEDvel baixar boletos",n);return}finally{$q.loading.hide()}}const u=t?e.dataHoraFinalizado:$utils.dataAtual(),C=u,r=await $db.documento.ler({id:this.$refs.faturamento.idDocumentoCaixa});if(this.documentoStatus=[],s){let o,n;if(o=await $erp().caixa.where({idEmpresa:e.idEmpresa}).toArray(),n=o.some(p=>p.ativo),n&&!(r!=null&&r.id)){$q.notify({message:"Opera\xE7\xE3o negada. \xC9 necess\xE1rio abertura de caixa.",type:"negative"});return}if(await this.$refs.faturamento.checarCaixa(),this.fatura.totalDocumento-a<0){$q.notify({message:"Opera\xE7\xE3o negada. Valor em dinheiro acima do total do documento.",type:"negative"});return}if(a<0){$q.notify({message:"Opera\xE7\xE3o negada. Valor em dinheiro n\xE3o permitido.",type:"negative"});return}if(o=await j.oper("crt",{idTransacao:`1${this.fatura.id}`,idLoja:(M=this.fatura.numeroDocumentoEmpresa)==null?void 0:M.replace(/\D/g,""),idAutomacao:$utils.sistemaPai()==="b15"?"07660198000189":"09492015000199",valorTransacao:$utils.arredondar(this.fatura.totalDocumento-a,2).toLocaleString("pt-BR",{minimumFractionDigits:2}),nroDocFiscal:(b=this.fatura.numero)!=null?b:this.fatura.id.replace(/\D/g,"").slice(-6)}),!(o!=null&&o.fileContent))return;if(o!=null&&o.fileContent){let p,v,_,f,D=!1;if(p=j.extrairCampo("mensagemOperador",o.fileContent),v=j.extrairComprovante(o.fileContent),_=j.extrairCampo("codigoAutorizacao",o.fileContent),f=j.extrairCampo("nsu",o.fileContent),D=v&&_&&f,p&&$q.notify({message:p,type:D?"positive":"negative"}),!D)return;D&&await this.$refs.faturamento.tef({fatura:e,tefRetorno:o.fileContent,valorDinheiro:a})}}await this.$refs.faturamento.validar();let d=$lodash.orderBy(this.$refs.faturamento.condicaoPagamento.filter(o=>o.valor),["idFormaPagamento","autorizacao","dataVencimento"]);$utils.verificarErro(A.find(o=>!o.dataHoraFinalizado),"Existe pedido de venda sem data de finaliza\xE7\xE3o.");const z=$utils.arredondar(this.carnes.reduce((o,n)=>o+(n.valorARealizar||0),0)),B=$utils.arredondar(d.reduce((o,n)=>o+(n.valor||0),0));let la=0;if(t&&(d=d.filter(o=>!this.$refs.faturamento.condicaoPagamentoOriginal.find(n=>n.id===o.id))),e.totalDocumento>=0){if(this.carnes.length){if(B<z)return this.$q.notify("Valor pago menor que a soma dos t\xEDtulos \xE0 faturar!"),!1;if(!await $db.permissao.objeto("Diretiva_Caixa_PagarCarneCartao")){const n=d.reduce((p,v)=>{const _=`${v.autorizacao||""}${v.documento||""}${v.idFormaPagamento}`;return p[_]||(p[_]={parcelas:0,formaPagamento:v.formaPagamento}),p[_].parcelas++,p},{});for(const p in n)if(n[p].parcelas>this.carnes.length)return this.$q.notify(`Quantidade de parcelas da forma de pagamento ${n[p].formaPagamento} acima do permitido.`),!1}}B<e.totalDocumento&&(la=1)}let Z=la===1?"Aguardando Pagamento":"Finalizada";if(!t){this.documentoStatus.push({id:$utils.uuid(),idDocumento:e.id,operacao:"Fatura",statusOriginal:e.status,statusFinalizado:Z,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:r.id||""}),e.status=Z,e.dataHoraFinalizado=u;let o=0;for(const D of A)o=(await $db.documentoItem.ler({idDocumento:D.id})).reduce((T,$)=>($.total>0&&(T+=$.total),T),o);o=$utils.arredondar(o),Z="Faturado";const n=parseInt(await $db.configuracoes.leValorComFiltroEmpresa("vendas.usaExpedicao",e.idEmpresa,0))||0;let p=0,v=0,_=!1,f=!0;n&&(this.$q.loading.hide(),await new Promise((D,g)=>{this.$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},message:"Gostaria de dar baixa na(s) venda(s), removendo-a(s) do processo de expedi\xE7\xE3o?",noRefocus:!0,preventClose:!0,persistent:!0,title:"Confirma?"}).onOk(()=>{f=!0,D()}).onCancel(()=>{f=!1,D()})}),this.$q.loading.show({message:"Processando..."}));for(const D of A)v+=(await $db.documento.ler({tipo:"Envelope",documentoId:D.id,documentoTipo:"Venda"})||[]).filter(T=>T.status!=="Entregue").length;if(v){let D="Nesta Fatura h\xE1 1 envelope aguardando entrega, deseja mudar o status deste para Entregue?";v>1&&(D=`Nesta Fatura h\xE1 ${v} envelopes aguardando entrega, deseja mudar o status destes para Entregue?`),this.$q.loading.hide();try{await new Promise((g,T)=>{this.$q.dialog({cancel:"N\xE3o",message:D,noRefocus:!0,ok:"Sim",preventClose:!0,title:"Confirma?"}).onOk(()=>{_=!0,g()}).onCancel(()=>{T()})})}catch{}this.$q.loading.show({message:"Processando..."})}for(const D of A){Z=f?"Faturado":D.status,f&&this.documentoStatus.push({id:$utils.uuid(),idDocumento:D.id,operacao:"Venda de Mercadoria",statusOriginal:D.status,statusFinalizado:Z,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:r.id||""}),D.status=Z;const g=await $db.documento.ler({tipo:"Envelope",documentoId:D.id,documentoTipo:"Venda"});if(this.envelopesOriginal=this.envelopesOriginal.concat($utils.clonar(g)),_)for(const $ of g.filter(S=>S.status!=="Entregue"))this.documentoStatus.push({id:$utils.uuid(),idDocumento:$.id,operacao:"Envelope",statusOriginal:$.status,statusFinalizado:"Entregue",dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),$.status="Entregue",$.dataHoraFinalizado=$utils.dataAtual();this.envelopes=this.envelopes.concat(g);const T=await $db.documentoItem.ler({idDocumento:D.id});this.documentoItensOriginal=this.documentoItensOriginal.concat($utils.clonar(T));for(const $ of T)if($.status=Z,$.total>0){$.quantidade=$.quantidade||1,$.valorItem=$.valorItem||0,$.descontoItem=$.descontoItem||0,$.descontoTotalRateado=$.descontoTotalRateado||0;let S=($.valorItem-$.descontoItem)*$.quantidade-$.descontoTotalRateado;const X=$utils.arredondar((e.totalDesconto||0)*S/(o||1)||0);$.descontoFaturaRateado=$utils.arredondar(X),$.valorRealTotal=$utils.arredondar(S-X),$.valorReal=$utils.arredondar($.valorRealTotal/$.quantidade),p+=X}this.documentoItens=this.documentoItens.concat(T)}if(e.totalDesconto!==$utils.arredondar(p)){const D=$utils.arredondar((e.totalDesconto||0)-(p||0));let g,T=0;for(const $ of this.documentoItens)$.total>T&&(T=$.total,g=$);if(g){const $=(g.descontoFaturaRateado||0)+(D||0),S=((g.valorItem||0)-(g.descontoItem||0))*(g.quantidade||1)-(g.descontoTotalRateado||0)-($||0),X=(S||0)/(g.quantidade||1);g.descontoFaturaRateado=$utils.arredondar($),g.valorReal=$utils.arredondar(X),g.valorRealTotal=$utils.arredondar(S)}}}const wa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.renegociacao"}))[0].valor),ia=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:wa}),ma=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatareceber"}))[0].valor);let Y=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ma});const ba=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatapagar"}))[0].valor),aa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ba}),fa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cheque"}))[0].valor),pa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:fa}),Pa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.faturamentogeral"}))[0].valor),U=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Pa}),ja=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0].valor),Ia=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ja}),Ha=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.frete"}))[0].valor),za=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ha}),Qa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cmv"}))[0].valor),$a=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Qa}),Ua=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.creditoclientes"}))[0].valor),Ja=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ua}),Ga=await $db.formaPagamento.le(),qa=(w=this.contatos[e.idContato])==null?void 0:w.descontoCondicionadoPercentual;let ha=$utils.arredondar(A.reduce((o,n)=>o+n.totalDocumento,0));ha=$utils.arredondar(ha-e.totalDesconto);let ea=e.totalDocumento,W=[];const O=[],Na=[],Fa=[],ka=[];let va=1,Ea="",Da=1,oa="";for(const o of d.filter(n=>!n.sinal)){o.sinal=o.sinal||la;const n=Ga.filter(p=>p.id===o.idFormaPagamento)[0];if(ea<0)oa=$utils.uuid(),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idContato:e.idContato,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:U.id,dataEmissao:u,valorCredito:0,valorDebito:$utils.arredondar(ea*-1),descricao:U.descricao,observacao:`Movimenta\xE7\xE3o de d\xE9bito da devolu\xE7\xE3o de clientes no(s) pedido(s) da fatura c\xF3digo (${e.id})`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:o.dataVencimento,dataMovimento:o.dataVencimento,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idContato:e.idContato,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:Ja.id,dataEmissao:u,valorCredito:$utils.arredondar(ea*-1),valorDebito:0,descricao:`Cr\xE9dito proveniente de produtos devolvidos no(s) pedido(s) da fatura c\xF3digo (${e.id})`,observacao:"Movimenta\xE7\xE3o de cr\xE9dito na conta de clientes",automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:o.dataVencimento,dataMovimento:o.dataVencimento,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id});else{if(Ea!==o.idFormaPagamento+o.autorizacao&&(Ea=o.idFormaPagamento+o.autorizacao,va=1,Da=d.reduce((p,v)=>v.idFormaPagamento+v.autorizacao===Ea?p+1:p,0)),n.tipoFinanceiro==="T\xEDtulo Liquidado"&&(oa=$utils.uuid()),z>0){const p=$utils.uuid(),v=$utils.arredondar(o.valor*(z/ea));let _=0,f=0,D=0,g=0;if(n.tipo===5){let T=(await $erp().financeiroBanco.toArray()).find($=>$.codigoBanco===122);T&&(f=T.percentualMulta||0,g=T.percentualJuros||0,_=$utils.arredondar(f/100*v),D=$utils.arredondar(g/100*v))}W.push({id:p,idFinanceiroPlanoConta:ia.id,idContato:e.idContato,dataEmissao:u,dataCompetencia:C,dataVencimento:o.dataVencimento,dataVencimentoOriginal:o.dataVencimento,valor:v,valorTotal:v,valorARealizar:v,valorMulta:_,percentualMulta:f,valorJuros:D,percentualJuros:g,documentoId:e.id,documentoTipo:"Fatura",parcela:va+"/"+Da,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${o.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:e.idEmpresa,formaDePagamento:n.descricao,carne:n.tipo===5?1:0,dataEmissaoCarne:n.tipo===5?u:"",idDocumentoCaixa:r.id,idFinanceiroMovimentacaoAgrupamento:n.tipoFinanceiro==="T\xEDtulo Liquidado"?oa:""}),o.idFinanceiroTitulo=p,n.tipo===2&&Fa.push({idTitulo:p,idDocumentoCondicaoPagamento:o.id,valor:v,dataVencimento:o.dataVencimento,idBanco:o.idBanco,agencia:o.agencia,conta:o.conta,numeroCheque:o.numeroCheque,formaPagamento:n}),ka.push({idTitulo:p,valor:v,desconto:0})}if(ha>0){const p=$utils.uuid(),v=$utils.arredondar(o.valor*(ha/ea));let _=0,f=0,D=0,g=0;if(n.tipo===5){let T=(await $erp().financeiroBanco.toArray()).find($=>$.codigoBanco===122);T&&(f=T.percentualMulta||0,g=T.percentualJuros||0,_=$utils.arredondar(f/100*v),D=$utils.arredondar(g/100*v))}W.push({id:p,idFinanceiroPlanoConta:U.id,idContato:e.idContato,dataEmissao:u,dataCompetencia:C,dataVencimento:o.dataVencimento,dataVencimentoOriginal:o.dataVencimento,valor:v,valorTotal:v,valorARealizar:v,valorMulta:_,percentualMulta:f,valorJuros:D,percentualJuros:g,documentoId:e.id,documentoTipo:"Fatura",parcela:va+"/"+Da,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${o.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:e.idEmpresa,formaDePagamento:n.descricao,carne:n.tipo===5?1:0,dataEmissaoCarne:n.tipo===5?u:"",idDocumentoCaixa:r.id,idFinanceiroMovimentacaoAgrupamento:n.tipoFinanceiro==="T\xEDtulo Liquidado"?oa:"",descontoCondicionadoValor:qa>0?qa/100*v:0,descontoCondicionadoPercentual:qa}),o.idFinanceiroTitulo=p,n.tipo===2&&Fa.push({idTitulo:p,idDocumentoCondicaoPagamento:o.id,valor:v,dataVencimento:o.dataVencimento,idBanco:o.idBanco,agencia:o.agencia,conta:o.conta,numeroCheque:o.numeroCheque,formaPagamento:n})}if(n.tipoFinanceiro==="T\xEDtulo Liquidado"&&ha>=0){O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idEmpresa:e.idEmpresa,idContato:e.idContato,idFinanceiroPlanoConta:Y.id,idFinanceiroTitulo:o.idFinanceiroTitulo,dataEmissao:u,valorCredito:o.valor,valorDebito:0,descricao:Y.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:o.dataVencimento,dataMovimento:o.dataVencimento,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id});let p=n.idFinanceiroPlanoConta;n.tipo===1&&(r||{}).idFinanceiroPlanoContaCaixa&&(p=r.idFinanceiroPlanoContaCaixa);let v=await $db.financeiroPlanoConta.le({id:p});O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idEmpresa:e.idEmpresa,idContato:e.idContato,idFinanceiroPlanoConta:v.id,idFinanceiroTitulo:o.idFinanceiroTitulo,dataEmissao:u,valorCredito:0,valorDebito:o.valor,descricao:v.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:o.dataVencimento,dataMovimento:o.dataVencimento,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id});for(const _ of W)_.idFinanceiroMovimentacaoAgrupamento===oa&&(_.valorRealizado=_.valorARealizar,_.dataPagamento=o.dataVencimento,_.dataMovimento=o.dataVencimento,_.idDocumentoCaixaLiquidacao=r.id)}if(n.aliquota){const p=$utils.uuid(),v=$utils.arredondar(o.valor*(n.aliquota/100));if(W.push({id:p,idFinanceiroPlanoConta:n.idFinanceiroPlanoContaAliquota,idContato:n.idContatoOperadoraCartao,dataEmissao:u,dataCompetencia:C,dataVencimento:o.dataVencimento,dataVencimentoOriginal:o.dataVencimento,valor:v,valorTotal:v,valorARealizar:v,valorMulta:0,percentualJuros:0,documentoId:e.id,documentoTipo:"Fatura",parcela:va+"/"+Da,descricao:`T\xEDtulo referente a al\xEDquota da forma de pagamento: ${n.descricao}`,observacao:`T\xEDtulo referente a al\xEDquota. ${this.$refs.faturamento.observacaoFaturamento||""} ${o.observacao||""}`.trim(),documentoVinculado:1,receberPagar:0,valorDesconto:0,percentualDesconto:0,idEmpresa:e.idEmpresa,formaDePagamento:n.descricao,idDocumentoCaixa:r.id}),o.idFinanceiroTituloPagar=p,n.tipoFinanceiro==="T\xEDtulo Liquidado"){const _=$utils.uuid();O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:_,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:u,valorCredito:0,valorDebito:v,descricao:aa.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:o.dataVencimento,dataMovimento:o.dataVencimento,documentoTipo:"Fatura",documentoId:e.id,idFinanceiroTitulo:p,idContato:n.idContatoOperadoraCartao,idDocumentoCaixa:r.id});let f=n.idFinanceiroPlanoConta;n.tipo===1&&(r||{}).idFinanceiroPlanoContaCaixa&&(f=r.idFinanceiroPlanoContaCaixa);let D=await $db.financeiroPlanoConta.le({id:f});O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:_,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:D.id,dataEmissao:u,valorCredito:v,valorDebito:0,descricao:D.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:o.dataVencimento,dataMovimento:o.dataVencimento,documentoTipo:"Fatura",documentoId:e.id,idFinanceiroTitulo:p,idContato:n.idContatoOperadoraCartao,idDocumentoCaixa:r.id});for(const g of W)g.id===p&&(g.idFinanceiroMovimentacaoAgrupamento=_,g.valorRealizado=v,g.dataPagamento=o.dataVencimento,g.dataMovimento=o.dataVencimento,g.idDocumentoCaixaLiquidacao=r.id)}}va++}}const Oa=[];for(const o of Fa){const n=$utils.uuid(),p=$utils.uuid();for(const _ of W)_.id===o.idTitulo&&(_.idFinanceiroMovimentacaoAgrupamento=p,_.valorRealizado=_.valorARealizar,_.dataPagamento=u,_.dataMovimento=u,_.dataVencimento=u,_.dataVencimentoOriginal=u,_.idDocumentoCaixaLiquidacao=r.id);if(Oa.includes(o.idDocumentoCondicaoPagamento))continue;Oa.push(o.idDocumentoCondicaoPagamento);const v=$utils.arredondar(Fa.reduce((_,f)=>f.idDocumentoCondicaoPagamento===o.idDocumentoCondicaoPagamento?_+(f.valor||0):_,0));W.push({id:n,idFinanceiroPlanoConta:pa.id,idContato:e.idContato,dataEmissao:u,dataCompetencia:C,dataVencimento:o.dataVencimento,dataVencimentoOriginal:o.dataVencimento,valor:v,valorTotal:v,valorARealizar:v,valorMulta:0,percentualJuros:0,receberPagar:1,valorDesconto:0,percentualDesconto:0,documentoId:e.id,documentoTipo:"Fatura",idEmpresa:e.idEmpresa,formaDePagamento:o.formaPagamento.descricao,idDocumentoCaixa:r.id,cheque:1,idBanco:o.idBanco,agencia:o.agencia,conta:o.conta,numeroCheque:o.numeroCheque,observacao:`Liquida\xE7\xE3o de Cheques da Fatura #${e.id} - C\xF3digoN #${p}`,descricao:"Cheque"}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:p,idEmpresa:e.idEmpresa,idContato:e.idContato,idFinanceiroPlanoConta:pa.id,idFinanceiroTitulo:n,dataEmissao:u,valorCredito:0,valorDebito:v,descricao:"Cheque - Cr\xE9dito de t\xEDtulos a receber",observacao:"Cr\xE9dito de t\xEDtulos a receber",automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,idFinanceiroCheque:n,idDocumentoCaixa:r.id,documentoId:e.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:p,idEmpresa:e.idEmpresa,idContato:e.idContato,idFinanceiroPlanoConta:Y.id,idFinanceiroTitulo:n,dataEmissao:u,valorCredito:v,valorDebito:0,descricao:Y.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,idFinanceiroCheque:n,idDocumentoCaixa:r.id,documentoId:e.id})}if(z>0){const o=$utils.uuid();O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idContato:e.idContato,idFinanceiroPlanoConta:Y.id,dataEmissao:u,valorCredito:z,valorDebito:0,descricao:Y.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:1,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,idDocumentoCaixa:r.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idContato:e.idContato,idFinanceiroPlanoConta:ia.id,dataEmissao:u,valorCredito:0,valorDebito:z,descricao:ia.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica - Complemento",automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:"Renegocia\xE7\xE3o",documentoId:o,idDocumentoCaixa:r.id});for(const n of ka)Na.push({idFinanceiroMovimentacaoN:o,idFinanceiroTitulo:n.idTitulo,dataVencimento:u,valorOriginal:n.valor,valorDesconto:n.desconto,valorTotal:$utils.arredondar(n.valor-n.desconto)});for(const n of q){if(n.idFinanceiroMovimentacaoAgrupamento=o,n.idDocumentoCaixaLiquidacao=r.id,n.dataPagamento=u,n.dataMovimento=u,n.renegociado=1,n.cheque===1){n.valorRealizado=n.valor;continue}if(!n.valorARealizar){n.valorRealizado=n.valorTotal;continue}n.valorRealizado=n.valorARealizar}W=W.concat(q)}if(la===0){let o=$utils.uuid();const n=e.valorFrete||0;let p=0,v=0;const _=[];if(n>0&&(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:U.id,dataEmissao:u,valorCredito:0,valorDebito:n,descricao:U.descricao,observacao:`Lan\xE7amento frete da fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:za.id,dataEmissao:u,valorCredito:n,valorDebito:0,descricao:za.descricao,observacao:`Lan\xE7amento frete da fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id})),!t){o=$utils.uuid();for(const f of this.documentoItens){let D="",g={},T="",$={},S="",X={};const da=await $db.item.leNew({id:f.idItem});if(D=f.idPlanoContaEstoque,!D){const G=await $db.perfilContabilItem.le({idPerfilContabil:da.idPerfilContabil,idCfop:f.idCfop,and:{idPerfilContabil:da.idPerfilContabil,idCfop:f.idCfop}});G.length&&G[0].idPlanoContaEstoque&&(D=G[0].idPlanoContaEstoque)}if(!D&&Ia.id&&(D=Ia.id),!D&&f.idCfop&&(D=(await $db.cfop.le({id:f.idCfop})).idPlanoContaEstoque),g=await $db.financeiroPlanoConta.le({id:D}),!g.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Estoque.");return}if(T="",!T){const G=await $db.perfilContabilItem.le({idPerfilContabil:da.idPerfilContabil,idCfop:f.idCfop,and:{idPerfilContabil:da.idPerfilContabil,idCfop:f.idCfop}});G.length&&G[0].idPlanoContaDespesa&&(T=G[0].idPlanoContaDespesa)}if(!T&&$a.id&&(T=$a.id),!T&&f.idCfop&&(T=(await $db.cfop.le({id:f.idCfop})).idPlanoContaDestino),$=await $db.financeiroPlanoConta.le({id:T}),!$.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Despesa.");return}const ya=$utils.arredondar(f.total-(f.descontoTotalRateado||0)-(f.descontoFaturaRateado||0)),Ca=$utils.arredondar(f.valorCustoMedio*f.quantidade);if(Ca){if(f.operacaoFator<0?(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:g.id,dataEmissao:f.dataHoraFinalizado||u,valorCredito:Ca,valorDebito:0,descricao:g.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${e.id}) e item (${f.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:e.tipo,documentoId:e.id,idDocumentoCaixa:r.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:$.id,dataEmissao:f.dataHoraFinalizado||u,valorCredito:0,valorDebito:Ca,descricao:$.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${e.id}) e item (${f.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:e.tipo,documentoId:e.id,idDocumentoCaixa:r.id})):(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:g.id,dataEmissao:f.dataHoraFinalizado||u,valorCredito:0,valorDebito:Ca,descricao:g.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${e.id}) e item (${f.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:e.tipo,documentoId:e.id,idDocumentoCaixa:r.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:$.id,dataEmissao:f.dataHoraFinalizado||u,valorCredito:Ca,valorDebito:0,descricao:$.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${e.id}) e item (${f.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:e.tipo,documentoId:e.id,idDocumentoCaixa:r.id})),S=f.idPlanoContaDestino,!S){const ta=await $db.perfilContabilItem.le({idPerfilContabil:da.idPerfilContabil,idCfop:f.idCfop,and:{idPerfilContabil:da.idPerfilContabil,idCfop:f.idCfop}});ta.length&&ta[0].idPlanoContaDespesa&&(S=ta[0].idPlanoContaDespesa)}if(!S&&$a.id&&(S=$a.id),!S&&f.idCfop&&(S=(await $db.cfop.le({id:f.idCfop})).idPlanoContaDestino),X=await $db.financeiroPlanoConta.le({id:S}),!X.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Receita.");return}let G=!0;for(const ta of _)if(ta.idPlanoContaDestino===X.id&&ta.idPlanoContaEstoque===g.id){ta.valor=$utils.arredondar(ta.valor+ya),G=!1;break}G&&_.push({idPlanoContaDestino:X.id,idPlanoContaEstoque:g.id,valor:ya}),p+=ya}}for(const f of _)f.valor<0&&(v+=f.valor);for(const f of _)if(f.valor>0){const D=await $db.financeiroPlanoConta.le({id:f.idPlanoContaDestino}),g=$utils.arredondar(v*(f.valor/(p||1)));if(g>0){O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:U.id,dataEmissao:u,valorCredito:0,valorDebito:g,descricao:U.descricao,observacao:`Lan\xE7amento entrada faturamento geral da devolu\xE7\xE3o referente fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:D.id,dataEmissao:u,valorCredito:g,valorDebito:0,descricao:D.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de destino referente fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id});for(const T of d)O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:U.id,dataEmissao:u,valorCredito:0,valorDebito:$utils.arredondar((f.valor-g)*(T.valor/(ea||1))),descricao:U.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:T.dataVencimento,dataMovimento:T.dataVencimento,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:D.id,dataEmissao:u,valorCredito:$utils.arredondar((f.valor-g)*(T.valor/(ea||1))),valorDebito:0,descricao:D.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:T.dataVencimento,dataMovimento:T.dataVencimento,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id})}else for(const T of d){const $=$utils.arredondar(f.valor*(T.valor/(ea||1)));O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:U.id,dataEmissao:u,valorCredito:0,valorDebito:$,descricao:U.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:T.dataVencimento,dataMovimento:T.dataVencimento,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:o,idEmpresa:e.idEmpresa,idFinanceiroPlanoConta:D.id,dataEmissao:u,valorCredito:$,valorDebito:0,descricao:D.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${e.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:T.dataVencimento,dataMovimento:T.dataVencimento,documentoTipo:"Fatura",documentoId:e.id,idDocumentoCaixa:r.id})}}}}if(this.financeiroTitulo=W,this.financeiroMovimentacao=O,this.financeiroRenegociacao=Na,this.fatura=e,this.vendas=A,this.carnes=q,!t){await this.salvarFatura(),$utils.emitter.emit("desativarBotoesFaturaModal");try{let n,p,v,_;if(n=await $db.configuracoes.porNome("integracao.bten.business"),p=(k=(y=n[0])==null?void 0:y.valor)!=null?k:!1,n=await $db.configuracoes.porNome("integracao.bten.authorization"),v=(I=(P=n[0])==null?void 0:P.valor)!=null?I:!1,_=p&&v,_){const f=[],D=this.contatos[e.idContato],g=await $api.bten.send(D,e);for(let T=0;T<g.length;T++){const $=g[T];$.status?f.push($.telefone):this.$q.notifyError(`Falha ao enviar NPS para ${$.telefone}!`)}f.length&&this.$q.notifyPositive(`NPS enviado para ${f.join(",")}!`)}}catch(n){n.name==="GeeksException"&&this.$q.notifyAlert(`N\xE3o foi poss\xEDvel enviar NPS: ${n.message}`),n.name!=="GeeksException"&&this.$q.notifyError("N\xE3o foi possivel enviar NPS para o contato.",n)}let o;if(r!=null&&r.idCaixa){const n=await $erp().caixa.get(r==null?void 0:r.idCaixa);n!=null&&n.id&&(o=$db.caixa.tiposCaixa[Number(n.tipo)])}if(this.vendas.length&&~["SAT","NFCe"].indexOf(o))try{const n=s;await this.$refs.documentosFiscais.emitirCupom(this.fatura.id,n)}catch(n){console.error(n)}finally{if(s){const n=[];for(const p of this.$refs.faturamento.condicaoPagamento)!p.tefRetorno||n.some(v=>v.tefRetorno===p.tefRetorno)||n.push(p);for(const p of n){let v;!p.tefRetorno||(v=j.extrairComprovante(p.tefRetorno),v&&await j.oper("print",{content:v,opts:{txt:!0}}))}}}this.$q.notifyPositive("Fatura finalizada")}return!0}catch(e){this.$q.notifyError("N\xE3o foi poss\xEDvel finalizar a fatura",e)}finally{this.$q.loading.hide()}}};const ft={components:{Avatar:Ra,DocumentoCodigo:Ya,DocumentoMetas:ao,DocumentosFiscais:co,Faturamento:oo,TituloCard:ut,VendaCard:fo},computed:{config(){return $db.configuracoes.valores},descontoSomenteLeitura(){let t=!1;return t=this.fatura.status==="Aberta",t||(t=this.fatura.status==="Aguardando Pagamento"&&this.permissaoDescontoFaturaSinal),!t}},data(){return{contatos:{},faturaOriginal:{},fatura:{totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0},vendas:[],vendasOriginal:[],envelopes:[],envelopesOriginal:[],documentoItens:[],documentoItensOriginal:[],carnes:[],carnesOriginal:[],documentoStatus:[],erroCalculo:!1,erroCalculoMsg:"",sistemaPai:"",configImpressaoCarne:[],configImpressaoConvenio:[],configImpressaoFatura:[],configImpressaoEnvelope:[],permissaoDesconto:!1,permissaoDescontoFaturaSinal:!1,pesoTotal:null,pesoBrutoTotal:null,metroCubicoTotal:null}},emits:["executar"],mixins:[mo],methods:{async calcularPesoTotal(){var F,M;const t=await $erp().documento.where({idFatura:this.fatura.id}).toArray(),i=[],s={};let h=0,a=0;for(const b of t){const w=await $erp().documentoItem.where({idDocumento:b.id}).toArray();for(const y of w)i.push(y)}for(const b of i)if(b.operacaoFator===-1){if(b.idItem&&!s[b.idItem]){const w=await $erp().item.get(b.idItem);w&&(s[b.idItem]=w)}h+=(((F=s[b.idItem])==null?void 0:F.peso)||0)*(b.quantidade||0),a+=(((M=s[b.idItem])==null?void 0:M.pesoBruto)||0)*(b.quantidade||0)}h=$utils.arredondar(h,4),a=$utils.arredondar(a,4),this.pesoTotal=h?$filters.numeroZerosDireita(h,4,2):null,this.pesoBrutoTotal=a?$filters.numeroZerosDireita(a,4,2):null},async calcularMetroCubicoTotal(){var a,F,M;const t=await $erp().documento.where({idFatura:this.fatura.id}).toArray(),i=[],s={};let h=0;for(const b of t){const w=await $erp().documentoItem.where({idDocumento:b.id}).toArray();for(const y of w)i.push(y)}for(const b of i){if(b.operacaoFator!==-1||b.tipoItem!=="Produto")continue;if(b.idItem&&!s[b.idItem]){const k=await $erp().item.get(b.idItem);k&&(s[b.idItem]=k)}const w=((a=s[b.idItem])==null?void 0:a.altura)*((F=s[b.idItem])==null?void 0:F.largura)*((M=s[b.idItem])==null?void 0:M.comprimento)||0,y=b.quantidade||0;h+=w>0?w*y:0}h=$utils.arredondar(h,4),this.metroCubicoTotal=h?$filters.numeroZerosDireita(h,4,2):null},atualizarDocumentoMetas(){!this.$refs.documentoMetas||(this.$refs.documentoMetas.documento=$utils.clonarV2(this.fatura))},...mt,async atualizar(){let t=!1;if(this.permissaoDesconto=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura"),this.permissaoDescontoFaturaSinal=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura_Sinal"),this.vendas=[],this.envelopes=[],this.envelopesOriginal=[],this.documentoItens=[],this.documentoitensOriginal=[],this.carnes=[],this.carnesOriginal=[],this.documentoStatus=[],this.contatos={},this.erroCalculo=!1,this.erroCalculoMsg="",this.prop.id){const i=await $db.fatura.leCompleto(this.prop.id);this.faturaOriginal=$utils.clonar(i.fatura),this.fatura=i.fatura,this.$refs.faturamento&&(this.$refs.faturamento.condicaoPagamentoOriginal=$utils.clonar(i.condicaoPagamento),this.$refs.faturamento.condicaoPagamento=i.condicaoPagamento),this.vendasOriginal=$utils.clonar(i.vendas),this.vendas=i.vendas.sort((h,a)=>new Date(h.dataHoraFinalizado)<new Date(a.dataHoraFinalizado)?-1:1),this.receberTitulo.id&&!i.carnes.find(h=>h.id===this.receberTitulo.id)&&(i.carnes.push(await $db.financeiroTitulo.le({id:this.receberTitulo.id})),t=!0),this.carnesOriginal=$utils.clonar(i.carnes),this.carnes=i.carnes.sort((h,a)=>new Date(h.dataVencimento)<new Date(a.dataVencimento)?-1:1);const s={};if(i.fatura.idContato){const h=i.fatura.idContato;s[h]||(s[h]=await $db.contato.le({id:h}))}this.configuraImpressaoCarne(i.fatura.idEmpresa),this.configuraImpressaoConvenio(i.fatura.idEmpresa),this.configuraImpressaoEnvelope(i.fatura.idEmpresa),this.configuraImpressaoFatura(i.fatura.idEmpresa),this.contatos=s,await this.atualizarDocumentoMetas(),await this.calculaTotais(),await this.calcularPesoTotal(),await this.calcularMetroCubicoTotal(),t&&await this.salvarFatura()}},async executar(t){if(t==="recalcular"){if(this.prop.id){const i=await $db.fatura.leCompleto(this.prop.id);this.carnesOriginal=$utils.clonar(i.carnes),this.carnes=i.carnes,await this.calculaTotais()}}else await this.atualizar(),this.$emit("executar",t)},async calculaTotais(t){const i=$utils.arredondar(this.vendas.reduce((h,a)=>h+a.totalDocumento||0,0)),s=$utils.arredondar(this.carnes.reduce((h,a)=>h+a.valorARealizar||0,0));t||(this.fatura.subTotal=$utils.arredondar(i+s),t="desconto"),t==="descontoPercentual"&&(this.fatura.totalDesconto=$utils.arredondar((this.fatura.totalPercentualDesconto||0)/100*this.fatura.subTotal)),t==="desconto"&&(this.fatura.totalPercentualDesconto=$utils.arredondar((this.fatura.totalDesconto||0)/this.fatura.subTotal*100)),this.fatura.totalDocumento=$utils.arredondar(this.fatura.subTotal-(this.fatura.totalDesconto||0)),this.erroCalculo=!1,this.erroCalculoMsg="",this.fatura.totalDesconto!==0&&(i===0&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto n\xE3o permitido para fatura sem venda"),i>0&&this.fatura.totalDesconto>i&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto maior que o total das vendas")),this.fatura.totalDesconto!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculo=!0);try{await this.$refs.faturamento.resumeCondicaoPagamento(),await this.$refs.faturamento.atualizaValorRestante(),await this.$refs.faturamento.redefinirCampos()}catch{}},async configuraImpressaoConvenio(t){const i=await $db.configuracoes.porNome("impressao.convenio",t);this.configImpressaoConvenio=[...i.length?i.map(s=>({texto:"Imprimir Conv\xEAnio",...s})):[{valor:"convenio",texto:"Imprimir Conv\xEAnio"}]]},async configuraImpressaoCarne(t){const i=await $db.configuracoes.porNome("impressao.carne",t);this.configImpressaoCarne=[...i.length?i.map(s=>({texto:"Imprimir Carn\xEA",...s})):[{valor:"carne-crediario",texto:"Reimprimir carn\xEA e notas promiss\xF3rias da fatura"}]]},async configuraImpressaoEnvelope(t){const i=await $db.configuracoes.porNome("impressao.envelope",t);this.configImpressaoEnvelope=[...i.length?i.map(s=>({texto:"Imprimir Envelope",...s})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoFatura(t){const i=await $db.configuracoes.porNome("impressao.fatura",t);this.configImpressaoFatura=[...i.length?i.map(s=>({texto:"Imprimir Fatura",...s})):[{valor:"invoice",texto:"Fatura (Invoice)"},{valor:"fatura-recibo",texto:"Recibo"},this.sistemaPai==="optisoul"?{valor:"termoGarantia",texto:"Termo de Garantia"}:{}]]},async reabrir(t){var i;if(!((i=this.fatura)!=null&&i.id)){this.$q.notifyError("N\xE3o foi poss\xEDvel encontrar o ID da fatura");return}if(!t)try{$q.loading.show(),await to({idDocumento:this.fatura.id})}catch(s){this.$q.notifyError(s.message);return}finally{$q.loading.hide()}if(!t)try{await new Promise((s,h)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 reabrir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{s()}).onCancel(()=>{h()})})}catch{return}try{this.$q.loading.show({message:"Processando..."});const s=$utils.clonar(this.fatura),h=$utils.clonar(this.vendas),a=$utils.clonar(this.envelopes),F=$utils.clonar(this.documentoItens),M=this.$refs.faturamento.condicaoPagamento.filter(P=>P.valor);if(!t){const P=[];M.reduce((I,e)=>(e.idDocumentoCaixa&&!I[e.idDocumentoCaixa]&&(I[e.idDocumentoCaixa]=!0,P.push($db.documento.ler({id:e.idDocumentoCaixa}))),I),{});for await(const I of P)if(I.status!=="Aberto")return this.$q.notify({message:"N\xE3o \xE9 poss\xEDvel reabrir fatura de caixas fechados!"}),!1}try{await $db.fatura.checarTitulosLiquidados({condicoesPagamento:this.$refs.faturamento.condicaoPagamentoOriginal})}catch(P){$q.notifyError(P.message);return}let b=[],w=[],y=[];if(!t){b=await $db.financeiroTitulo.le({documentoId:s.id});for(const r of b)if(r.idFinanceiroBoleto){const d=await $erp().financeiroBoleto.get(r.idFinanceiroBoleto),z=await $db.financeiroBanco.le({id:d.idFinanceiroBanco}),B=await $db.banco.le({id:z.idBanco}),la=d.revisao,Z=B.baixa,wa=B.registro;if(d.remessaOperacao!==Z){const ia=r.idFinanceiroBoleto,ma=$utils.uuid(),Y={id:ma,idFinanceiroBanco:d.idFinanceiroBanco,nossoNumero:d.nossoNumero,nossoNumeroDv:d.nossoNumeroDv,revisao:la+1,idEmpresa:d.idEmpresa,idContato:d.idContato,empresaNome:d.empresaNome,empresaNumeroDocumento:d.empresaNumeroDocumento,contatoNome:d.contatoNome,contatoNumeroDocumento:d.contatoNumeroDocumento,contatoLogradouro:d.contatoLogradouro,contatoCEP:d.contatoCEP,contatoBairro:d.contatoBairro,contatoCidade:d.contatoCidade,contatoUF:d.contatoUF,dataEmissao:$utils.dataAtual(),dataVencimento:d.dataVencimento,dataImpressao:d.dataImpressao,valor:d.valor,valorJuros:d.valorJuros,tipoJuros:d.tipoJuros,valorMulta:d.valorMulta,valorDesconto:d.valorDesconto,valorTotal:d.valorTotal,codigoBarras:d.codigoBarras,linhaDigitavel:d.linhaDigitavel,mensagem1:d.mensagem1,mensagem2:d.mensagem2,mensagem3:d.mensagem3,mensagem4:d.mensagem4,mensagem5:d.mensagem5,gerarRemessa:1,remessaOperacao:Z};await $db.financeiroBoleto.grava({atual:Y});let ba=[];ia&&(ba=await $db.financeiroTitulo.le({idFinanceiroBoleto:ia}));for(const aa of ba){const fa=$utils.clonar(aa);aa.idFinanceiroBoleto=ma;let pa=[];ia&&(pa=await $db.financeiroBoletoTitulo.le({idFinanceiroBoleto:ia}));for(const Pa of pa){const U={id:$utils.uuid(),idFinanceiroBoleto:ma,idFinanceiroTitulo:Pa.idFinanceiroTitulo};await $db.financeiroBoletoTitulo.grava({atual:U})}await $db.financeiroTitulo.grava({atual:aa,original:fa})}if(d.remessaOperacao===wa&&d.gerarRemessa===1)for(const aa of[d,Y]){const fa={...aa,gerarRemessa:0};await $db.financeiroBoleto.grava({original:aa,atual:fa})}}}let P=[];this.$refs.faturamento.idDocumentoCaixa&&(P=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa})),b=await $db.financeiroTitulo.le({idFatura:s.id});let I=await $db.financeiroTitulo.le({idFatura:s.id});for(const r of $utils.clonar(b)){if(!r.idFinanceiroMovimentacaoAgrupamento)continue;const d=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento});for(const z of d){const B=await $db.financeiroTitulo.le({id:z.idFinanceiroTitulo});B.idDocumentoCaixa===this.$refs.faturamento.idDocumentoCaixa&&(b=b.concat(B))}}let e=!1;for(const r of M){const d=await $db.financeiroTitulo.le({id:r.idFinanceiroTitulo});if(Object.keys(d).length){let z=[];z=P.filter(B=>B.idFinanceiroMovimentacaoN===d.idFinanceiroMovimentacaoAgrupamento),w=w.concat(z),z=P.filter(B=>B.idFinanceiroTitulo===d.id),w=w.concat(z),z=P.filter(B=>B.idFinanceiroCheque===d.id),w=w.concat(z),b=b.concat(d)}r.idFinanceiroTitulo="",r.sinal===1&&(e=!0)}I=await $db.financeiroTitulo.le({idFatura:s.id,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const r of I){if(!r.idFinanceiroMovimentacaoAgrupamento)continue;const d=await $db.financeiroMovimentacao.le({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento});w=w.concat(d);const z=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento});y=y.concat(z)}if(I=await $db.financeiroTitulo.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:s.id}),b=b.concat(I),s.id){let r=await $db.financeiroMovimentacao.lerV2({documentoTipo:"Devolu\xE7\xE3o",documentoId:s.id});w=w.concat(r),r=await $db.financeiroMovimentacao.lerV2({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:s.id}),w=w.concat(r),r=await $db.financeiroMovimentacao.lerV2({documentoId:s.id});for(const d of r)(await $db.financeiroTitulo.le({id:d.idFinanceiroTitulo})).id||(w=w.concat(d))}const A=await $db.documento.ler({idFatura:s.id});for(const r of A){const d=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:r.id});w=w.concat(d)}let q=[];for(const r in b){const d=b[r].id;q.includes(d)?delete b[r]:q.push(d)}b=b.filter(r=>r),q=[];for(const r in w){const d=w[r].id;q.includes(d)?delete w[r]:q.push(d)}w=w.filter(r=>r),q=[];for(const r in y){const d=y[r].id;q.includes(d)?delete y[r]:q.push(d)}y=y.filter(r=>r);let u=$utils.dataAtual(),C=e?"Aguardando Pagamento":"Aberta";this.documentoStatus=[{id:$utils.uuid(),idDocumento:s.id,operacao:"Fatura",statusOriginal:s.status,statusFinalizado:C,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}],s.status=C,C==="Aberta"&&(s.dataHoraFinalizado=""),C=e?"Aguardando Pagamento":"Aguardando Faturamento";for(const r of h)this.documentoStatus.push({id:$utils.uuid(),idDocumento:r.id,operacao:"Venda de Mercadoria",statusOriginal:r.status,statusFinalizado:C,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),r.status=C;for(const r of F)r.status=C;this.fatura=s,this.vendas=h,this.envelopes=a,this.documentoItens=F}if(this.$q.loading.hide(),t&&await this.finalizar(t),this.$q.loading.show({message:"Processando..."}),t){let P=[],I=[],e=[],A=[],q=[],u=[];P=this.$refs.faturamento.condicaoPagamento.map(C=>C.id),I=this.$refs.faturamento.condicaoPagamentoOriginal.filter(C=>!P.includes(C.id));for(const C of I)if(C.idFinanceiroTitulo&&e.push(C.idFinanceiroTitulo),C.idFormaPagamento){let r;r=await $erp().formaPagamento.get(C.idFormaPagamento),(r||{}).aliquota&&(C.idFinanceiroTituloPagar?e.push(C.idFinanceiroTituloPagar):this.$q.notify("N\xE3o foi poss\xEDvel excluir as movimenta\xE7\xF5es referentes \xE0 aliquota. Exclua-as manualmente."))}for(const C of e){let r;if(r=await $erp().financeiroTitulo.get(C),r.id&&A.push(r),r.idFinanceiroMovimentacaoAgrupamento){let d,z;if(d=await $erp().financeiroMovimentacao.where({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento}).toArray(),z=(d.find(B=>B.idFinanceiroCheque)||{}).idFinanceiroCheque,z){let B=await $erp().financeiroTitulo.get(z);B.id&&A.push(B)}q.push(...d)}}for(let C of this.carnes){if(!C.id||(C=await $erp().financeiroTitulo.get(C.id),!(C||{}).idFinanceiroMovimentacaoAgrupamento))continue;let r,d;r=await $erp().financeiroMovimentacao.where({idFinanceiroMovimentacaoN:C.idFinanceiroMovimentacaoAgrupamento}).toArray(),d=await $erp().financeiroRenegociacao.where({idFinanceiroMovimentacaoN:C.idFinanceiroMovimentacaoAgrupamento}).toArray(),q.push(...r),u.push(...d)}await $db.financeiroTitulo.remove(A),await $db.financeiroMovimentacao.remove(q),await $db.financeiroRenegociacao.remove(u)}else{await $db.financeiroTitulo.remove(b.filter(P=>!(P.carne&&P.idFatura===s.id))),await $db.financeiroMovimentacao.remove(w),await $db.financeiroRenegociacao.remove(y);for(const P of b.filter(I=>I.carne&&I.idFatura===s.id))await $db.financeiroTitulo.grava({original:P,atual:{valorRealizado:0,receberPagar:1,dataPagamento:""}})}const k=[];for(const P of M)!P.tefRetorno||k.some(I=>I.tefRetorno===P.tefRetorno)||k.push(P);for(const P of k){let I,e,A;if(I=j.extrairCampo("valorTransacao",P.tefRetorno),e=j.extrairCampo("dataTransacao",P.tefRetorno),A=j.extrairCampo("nsu",P.tefRetorno),I&&e&&A){const q=await j.oper("cnc",{idTransacao:`2${this.fatura.id}`,tefRetorno:P.tefRetorno});let u,C,r,d=!1;if(u=j.extrairCampo("mensagemOperador",q.fileContent),C=j.extrairComprovante(q.fileContent),r=j.extrairCampo("codigoAutorizacao",q.fileContent),A=j.extrairCampo("nsu",q.fileContent),d=C&&r&&A,u&&$q.notify({message:u,type:d?"positive":"negative"}),!d)return;d&&(this.$refs.faturamento.condicaoPagamento=[],await j.oper("print",{content:C,opts:{txt:!0}}))}}return await this.salvarFatura(),await this.atualizar(),t?this.$q.notifyPositive("Fatura corrigida."):this.$q.notifyPositive("Fatura reaberta."),!0}catch{this.$q.notify("N\xE3o foi poss\xEDvel reabrir a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async corrigir(){let t,i,s,h;if(t=this.$refs.faturamento.condicaoPagamentoOriginal,i=this.$refs.faturamento.condicaoPagamento,h=$utils.arredondar(this.fatura.totalDocumento||0),s=$utils.arredondar(i.reduce((a,F)=>a+F.valor||0,0)),s!==h){this.$q.notify("Total das condi\xE7\xF5es de pagamento difere do total da fatura");return}if(t.length){let a=!1;i.length||(a=!0);for(const F of i)if(!t.find(M=>M.id===F.id)){a=!0;break}if(!a){this.$q.notify("N\xE3o h\xE1 corre\xE7\xE3o a ser realizada");return}}try{return await new Promise((a,F)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 corrigir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{F()})}),await this.reabrir(!0),!0}catch{return!1}},async salvarFatura(){try{this.$q.loading.show({message:"Processando..."});let t=$utils.clonar(this.$refs.faturamento.condicaoPagamento.filter(s=>s.valor));for(let s in t)delete t[s].idDocumentoCondicaoPagamento,delete t[s].parcelas,delete t[s].formaPagamento,delete t[s].edicao,delete t[s].codigoDocumento,delete t[s].codigoDocumentoCaixa;this.fatura.observacaoFaturamento=this.$refs.faturamento.observacaoFaturamento;const i=(this.carnesOriginal||[]).filter(s=>(this.financeiroTitulo||[]).find(h=>h.id===s.id));if(await $db.fatura.grava({faturaOriginal:this.faturaOriginal,fatura:this.fatura,vendasOriginal:this.vendasOriginal,vendas:this.vendas,envelopesOriginal:this.envelopesOriginal,envelopes:this.envelopes,documentoItensOriginal:this.documentoItensOriginal,documentoItens:this.documentoItens,condicaoPagamentoOriginal:this.$refs.faturamento.condicaoPagamentoOriginal,condicaoPagamento:t,documentoStatus:this.documentoStatus,financeiroTitulo:this.financeiroTitulo,financeiroTituloOriginal:i,financeiroMovimentacao:this.financeiroMovimentacao,financeiroRenegociacao:this.financeiroRenegociacao}),this.receberTitulo.id){let s=this.carnes.find(h=>h.id===this.receberTitulo.id);s.id&&await $db.financeiroTitulo.grava({original:s,atual:{idFatura:this.fatura.id}})}}catch{this.$q.notify("N\xE3o foi poss\xEDvel salvar a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}}},props:{prop:{default:()=>({}),required:!0,type:Object},receberTitulo:{default:()=>({}),type:Object}},mounted(){this.sistemaPai=$utils.sistemaPai(),this.atualizar()}},pt={class:"Fatura round-borders bg-grey-2 q-pb-sm"},ht={class:"row items-center"},vt={class:"col q-ma-sm q-title"},Ct=c("div",{class:"text-h5"},null,-1),gt={class:"bg-grey-2"},bt={class:"q-ma-sm"},$t={key:0,class:"q-item-label",style:{color:"#0c0c0c"}},Ft={key:1,class:"q-item-label q-mt-md",style:{color:"#0c0c0c"}},Dt={class:"col-12 col-md-4 border-1 q-ma-md"},_t=c("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Subtotal",-1),Tt={class:"col-8 text-right"},wt=c("div",{class:"col-4 col-lg-3",style:{"line-height":"50px"}},"Desconto",-1),Pt={class:"col-3"},qt={class:"col-5"},Et=c("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Total",-1),yt={class:"col-8 q-mt-sm text-right"},xt=c("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Total",-1),Mt={class:"col-8 q-mt-sm text-right"},Vt=c("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Bruto Total",-1),It={class:"col-8 q-mt-sm text-right"},zt=c("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Metro C\xFAbico Total",-1),Nt={class:"col-8 q-mt-sm text-right"},kt={class:"Fatura-faturamento round-borders q-ma-sm q-pa-md"},Ot={class:"round-borders q-ma-sm q-pa-md"};function Rt(t,i,s,h,a,F){const M=L("avatar"),b=L("documento-codigo"),w=L("documento-metas"),y=L("venda-card"),k=L("titulo-card"),P=L("row"),I=L("campo"),e=L("faturamento"),A=L("documentos-fiscais");return E(),Q("div",pt,[l(na,{class:"Fatura-barra bg-grey-2 q-py-md",color:"black",dark:""},{default:m(()=>[l(ra,null,{default:m(()=>[c("div",ht,[l(M,{imagem:(a.contatos[a.fatura.idContato]||{}).imagem,rotulo:a.fatura.descricaoContato,tamanho:"60"},null,8,["imagem","rotulo"]),c("div",vt,x(a.fatura.descricaoContato),1)]),Ct]),_:1}),a.fatura.id?(E(),N(b,{key:0,documento:a.fatura},null,8,["documento"])):V("",!0),l(H,{color:"tertiary",flat:"",icon:"more_vert",round:""},{default:m(()=>[l(Aa,null,{default:m(()=>[l(Ba,{link:"",separator:""},{default:m(()=>[a.fatura.id?(E(),N(ca,{key:0,clickable:"",onClick:i[0]||(i[0]=q=>t.$refs.documentosFiscais.emitirCupom(a.fatura.id))},{default:m(()=>[l(K,{avatar:""},{default:m(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:m(()=>[l(ua,null,{default:m(()=>[R("Emitir cupom")]),_:1})]),_:1})]),_:1})):V("",!0),a.fatura.id&&t.$utils.mapearStatus(a.fatura).permiteNota?(E(),Q(sa,{key:1},[l(ca,{clickable:"",onClick:i[1]||(i[1]=q=>t.emitirNFeV2({idFatura:a.fatura.id},1,"Venda"))},{default:m(()=>[l(K,{avatar:""},{default:m(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:m(()=>[l(ua,null,{default:m(()=>[R("NFe de Sa\xEDda/Venda")]),_:1})]),_:1})]),_:1}),l(ca,{clickable:"",onClick:i[2]||(i[2]=q=>t.emitirNFeV2({idFatura:a.fatura.id},0,"Devolu\xE7\xE3o"))},{default:m(()=>[l(K,{avatar:""},{default:m(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:m(()=>[l(ua,null,{default:m(()=>[R("NFe de Entrada/Devolu\xE7\xE3o")]),_:1})]),_:1})]),_:1}),l(ca,{clickable:"",onClick:i[3]||(i[3]=q=>t.emitirNFeV2({idFatura:a.fatura.id},1,"Remessa"))},{default:m(()=>[l(K,{avatar:""},{default:m(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:m(()=>[l(ua,null,{default:m(()=>[R("NFe de Remessa")]),_:1})]),_:1})]),_:1})],64)):V("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),c("div",gt,[l(w,{ref:"documentoMetas"},null,512)]),c("div",bt,[a.vendas.length>0?(E(),Q("p",$t,[l(J,{name:"shopping_cart",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),R(" Vendas ")])):V("",!0),(E(!0),Q(sa,null,xa(a.vendas,q=>(E(),Q("div",{key:q.id,class:"bg-white q-mt-sm round-borders"},[l(y,{id:q.id,onAtualizar:F.atualizar,onExecutar:F.executar},null,8,["id","onAtualizar","onExecutar"])]))),128)),a.carnes.length>0?(E(),Q("p",Ft,[l(J,{name:"attach_money",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),R(" Carn\xEAs ")])):V("",!0),(E(!0),Q(sa,null,xa(a.carnes,q=>(E(),Q("div",{key:q.id,class:"bg-white q-mt-sm round-borders"},[l(k,{dados:q,class:"q-mt-md",onExecutar:F.executar},null,8,["dados","onExecutar"])]))),128))]),l(P,{class:"justify-end"},{default:m(()=>[c("div",Dt,[l(P,{class:"q-col-gutter-md q-mb-sm"},{default:m(()=>[_t,c("strong",Tt,x(t.$filters.numero(a.fatura.subTotal,2)),1)]),_:1}),a.permissaoDesconto?(E(),N(P,{key:0,class:"q-col-gutter-x-sm"},{default:m(()=>[wt,c("div",Pt,[l(I,{modelValue:a.fatura.totalPercentualDesconto,"onUpdate:modelValue":[i[4]||(i[4]=q=>a.fatura.totalPercentualDesconto=q),i[5]||(i[5]=q=>F.calculaTotais("descontoPercentual"))],tipo:"decimal",decimals:"2",suffix:"%","somente-leitura":F.descontoSomenteLeitura,error:a.erroCalculo},null,8,["modelValue","somente-leitura","error"])]),c("div",qt,[l(I,{modelValue:a.fatura.totalDesconto,"onUpdate:modelValue":[i[6]||(i[6]=q=>a.fatura.totalDesconto=q),i[7]||(i[7]=q=>F.calculaTotais("desconto"))],tipo:"decimal",decimals:"2","somente-leitura":F.descontoSomenteLeitura,error:a.erroCalculo,errorMessage:a.erroCalculoMsg},null,8,["modelValue","somente-leitura","error","errorMessage"])])]),_:1})):V("",!0),l(P,{class:"q-col-gutter-x-sm q-mt-sm"},{default:m(()=>[Et,c("strong",yt,x(t.$filters.numero(a.fatura.totalDocumento,2)),1)]),_:1}),a.pesoTotal?(E(),N(P,{key:1,class:"q-col-gutter-x-sm q-mt-sm"},{default:m(()=>[xt,c("span",Mt,x(a.pesoTotal),1)]),_:1})):V("",!0),a.pesoBrutoTotal?(E(),N(P,{key:2,class:"q-col-gutter-x-sm q-mt-sm"},{default:m(()=>[Vt,c("span",It,x(a.pesoBrutoTotal),1)]),_:1})):V("",!0),a.metroCubicoTotal?(E(),N(P,{key:3,class:"q-col-gutter-x-sm q-mt-sm"},{default:m(()=>[zt,c("span",Nt,x(a.metroCubicoTotal),1)]),_:1})):V("",!0)])]),_:1}),c("div",kt,[l(e,{documento:a.fatura,ref:"faturamento"},null,8,["documento"])]),c("div",Ot,[l(A,{ref:"documentosFiscais",idFatura:a.fatura.id},null,8,["idFatura"])])])}var At=Va(ft,[["render",Rt]]);const Bt={components:{CpfCnpjNoCupom:uo,Fatura:At},data(){return{fatura:{},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:"",tipoCaixa:""},dinheiroTef:{mostrar:!1,valor:0},permissaoTef:!1,visivel:!1,visibilidade:{botao:{finalizar:!1,reabrir:!1,corrigir:!1}},temPermissaoCorrigir:!1}},emits:["executar"],methods:{async atualizar(){let t;try{t=setTimeout(()=>{$q.loading.show({message:"Carregando informa\xE7\xF5es...",boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})},500);let i=this.id?await $db.documento.ler({id:this.id}):{};this.fatura=i,await this.verificarPermissoes(),this.desativarBotoes(),i.status==="Aberta"&&(this.visibilidade.botao.salvar=!0),i.status==="Finalizada"||i.status!=="Aguardando Pagamento"&&i.dataHoraFinalizado?this.visibilidade.botao.reabrir=!0:this.visibilidade.botao.finalizar=!0,await $db.contato.exibirCondutaObservacao(i.idContato,$q.notify)}finally{clearTimeout(t),$q.loading.hide()}},desativarBotoes(){this.visibilidade.botao.finalizar=!1,this.visibilidade.botao.reabrir=!1,this.visibilidade.botao.salvar=!1},desativarEsc(){this.lockEsc=!0},reativarEsc(){this.lockEsc=!1},async reabrir(){await this.$refs.fatura.reabrir(),await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"))},voltar(t){t.stopPropagation(),!this.lockEsc&&this.fechar()},async finalizarTef(t){t==="dinheiro"&&(this.dinheiroTef.valor=0,this.dinheiroTef.mostrar=!0),t==="cpfCnpj"&&(this.dinheiroTef.mostrar=!1,this.cpfCnpjNoCupom={visivel:!0,incluirCpfCnpjNoCupom:!1,idEmpresa:this.fatura.idEmpresa,cpfCnpj:this.fatura.numeroDocumentoContato,nomeCliente:this.fatura.descricaoContato,tipoCaixa:""})},async finalizar(t){var a;const{tef:i}=t!=null?t:{},s=!1,h={tef:i,cpfCnpjNoCupom:this.cpfCnpjNoCupom,valorDinheiro:(a=this.dinheiroTef.valor)!=null?a:0};if(this.lockEsc=!0,!await this.$refs.fatura.finalizar(s,h)){this.lockEsc=!1;return}this.$emit("executar","finalizar"),this.fechar()},async executar(t){switch(t){case"finalizar":if(!await this.$refs.fatura.finalizar())return;break;case"retornarOrcamento":case"remover":await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"));return}this.$emit("executar",t),this.fechar()},fechar(){this.visivel=!1},async mostrar(t={}){this.id=t.id,await this.atualizar(),this.visivel=!0},onHide(){this.fatura={},this.visibilidade={botao:{finalizar:!1,reabrir:!1,corrigir:!1}},this.temPermissaoCorrigir=!1,this.runOnHide.forEach(t=>t()),this.runOnHide=[]},async salvar(){try{await new Promise((t,i)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 salvar esta fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{t()}).onCancel(()=>{i()})})}catch{return}await this.$refs.fatura.salvarFatura(),this.$emit("executar","atualizar"),this.fechar()},corrigir(){this.$refs.fatura.corrigir().then(()=>{this.$emit("executar","atualizar"),this.fechar()})},async verificarPermissoes(){const t=await $erp().formaPagamento.toArray();this.temPermissaoCorrigir=await $db.permissao.objeto("caixa/tesouraria"),this.permissaoTef=t.some(i=>i.idContatoEmpresa===this.fatura.idEmpresa&&i.ativo&&i.tef)}},props:{receberTitulo:{default:()=>({}),type:Object}},created(){this.runOnHide=[]},mounted(){$utils.emitter.on("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.on("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.on("reativarVoltarEscModal",this.reativarEsc)},beforeUnmount(){$utils.emitter.off("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.off("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.off("reativarVoltarEscModal",this.reativarEsc)}},St={class:"layout-padding q-pa-none q-pb-xl"},Lt={class:"u-container"},jt={class:"q-gutter-xs"},Ht={class:"col-12"},Qt={class:"q-mt-lg text-right"};function Ut(t,i,s,h,a,F){const M=L("fatura"),b=L("campo"),w=L("row"),y=L("CpfCnpjNoCupom");return E(),Q(sa,null,[l(Ma,{modelValue:a.visivel,"onUpdate:modelValue":i[1]||(i[1]=k=>a.visivel=k),maximized:"",persistent:"",onKeyup:so(F.voltar,["esc"]),onHide:F.onHide},{default:m(()=>[l(io,{container:"",class:"bg-grey-4"},{default:m(()=>[l(eo,null,{default:m(()=>[l(na,null,{default:m(()=>[_a(l(H,{dense:"",flat:"",icon:"arrow_back",round:"",clikable:""},null,512),[[Ta]]),l(ra,null,{default:m(()=>[R("Fatura")]),_:1}),a.visibilidade.botao.salvar?(E(),N(H,{key:0,unelevated:"",color:"white","text-color":"primary",label:"Salvar",onClick:F.salvar},null,8,["onClick"])):V("",!0),a.visibilidade.botao.reabrir&&a.temPermissaoCorrigir?(E(),N(H,{key:1,unelevated:"",color:"white","text-color":"negative",label:"Corrigir",onClick:F.corrigir},null,8,["onClick"])):V("",!0)]),_:1})]),_:1}),l(no,null,{default:m(()=>[c("div",St,[c("div",Lt,[a.fatura.id?(E(),N(M,{key:0,prop:{id:a.fatura.id},receberTitulo:s.receberTitulo,ref:"fatura",onExecutar:F.executar},null,8,["prop","receberTitulo","onExecutar"])):V("",!0)])])]),_:1}),l(ro,null,{default:m(()=>[l(na,{class:"footer",style:{background:"#eee !important"}},{default:m(()=>[l(ra,{class:"text-right"},{default:m(()=>[a.visibilidade.botao.reabrir?(E(),N(H,{key:0,class:"q-mx-md",color:"negative",flat:"",label:"Reabrir",onClick:F.reabrir},null,8,["onClick"])):V("",!0),c("div",jt,[a.visibilidade.botao.reabrir?V("",!0):(E(),N(H,{key:0,disabled:!a.visibilidade.botao.finalizar,color:"primary",label:"Finalizar",onClick:F.finalizar},null,8,["disabled","onClick"])),!a.visibilidade.botao.reabrir&&a.permissaoTef?(E(),N(H,{key:1,disabled:!a.visibilidade.botao.finalizar,color:"primary",label:"Finalizar TEF",onClick:i[0]||(i[0]=k=>F.finalizarTef("dinheiro"))},null,8,["disabled"])):V("",!0)])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup","onHide"]),l(Ma,{modelValue:a.dinheiroTef.mostrar,"onUpdate:modelValue":i[4]||(i[4]=k=>a.dinheiroTef.mostrar=k)},{default:m(()=>[l(Sa,null,{default:m(()=>[l(na,{class:"bg-primary text-white"},{default:m(()=>[l(ra,null,{default:m(()=>[R("Dinheiro")]),_:1})]),_:1}),l(lo,null,{default:m(()=>[l(La,{onSubmit:i[3]||(i[3]=k=>F.finalizarTef("cpfCnpj"))},{default:m(()=>[l(w,{class:"q-col-gutter-md"},{default:m(()=>[c("div",Ht,[l(b,{modelValue:a.dinheiroTef.valor,"onUpdate:modelValue":i[2]||(i[2]=k=>a.dinheiroTef.valor=k),before:[{icon:"attach_money"}],rotulo:"Valor",tipo:"decimal",decimals:"2"},null,8,["modelValue"])])]),_:1}),c("div",Qt,[_a(l(H,{color:"tertiary",flat:"",label:"Cancelar"},null,512),[[Ta]]),l(H,{color:"primary",class:"q-ml-sm",unelevated:"",label:"Ok",type:"submit"})])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(y,{modelValue:a.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":i[5]||(i[5]=k=>a.cpfCnpjNoCupom.visivel=k),dados:a.cpfCnpjNoCupom,onConfirmar:i[6]||(i[6]=k=>F.finalizar({tef:!0}))},null,8,["modelValue","dados"])],64)}var Wt=Va(Bt,[["render",Ut]]);export{Wt as F,ut as T};
