import{_ as z,cP as K,cQ as V,p as k,W,o as d,i as b,w as m,f as l,K as Y,x as p,V as Z,A as ee,B as R,C as j,D as w,L as H,E as L,e as y,G as oe,H as ae,d as E,F as S,aA as te,Q as re,l as D,y as G,S as ie,Z as N,s as ne,aK as se,r as $,ct as ce,cn as c,bd as A,aN as T,b$ as g,cu as le,Y as h,cp as v,co as P,$ as M,cr as me,ch as ue,cl as F,cm as I,aP as _,cR as pe,j as U,aj as O,t as C,k as x,ai as J,aF as de,ak as Q,ah as fe}from"./index.2840a24b.js";import{C as Ce}from"./Campo.6b70276b.js";import{c as X,a as q}from"./compactarValidarNFe.49f061d2.js";import{a as he,g as ge,b as Ne,o as ve,d as Fe,e as Ee,c as we,f as Pe,h as _e,i as be,t as ye}from"./obterItens.d8cf8f28.js";const Se={components:{Campo:Ce},data(){return{cpfCnpjErro:!1,tipoCaixa:""}},emits:["confirmar","update:modelValue"],methods:{eventoConfirmar(){if(!this.dados.incluirCpfCnpjNoCupom)this.dados.cpfCnpj="",this.dados.nomeCliente="";else if(!!this.dados.cpfCnpj&&!K(this.dados.cpfCnpj)){this.cpfCnpjErro=!0;return}this.eventoInput(!1),this.$emit("confirmar",this.dados)},eventoInput(e){this.$emit("update:modelValue",e)}},watch:{async modelValue(){let e;!this.modelValue||(e=this.dados.tipoCaixa,e==="SAT"&&(e=await V.hwDest(this.dados.idEmpresa)),this.tipoCaixa=e,this.cpfCnpjErro=!1)}},props:{modelValue:{required:!0,type:Boolean},dados:{required:!0,type:Object}}},De={class:"row q-pa-sm"},Ie={class:"row q-col-gutter-x-sm"},xe={class:"row q-col-gutter-x-sm"};function qe(e,t,a,r,o,n){const s=k("campo"),u=W("mask");return d(),b(G,{"model-value":a.modelValue,"onUpdate:modelValue":n.eventoInput},{default:m(()=>[l(Y,{container:"",class:"bg-white"},{default:m(()=>[p("form",{onSubmit:t[4]||(t[4]=Z((...i)=>n.eventoConfirmar&&n.eventoConfirmar(...i),["prevent"]))},[l(ee,null,{default:m(()=>[l(R,null,{default:m(()=>[j(l(w,{flat:"",round:"",dense:"",icon:"arrow_back"},null,512),[[H]]),l(L,null,{default:m(()=>[y("CPF/CNPJ no Cupom")]),_:1}),l(w,{color:"white","text-color":"primary",label:`Emitir ${o.tipoCaixa}`,type:"submit",unelevated:""},null,8,["label"])]),_:1})]),_:1}),l(oe,null,{default:m(()=>[l(ae,{class:"q-pa-md"},{default:m(()=>[p("div",De,[l(s,{modelValue:a.dados.incluirCpfCnpjNoCupom,"onUpdate:modelValue":t[0]||(t[0]=i=>a.dados.incluirCpfCnpjNoCupom=i),class:"col-12",rotulo:"Incluir CPF/CNPJ no cupom",tipo:"logico"},null,8,["modelValue"])]),a.dados.incluirCpfCnpjNoCupom?(d(),E(S,{key:0},[p("div",Ie,[l(te,{class:"col-12",error:o.cpfCnpjErro,"error-label":"CPF/CNPJ inv\xE1lido"},{default:m(()=>[j(l(re,{label:"CPF / CNPJ",modelValue:a.dados.cpfCnpj,"onUpdate:modelValue":[t[1]||(t[1]=i=>a.dados.cpfCnpj=i),t[2]||(t[2]=i=>o.cpfCnpjErro=!1)]},null,8,["modelValue"]),[[u,["###.###.###-##","##.###.###/####-##"]]])]),_:1},8,["error"])]),p("div",xe,[l(s,{modelValue:a.dados.nomeCliente,"onUpdate:modelValue":t[3]||(t[3]=i=>a.dados.nomeCliente=i),class:"col-12",rotulo:"Nome"},null,8,["modelValue"])])],64)):D("",!0)]),_:1})]),_:1})],32)]),_:1})]),_:1},8,["model-value","onUpdate:modelValue"])}var Te=z(Se,[["render",qe]]);const Ve={components:{SeletorCest:ie},computed:{campos(){return this.modal.campos}},data(){return{itens:[]}},emits:["confirmar"],methods:{async atualizar(){try{this.$lodash.get(this.campos,"ids.length")?(this.itens=await N().item.where("id").anyOf(this.campos.ids).toArray(),this.itensOriginal=this.$utils.clonarV2(this.itens)):this.itens=[]}catch(e){this.$q.notifyError("Erro ao carregar os dados",e)}},async confirmar(){this.$utils.gconsole.log("ItemTrocarCest","confirmar",this.itens);for(const e in this.itens)!!this.itens[e].cest&&this.itens[e].cest!==this.itensOriginal[e].cest&&$db.item.gravaItem({atual:this.itens[e],original:this.itensOriginal[e]});this.modal.visivel=!1,this.$emit("confirmar")}},props:{modal:{required:!0,type:Object}},watch:{"modal.visivel"(e){e&&this.atualizar()}},mounted(){this.atualizar()}},$e={class:"bg-white q-mx-md q-pa-md"};function ke(e,t,a,r,o,n){const s=k("campo"),u=k("SeletorCest");return d(),b(G,{modelValue:a.modal.visivel,"onUpdate:modelValue":t[1]||(t[1]=i=>a.modal.visivel=i),maximized:""},{default:m(()=>[l(ne,null,{default:m(()=>[l(R,{class:"bg-primary text-white"},{default:m(()=>[j(l(w,{flat:"",round:"",dense:"",icon:"arrow_back"},null,512),[[H]]),l(L,{class:"q-mx-sm"},{default:m(()=>[y("Selecionar CEST para os itens")]),_:1}),l(w,{class:"q-ml-sm no-shadow",color:"white","text-color":"primary",label:"Salvar",onClick:t[0]||(t[0]=i=>e.tryLoading(n.confirmar,{erro:"Ocorreu erro ao salvar CEST"}))})]),_:1}),l(se,{class:"text-body1 q-mx-lg q-my-sm"},{default:m(()=>[p("div",$e,[(d(!0),E(S,null,$(o.itens,i=>(d(),E("div",{key:i.id,class:"q-col-gutter-x-sm items-baseline row"},[l(s,{"model-value":i.descricao,rotulo:"Descri\xE7\xE3o",class:"col-12 col-md-6","apenas-leitura":""},null,8,["model-value"]),l(s,{"model-value":i.ncm,rotulo:"NCM",class:"col-12 col-md-3","apenas-leitura":""},null,8,["model-value"]),l(u,{modelValue:i.cest,"onUpdate:modelValue":f=>i.cest=f,class:"col-12 col-md-3",ncm:i.ncm},null,8,["modelValue","onUpdate:modelValue","ncm"])]))),128))])]),_:1})]),_:1})]),_:1},8,["modelValue"])}var Ae=z(Ve,[["render",ke]]),B={tipo:"NFCe",serie:"nfce.padrao.serie",homologacao:"nfce.homologacao",usadesconto:"nfce.usadesconto",gerarAutorizacaoDownload:he,gerarConfiguracaoImposto:ge,gerarNumeroNFe:Ne,obterConfiguracaoImpostoV2:ve,obterObservacoesFigurasFiscais:Fe,obterValoresAproximadosTributos:Ee,obterFatura:we,obterFormasPagamento:Pe,obterFrete:_e,obterItens:be,async gerarJson(e,t,a){const r=ce("gerarJsonNFCe",e,t,a);try{c(!e,"Fatura n\xE3o fornecida");const o=A.iniciarCampos({idDocumento:e,cpfCnpjCliente:t,nomeCliente:a,totalDesconto:0,totalDevolucao:0,totalProdutos:0,totalServicos:0,alertas:[],erros:[],cache:{},outrosNFe:{},infNFe:X.executa(T.infNFe,{},"NFCe")},"gerarNFCeFatura");g.log("gerarJsonNFCeD","iniciarCampos",o),await this.acertoInicial(o),await this.obterFatura(o),await this.obterEmitente(o),await this.obterDestinatario(o,t,a);const n=[];if(await this.obterItens(o,n),n.length)throw $utils.emitter.emit("confrontarFigurasFiscais",n),new Error("Figura fiscal n\xE3o encontrada");return await this.obterFormasPagamento(o),await this.obterFrete(o),await this.gerarNumeroNFe(o.infNFe),await this.gerarAutorizacaoDownload(o.infNFe,o.outrosNFe.idContatoEmitente),ye.calculaTotais(o.infNFe,o.outrosNFe,T),this.obterObservacoesNFe(o),this.obterValoresAproximadosTributos(o),this.obterObservacoesFigurasFiscais(o),await A.acertarDadosNFe(o.infNFe,o.outrosNFe,"NFCe"),o.infNFe=q.executa(T.infNFe,o.infNFe),o.erros=q.erros,g.log("gerarJsonNFCeD","infNFe",o.infNFe),g.log("gerarJsonNFCeD","compactarValidarNFe.erros",q.erros),o}finally{le(r,1)}},async acertoInicial(e){var o;g.log("gerarJsonNFeD","acertoInicial"),e.infNFe.ide.tpNF="1",e.infNFe.ide.finNFe="1",e.infNFe.ide.tpAmb=await h.configuracoes.leValorNumerico(this.homologacao)===1?"2":"1",e.infNFe.ide.mod="65",e.infNFe.ide.tpImp="4",e.infNFe.ide.dhEmi=A.formatarDataNFe(new Date),c(!e.idDocumento,"Ops! N\xE3o foi encontrado o c\xF3digo do documento (venda/fatura).");const t=await $erp().documento.get(e.idDocumento);let a=[];t.tipo==="Venda"&&a.push(t),t.tipo==="Fatura"&&(a=await N().documento.where({idFatura:e.idDocumento}).toArray());let r;for(const n of a){const s=Number(n==null?void 0:n.codigoDocumentoOperacao);if(Number.isInteger(s)&&s>0){const u=await $erp().documentoOperacao.where({codigoDocumentoOperacao:s}).toArray();r||(r=u[0]),c((r==null?void 0:r.finalidade)!==((o=u[0])==null?void 0:o.finalidade),"Vendas possuem opera\xE7\xF5es com finalidades diferentes.")}}e.idCfopVenda=r==null?void 0:r.idCfop,c(!e.idCfopVenda,"Erro na configura\xE7\xE3o do sistema. Sem defini\xE7\xE3o do CFOP de venda.")},async gerarJsonCancelamento(e){const t={infEvento:{cOrgao:e.infNFe.ide.cUF,tpAmb:e.infNFe.ide.tpAmb,escolhas:{valor_escolha:e.infNFe.emit.escolhas.valor_escolha,CNPJ:e.infNFe.emit.escolhas.CNPJ,CPF:e.infNFe.emit.escolhas.CPF},chNFe:e.outrosNFe.chNFe,dhEvento:A.formatarDataNFe(new Date),nSeqEvento:"1",detEvento:{nProt:e.outrosNFe.nProt_emissao,xJust:"Nota cancelada devido divergencia de informacoes"}}};return t.infEvento=X.executa(T.infEvento,t.infEvento,"NFCe"),t.infEvento=q.executa(T.infEvento,t.infEvento),e.erros=q.erros,g.log("gerarJsonNFCeD","infNFe",e.infNFe),g.log("gerarJsonNFCeD","compactarValidarNFe.erros",q.erros),t.infEvento},obterObservacoesNFe(e){if(e.outrosNFe.dadosAdicionaisEmitente="",e.empresa.observacaoNFE){let t=v(e.empresa.observacaoNFE);t=`[${t}]`,e.outrosNFe.dadosAdicionaisEmitente+=t}},async obterConfiguracaoImposto(e){g.log("gerarJsonNFCeD","obterConfiguracaoImposto");const t=`Produto '${e.documentoItem.descricaoItem||""}'`;c(!e.item.ncm,`${t} sem cadastro de NCM`);const a=await N()._ncm.where("ncm").equals(e.item.ncm).first();c(!a,`${t} com NCM '${e.item.ncm||""}' inv\xE1lido`),e.documentoItem.idCfop||(e.documentoItem.idCfop=e.idCfopVenda);const r=await N().cfop.get(e.documentoItem.idCfop);c(!r,`${t} com CFOP inv\xE1lido`),g.log("gerarJsonNFCeD",`dadosNcm.id: ${a.id} dadosCfop.id: ${r.id} dados.empresa.id: ${e.empresa.id}`);const o=await N().impostoConfiguracao.where("idNcm").equals(a.id).filter(i=>i.idCfop===r.id&&i.idEmitente===e.empresa.id&&i.ufOrigem===e.empresa.enderecoPrincipal.uf&&i.ufDestino===e.empresa.enderecoPrincipal.uf).first();g.log("gerarJsonNFCeD","impostoConfiguracao",o);const n=`Verifique a configura\xE7\xE3o do imposto para NCM: ${e.item.ncm||""}, CFOP: ${r.cfop||""}, CNPJ: ${e.empresa.numeroDocumentoNacional||""}, UF origem: ${e.empresa.enderecoPrincipal.uf||""}, UF destino: ${e.empresa.enderecoPrincipal.uf||""}.`;c(!o,`${t} sem configura\xE7\xE3o de imposto. ${n}`);const s=e.det.prod,u=e.det.imposto;try{if(s.CFOP=(r.cfop||0).toString(),u.noXml_orig=await this.obterImpostoParametro(e,o.idOrigem),u.noXml_CST=u.noXml_CSOSN=await this.obterImpostoParametro(e,o.idCst),u.noXml_pICMS=o.aliqIcmsUFOrigem||o.aliqIcms||0,u.noXml_pRedBC=o.percRedBcIcms||0,u.noXml_pFCP=o.aliqFcp||0,u.noXml_CSTPis=await this.obterImpostoParametro(e,o.idTipoTribPis),u.noXml_pPIS=o.aliqPis||0,u.noXml_CSTCofins=await this.obterImpostoParametro(e,o.idTipoTribCofins),u.noXml_pCOFINS=o.aliqCofins||0,o.idCest){const i=await this.obterImpostoParametro(e,o.idCest);i&&(s.opcional.visivel=!0,s.opcional.CEST=P(i))}}catch(i){console.error(i),c(!0,`${t} com erro na configura\xE7\xE3o de imposto. ${n}`)}},async obterDestinatario(e,t,a){var s;if(e.destinatario={},!t){e.infNFe.dest.visivel=!1;return}const r=e.documentoFatura.idContato;r&&(e.destinatario=await N().contato.get(r),e.destinatario&&(e.destinatario.enderecos=await N().contatoEndereco.where("idContato").equals(r).toArray(),e.destinatario.enderecoPrincipal=e.destinatario.enderecos.find(u=>u.grupo==="Principal"),e.destinatario.enderecoPrincipal||(e.destinatario.enderecoPrincipal=e.destinatario.enderecos[0]||{}),e.destinatario.telefones=await N().contatoTelefone.where("idContato").equals(r).toArray(),e.destinatario.telefonePrincipal=e.destinatario.telefones.find(u=>u.grupo==="Principal"),e.destinatario.telefonePrincipal||(e.destinatario.telefonePrincipal=e.destinatario.telefones[0]||{}),g.log("gerarJsonNFCeD","dados.destinatario",e.destinatario)));const o=e.infNFe.dest;o.visivel=!0;const n=P(t);n.length===11?(o.escolhas.valor_escolha="CPF",o.escolhas.CPF=n,o.indIEDest="9"):n.length===14?(o.escolhas.valor_escolha="CNPJ",o.escolhas.CNPJ=n,o.indIEDest="9"):c(!0,"Destinatario com CPF/CNPJ inv\xE1lido"),n===P(e.destinatario.numeroDocumentoNacional)&&(o.escolhas.valor_escolha==="CNPJ"&&!!e.destinatario.numeroDocumentoEstadual&&(o.IE=P(e.destinatario.numeroDocumentoEstadual)),o.xNome=v(a||e.destinatario.nome),!(!e.destinatario.enderecoPrincipal.uf||!e.destinatario.enderecoPrincipal.ibgeCod)&&(o.enderDest.visivel=!0,o.email=(e.destinatario.emailNfe||e.destinatario.email||"").trim(),o.enderDest.fone=P(e.destinatario.telefonePrincipal.telefone||""),o.enderDest.xLgr=v(e.destinatario.enderecoPrincipal.logradouro),o.enderDest.nro=(e.destinatario.enderecoPrincipal.numero||"SN").trim(),o.enderDest.xCpl=v(e.destinatario.enderecoPrincipal.complemento),o.enderDest.xBairro=v(e.destinatario.enderecoPrincipal.bairro),o.enderDest.cMun=String(e.destinatario.enderecoPrincipal.ibgeCod||"").trim(),o.enderDest.xMun=v(e.destinatario.enderecoPrincipal.municipio),o.enderDest.UF=(e.destinatario.enderecoPrincipal.uf||"").trim(),o.enderDest.CEP=P(e.destinatario.enderecoPrincipal.cep||""),o.enderDest.cPais=String((s=e.destinatario.enderecoPrincipal.codigoPais)!=null?s:"")||"1058",o.enderDest.xPais=(e.destinatario.enderecoPrincipal.pais||"").trim()||"Brasil"))},async obterEmitente(e){var r;g.log("gerarJsonNFCeD","obterEmitente");const t=e.documentoFatura.idEmpresa;if(c(!t,"Fatura sem empresa emitente"),e.empresa=await N().contato.get(t),c(!e.empresa,"N\xE3o foi poss\xEDvel carregar a empresa emitente"),e.outrosNFe.idContatoEmitente=t,e.empresaPlat=await M.empresa.where({idContato:t}).first(),!e.empresaPlat){const o=JSON.parse(localStorage.getItem("clienteSistema"));e.empresaPlat=await M.empresa.where({codigoContato:e.empresa.codigoContato}).filter(n=>n.codigoClienteSistema===o.codigoClienteSistema).first()}c(!e.empresaPlat,"N\xE3o foi poss\xEDvel carregar a empresa emitente"),e.infNFe.ide.tpAmb==="1"?(c(!e.empresaPlat.hashCSCProducao,"Empresa emitente sem hashCSC de produ\xE7\xE3o cadastrado"),c(!e.empresaPlat.tokenCSCProducao,"Empresa emitente sem tokenCSC de produ\xE7\xE3o cadastrado"),e.empresaPlat.hashCSC=e.empresaPlat.hashCSCProducao,e.empresaPlat.tokenCSC=e.empresaPlat.tokenCSCProducao):(c(!e.empresaPlat.hashCSCHomologacao,"Empresa emitente sem hashCSC de homologa\xE7\xE3o cadastrado"),c(!e.empresaPlat.tokenCSCHomologacao,"Empresa emitente sem tokenCSC de homologa\xE7\xE3o cadastrado"),e.empresaPlat.hashCSC=e.empresaPlat.hashCSCHomologacao,e.empresaPlat.tokenCSC=e.empresaPlat.tokenCSCHomologacao),e.empresa.enderecos=await N().contatoEndereco.where("idContato").equals(t).toArray(),c(!e.empresa.enderecos||e.empresa.enderecos.length===0,"N\xE3o foi poss\xEDvel carregar o endere\xE7o da empresa emitente"),e.empresa.enderecoPrincipal=e.empresa.enderecos.find(o=>o.grupo==="Principal"),e.empresa.enderecoPrincipal||(e.empresa.enderecoPrincipal=e.empresa.enderecos[0]||{}),e.empresa.telefones=await N().contatoTelefone.where("idContato").equals(t).toArray()||[],e.empresa.telefonePrincipal=e.empresa.telefones.find(o=>o.grupo==="Principal"),e.empresa.telefonePrincipal||(e.empresa.telefonePrincipal=e.empresa.telefones[0]||{}),g.log("gerarJsonNFCeD","dados.empresa",e.empresa),c(!e.empresa.numeroDocumentoNacional,"Empresa emitente sem CNPJ cadastrado"),c(!e.empresa.numeroDocumentoEstadual,"Empresa emitente sem Inscri\xE7\xE3o Estadual cadastrado"),c(!e.empresa.nome,"Empresa emitente sem Raz\xE3o Social (nome) cadastrado"),c(!e.empresa.enderecoPrincipal.uf,"Empresa emitente sem UF cadastrado"),c(!e.empresa.enderecoPrincipal.ibgeCod,"Empresa emitente sem c\xF3digo do munic\xEDpio cadastrado"),c(!e.empresa.regime,"Empresa emitente sem regime cadastrado");const a=e.infNFe.emit;a.escolhas.CNPJ=P(e.empresa.numeroDocumentoNacional),a.IE=P(e.empresa.numeroDocumentoEstadual),a.CRT=e.empresa.regime==="SimplesNacional"?"1":"3",a.xNome=v(e.empresa.nome),a.xFant=v(e.empresa.apelido),a.email=(e.empresa.email||"").trim(),a.enderEmit.fone=P(e.empresa.telefonePrincipal.telefone),a.enderEmit.xLgr=v(e.empresa.enderecoPrincipal.logradouro),a.enderEmit.nro=(e.empresa.enderecoPrincipal.numero||"SN").trim(),a.enderEmit.xCpl=v(e.empresa.enderecoPrincipal.complemento),a.enderEmit.xBairro=v(e.empresa.enderecoPrincipal.bairro),a.enderEmit.cMun=String(e.empresa.enderecoPrincipal.ibgeCod||"").trim(),a.enderEmit.xMun=v(e.empresa.enderecoPrincipal.municipio),a.enderEmit.UF=(e.empresa.enderecoPrincipal.uf||"").trim(),a.enderEmit.CEP=P(e.empresa.enderecoPrincipal.cep),a.enderEmit.cPais=String((r=e.empresa.enderecoPrincipal.codigoPais)!=null?r:"")||"1058",a.enderEmit.xPais=v(e.empresa.enderecoPrincipal.pais||"Brasil"),e.infNFe.ide.cMunFG=a.enderEmit.cMun,e.infNFe.ide.cUF=String(me[a.enderEmit.UF])},async obterImpostoParametro(e,t){c(!t,"Configura\xE7\xE3o de imposto sem informa\xE7\xE3o completa");let a=e.cache[t];if(!a){const r=await N().impostoParametro.get(t);a=r?r.numero.trim():void 0,e.cache[t]=a}return c(!a,"Configura\xE7\xE3o de imposto inv\xE1lida"),a},async obterMeioPagamento(e,t){g.log("gerarJsonNFCeD","obterMeioPagamento",t),c(!t,"Forma de pagamento inv\xE1lida");let a=e.cache[t];if(a)return a;const r=await N().formaPagamento.get(t);c(!r||!r.descricao,"N\xE3o foi poss\xEDvel carregar a forma de pagamento");const o=r.descricao.toLowerCase();return a=o.includes("dinheiro")?"01":o.includes("d\xE9bito")?"04":o.includes("cr\xE9dito de clientes")?"01":o.includes("cr\xE9dito")?"03":o.includes("cart\xE3o")&&Number(r.parcelamentoMaximo||0)===1?"04":o.includes("cart\xE3o")&&Number(r.parcelamentoMaximo||0)>1?"03":"99",e.cache[t]=a,console.log("codigoMeioPagamento: ",a),a},async obterAliquotasTributosIbpt(e,t){g.log("gerarJsonNFCeD","obterValorAproxTributos",t);const a=await N().nfeIbpt.where("codigo").equals(Number(t.prod.NCM)).toArray();if(this.verificarAlerta(!a||a.length===0,`N\xE3o encontrado al\xEDquotas para calculo do valor aproximado de tributos do NCM: ${t.prod.NCM}. Atualize sua tabela IBPT.`,e))return;const r=a.filter(s=>s.idContato===e.empresa.id),n=(r.length?r:a).reduce((s,u)=>!s||s.vigenciaFim<u.vigenciaFim?u:s,null);this.verificarAlerta(n.vigenciaFim<ue(),`Informa\xE7\xF5es vencidas para para o calculo do valor aproximado de tributos do NCM: ${t.prod.NCM}. Atualize sua tabela IBPT.`,e),t.imposto.noXml_pTribImp=Number(n.importadosFederal||0),t.imposto.noXml_pTribFed=Number(n.nacionalFederal||0),t.imposto.noXml_pTribEst=Number(n.estadual||0),t.imposto.noXml_pTribMun=Number(n.municipal||0)},verificarAlerta(e,t,a){return e&&(a.alertas||(a.alertas=[]),a.alertas.push(t),console.warn(t)),e}};const Oe={components:{CpfCnpjNoCupom:Te,ItemTrocarCest:Ae},computed:{config(){return h.configuracoes.valores}},data(){return{configImpressaoNFe:[],documentosSat:[],documentosFiscais:[],documentosNFe:[],hwDest:"",modalItemTrocarCest:{visivel:!1,campos:{}},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:""}}},methods:{abrirNFe(e){$utils.emitter.emit("abrirNFe",e)},async atualiza(){const e=this.idFatura||this.idVenda;if(e){const a=await h.documentoFiscalEletronico.ler({idDocumento:e});this.documentosFiscais=a.sort((s,u)=>Number(u.nNF)-Number(s.nNF));const r=await h.documentoSat.ler({idDocumento:e}),o=r.filter(s=>s.cancelamento).map(s=>s.chaveCupomCancelado),n=r.filter(s=>!o.includes(s.chaveCupom));this.documentosSat=n.sort((s,u)=>u.numeroCupom-s.numeroCupom)}const t=await h.documento.ler({id:e});await this.configuraImpressao(t.idEmpresa),this.hwDest=await V.hwDest(t.idEmpresa)},async cancelarSat(e){try{await new Promise((a,r)=>{$q.dialog({title:"Tem certeza?",message:"Ao continuar voc\xEA ir\xE1 cancelar este cupom",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONFIRMAR",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{r()})})}catch{return}let t="Erro no cupom";try{F.show({spinner:I,spinnerColor:"amber",message:"Cancelando o cupom"});const a=this.documentosSat.find(n=>n.id===e),r={NumeroPDV:1,ChaveAcessoCFe:a.chaveCupom,CPF_CNPJ:"",Total:a.valorTotal};t="Ocorreu um erro ao cancelar o cupom";const o=await _.cancelarSat(JSON.stringify(r),a.idEmpresa);c(o.status==="Erro",o.mensagem),this.$q.notifyPositive(o.mensagem),t="Ocorreu um erro ao gravar os dados do cancelamento do cupom",await V.salvarRetornoCancelamento(this.idFatura,o.chaveCFe,o.xml),(o==null?void 0:o.versaoIntegrador)==="V2"&&await _.imprimirCancelamentoSat(o.xml,a.idEmpresa)}catch(a){this.$q.notifyError(t,a)}finally{F.hide(),this.atualiza()}},async cancelarNFCe(e){try{await new Promise((a,r)=>{this.$q.dialog({title:"Tem certeza?",message:"Ao continuar voc\xEA ir\xE1 cancelar este cupom",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONFIRMAR",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{r()})})}catch{return}let t="Erro no NFCe";try{F.show({spinner:I,spinnerColor:"amber",message:"Selecionando Certificado e Cancelando NFCe"});const a=JSON.parse(this.documentosFiscais.find(o=>o.id===e).json);if(a.infEvento=await B.gerarJsonCancelamento(a),c(!a.infEvento,t),a.erros.length){$g.modalAlerta.show({titulo:"Erro de valida\xE7\xE3o",erros:a.erros});return}t="Ocorreu um erro ao cancelar o NFCe";const r=await _.cancelarNFCe(a);if(r.status==="Erro"){const o=[...(r.mensagem||"").split(`
`),...(r.complemento||"").split(`
`)];$g.modalAlerta.show({titulo:r.status,erros:o});return}this.$q.notifyPositive(r.mensagem)}catch(a){this.$q.notifyError(t,a)}finally{F.hide(),this.atualiza()}},async configuraImpressao(e){const t=await h.configuracoes.porNome("impressao.nfe",e);this.configImpressaoNFe=t.length?t.map(a=>({texto:"Imprimir DANFE",...a})):[{valor:"nfe-danfe",texto:"DANFE"},{valor:"nfe-danfe-simplificado",texto:"DANFE Simplificado"},{valor:"duplicata-mercantil",texto:"Duplicata Mercantil"}]},async emitirCupom(e,t){try{const a=await h.documento.ler({id:e});c(!a||!a.status,"Erro ao emitir cupom. Falha na consulta da fatura."),c(a.status!=="Finalizada","Cupom n\xE3o emitido. A Fatura n\xE3o foi finalizada.");const r=(await h.financeiroTitulo.le({documentoId:e}))[0];if(!r)return;let o;if(r.idDocumentoCaixa){const n=await h.documento.ler({id:r.idDocumentoCaixa});c(!n||!n.idCaixa,"Erro ao emitir cupom. Falha na consulta do documento Caixa.");const s=await h.caixa.le({id:n.idCaixa});c(!s||!s.tipo,"Erro ao emitir cupom. Falha na consulta do Caixa."),o=s.tipo}else{const n=await h.configuracoes.porNome("vendas.tipoPDV",a.idEmpresa);o=parseInt(((n||[]).find(s=>s.valor)||{}).valor)||4}if(o=h.caixa.tiposCaixa[o],c(!["SAT","NFCe"].includes(o),`Cupom n\xE3o emitido. Caixa configurado para ${o}.`),o==="SAT"){const n=await h.documentoSat.ler({idDocumento:e});c(!n,"Erro ao emitir cupom. Falha na consulta dos documentos.");const s=n.filter(f=>f.cancelamento).map(f=>f.chaveCupomCancelado),i=n.filter(f=>!s.includes(f.chaveCupom)).filter(f=>!f.cancelamento);c(i.length>0,"Cupom j\xE1 emitido para a fatura")}else if(o==="NFCe"){const n=await h.documentoFiscalEletronico.ler({idDocumento:e,situacao:"Emitido"});c(!n,"Erro ao emitir cupom. Falha na consulta dos dados."),c(n.length>0,"Cupom j\xE1 emitido para a fatura")}await pe(e),t&&(this.cpfCnpjNoCupom={visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:a.idEmpresa,cpfCnpj:a.numeroDocumentoContato,nomeCliente:a.descricaoContato,idFatura:e,tipoCaixa:o,concluir:null},await this.emitirCupomConfirma(this.cpfCnpjNoCupom)),t||(this.cpfCnpjNoCupom={visivel:!0,incluirCpfCnpjNoCupom:!1,idEmpresa:a.idEmpresa,cpfCnpj:a.numeroDocumentoContato,nomeCliente:a.descricaoContato,idFatura:e,tipoCaixa:o,concluir:null},await new Promise((n,s)=>{this.cpfCnpjNoCupom.concluir=n}),await this.$utils.dormir(500),this.modalItemTrocarCest.visivel&&await new Promise((n,s)=>{this.concluirItemTrocarCest=n}))}catch(a){this.$q.notifyError("Erro ao emitir cupom",a)}},async emitirCupomConfirma(e){return{SAT:this.emitirCupomSatConfirma,NFCe:this.emitirCupomNFCeConfirma}[e.tipoCaixa](e)},async emitirCupomSatConfirma(e){let t="Erro desconhecido";try{F.show({spinner:I,spinnerColor:"amber",message:"Emitindo cupom"}),e.incluirCpfCnpjNoCupom||(e.idEmpresa="",e.cpfCnpj="",e.nomeCliente=""),t="Ocorreu um erro ao gerar o cupom";const{objetoJson:a,dados:r}=await V.gerar(e.idFatura,1,e.cpfCnpj,e.nomeCliente);c(!a,t);for(const n of r.alertas)this.$q.notify({message:n,textColor:"black",type:"warning"});t="Ocorreu um erro ao emitir o cupom";const o=await _.emitirSat(JSON.stringify(a),r.empresa.id);c(o.status==="Erro",o.mensagem),this.$q.notifyPositive(o.mensagem),t="Ocorreu um erro ao gravar os dados do cupom",await V.salvarRetornoEmissao(r,o.chaveCFe,o.xml),(o==null?void 0:o.versaoIntegrador)==="V2"&&await _.imprimirSat(o.xml,r.empresa.id)}catch(a){this.$q.notifyError(t,a)}finally{!this.modalItemTrocarCest.visivel&&this.concluirItemTrocarCest&&(this.concluirItemTrocarCest(),this.concluirItemTrocarCest=null),await this.atualiza(),F.hide()}},async emitirCupomNFCeConfirma(e){let t="Erro ao emitir Cupom NFCe",a,r;try{if(F.show({spinner:I,spinnerColor:"amber",message:"Selecionando Certificado e Emitindo o Cupom NFCe"}),e.incluirCpfCnpjNoCupom||(e.idEmpresa="",e.cpfCnpj="",e.nomeCliente=""),t="Ocorreu um erro ao gerar o Cupom NFCe",r=await B.gerarJson(e.idFatura,e.cpfCnpj,e.nomeCliente),c(!r,t),r.erros.length){$g.modalAlerta.show({titulo:"Erro de valida\xE7\xE3o",erros:r.erros});return}if(await this.verificarCestEmST(r))return;for(const o of r.alertas)this.$q.notify({message:o,textColor:"black",type:"warning"});if(t="Ocorreu um erro ao emitir o Cupom NFCe",a=await _.emitirNFCe(r,r.empresaPlat.hashCSC,r.empresaPlat.tokenCSC),a.status==="Erro"){const o=[...(a.mensagem||"").split(`
`),...(a.complemento||"").split(`
`)];$g.modalAlerta.show({titulo:a.status,erros:o});return}this.$q.notifyPositive(a.mensagem)}catch(o){this.$q.notifyError(t,o);return}finally{F.hide(),!this.modalItemTrocarCest.visivel&&this.concluirItemTrocarCest&&(this.concluirItemTrocarCest(),this.concluirItemTrocarCest=null),this.atualiza()}try{const o=await _.imprimirNFCe(a.xml,r.outrosNFe.idContatoEmitente);o.status==="Erro"&&console.error(`Erro ao imprimir NFCe
`,o.mensagem)}catch(o){console.error(`Erro ao imprimir NFCe
`,o.toString())}},async reimprimirSat(e){try{F.show({spinner:I,spinnerColor:"amber",message:"Imprimindo cupom"});const t=this.documentosSat.find(r=>r.id===e),a=t.cancelamento?await _.imprimirCancelamentoSat(t.xml,t.idEmpresa):await _.imprimirSat(t.xml,t.idEmpresa);c(a.status==="Erro",a.mensagem),this.$q.notifyPositive(a.mensagem)}catch(t){this.$q.notifyError("Ocorreu um erro ao imprimir o cupom",t)}finally{F.hide()}},async reimprimirNFCe(e){try{F.show({spinner:I,spinnerColor:"amber",message:"Imprimindo NFCe"});const t=await h.documentoFiscalEletronicoXml.ler({idDocumentoFiscalEletronico:e,status:"Sucesso",situacao:"Emitido"});c(!t||!t.length||!t[0].xmlProt,"Ocorreu um erro ao carregar o xml da NFCe");const a=JSON.parse(t[0].json),r=await _.imprimirNFCe(t[0].xmlProt,a.outrosNFe.idContatoEmitente);c(r.status==="Erro",r.mensagem),r.mensagem&&this.$q.notifyPositive(r.mensagem)}catch(t){this.$q.notifyError("Ocorreu um erro ao imprimir o NFCe",t)}finally{F.hide()}},async verificarCestEmST(e){if(await h.configuracoes.leValorNumerico("imposto.versao")!==2)return!1;const a=[];for(const r of e.infNFe.det){const o=$lodash.get(r,"prod.noXml_id"),n=$lodash.get(r,"prod.opcional.CEST"),s=$lodash.get(r,"imposto.noXml_CSOSN")||$lodash.get(r,"imposto.noXml_CST");["10","20","60","70","201","202","500"].includes(s)&&!n&&a.push(o)}return a.length===0?!1:(this.modalItemTrocarCest={visivel:!0,campos:{ids:a}},!0)},verNoSefaz(e){window.open(e,"_blank")}},props:{idFatura:{required:!1,type:String},idVenda:{required:!1,type:String}},watch:{idFatura(){this.atualiza()},"cpfCnpjNoCupom.visivel"(e){!e&&this.cpfCnpjNoCupom.concluir&&(this.cpfCnpjNoCupom.concluir(),this.cpfCnpjNoCupom.concluir=null)},"modalItemTrocarCest.visivel"(e){!e&&this.concluirItemTrocarCest&&(this.concluirItemTrocarCest(),this.concluirItemTrocarCest=null)}},mounted(){$utils.emitter.on("atualizarDocumentosFiscais",this.atualiza),this.atualiza()},beforeUnmount(){$utils.emitter.off("atualizarDocumentosFiscais",this.atualiza)}},Je={class:""},je={key:0,class:"q-item-label",style:{color:"#0c0c0c"}},ze={class:"col-9 col-lg-10 q-pl-sm"},Me={class:"row"},Ue={class:"col-4 col-sm-1"},Qe={class:"col-4 col-sm-1"},Xe={class:"col-4 col-sm-3"},Be={class:"col-6 col-sm-4"},Re={class:"col-6 col-sm-3"},He={class:"col-3 col-lg-2 text-right"},Le={class:"col-10 q-pl-sm"},Ge={class:"row"},Ke={class:"col-3 col-sm-1"},We={class:"col-3 col-sm-2"},Ye={class:"col-6 col-sm-4"},Ze={class:"col-6 col-sm-2"},eo={class:"col-6 col-sm-3"},oo={class:"col-2 text-right"},ao={class:"col-9 col-lg-10 q-pl-sm"},to={class:"row"},ro=p("div",{class:"col-4 col-sm-1"},"NFe",-1),io={class:"col-4 col-sm-1"},no={class:"col-4 col-sm-3"},so={class:"col-6 col-sm-4"},co={class:"col-6 col-sm-3"};function lo(e,t,a,r,o,n){const s=k("CpfCnpjNoCupom"),u=k("ItemTrocarCest");return d(),E("div",Je,[!!o.documentosSat.length||!!o.documentosFiscais.length||!!o.documentosNFe.length?(d(),E("p",je,[l(U,{name:"account_balance",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),y(" Documentos fiscais ")])):D("",!0),o.documentosSat.length?(d(),b(J,{key:1,highlight:"",class:"q-pa-none"},{default:m(()=>[(d(!0),E(S,null,$(o.documentosSat,i=>(d(),b(O,{class:"row u-separador q-my-none q-pa-xs",key:i.id},{default:m(()=>[p("div",ze,[p("div",Me,[p("div",Ue,C(o.hwDest),1),p("div",Qe,C(i.numeroCupom),1),p("div",Xe,C(i.cancelamento?"Cancelado":"Emitido"),1),p("div",Be,C(e.$filters.numero(i.valorTotal,2)),1),p("div",Re,C(e.$filters.dataHora(i.dataHoraEmissao)),1)])]),p("div",He,[l(w,{color:"primary",dense:"",flat:"",icon:"print",round:"",onClick:f=>n.reimprimirSat(i.id)},{default:m(()=>[l(x,null,{default:m(()=>[y("Reimprimir "+C(o.hwDest),1)]),_:1})]),_:2},1032,["onClick"]),i.cancelamento?D("",!0):(d(),b(w,{key:0,color:"primary",dense:"",flat:"",icon:"cancel",round:"",onClick:f=>n.cancelarSat(i.id)},{default:m(()=>[l(x,null,{default:m(()=>[y("Cancelar "+C(o.hwDest),1)]),_:1})]),_:2},1032,["onClick"]))])]),_:2},1024))),128))]),_:1})):D("",!0),o.documentosFiscais.length?(d(),b(J,{key:2,highlight:"",class:"q-pa-none"},{default:m(()=>[(d(!0),E(S,null,$(o.documentosFiscais,i=>(d(),b(O,{class:"row q-px-xs",key:i.id},{default:m(()=>[p("div",Le,[p("div",Ge,[p("div",Ke,C(i.tipo),1),p("div",We,C(i.nNF),1),p("div",Ye,C(i.situacao)+" "+C(i.tpAmb==="2"?"em Homologa\xE7\xE3o":"")+" "+C(i.operacao?" - "+i.operacao:""),1),p("div",Ze,C(e.$filters.numero(i.vNF,2)),1),p("div",eo,C(e.$filters.dataHora(i.dataHoraEmissao)),1)])]),p("div",oo,[i.tipo==="NFCe"?(d(),E(S,{key:0},[i.situacao==="Emitido"?(d(),E(S,{key:0},[l(w,{color:"primary",dense:"",flat:"",icon:"print",round:"",onClick:f=>n.reimprimirNFCe(i.id)},{default:m(()=>[l(x,null,{default:m(()=>[y("Reimprimir NFCe")]),_:1})]),_:2},1032,["onClick"]),l(w,{color:"primary",dense:"",flat:"",icon:"cancel",round:"",onClick:f=>n.cancelarNFCe(i.id)},{default:m(()=>[l(x,null,{default:m(()=>[y("Cancelar NFCe")]),_:1})]),_:2},1032,["onClick"])],64)):D("",!0),l(w,{color:"primary",dense:"",flat:"",icon:"open_in_browser",round:"",onClick:f=>n.verNoSefaz(i.qrCode)},{default:m(()=>[l(x,null,{default:m(()=>[y("Ver no Sefaz")]),_:1})]),_:2},1032,["onClick"])],64)):i.tipo==="NFe"?(d(),E(S,{key:1},[l(w,{rounded:"",dense:"",flat:"",icon:"print",color:"primary",class:"no-shadow q-ma-xs",size:"md",style:{float:"right"}},{default:m(()=>[l(de,null,{default:m(()=>[l(J,{link:"",separator:""},{default:m(()=>[(d(!0),E(S,null,$(o.configImpressaoNFe,f=>(d(),b(O,{clickable:"",key:f.valor,onClick:mo=>e.$imprimir(f.valor,i.id)},{default:m(()=>[l(Q,{avatar:""},{default:m(()=>[l(U,{name:"mdi-printer"})]),_:1}),l(Q,null,{default:m(()=>[l(fe,null,{default:m(()=>[y(C(f.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024),l(w,{color:"primary",dense:"",flat:"",icon:"edit",round:"",onClick:f=>n.abrirNFe(i.id)},{default:m(()=>[l(x,null,{default:m(()=>[y("Abrir")]),_:1})]),_:2},1032,["onClick"])],64)):D("",!0)])]),_:2},1024))),128))]),_:1})):D("",!0),o.documentosNFe.length?(d(),b(J,{key:3,highlight:"",class:"q-pa-none"},{default:m(()=>[(d(!0),E(S,null,$(o.documentosNFe,(i,f)=>(d(),b(O,{class:"row u-separador q-my-none q-pa-xs",key:f},{default:m(()=>[p("div",ao,[p("div",to,[ro,p("div",io,C(i.noNota),1),p("div",no,C(i.nfeCanceladaEvento?"Cancelado":"Emitido"),1),p("div",so,C(e.$filters.numero(i.valTotNota,2)),1),p("div",co,C(e.$filters.dataHora(i.horaSaidaEntrada)),1)])])]),_:2},1024))),128))]),_:1})):D("",!0),l(s,{modelValue:o.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":t[0]||(t[0]=i=>o.cpfCnpjNoCupom.visivel=i),dados:o.cpfCnpjNoCupom,onConfirmar:n.emitirCupomConfirma},null,8,["modelValue","dados","onConfirmar"]),l(u,{modal:o.modalItemTrocarCest,onConfirmar:t[1]||(t[1]=i=>n.emitirCupomConfirma(o.cpfCnpjNoCupom))},null,8,["modal"])])}var ho=z(Oe,[["render",lo]]);export{Te as C,ho as D};
