import{_ as Z,N as $,b1 as ot,M as tt,cg as J,ch as P,Y as S,ci as U,cj as at,Z as it,ck as A,p as C,o as d,d as p,f as e,w as i,K as st,G as lt,A as rt,B as M,C as H,D as w,L as T,E as L,e as g,t as f,i as _,l as m,H as nt,s as K,x as u,j as E,k as R,ai as B,aj as z,ak as b,ah as V,am as Q,F,r as N,I as dt,y as X,U as ct,aF as Y}from"./index.6f8ff6bd.js";import{l as ut}from"./listaV2.3a85dca4.js";import{C as mt}from"./Campo.e9425fe1.js";import{B as et}from"./BadgeCopiarUid.b58aa471.js";import{P as ht}from"./PromptContatoV2.aa6667be.js";import{e as ft}from"./emitirNFe.de0f28dd.js";import{n as pt}from"./nfePrincipal.e4e301a4.js";import"./QBreadcrumbs.0f26c7d2.js";import"./QSpace.f8f6c471.js";import"./xlsx.74095fe1.js";import"./compactarValidarNFe.ac606e12.js";import"./obterItens.adfc0f89.js";import"./codigosANP.a6c1a264.js";const gt={components:{BadgeCopiarUid:et,Badge:$,Campo:mt,PromptItemV2:ot,Avatar:tt,PromptContatoV2:ht},data(){return{cliente:{},emitente:{},diaVencimento:"",operacaoFator:-1,opcoesFator:[{rotulo:"Sa\xEDda",valor:-1},{rotulo:"Entrada",valor:1}],documentoAnterior:{},documentoItensAnterior:[],documento:{id:J(),dataHoraEmissao:P(),numero:"",descricaoContato:"",idContato:"",descricaoEmpresa:"",idEmpresa:"",numeroVolumeTransporte:"",status:"Digita\xE7\xE3o",tipo:"Registro",operacao:this.operacao,idContatoDigitador:null},documentoItens:[],totalItens:0,qtdItens:0,visibilidade:{modal:!1},itensModal:!1,carregando:!0,contatosModal:!1,emitenteModal:!1,empresas:[],configImpressaoRegistro:[],operacao:"",somenteLeitura:!1,ocultarValores:!0,modalItemSemEstoque:{},item:{}}},emits:["atualizar","tituloPagina"],methods:{async atualizar(o){var a;if(this.modalItemSemEstoque={},o){this.documentoAnterior=await S.registro.le({id:o}),this.documento=U(this.documentoAnterior),this.documentoItensAnterior=await S.itemManipulacao.leItens({idDocumento:o});for(let n=0;n<this.documentoItensAnterior.length;n++)this.documentoItensAnterior[n];this.documentoItens=U(this.documentoItensAnterior),this.cliente.id=this.documento.idContato,this.cliente.nome=this.documento.descricaoContato,this.emitente.id=this.documento.idEmpresa,this.emitente.nome=this.documento.descricaoEmpresa,this.operacaoFator=null}else if(this.limparCampos(),this.empresas=await S.empresa.le(),this.empresas.length===1)this.emitente=U(this.empresas[0]),this.documento.idEmpresa=this.emitente.idContato,this.documento.descricaoEmpresa=this.emitente.nome;else{const n=await $g.promptContato.show({filtro:{ativo:!0,empresas:!0},placeholder:"Selecione"});if(!n){$q.notify({type:"negative",message:"Selecione a empresa"}),this.visibilidade.modal=!1;return}this.emitente=U(n),this.documento.idEmpresa=this.emitente.id,this.documento.descricaoEmpresa=this.emitente.nome}for(const n of this.documentoItens)this.item[n.idItem]=(a=await $db.item.ler({filtros:{id:n.idItem}}))==null?void 0:a.data[0],this.operacaoFator||(this.operacaoFator=n.operacaoFator);this.somarValorTotal(),this.configuraImpressaoContrato(this.documento.idEmpresa)},async mostrar(){await at(500),this.carregando=!1},async configuraImpressaoContrato(o){const a=await S.configuracoes.porNome("impressao.contrato",o);this.configImpressaoContrato=a},fechar(){this.operacaoFator=-1,this.carregando=!0,this.$router.replace({params:{id:""}})},limparCampos(){this.documentoAnterior={},this.documento={id:J(),dataHoraEmissao:P(),numero:"",descricaoContato:"",idContato:"",descricaoEmpresa:"",idEmpresa:"",numeroVolumeTransporte:"",status:"Digita\xE7\xE3o",tipo:"Registro",operacao:this.operacao},this.documentoItensAnterior=[],this.documentoItens=[],this.cliente.id="",this.cliente.nome="",this.emitente.id="",this.emitente.nome="",this.diaVencimento=""},capitalizeFirstLetter(o){return o.charAt(0).toUpperCase()+o.slice(1)},async abrirModal(o=""){let a={},n=[];o?n=this.documentoItens.filter(c=>c.idItem===o):n=this.documentoItens;for(const c of n)a[c.idItem]={item:await it().item.get(c.idItem)||{},quantidade:c.quantidade},a[c.idItem].item.novoValorVenda=c.valorItem;this.$refs.promptItem.itensSelecionados=a,this.$refs.promptItem.termo=o,this.$refs.promptItem.atualizar(),this.itensModal=!0},recalcularTotal(o){o.subTotal=A(o.quantidade*o.valorItem),o.total=A(o.quantidade*o.valorItem),this.somarValorTotal()},async selecionarCliente(){if(this.documento.status==="Digita\xE7\xE3o"){const o=await $g.promptContato.show({filtro:{ativo:!0},placeholder:"Selecione"});this.cliente=U(o),this.contatosModal=!1,this.documento.idContato=this.cliente.id,this.documento.descricaoContato=this.cliente.nome}},aoSelecionarVencimento(){this.documento.numeroVolumeTransporte=this.diaVencimento},selecionarItens:async function(o){for(const a in o){const n=o[a].item||{},c=o[a].quantidade||0;this.item[a]=n;let t=this.documentoItens.find(s=>s.idItem===a);t?(t.quantidade=c,t.quantidadeRealizado=c,t.total=A(c*t.valorItem),t.subTotal=A(c*t.valorItem)):this.documentoItens.push({dataHoraEmissao:P(),descricaoItem:n.descricao,id:J(),idDocumento:this.documento.id,idItem:n.id,operacao:this.operacao,quantidade:c,unidade:n.unidade,quantidadeRealizado:c,tipoItem:n.tipo,total:A(c*n.valorVenda),subTotal:A(c*n.valorVenda),valorItem:n.valorVenda,operacaoFator:this.operacaoFator})}this.somarValorTotal()},somarValorTotal(){this.totalItens=this.documentoItens.reduce((o,a)=>o+=a.total,0),this.qtdItens=this.documentoItens.reduce((o,a)=>o+=a.quantidade,0)},excluirItem(o){this.documentoItens=this.documentoItens.filter(a=>a.id!==o),this.somarValorTotal()},validaDia(){if(this.diaVencimento<1||this.diaVencimento>28){this.$q.notifyAlert("O dia deve ser um valor entre 1 e 28"),this.diaVencimento="";return}this.aoSelecionarVencimento()},async gravar(o=!1){if(!this.cliente.id){this.$q.notifyAlert("Selecione um Cliente");return}if(!this.emitente.id){this.$q.notifyAlert("Selecione um Emitente");return}if(!this.totalItens||!this.qtdItens){this.$q.notifyAlert(`Adicione alguns itens ao ${this.tituloPagina}`);return}try{if(!this.documento.codigoContatoDigitador){const a=await this.obterContatoUsuario();this.documento.idContatoDigitador=a.id,this.documento.codigoContatoDigitador=a.codigoContato}this.documento.totalDocumento=this.totalItens,this.documento.subTotal=this.totalItens,await S.registro.grava({documentoAnterior:this.documentoAnterior,documento:this.documento,documentoItensAnterior:this.documentoItensAnterior,documentoItens:this.documentoItens}),this.visibilidade.modal=o,this.atualizar(this.documento.id),this.$emit("atualizar")}catch(a){this.$q.notifyError("Erro ao salvar",a)}},async cancelar(){try{$q.loading.show(),this.documento.status="Cancelado",this.documento.dataHoraFinalizado=P(),await this.gravar(!0),this.visibilidade.modal=!1}catch(o){console.error(o)}finally{$q.loading.hide()}},async ativar(){try{$q.loading.show(),this.documento.status="Digita\xE7\xE3o",this.documento.dataHoraFinalizado="",this.documentoItens.forEach(o=>{o.status="Digita\xE7\xE3o",o.dataHoraFinalizado=""}),await this.gravar(!0),$q.notifyPositive(`${this.tituloPagina} Em Digita\xE7\xE3o`)}catch(o){console.error(o)}finally{$q.loading.hide()}},async finalizar(){var o,a,n;try{$q.loading.show();const c=P(),s=(await $db.configuracoes.porNome("vendas.checaestoque",this.emitente.id)).find(h=>parseInt(h.valor)===1)&&this.operacaoFator===-1;this.modalItemSemEstoque={};for(let h of this.documentoItens){if(s){const y=(a=(o=(await $db.estoqueSaldoProdutoEmpresa.leEstoquePorEmpresa(h.idItem,this.emitente.id))[0])==null?void 0:o.estoquePorLote)==null?void 0:a.find(k=>k.tipoEstoque==="Dispon\xEDvel");y&&!(y.saldo>0)&&(this.modalItemSemEstoque.itens||(this.modalItemSemEstoque.itens=[]),this.modalItemSemEstoque.itens.push({descricao:h.descricaoItem,saldo:y.saldo}))}h.status="Finalizado",h.dataHoraFinalizado=c}if((n=this.modalItemSemEstoque.itens)!=null&&n.length){this.modalItemSemEstoque.visivel=!0;return}this.documento.status="Finalizado",this.documento.dataHoraFinalizado=c,await this.gravar(!0),$q.notifyPositive(`${this.tituloPagina} finalizado`),this.visibilidade.modal=!1}catch(c){console.error(c)}finally{$q.loading.hide()}},async obterContatoUsuario(){const o=JSON.parse(localStorage.getItem("usuario"))||{};let a={};return o.codigoUsuario&&(a=(await $erp().contato.where({codigoUsuario:o.codigoUsuario}).toArray()).find(n=>n.id)||{}),a},calcularQtdItem(){return this.documentoItens.length},calcularQtdItemBol(){let o=!1;return this.documentoItens.length&&(o=!0),o}},mounted(){this.operacao=this.capitalizeFirstLetter(this.$route.params.operacao),this.documento.operacao=this.operacao},computed:{tituloPagina(){return this.capitalizeFirstLetter(this.$route.params.operacao)}},async created(){const o=await $db.configuracoes.le({nome:`registro.${this.$route.params.operacao}.ocultarvalores`});this.ocultarValores=o.some(n=>Number(n.valor)===1),this.empresas=await S.empresa.le();const a=await this.obterContatoUsuario();this.documento.idContatoDigitador=a.id}},_t={key:0},vt={ref:"form"},bt={class:"col-12 col-md"},It={class:"col-auto"},yt={class:"col"},Ct={class:"col-12 col-md"},kt={class:"col-auto"},wt={class:"col"},qt={class:"col-8"},Vt={class:"col-4"},xt=u("div",{class:"col-2 col-md"},"Refer\xEAncia",-1),zt=u("div",{class:"col-10 col-md-4"},"Descri\xE7\xE3o",-1),Et=u("div",{class:"col-6 col-md text-right"},"\xA0",-1),Ft=u("div",{class:"col-2 col-md text-right"},"\xA0",-1),Dt={key:0,class:"col-6 col-md text-right"},St={key:1,class:"col-6 col-md text-right"},At={key:2,class:"col-6 col-md text-right"},Pt={key:3,class:"col-6 col-md text-right"},Ut=u("div",{class:"col-6 col-md-1 text-right"},"A\xE7\xF5es",-1),Lt={class:"col-2 col-md"},Mt={key:0},Ht={class:"col-10 col-md-4"},Tt={class:"col-6 col-md text-center row"},Qt={class:"col-2 col-md text-right row"},Rt={key:0,class:"col-6 col-md text-right"},Bt={key:1,class:"col-6 col-md text-right"},Nt={key:2,class:"col-6 col-md text-right"},Ot={key:3,class:"col-6 col-md text-right"},jt={class:"col-6 col-md-1 text-right"},Gt={class:"col-2 col-md"},Jt={key:0},Kt=u("div",{class:"col-10 col-md-4"},"\xA0",-1),Wt={class:"col-6 col-md text-center"},Xt=u("div",{class:"col-2 col-md text-right"},"\xA0",-1),Yt=u("div",{class:"col-6 col-md text-right"},"\xA0",-1),Zt={key:0,class:"col-6 col-md text-right"},$t={key:1,class:"col-6 col-md text-right"},te=u("div",{class:"col-6 col-md-1 text-right"},"\xA0",-1),ee={class:"u-container relative-position"},oe={class:"layout-padding"},ae={class:"q-pa-md"},ie={class:"q-mt-lg text-right"};function se(o,a,n,c,t,s){const h=C("badge"),I=C("BadgeCopiarUid"),y=C("avatar"),k=C("campo"),x=C("row"),O=C("PromptItemV2"),j=C("PromptContatoV2");return d(),p(F,null,[e(X,{modelValue:t.visibilidade.modal,"onUpdate:modelValue":a[9]||(a[9]=r=>t.visibilidade.modal=r),maximized:"",onShow:s.mostrar,onHide:s.fechar},{default:i(()=>[e(st,{class:"bg-light",container:""},{default:i(()=>[e(lt,{class:"u-container"},{default:i(()=>[e(rt,null,{default:i(()=>[e(M,null,{default:i(()=>[H(e(w,{dense:"",flat:"",icon:"arrow_back",round:""},null,512),[[T]]),e(L,null,{default:i(()=>[g(f(s.tituloPagina),1)]),_:1}),t.documento.status==="Digita\xE7\xE3o"?(d(),_(w,{key:0,class:"no-shadow",unelevated:"",color:"white","text-color":"primary",label:"Salvar",onClick:a[0]||(a[0]=r=>s.gravar(!1))})):m("",!0)]),_:1})]),_:1}),e(nt,null,{default:i(()=>[e(M,{class:"q-pa-none q-ma-none q-my-md",color:"none","text-color":"black",style:{"min-height":"auto"}},{default:i(()=>{var r,q;return[e(L,{class:"text-black q-px-none text-body2"},{default:i(()=>[g("Emiss\xE3o: "+f(o.$filters.data(t.documento.dataHoraEmissao))+" ",1),t.documento.dataHoraFinalizado?(d(),p("span",_t,f(t.documento.status)+": "+f(o.$filters.data(t.documento.dataHoraFinalizado)),1)):m("",!0)]),_:1}),e(h,{cor:((r=[{status:"Digita\xE7\xE3o",cor:"positive"},{status:"Cancelado",cor:"negative"},{status:"Finalizado",cor:"tertiary"}].find(l=>l.status===t.documento.status))==null?void 0:r.cor)||"tertiary",class:"q-mx-xs",icone:"flag",escuro:""},{default:i(()=>[g(f(t.documento.status),1)]),_:1},8,["cor"]),e(I,{cor:((q=[{status:"Digita\xE7\xE3o",cor:"positive"},{status:"Cancelado",cor:"negative"},{status:"Finalizado",cor:"tertiary"}].find(l=>l.status===t.documento.status))==null?void 0:q.cor)||"tertiary",id:t.documento.id,numero:(t.documento.numero.toString()||t.documento.id).slice(-8)},null,8,["cor","id","numero"])]}),_:1}),e(K,{class:"bg-white q-pa-md q-mt-md no-shadow"},{default:i(()=>[u("form",vt,[e(x,{class:"q-col-gutter-sm"},{default:i(()=>[u("div",bt,[e(x,null,{default:i(()=>{var r;return[u("div",It,[e(y,{imagem:((r=t.emitente)==null?void 0:r.imagem)||"",rotulo:t.emitente.nome,tamanho:"30",style:{float:"left"},class:"q-mr-sm"},null,8,["imagem","rotulo"])]),u("div",yt,[e(k,{rotulo:"Emitente",somenteLeitura:"",tipo:"texto",class:"col-10",modelValue:t.emitente.nome,"onUpdate:modelValue":a[1]||(a[1]=q=>t.emitente.nome=q)},null,8,["modelValue"])])]}),_:1})]),u("div",Ct,[e(x,null,{default:i(()=>{var r;return[u("div",kt,[e(y,{imagem:((r=t.cliente)==null?void 0:r.imagem)||"",rotulo:t.cliente.nome||"",tamanho:"30",style:{float:"left"},class:"q-mr-sm"},null,8,["imagem","rotulo"])]),u("div",wt,[e(k,{placeholder:"Cliente",rotulo:"Cliente",tipo:"texto",after:[{icon:"search",handler(){s.selecionarCliente()}}],modelValue:t.cliente.nome,"onUpdate:modelValue":a[2]||(a[2]=q=>t.cliente.nome=q),somenteLeitura:""},null,8,["after","modelValue"])])]}),_:1})])]),_:1}),e(x,null,{default:i(()=>[u("div",qt,[e(k,{modelValue:t.documento.observacao,"onUpdate:modelValue":a[3]||(a[3]=r=>t.documento.observacao=r),rotulo:"Observa\xE7\xE3o",tipo:"texto"},null,8,["modelValue"])]),u("div",Vt,[e(k,{somenteLeitura:t.somenteLeitura||s.calcularQtdItemBol(),placeholder:"Fator Opera\xE7\xE3o",rotulo:"Fator Opera\xE7\xE3o",modelValue:t.operacaoFator,"onUpdate:modelValue":a[4]||(a[4]=r=>t.operacaoFator=r),opcoes:t.opcoesFator,tipo:"seletor"},null,8,["somenteLeitura","modelValue","opcoes"])])]),_:1})],512)]),_:1}),e(K,{class:"bg-white q-pa-md q-mt-md no-shadow"},{default:i(()=>[e(M,{class:"q-pa-none q-ma-none q-mb-md",color:"none","text-color":"black",style:{"min-height":"auto"}},{default:i(()=>[e(E,{name:"shopping_cart",size:"24px",style:{color:"#737373"}}),e(L,null,{default:i(()=>[g(" Produtos e Servi\xE7os ")]),_:1}),t.documento.status==="Digita\xE7\xE3o"?(d(),_(w,{key:0,color:"positive",flat:"",dense:"",icon:"add",round:"",size:"md",onClick:a[5]||(a[5]=r=>s.abrirModal())},{default:i(()=>[e(R,null,{default:i(()=>[g("Adicionar Item")]),_:1})]),_:1})):m("",!0)]),_:1}),e(B,{class:"col-12 no-border q-mx-none q-pa-none"},{default:i(()=>[e(z,{class:"q-pa-none"},{default:i(()=>[e(b,null,{default:i(()=>[e(V,null,{default:i(()=>[e(x,{class:"q-col-gutter-md text-weight-bold justify-around"},{default:i(()=>[xt,zt,Et,Ft,t.ocultarValores?m("",!0):(d(),p("div",Dt,"Valor")),t.ocultarValores?m("",!0):(d(),p("div",St,"Total")),t.ocultarValores?(d(),p("div",At,"\xA0")):m("",!0),t.ocultarValores?(d(),p("div",Pt,"\xA0")):m("",!0),Ut]),_:1})]),_:1}),e(Q,{class:"q-my-xs"}),(d(!0),p(F,null,N(t.documentoItens,(r,q)=>(d(),p(F,{key:q},[e(V,null,{default:i(()=>[e(x,{class:"q-col-gutter-md text-weight-bold text-left justify-around"},{default:i(()=>{var l,v,G,W;return[u("div",Lt,[((l=t.item[r.idItem])==null?void 0:l.referencia)||((v=t.item[r.idItem])==null?void 0:v.codigoItem)?(d(),p("span",Mt,f(((G=t.item[r.idItem])==null?void 0:G.referencia)||"#"+((W=t.item[r.idItem])==null?void 0:W.codigoItem)||"-"),1)):m("",!0)]),u("div",Ht,f(r.descricaoItem||"-"),1),u("div",Tt,[e(k,{somenteLeitura:t.somenteLeitura,tipo:"quantidade",modelValue:r.quantidade,"onUpdate:modelValue":D=>r.quantidade=D,min:1,rotulo:"Quantidade",dense:"",outlined:"",color:"tertiary",onBlur:D=>s.recalcularTotal(r)},null,8,["somenteLeitura","modelValue","onUpdate:modelValue","onBlur"])]),u("div",Qt,[u("span",null,f(r.unidade||"-"),1)]),t.ocultarValores?m("",!0):(d(),p("div",Rt,[e(k,{somenteLeitura:t.somenteLeitura,class:"col-10",modelValue:r.valorItem,"onUpdate:modelValue":D=>r.valorItem=D,tipo:"decimal",decimals:"4",onBlur:D=>s.recalcularTotal(r)},null,8,["somenteLeitura","modelValue","onUpdate:modelValue","onBlur"])])),t.ocultarValores?(d(),p("div",Bt,"\xA0")):m("",!0),t.ocultarValores?m("",!0):(d(),p("div",Nt,f(o.$filters.numero(r.total,2)),1)),t.ocultarValores?(d(),p("div",Ot,"\xA0")):m("",!0),u("div",jt,[t.documento.status==="Digita\xE7\xE3o"?(d(),_(w,{key:0,flat:"",dense:"",icon:"delete",round:"",size:"md",onClick:D=>s.excluirItem(r.id)},{default:i(()=>[e(R,null,{default:i(()=>[g("Excluir")]),_:1})]),_:2},1032,["onClick"])):m("",!0)])]}),_:2},1024)]),_:2},1024),e(Q,{class:"q-my-xs"})],64))),128))]),_:1})]),_:1}),e(z,{class:"q-px-none"},{default:i(()=>[e(b,null,{default:i(()=>[e(V,null,{default:i(()=>[e(x,{class:"q-col-gutter-md text-weight-bold text-left justify-around"},{default:i(()=>[u("div",Gt,[s.calcularQtdItem()?(d(),p("span",Jt,f(s.calcularQtdItem()),1)):m("",!0)]),Kt,u("div",Wt,f(o.$filters.numero(t.qtdItens,0)),1),Xt,Yt,t.ocultarValores?m("",!0):(d(),p("div",Zt,f(o.$filters.numero(t.totalItens,2)),1)),t.ocultarValores?(d(),p("div",$t,"\xA0")):m("",!0),te]),_:1})]),_:1})]),_:1})]),_:1}),e(z,{class:"q-px-none"},{default:i(()=>[e(b,null,{default:i(()=>[e(V,{class:"text-center"},{default:i(()=>[t.documento.status==="Digita\xE7\xE3o"?(d(),_(w,{key:0,color:"positive",icon:"add",class:"q-mx-auto",label:"Adicionar item",outline:"",size:"xs",onClick:a[6]||(a[6]=r=>s.abrirModal())})):m("",!0)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(O,{modelValue:t.itensModal,"onUpdate:modelValue":a[7]||(a[7]=r=>t.itensModal=r),filtro:{ativo:!0,idEmpresa:t.documento.idEmpresa},onSelecionarItens:s.selecionarItens,habilitarQuantidade:!0,ref:"promptItem"},null,8,["modelValue","filtro","onSelecionarItens"]),e(j,{modelValue:t.contatosModal,"onUpdate:modelValue":a[8]||(a[8]=r=>t.contatosModal=r),filtro:{ativo:!0},placeholder:"Seleciona o Cliente"},null,8,["modelValue"])]),_:1}),e(dt,{class:"bg-light no-shadow q-pa-sm text-right",bordered:""},{default:i(()=>[u("div",ee,[e(L,{class:"text-right"},{default:i(()=>[t.documento.status==="Digita\xE7\xE3o"?(d(),_(w,{key:0,class:"q-mx-md",color:"negative",flat:"",label:"Cancelar",onClick:s.cancelar},null,8,["onClick"])):m("",!0),t.documento.status!=="Digita\xE7\xE3o"?(d(),_(w,{key:1,color:"primary",label:"Reabrir",onClick:s.ativar},null,8,["onClick"])):m("",!0),t.documento.status==="Digita\xE7\xE3o"?(d(),_(w,{key:2,color:"primary",label:"Finalizar",onClick:s.finalizar},null,8,["onClick"])):m("",!0)]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onShow","onHide"]),e(X,{modelValue:t.modalItemSemEstoque.visivel,"onUpdate:modelValue":a[10]||(a[10]=r=>t.modalItemSemEstoque.visivel=r),minimized:""},{default:i(()=>[e(K,{class:"q-dialog-plugin"},{default:i(()=>[e(M,{class:"bg-primary text-white"},{default:i(()=>[e(L,null,{default:i(()=>[g(f((t.modalItemSemEstoque.itens||[]).length>1?"Itens":"Item")+" sem estoque ",1)]),_:1}),H(e(w,{dense:"",flat:"",icon:"close",round:""},null,512),[[T]])]),_:1}),u("div",oe,[u("form",ae,[e(B,{"no-border":"",dense:""},{default:i(()=>[(d(!0),p(F,null,N(t.modalItemSemEstoque.itens,(r,q)=>(d(),p(F,{key:q+r.descricao},[q?(d(),_(Q,{key:0})):m("",!0),e(z,null,{default:i(()=>[e(b,{class:"q-py-sm"},{default:i(()=>[e(V,null,{default:i(()=>[g(f(r.descricao),1)]),_:2},1024),e(V,{caption:""},{default:i(()=>[g("Estoque: "+f(r.saldo),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)],64))),128))]),_:1}),u("div",ie,[H(e(w,{color:"tertiary",flat:"",label:"Ok"},null,512),[[T]])])])])]),_:1})]),_:1},8,["modelValue"])],64)}var le=Z(gt,[["render",se]]);const re={components:{Avatar:tt,lista:ut,Badge:$,RegistroModal:le,BadgeCopiarUid:et,NfePrincipal:pt},mixins:[ft],data(){return{paginacao:{atual:1,minimo:1,maximo:1,total:1,limite:25},contatosModal:!1,digitadorModal:!1,filtros:{tab:"Em Digita\xE7\xE3o",tipo:"Registro",operacao:this.capitalizeFirstLetter(this.$route.params.operacao),empresa:{selecionada:"",opcoes:[]},cliente:{id:"",nome:""},digitador:{id:""},periodo:{emissao:{ini:"",fim:""},finalizado:{ini:"",fim:""}}},digitadorSelecionado:null,digitadoresOpcoes:[],diretivaContatosAcessaTodosContatos:!1,entregueInicio:new Date(new Date($utils.dataAtual()).toDateString()),entregueFim:new Date(new Date($utils.dataAtual()).toDateString()),documentos:[],tabs:[{rotulo:"Em Digita\xE7\xE3o",value:"Em Digita\xE7\xE3o"},{rotulo:"Finalizado",value:"Finalizado"},{rotulo:"Todos",value:"Todos"}],tabSelecionada:{valor:"Em Digita\xE7\xE3o"},tabAtiva:"Em Digita\xE7\xE3o",checkboxModel:!1,showAllPreviewDetail:!1,listaItensLayout:{},configImpressaoRegistro:[],showFilters:!1,filtrosDrawer:{ativo:null,cliente:null,dataInicio:null,dataFim:null},buscaCampo:"",ocultarValores:!0}},computed:{tituloPagina(){return this.capitalizeFirstLetter(this.$route.params.operacao)}},methods:{async filtroCliente_click(){const o=await $g.promptContato.show({filtro:{ativo:!0}});o.nome&&(this.filtros.cliente.nome=o.nome,this.filtros.cliente.id=o.codigoContato)},limparFiltros_click(){this.filtros={tab:"Em Digita\xE7\xE3o",tipo:"Registro",operacao:this.capitalizeFirstLetter(this.$route.params.operacao),empresa:{selecionada:"",opcoes:[]},cliente:{id:""},digitador:{codigo:""},periodo:{emissao:{ini:"",fim:""},finalizado:{ini:"",fim:""}}},this.atualizar()},async atualizar(){this.filtros.tab=this.tabSelecionada.valor;try{this.$q.loading.show();const o=this.paginacao.limite,a=this.paginacao.atual,n="descricao";let c="";this.filtros.tab==="Em Digita\xE7\xE3o"?c="Digita\xE7\xE3o":this.filtros.tab==="Finalizado"&&(c="Finalizado");let t=this.filtros.empresa.selecionada.value||"";this.filtros.idEmpresa=t,this.digitadorSelecionado!==null&&(this.filtros.digitador.codigo=this.digitadorSelecionado.value);let s={},h=this.$utils.eliminarVazios(this.filtros);this.buscaCampo&&(h.termoBusca=this.buscaCampo),h.status=c,h.operacao=this.capitalizeFirstLetter(this.$route.params.operacao),s=await this.filtrarCampos(h,o,a,n);for(let I of s.data){let y=await $db.registro.leItens({idDocumento:I.id});I.documentoItens=y,I.totalItens=y.map(function(k){return k.total}),I.qtdItens=y.map(function(k){return k.quantidade}),this.listaItensLayout[I.id]={detalhes:!1,showPreviewDetail:!1,remover:!1}}s.data.sort((I,y)=>Number(I.numero)<Number(y.numero)?1:-1),s.data.sort((I,y)=>I.dataHoraFinalizado?new Date(I.dataHoraFinalizado)<new Date(y.dataHoraFinalizado)?1:-1:new Date(I.dataHoraEmissao)<new Date(y.dataHoraEmissao)?1:-1),this.documentos=s.data,this.paginacao.total=s.total,this.paginacao.maximo=s.totalPages,this.configuraImpressaoRegistro(s.idEmpresa)}catch(o){this.$q.notifyError("Erro iniciar",o)}finally{this.$q.loading.hide()}},criarItem(){this.$refs.registroModal.visibilidade.modal=!0,this.$refs.registroModal.atualizar()},capitalizeFirstLetter(o){return o.charAt(0).toUpperCase()+o.slice(1)},abrirItem(o,a=!1){this.$router.replace({params:{id:o}}).finally(()=>{this.$refs.registroModal.atualizar(o),this.$refs.registroModal.somenteLeitura=a,this.$refs.registroModal.visibilidade.modal=!0})},async excluirItem(o){await this.$q.dialog({message:`Deseja mesmo cancelar esse ${this.tituloPagina}?`,title:`Cancelar ${this.tituloPagina}?`,cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).then(async()=>{let a=$utils.clonarV2(o);a.status="Cancelado",a.dataHoraFinalizado=$utils.dataAtual(),await $db.registro.grava({documentoAnterior:o,documento:a}),this.atualizar()})},selecionarTodosXCheckBox(){for(let o of this.listaItens)this.listaItensLayout[o.id].remover=this.checkboxModel},async showDetails(o){let a=await $db.registro.leItens({idDocumento:o.id});o.documentoItens=a,o.showAllPreviewDetail=!o.showAllPreviewDetail,o.detalhes=!o.detalhes,this.listaItensLayout[o.id].detalhes=!this.listaItensLayout[o.id].detalhes},async filtrarCampos(o,a,n,c){return $db.registro.leRefatorado({filtros:o,limit:a,page:n,sort:c})},async buscar(){if(this.buscaCampo!==""){let o=[],a=[],c=(await $db.item.ler({filtros:{termoBusca:this.buscaCampo}})).data;if(c){for(let s of c){let h=await $db.registro.leItens({idItem:s.id});o.push(h)}o=o.flat();for(let s of o){let h=await $db.registro.le({id:s.idDocumento});a.push({...h})}}let t=(await $db.contato.ler({filtros:{termoBusca:this.buscaCampo}})).data;if(t)for(let s of t){let h=await $db.registro.le({idContato:s.id});a.push(...h[0])}a=a.flat(),this.documentos=a.map(s=>({...s,showPreviewDetail:!1,detalhes:!1,documentoItens:[]}))}},async removerItem(o){$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},title:"Remover",message:"Ao continuar voc\xEA ir\xE1 remover este item.",ok:{label:"Sim",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(async()=>{try{$q.loading.show(),await $db.registro.remove(o.id),this.atualizar(),$q.notifyPositive("O registro foi exclu\xEDdo com sucesso.")}catch(a){console.error(a),$q.notifyError("Ocorreu um erro ao remover o registro",a)}finally{$q.loading.hide()}}),this.atualizar()},async configuraImpressaoRegistro(o){const a=await $db.configuracoes.porNome("impressao.registro",o);this.configImpressaoRegistro=[...a.length?a.map(n=>({texto:`Imprimir ${this.tituloPagina}`,...n})):[{valor:"invoice",texto:`${this.tituloPagina}`},this.sistemaPai==="optisoul"?{valor:"registro",texto:"Registro"}:{}]]},async emitirNFeClick(o,a=1,n="Remessa"){await this.emitirNFeV2({idVenda:o},a,n)}},async created(){const o=await $db.configuracoes.le({nome:`registro.${this.$route.params.operacao}.ocultarValores`});this.ocultarValores=o.some(a=>Number(a.valor)===1),$db.permissao.objeto("Diretiva_RelatorioVenda_VerTodos").then(a=>{this.diretivaContatosAcessaTodosContatos=a,this.diretivaContatosAcessaTodosContatos&&(this.digitadoresOpcoes=[],$db.crm.leOnlineVendedoresDigitadores({entregueInicio:this.entregueInicio,entregueFim:this.entregueFim}).then(n=>{n.forEach(c=>{c.codigo&&this.digitadoresOpcoes.push({label:c.nome,value:c.codigo})})}))}),this.atualizar()},mounted(){this.$route.params.id&&this.$route.params.id.length&&(this.$refs.registroModal.atualizar(this.$route.params.id),this.$refs.registroModal.visibilidade.modal=!0)}},ne=u("span",{class:"col-12 text-body1 text-dark"},"Per\xEDodo de Emiss\xE3o",-1),de=u("span",{class:"col-12 text-body1 text-dark"},"Per\xEDodo de Finaliza\xE7\xE3o",-1),ce=["onClick"],ue=["onClick"],me={class:"q-col-gutter-xs"};function he(o,a,n,c,t,s){const h=C("campo"),I=C("row"),y=C("Badge"),k=C("BadgeCopiarUid"),x=C("avatar"),O=C("badge"),j=C("lista"),r=C("RegistroModal"),q=C("NfePrincipal");return d(),p("div",null,[e(j,{titulo:s.tituloPagina,onCriar_click:s.criarItem,showAdd:!1,onFiltro_change:s.atualizar,onLimparFiltros_click:s.limparFiltros_click,icone:"description",tabSelecionada:t.tabSelecionada,tabs:t.tabs,showToolbar:!1,paginacao:t.paginacao,filtros:t.filtros,buscaCampo:t.buscaCampo,"onUpdate:buscaCampo":a[6]||(a[6]=l=>t.buscaCampo=l),checkboxModel:t.checkboxModel,"onUpdate:checkboxModel":a[7]||(a[7]=l=>t.checkboxModel=l)},{filtroCampos:i(()=>[e(h,{modelValue:t.filtros.cliente.nome,"onUpdate:modelValue":a[0]||(a[0]=l=>t.filtros.cliente.nome=l),before:[{icon:"search",handler:s.filtroCliente_click}],dense:"",rotulo:"Cliente"},null,8,["modelValue","before"]),t.diretivaContatosAcessaTodosContatos?(d(),_(ct,{key:0,modelValue:t.digitadorSelecionado,"onUpdate:modelValue":[a[1]||(a[1]=l=>t.digitadorSelecionado=l),s.atualizar],options:t.digitadoresOpcoes,clearable:"",label:"Digitador"},null,8,["modelValue","options","onUpdate:modelValue"])):m("",!0),e(I,{class:"q-col-gutter-md q-mt-md"},{default:i(()=>[ne,e(h,{modelValue:t.filtros.periodo.emissao.ini,"onUpdate:modelValue":a[2]||(a[2]=l=>t.filtros.periodo.emissao.ini=l),tipo:"data",class:"no-shadow full-width",rotulo:"De",col:"12",after:[{icon:"mdi-close-circle",handler(){t.filtros.periodo.emissao.ini=""}}],dense:""},null,8,["modelValue","after"]),e(h,{modelValue:t.filtros.periodo.emissao.fim,"onUpdate:modelValue":a[3]||(a[3]=l=>t.filtros.periodo.emissao.fim=l),tipo:"data",class:"no-shadow full-width",rotulo:"at\xE9",col:"12",after:[{icon:"mdi-close-circle",handler(){t.filtros.periodo.emissao.fim=""}}],dense:""},null,8,["modelValue","after"])]),_:1}),e(I,{class:"q-col-gutter-md q-mt-md"},{default:i(()=>[de,e(h,{modelValue:t.filtros.periodo.finalizado.ini,"onUpdate:modelValue":a[4]||(a[4]=l=>t.filtros.periodo.finalizado.ini=l),tipo:"data",class:"no-shadow full-width",rotulo:"De",col:"12",after:[{icon:"mdi-close-circle",handler(){t.filtros.periodo.finalizado.ini=""}}],dense:""},null,8,["modelValue","after"]),e(h,{modelValue:t.filtros.periodo.finalizado.fim,"onUpdate:modelValue":a[5]||(a[5]=l=>t.filtros.periodo.finalizado.fim=l),tipo:"data",class:"no-shadow full-width",rotulo:"at\xE9",col:"12",after:[{icon:"mdi-close-circle",handler(){t.filtros.periodo.finalizado.fim=""}}],dense:""},null,8,["modelValue","after"])]),_:1})]),itemLista:i(()=>[e(B,{class:"bg-white"},{default:i(()=>[(d(!0),p(F,null,N(t.documentos,l=>(d(),p("div",{key:l,class:"itemHover fullWidth"},[e(z,{"manual-focus":"",clickable:"",class:"items-center d-flex q-pa-xs"},{default:i(()=>[e(b,{avatar:"",center:"",class:"mw80 hideonmobile"},{default:i(()=>[Number(l.numero)?(d(),_(y,{key:0,class:"q-mr-sm",cor:"tertiary",escuro:""},{default:i(()=>[g(" #"+f(String(l.numero).padStart(6,"0")),1)]),_:2},1024)):(d(),_(k,{key:1,id:l.id,numero:l.id.slice(-6),cor:"tertiary"},null,8,["id","numero"]))]),_:2},1024),e(b,{clickable:""},{default:i(()=>[e(I,{class:"items-center q-col-gutter-x-sm"},{default:i(()=>[u("div",{class:"col-auto items-center",onClick:v=>s.abrirItem(l.id)},[e(x,{imagem:l.imagem,tamanho:"40",rotulo:l.descricaoContato,style:{display:"flex","align-self":"center"}},null,8,["imagem","rotulo"])],8,ce),u("div",{class:"col",onClick:v=>s.abrirItem(l.id)},[e(V,{class:"text-tertiary text-weight-bold"},{default:i(()=>[g(f(l.descricaoContato),1)]),_:2},1024)],8,ue)]),_:2},1024)]),_:2},1024),e(b,{onClick:v=>s.abrirItem(l.id),avatar:"",class:"mw100 hideonmobile"},{default:i(()=>[e(V,{class:"full-width"},{default:i(()=>[e(E,{name:"mdi-calendar-today"}),g(" "+f(o.$filters.data(l.dataHoraEmissao))+" ",1),e(R,null,{default:i(()=>[g(" Data Emiss\xE3o "+f(o.$filters.dataHora(l.dataHoraEmissao)),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),l.dataHoraFinalizado?(d(),_(b,{key:0,onClick:v=>s.abrirItem(l.id),avatar:"",class:"mw100 hideonmobile"},{default:i(()=>[e(V,{class:"full-width"},{default:i(()=>[e(E,{name:"mdi-calendar-check"}),g(f(o.$filters.data(l.dataHoraFinalizado))+" ",1),e(R,null,{default:i(()=>[g(" Data Finalizado "+f(o.$filters.dataHora(l.dataHoraFinalizado)),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])):m("",!0),e(b,{onClick:v=>s.abrirItem(l.id),avatar:"",class:"mw100 hideonmobile"},{default:i(()=>[e(O,{class:"q-mr-sm",cor:"primary",escuro:""},{default:i(()=>[g(f(l.status),1)]),_:2},1024)]),_:2},1032,["onClick"]),t.ocultarValores?m("",!0):(d(),_(b,{key:1,onClick:v=>s.abrirItem(l.id),avatar:"",class:"mw120 hideonmobile"},{default:i(()=>[e(V,{class:"text-right text-tertiary text-weight-bold"},{default:i(()=>[g(f(o.$filters.numero(l.totalDocumento,2)),1)]),_:2},1024),e(V,{caption:"",class:"text-right text-tertiary"},{default:i(()=>[g(f(l.documentoItens.length)+" Itens ",1)]),_:2},1024)]),_:2},1032,["onClick"])),e(b,{side:"",top:""},{default:i(()=>[u("div",me,[t.filtros.tab==="Em Digita\xE7\xE3o"?(d(),_(w,{key:0,class:"buttons",color:"primary",dense:"",flat:"",icon:"edit",round:"",size:"md",onClick:v=>s.abrirItem(l.id)},null,8,["onClick"])):m("",!0),t.filtros.tab!=="Em Digita\xE7\xE3o"?(d(),_(w,{key:1,class:"buttons",color:"primary",dense:"",flat:"",icon:"visibility",round:"",size:"md",onClick:v=>s.abrirItem(l.id,!0)},null,8,["onClick"])):m("",!0),e(w,{rounded:"",dense:"",flat:"",icon:"print",color:"tertiary",unelevated:"",class:"hideonmobile q-mx-xs",size:"md"},{default:i(()=>[e(Y,null,{default:i(()=>[(d(!0),p(F,null,N(t.configImpressaoRegistro.filter(v=>v.valor),v=>(d(),_(z,{clickable:"",key:v.valor,onClick:G=>o.$imprimir(v.valor,{id:(l||{}).id||"0",Oculto:"0"})},{default:i(()=>[e(b,{avatar:""},{default:i(()=>[e(E,{name:"print"})]),_:1}),e(b,null,{default:i(()=>[e(V,null,{default:i(()=>[g(f(v.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:2},1024)]),_:2},1024),e(w,{dense:"",flat:"",icon:"more_vert",round:"",size:"md"},{default:i(()=>[e(Y,null,{default:i(()=>[H((d(),_(B,{class:"q-py-none",link:"","no-border":"",separator:""},{default:i(()=>[t.filtros.tab==="Em Digita\xE7\xE3o"?(d(),_(z,{key:0,clickable:"",onClick:v=>s.removerItem(l)},{default:i(()=>[e(b,{avatar:""},{default:i(()=>[e(E,{name:"delete"})]),_:1}),e(b,null,{default:i(()=>[g(" Remover")]),_:1})]),_:2},1032,["onClick"])):m("",!0),t.filtros.tab==="Excluidos"?(d(),_(z,{key:1,onClick:v=>o.restaurarItem(l)},{default:i(()=>[e(b,{avatar:""},{default:i(()=>[e(E,{name:"restore_from_trash"})]),_:1}),e(b,null,{default:i(()=>[g("Restaurar")]),_:1})]),_:2},1032,["onClick"])):m("",!0),t.filtros.tab==="Finalizado"?(d(),_(z,{key:2,clickable:"",onClick:v=>s.emitirNFeClick(l.id)},{default:i(()=>[e(b,{avatar:""},{default:i(()=>[e(E,{name:"upload"})]),_:1}),e(b,null,{default:i(()=>[g("Emitir Nota")]),_:1})]),_:2},1032,["onClick"])):m("",!0)]),_:2},1024)),[[T]])]),_:2},1024)]),_:2},1024)])]),_:2},1024)]),_:2},1024),e(Q)]))),128))]),_:1})]),_:1},8,["titulo","onCriar_click","onFiltro_change","onLimparFiltros_click","tabSelecionada","tabs","paginacao","filtros","buscaCampo","checkboxModel"]),e(r,{ref:"registroModal",onAtualizar:s.atualizar},null,8,["onAtualizar"]),e(q)])}var xe=Z(re,[["render",he]]);export{xe as default};
