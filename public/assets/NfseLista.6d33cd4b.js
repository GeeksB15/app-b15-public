import{_ as A,a as q,bd as P,p as D,o as v,d as V,f as t,w as r,C as F,i as N,aj as S,ak as u,j as C,e as p,L as k,l as _,x as y,Q as L,ai as j,F as T,r as O,ah as w,t as E,k as $,D as R,aF as M,am as U,s as J,B as I,E as X,aK as Q,z as H,U as B,y as Z}from"./index.7658826a.js";import{x as z}from"./xlsx.7258543e.js";import{l as G}from"./listaV2.e299c90f.js";import{n as K}from"./Nfse.c605a8f1.js";import{J as W}from"./JsonViewer.07397496.js";import"./QBreadcrumbs.35544cbf.js";import"./QSpace.5a561618.js";import"./optionsNfse.22979934.js";const Y={components:{lista:G,nfse:K,JsonViewer:W},data(){return{lista:[],buscaCampo:"",checkboxModel:!0,im:"",dialogoSincronizarLote:{visivel:!1,listaEmpresas:[],empresa:null,periodoInicial:null,periodoFinal:null},filtros:{emitente:null,destinatario:null,numeroRps:null,numeroNfse:null,dataEmissaoNfseDe:null,dataEmissaoNfseAte:null,dataCriacaoRpsDe:null,dataCriacaoRpsAte:null},paginacao:{atual:1,maximo:1,total:1,limite:25},tabSelecionada:{valor:"Rascunho"},tabs:[{rotulo:"Rascunho",value:"Rascunho"},{rotulo:"Protocoladas",value:"Protocolada"},{rotulo:"Enviadas",value:"Enviada"},{rotulo:"Canceladas",value:"Cancelada"},{rotulo:"Todos",value:"Todos"}]}},methods:{async selecionarEmpresa(){let o;const a={ativo:!0,empresas:!0},i=await $g.promptContato.show({filtro:a,placeholder:"Selecione"});if(!i)throw new Error("Nenhum contato selecionado");i.nome||(o="\xC9 preciso informar a Raz\xE3o Social do Prestador"),!o&&!i.numeroDocumentoMunicipal&&(o="\xC9 preciso informar a inscri\xE7\xE3o municipal");const e=!i.numeroDocumentoNacional||i.numeroDocumentoNacional.length<14;if(!o&&e&&(o="\xC9 preciso informar o CNPJ do Prestador"),o)throw $q.notifyError(o),new Error(o);return i},async mostrarNfse(o){this.$router.replace({params:{id:o}}),await this.$refs.modalNfse.show(o)},async criarRps(){var o;try{const a=await this.selecionarEmpresa(),i=(await $db.empresa.le({idContato:a.id}))[0],e=await $db.contatoEndereco.leEnderecoPrincipal(a.id),s={documento:a.numeroDocumentoNacional.match(/\d+/g).join(""),nome:a.nome,inscricaoMunicipal:a.numeroDocumentoMunicipal,nfseOptanteSimples:(i==null?void 0:i.nfseOptanteSimples)||"",nfseIncentivadorCultural:(i==null?void 0:i.nfseIncentivadorCultural)||"",nfseNaturezaOperacao:(i==null?void 0:i.nfseNaturezaOperacao)||"",nfseRegimeTributario:(i==null?void 0:i.nfseRegimeTributario)||"",nfseDescricaoServico:(i==null?void 0:i.nfseDescricaoServico)||"",nfseCodigoServico:(i==null?void 0:i.nfseCodigoServico)||"",nfseAliquotaIss:i==null?void 0:i.nfseAliquotaIss,nfseItensListaDeServico:JSON.parse(i==null?void 0:i.nfseItensListaDeServico)||"",ibgeCod:(e==null?void 0:e.ibgeCod)||"",cidadeUf:(e==null?void 0:e.municipio)+"-"+(e==null?void 0:e.uf)};this.im=(o=a==null?void 0:a.numeroDocumentoMunicipal)!=null?o:"";const n=await this.obterNFSeRPSMaisRecente();this.$refs.modalNfse.show(null,s,n)}catch(a){console.log(a.message)}},async obterNFSeRPSMaisRecente(){var a;let o;return o=await $db.documentoFiscalEletronico.ler({tipo:"NFSe"}),this.im&&(o=o.filter(i=>JSON.parse(i.json).rps.inscricaoMunicipal===this.im)),o.sort((i,e)=>{var c,m,d,g,f,h,l,b;const s=Number((g=(d=(m=JSON.parse((c=i.json)!=null?c:null))==null?void 0:m.rps)==null?void 0:d.identificacaoRps)==null?void 0:g.numero),n=Number((b=(l=(h=JSON.parse((f=e.json)!=null?f:null))==null?void 0:h.rps)==null?void 0:l.identificacaoRps)==null?void 0:b.numero);return s>n?-1:1}),(a=o[0])!=null?a:null},async atualizar(o){try{$q.loading.show(),this.documentos=await $db.documentoFiscalEletronico.ler({tipo:"NFSe"});for(const a of this.documentos){const{rps:i}=JSON.parse(a.json);a.rps=i,a.showPreviewDetail=this.showPreviewDetail}if(this.documentos.sort((a,i)=>{var e,s;return Number((e=a==null?void 0:a.rps.identificacaoRps)==null?void 0:e.numero)<Number((s=i==null?void 0:i.rps.identificacaoRps)==null?void 0:s.numero)?1:-1}),(o==null?void 0:o.id)&&(o==null?void 0:o.situacaoNfse)==="Enviada"){await this.aplicarFiltrosEPaginacao(o);return}await this.aplicarFiltrosEPaginacao()}catch(a){$q.notifyError("Erro iniciar",a)}finally{$q.loading.hide()}},async aplicarFiltrosEPaginacao(o){if(this.aplicarFiltroPelaTab({situacaoNfse:o==null?void 0:o.situacaoNfse}),o!=null&&o.id&&(this.buscaCampo=o==null?void 0:o.id),/^[A-F|0-9]{8}-[A-F|0-9]{4}-[A-F|0-9]{4}-[A-F|0-9]{4}-[A-F|0-9]{12}$/.test(this.buscaCampo)){this.paginacao.atual=1,this.paginacao.maximo=1,this.paginacao.total=1,this.listaTmp=this.listaTmp.filter(e=>e.id===this.buscaCampo),this.lista=this.listaTmp;return}if(this.filtros.emitente){const e=new RegExp(this.filtros.emitente,"i");this.listaTmp=this.listaTmp.filter(s=>e.test(s.xNomeEmitente))}if(this.filtros.destinatario||this.buscaCampo){const e=this.buscaCampo||this.filtros.destinatario,s=new RegExp(e,"i");this.listaTmp=this.listaTmp.filter(n=>s.test(n.xNomeDestinatario))}if(this.filtros.numeroRps){const e=new RegExp(this.filtros.numeroRps);this.listaTmp=this.listaTmp.filter(s=>e.test(s.rps.identificacaoRps.numero))}if(this.filtros.numeroNfse&&(this.listaTmp=this.listaTmp.filter(e=>e.rps.numero===this.filtros.numeroNfse)),this.filtros.dataEmissaoNfseDe&&this.filtros.dataEmissaoNfseDe.length===10){const e=this.filtros.dataEmissaoNfseDe.split("/"),s=new Date(Number(e[2]),Number(e[1])-1,Number(e[0]));this.listaTmp=this.listaTmp.filter(n=>new Date(new Date(n.rps.dataEmissao).toDateString())>=s)}if(this.filtros.dataEmissaoNfseAte&&this.filtros.dataEmissaoNfseAte.length===10){const e=this.filtros.dataEmissaoNfseAte.split("/"),s=new Date(Number(e[2]),Number(e[1])-1,Number(e[0]));this.listaTmp=this.listaTmp.filter(n=>new Date(new Date(n.rps.dataEmissao).toDateString())<=s)}if(this.filtros.dataCriacaoRpsDe&&this.filtros.dataCriacaoRpsDe.length===10){const e=this.filtros.dataCriacaoRpsDe.split("/"),s=new Date(Number(e[2]),Number(e[1])-1,Number(e[0]));this.listaTmp=this.listaTmp.filter(n=>new Date(new Date(n.rps.dataHoraCriacao).toDateString())>=s)}if(this.filtros.dataCriacaoRpsAte&&this.filtros.dataCriacaoRpsAte.length===10){const e=this.filtros.dataCriacaoRpsAte.split("/"),s=new Date(Number(e[2]),Number(e[1])-1,Number(e[0]));this.listaTmp=this.listaTmp.filter(n=>new Date(new Date(n.rps.dataHoraCriacao).toDateString())<=s)}this.setupPaginacao();const a=this.paginacao.atual*this.paginacao.limite-this.paginacao.limite,i=this.paginacao.atual*this.paginacao.limite;this.lista=this.listaTmp.slice(a,i)},aplicarFiltroPelaTab(o){if(o!=null&&o.situacaoNfse&&(this.tabSelecionada={valor:o.situacaoNfse}),this.tabSelecionada.valor==="Todos"){this.listaTmp=this.documentos;return}const a=this.tabSelecionada.valor;this.listaTmp=this.documentos.filter(i=>i.situacao===a)},setupPaginacao(){const o=Math.ceil(this.listaTmp.length/this.paginacao.limite);this.paginacao.atual=this.paginacao.atual>o?o:this.paginacao.atual,this.paginacao.total=this.listaTmp.length,this.paginacao.maximo=o},toogleTodosPreview(){this.showPreviewDetail=!this.showPreviewDetail;for(const o of this.lista)o.showPreviewDetail=this.showPreviewDetail},async limparFiltros_click(){this.filtros={emitente:null,destinatario:null,numeroRps:null,numeroNfse:null},await this.atualizar()},async exportarXLSX_click(){try{$q.loading.show();const o=$utils.eliminarVazios(this.filtros);delete o.ativo,this.tabSelecionada.valor==="Ativos"&&(o.ativo=!0),this.tabSelecionada.valor==="Excluidos"&&(o.ativo=!1);const a=await $db.item.leRefatorado({filtros:o,limit:999999,page:1,sort:"descricao"}),i=z.utils.book_new(),e=z.utils.json_to_sheet(a.data,{header:Object.keys(a.data[0])});z.utils.book_append_sheet(i,e,"itens"),z.writeFile(i,"itens.xlsx")}catch(o){$q.notifyError("Erro iniciar",o)}finally{$q.loading.hide()}},abrirModalDeCancelamento(o){$q.dialog({title:"Cancelar NFS-e",message:"Qual o motivo do cancelamento?",prompt:{model:"",isValid:a=>!!a},cancel:!0,persistent:!0}).onOk(async a=>{const{rps:i}=o,e={numero:i.numero,motivoCancelamento:a,inscricaoMunicipal:i.prestador.inscricaoMunicipal,cnpj:i.prestador.documento,codigoMunicipio:i.servico.municipioPrestacaoServico,codigoCancelamento:5};await this.cancelarNfse(e,o)})},async cancelarNfse(o,a){var i,e,s,n,c;this.$q.loading.show();try{if((i=a.rps)!=null&&i.plugNotasConsulta){console.log("cancelamento via plugNotas");const m={motivo:o.motivoCancelamento},d=await $api.plugnotas.nfse.solicitarCancelamentoNFSe((e=a.rps.plugNotasConsulta)==null?void 0:e.id,m);if((d==null?void 0:d.message)==="Cancelamento em processamento"&&((s=d==null?void 0:d.data)==null?void 0:s.protocol))if((await $api.plugnotas.nfse.consultarCancelamentoNFSe((n=d==null?void 0:d.data)==null?void 0:n.protocol)).data.status==="CONCLUIDO"){a.rps.motivoCancelamento=o.motivoCancelamento,a.rps.status="2";const f={...a,situacao:"Cancelada",json:JSON.stringify({rps:a.rps})};await $db.documentoFiscalEletronico.grava({atual:f,original:a});let h={};f.id&&(h=(await $erp().documentoFiscalEletronicoXml.where({idDocumentoFiscalEletronico:f.id}).toArray())[0],await $db.documentoFiscalEletronicoXml.grava({atual:{...h,situacao:f.situacao},original:h})),$q.notifyPositive("NFS-e cancelada!")}else $q.notifyError("N\xE3o foi poss\xEDvel realizar o cancelamento, por favor tente novamente!")}if(!((c=a.rps)!=null&&c.plugNotasConsulta))if((await q.post("https://api.b15.com.br/integradorjs/nfse/cancelar",{jsonParaXML:o})).data.xmlPassou){$q.notifyPositive("NFS-e cancelada!"),a.rps.motivoCancelamento=o.motivoCancelamento,a.rps.status="2";const d={...a,situacao:"Cancelada",json:JSON.stringify({rps:a.rps})};await $db.documentoFiscalEletronico.grava({atual:d,original:a});let g={};d.id&&(g=(await $erp().documentoFiscalEletronicoXml.where({idDocumentoFiscalEletronico:d.id}).toArray())[0],await $db.documentoFiscalEletronicoXml.grava({atual:{...g,situacao:d.situacao},original:g}))}else $q.notifyError("N\xE3o foi poss\xEDvel realizar o cancelamento, por favor tente novamente!")}catch{$q.notifyError("Falha ao enviar XML")}await this.atualizar(),this.$q.loading.hide()},confirmarExclusaoNfse(o){$q.dialog({title:"Remover NFS-e",message:"Deseja remover esta NFS-e?",cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(async()=>{try{await $db.documentoFiscalEletronico.remove(o),$q.notifyPositive("NFS-e removida com sucesso")}catch{$q.notifyError("Falha ao remover NFS-e")}this.atualizar()})},async downloadPDF(o){var e;let a=await $db.documentoFiscalEletronico.ler({id:o}),i=JSON.parse((e=a==null?void 0:a.json)!=null?e:null);try{$q.loading.show({message:"Solicitando URL...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"}),i.rps.pdf=await $db.nfse.solicitarURLImpressao(o);let s=document.createElement("a");s.href=i.rps.pdf,s.download=`nfse-${i.rps.identificacaoRps.numero}.pdf`,s.click()}catch(s){console.error(s.message)}finally{$q.loading.hide()}},async solicitarURLImpressao(o){var s,n,c;let a=await $db.documentoFiscalEletronico.ler({id:o}),i=JSON.parse((s=a==null?void 0:a.json)!=null?s:null),e;try{$q.loading.show({message:"Solicitando URL...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"}),e=await $db.nfse.solicitarURLImpressao(o),(n=i==null?void 0:i.rps)!=null&&n.plugNotasConsulta&&window.open("","_blank").document.write(`<iframe width='100%' height='100%' src='${e}'></iframe>`),(c=i==null?void 0:i.rps)!=null&&c.plugNotasConsulta||window.open(e,"_blank"),await this.atualizar()}catch(m){let d=m.message.replace("db.nfse.sincronizarLote: ","");d.length!==m.message&&$q.notifyError(d),d.length===m.message&&console.error(m.message)}finally{$q.loading.hide()}},async solicitarURLImpressaoEmLote(){var a;const o=$utils.clonarV2(this.lista.filter(i=>i.situacao==="Enviada"));o.sort((i,e)=>{var c,m,d,g,f,h,l,b;const s=(g=(d=(m=JSON.parse((c=i.json)!=null?c:null))==null?void 0:m.rps)==null?void 0:d.identificacaoRps)==null?void 0:g.numero,n=(b=(l=(h=JSON.parse((f=e.json)!=null?f:null))==null?void 0:h.rps)==null?void 0:l.identificacaoRps)==null?void 0:b.numero;return s>n?1:-1});for(const i of o)try{let e=await $db.documentoFiscalEletronico.ler({id:i.id}),s=JSON.parse((a=e==null?void 0:e.json)!=null?a:null),n;n=await $db.nfse.solicitarURLImpressao(i.id)}catch(e){console.log(e.message)}},async baixarXml(o){var e,s;let{xml:a}=o.rps;if((!a||/^https:\/\/.+$/.test(a))&&((s=(e=o.rps)==null?void 0:e.plugNotasConsulta)==null?void 0:s.xml)){const n=o.rps.plugNotasConsulta.xml;a=await $api.plugnotas.nfse.baixarXmlNFSe(n,o)}if(a){const n=document.createElement("a");var i=new Blob([a],{type:"text/plain"});n.setAttribute("href",window.URL.createObjectURL(i)),n.setAttribute("download",`${o.rps.identificacaoRps.numero}.xml`),n.dataset.downloadurl=["text/plain",n.download,n.href].join(":"),n.click()}a||this.$q.notifyError("N\xE3o foi poss\xEDvel recuperar o XML")},async recarregarPDF(o){var s,n,c;let a=await $db.documentoFiscalEletronico.ler({id:o}),i=$utils.clonarV2(a),e=JSON.parse((s=a==null?void 0:a.json)!=null?s:null);(n=e.rps.plugNotasConsulta)!=null&&n.pdf&&((c=e.rps.plugNotasConsulta)==null||delete c.pdf),e.rps.pdf&&delete e.rps.pdf,a.json=e,await $db.documentoFiscalEletronico.grava({atual:a,original:i}),this.solicitarURLImpressao(o)},async enviarEmailNfse(o){var a,i;try{if(this.$q.loading.show(),!o.cpfCnpjDestinatario||!o.id)return;const e=await $db.documentoFiscalEletronico.ler({id:o.id});if(!(e!=null&&e.id))return;const n=(await $db.contato.ler({filtros:{termoBusca:e.cpfCnpjDestinatario,ativo:!0}})).data.find(f=>{var h;return((h=f.numeroDocumentoNacional)!=null?h:"").replace(/\D/g,"")===e.cpfCnpjDestinatario}),c=(i=JSON.parse((a=e.json)!=null?a:null))==null?void 0:i.rps;if(!c)return;let m;this.$q.loading.hide();try{m=await new Promise((f,h)=>{var l;$q.dialog({title:"Informe o e-mail",message:"E-mail do destinat\xE1rio",prompt:{model:(l=n==null?void 0:n.email)!=null?l:"",isValid:b=>/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(b.toLowerCase()),type:"text"},cancel:!0,persistent:!1}).onOk(b=>{f(b)}).onCancel(()=>{h("Cancelado pelo usu\xE1rio")}).onDismiss(()=>{h("Cancelado pelo usu\xE1rio")})}).catch(f=>{throw new Error(f)})}catch(f){console.log(f.message);return}this.$q.loading.show();const d=[{name:"nfse.xml",content:c.xml}];c.link&&d.push({name:"nfse.pdf",url:c.link,method:"url2pdf"});const g={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",to:m,subject:`Nota Fiscal Eletr\xF4nica de Servi\xE7os N\xBA ${c.numero}`,text:`Voc\xEA est\xE1 recebendo os arquivos digitais NFS-e (Nota Fiscal Eletr\xF4nica de Servi\xE7os) da empresa ${e.xNomeEmitente}`,attachments:d};await q({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:g}),this.$q.notifyPositive("E-mail enviado com sucesso")}catch{this.$q.notifyError("Erro ao enviar email")}finally{this.$q.loading.hide()}},async enviarLote(){var o,a;try{$q.loading.show({message:"Preparando envio do lote...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const i=$utils.clonarV2(this.lista.filter(e=>e.situacao==="Rascunho"));i.sort((e,s)=>{var m,d,g,f,h,l,b,x;const n=(f=(g=(d=JSON.parse((m=e.json)!=null?m:null))==null?void 0:d.rps)==null?void 0:g.identificacaoRps)==null?void 0:f.numero,c=(x=(b=(l=JSON.parse((h=s.json)!=null?h:null))==null?void 0:l.rps)==null?void 0:b.identificacaoRps)==null?void 0:x.numero;return n>c?1:-1});for(const e of i){const s=(await $erp().documentoFiscalEletronicoXml.where({idDocumentoFiscalEletronico:e.id}).toArray())[0],n=(o=JSON.parse(e.json))==null?void 0:o.rps;n!=null&&n.dataEmissao||(n.dataEmissao=$utils.dataAtual()),$q.loading.show({message:`Enviando...
                <br /><br />
                <strong>Lote</strong> ${n.numeroLote}<br />
                <strong>RPS</strong> ${n.identificacaoRps.numero}<br />
                <strong>S\xE9rie</strong> ${n.identificacaoRps.serie}<br />
                <br />
                ${n.tomador.razaoSocial}`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const{nfse:c,situacao:m}=await $db.nfse.emitir({nfse:n,aguardarRetorno:!1}),d={id:e.id,tipo:"NFSe",tpAmb:"2",situacao:m,mod:"",serie:"",nNF:"",chNFe:"",vNF:0,dhEmi:P.formatarDataNFe(new Date((a=this.nfse)==null?void 0:a.dataEmissao)),cpfCnpjEmitente:c.prestador.documento,xNomeEmitente:c.prestador.razaoSocial,cpfCnpjDestinatario:c.tomador.documento,xNomeDestinatario:c.tomador.razaoSocial,dataHoraEmissao:c==null?void 0:c.dataEmissao,dataHoraCriacao:e.dataHoraCriacao||$utils.dataAtual(),json:JSON.stringify({rps:c})},g={id:(s==null?void 0:s.id)||$utils.uuid(),tipo:d.tipo,situacao:m,tpAmb:d.tpAmb,dataHoraEnvio:c==null?void 0:c.dataEmissao,cpfCnpjEmitente:c.prestador.documento,xmlEnvio:c.xml,idDocumentoFiscalEletronico:d.id};await $db.documentoFiscalEletronico.grava({atual:d,original:e}),await $db.documentoFiscalEletronicoXml.grava({atual:g,original:s})}this.atualizar()}catch(i){console.log(i.message)}finally{$q.loading.hide()}},async protocolarLote(){var o,a;try{$q.loading.show({message:"Preparando envio do lote...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const i=$utils.clonarV2(this.lista.filter(e=>e.situacao==="Protocolada"));i.sort((e,s)=>{var m,d,g,f,h,l,b,x;const n=(f=(g=(d=JSON.parse((m=e.json)!=null?m:null))==null?void 0:d.rps)==null?void 0:g.identificacaoRps)==null?void 0:f.numero,c=(x=(b=(l=JSON.parse((h=s.json)!=null?h:null))==null?void 0:l.rps)==null?void 0:b.identificacaoRps)==null?void 0:x.numero;return n>c?1:-1});for(const e of i){const s=(await $erp().documentoFiscalEletronicoXml.where({idDocumentoFiscalEletronico:e.id}).toArray())[0],n=(o=JSON.parse(e.json))==null?void 0:o.rps;n!=null&&n.dataEmissao||(n.dataEmissao=$utils.dataAtual()),$q.loading.show({message:`Enviando...
                <br /><br />
                <strong>Lote</strong> ${n.numeroLote}<br />
                <strong>RPS</strong> ${n.identificacaoRps.numero}<br />
                <strong>S\xE9rie</strong> ${n.identificacaoRps.serie}<br />
                <br />
                ${n.tomador.razaoSocial}`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const{nfse:c,situacao:m}=await $db.nfse.emitir({nfse:n,aguardarRetorno:!1}),d={id:e.id,tipo:"NFSe",tpAmb:"2",situacao:m,mod:"",serie:"",nNF:"",chNFe:"",vNF:0,dhEmi:P.formatarDataNFe(new Date((a=this.nfse)==null?void 0:a.dataEmissao)),cpfCnpjEmitente:c.prestador.documento,xNomeEmitente:c.prestador.razaoSocial,cpfCnpjDestinatario:c.tomador.documento,xNomeDestinatario:c.tomador.razaoSocial,dataHoraEmissao:c==null?void 0:c.dataEmissao,dataHoraCriacao:e.dataHoraCriacao||$utils.dataAtual(),json:JSON.stringify({rps:c})},g={id:(s==null?void 0:s.id)||$utils.uuid(),tipo:d.tipo,situacao:m,tpAmb:d.tpAmb,dataHoraEnvio:c==null?void 0:c.dataEmissao,cpfCnpjEmitente:c.prestador.documento,xmlEnvio:c.xml,idDocumentoFiscalEletronico:d.id};await $db.documentoFiscalEletronico.grava({atual:d,original:e}),await $db.documentoFiscalEletronicoXml.grava({atual:g,original:s})}this.atualizar()}catch(i){console.log(i.message)}finally{$q.loading.hide()}},async abrirDialogoSincronizarLote(){const o=new Date,a=(await $db.contato.ler({filtros:{ativo:!0,empresas:!0}})).data;this.dialogoSincronizarLote.listaEmpresas=a.map(i=>({value:i.id,label:i.nome+" - "+i.numeroDocumentoNacional,cnpj:i.numeroDocumentoNacional,inscricaoMunicipal:i.numeroDocumentoMunicipal})),this.dialogoSincronizarLote.empresa=this.dialogoSincronizarLote.listaEmpresas[0],this.dialogoSincronizarLote.periodoInicial=o,this.dialogoSincronizarLote.periodoFinal=o,this.dialogoSincronizarLote.visivel=!0},async sincronizarLote(){try{$q.loading.show({message:"Obtendo dados do servidor...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"}),await $db.nfse.sincronizarLote({inscricaoMunicipal:this.dialogoSincronizarLote.empresa.inscricaoMunicipal,cnpj:this.dialogoSincronizarLote.empresa.cnpj,periodo:{inicial:this.dialogoSincronizarLote.periodoInicial,final:this.dialogoSincronizarLote.periodoFinal}},(o,a)=>$q.loading.show({message:`${a}...
                <br /><br />
                <strong>Lote</strong> ${o.numeroLote}<br />
                <strong>RPS</strong> ${o.identificacaoRps.numero}<br />
                <strong>S\xE9rie</strong> ${o.identificacaoRps.serie}<br />
                <br />
                ${o.tomador.razaoSocial}`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})),this.dialogoSincronizarLote.visivel=!1,this.atualizar()}catch(o){let a=o.message.replace("db.nfse.sincronizarLote: ","");a.length!==o.message&&$q.notifyError(a),a.length===o.message&&console.error(o.message)}finally{$q.loading.hide()}},async mostrarJsonViewer(){await this.$refs.jsonViewer.show(this)}},mounted(){this.$route.params.id&&this.$route.params.id.length&&this.mostrarNfse(this.$route.params.id),this.atualizar()}},aa=y("div",{class:"q-mt-md"},"Data de emiss\xE3o NFS-e",-1),oa={class:"row q-col-gutter-x-sm"},ea=y("div",{class:"q-mt-md"},"Data de cria\xE7\xE3o RPS",-1),ta={class:"row q-col-gutter-x-sm"},ia={class:"text-tertiary q-col-gutter-xs"},sa={class:"row full-width"},la={class:"col-12"},ra={class:"col"},na=y("div",{class:"col-auto",style:{"align-items":"center",display:"flex"}},[y("label",null,"at\xE9")],-1),ca={class:"col"},da={class:"q-mt-lg text-right"};function ua(o,a,i,e,s,n){const c=D("campo"),m=D("badge"),d=D("lista"),g=D("nfse"),f=D("JsonViewer"),h=D("row");return v(),V("div",null,[t(d,{titulo:"NFS-e",checkboxModel:s.checkboxModel,"onUpdate:checkboxModel":a[13]||(a[13]=l=>s.checkboxModel=l),buscaCampo:s.buscaCampo,"onUpdate:buscaCampo":a[14]||(a[14]=l=>s.buscaCampo=l),onCriar_click:n.criarRps,onFiltro_change:n.atualizar,onLimparFiltros_click:n.limparFiltros_click,onAbrirTodosPreview:n.toogleTodosPreview,onExportarXLSX_click:n.exportarXLSX_click,lista:s.lista,tabs:s.tabs,tabSelecionada:s.tabSelecionada,paginacao:s.paginacao,filtros:s.filtros,permissaoExtras:!0,exportarXLSXVisible:!1,checkboxVisible:!1,removerTodosVisible:!1,showQuickAdd:!1},{menuExtras:r(()=>[F((v(),N(S,{clickable:"",onClick:a[0]||(a[0]=l=>n.enviarLote())},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"mdi-file-replace",size:"sm"})]),_:1}),t(u,null,{default:r(()=>[p("Enviar Lote")]),_:1})]),_:1})),[[k]]),F((v(),N(S,{clickable:"",onClick:a[1]||(a[1]=l=>n.protocolarLote())},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"mdi-file-replace",size:"sm"})]),_:1}),t(u,null,{default:r(()=>[p("Protocolar Lote")]),_:1})]),_:1})),[[k]]),F((v(),N(S,{clickable:"",onClick:a[2]||(a[2]=l=>n.solicitarURLImpressaoEmLote())},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"mdi-file-replace",size:"sm"})]),_:1}),t(u,null,{default:r(()=>[p("Solicitar PDF Lote")]),_:1})]),_:1})),[[k]]),F((v(),N(S,{clickable:"",onClick:a[3]||(a[3]=l=>n.abrirDialogoSincronizarLote())},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"mdi-file-replace",size:"sm"})]),_:1}),t(u,null,{default:r(()=>[p("Sincronizar Lote")]),_:1})]),_:1})),[[k]]),o.$db.usuario.desenvolvedor()?F((v(),N(S,{key:0,clickable:"",onClick:a[4]||(a[4]=l=>n.mostrarJsonViewer())},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"mdi-file-replace",size:"sm"})]),_:1}),t(u,null,{default:r(()=>[p("Ver Objeto")]),_:1})]),_:1})),[[k]]):_("",!0)]),filtroCampos:r(()=>[t(c,{modelValue:s.filtros.emitente,"onUpdate:modelValue":a[5]||(a[5]=l=>s.filtros.emitente=l),rotulo:"Emitente",dense:""},null,8,["modelValue"]),t(c,{modelValue:s.filtros.destinatario,"onUpdate:modelValue":a[6]||(a[6]=l=>s.filtros.destinatario=l),rotulo:"Destinat\xE1rio",dense:""},null,8,["modelValue"]),t(c,{modelValue:s.filtros.numeroRps,"onUpdate:modelValue":a[7]||(a[7]=l=>s.filtros.numeroRps=l),rotulo:"Numero RPS",dense:""},null,8,["modelValue"]),t(c,{modelValue:s.filtros.numeroNfse,"onUpdate:modelValue":a[8]||(a[8]=l=>s.filtros.numeroNfse=l),rotulo:"Numero NFS-e",dense:""},null,8,["modelValue"]),aa,y("div",oa,[t(L,{class:"col-12 col-md-6",modelValue:s.filtros.dataEmissaoNfseDe,"onUpdate:modelValue":a[9]||(a[9]=l=>s.filtros.dataEmissaoNfseDe=l),mask:"##/##/####",label:"De",dense:""},null,8,["modelValue"]),t(L,{class:"col-12 col-md-6",modelValue:s.filtros.dataEmissaoNfseAte,"onUpdate:modelValue":a[10]||(a[10]=l=>s.filtros.dataEmissaoNfseAte=l),mask:"##/##/####",label:"At\xE9",dense:""},null,8,["modelValue"])]),ea,y("div",ta,[t(L,{class:"col-12 col-md-6",modelValue:s.filtros.dataCriacaoRpsDe,"onUpdate:modelValue":a[11]||(a[11]=l=>s.filtros.dataCriacaoRpsDe=l),mask:"##/##/####",label:"De",dense:""},null,8,["modelValue"]),t(L,{class:"col-12 col-md-6",modelValue:s.filtros.dataCriacaoRpsAte,"onUpdate:modelValue":a[12]||(a[12]=l=>s.filtros.dataCriacaoRpsAte=l),mask:"##/##/####",label:"At\xE9",dense:""},null,8,["modelValue"])])]),itemLista:r(()=>[s.lista.length>0?(v(),N(j,{key:0,bordered:"",class:"bg-white q-mb-xs rounded-borders",style:{"min-height":"calc(100vh - 200px)"}},{default:r(()=>[(v(!0),V(T,null,O(s.lista,l=>(v(),V("div",{key:l},[t(S,null,{default:r(()=>[t(u,{top:"",class:"col-2 gt-sm"},{default:r(()=>[t(w,null,{default:r(()=>[p(E(l.rps.identificacaoRps.numero)+" ",1),t($,null,{default:r(()=>[p(" RPS (Recibo provis\xF3rio) ")]),_:1})]),_:2},1024),t(w,{caption:""},{default:r(()=>[p(E(l.rps.numero)+" ",1),t($,null,{default:r(()=>[p(" N\xBA Nota ")]),_:1})]),_:2},1024)]),_:2},1024),t(u,{top:"",class:"col-5 gt-sm"},{default:r(()=>[t(w,null,{default:r(()=>[p(E(l.xNomeDestinatario),1)]),_:2},1024),t(w,{caption:""},{default:r(()=>[p(E(l.cpfCnpjDestinatario),1)]),_:2},1024)]),_:2},1024),t(u,null,{default:r(()=>[l.rps.mensagemDeRetorno?(v(),N(C,{key:0,name:"report",size:"sm",color:"red"},{default:r(()=>[t($,null,{default:r(()=>[p(E(l.rps.mensagemDeRetorno),1)]),_:2},1024)]),_:2},1024)):_("",!0)]),_:2},1024),t(u,null,{default:r(()=>[t(w,{lines:"1"},{default:r(()=>[t(C,{name:"event",class:"text-tertiary"}),p(" "+E(o.$filters.data(l.rps.dataEmissao))+" ",1),t($,null,{default:r(()=>[p("Data/Hora da emiss\xE3o: "+E(o.$filters.dataHora(l.rps.dataEmissao)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024),t(u,{avatar:""},{default:r(()=>[t(m,{class:"q-mr-sm",escuro:"",cor:"tertiary"},{default:r(()=>[p(E(l.situacao),1)]),_:2},1024)]),_:2},1024),t(u,null,{default:r(()=>[t(u,{caption:"",class:"text-right text-tertiary"},{default:r(()=>[y("span",null,[p(E(o.$filters.numero(l.rps.servico.valores.valorServicos,2))+" ",1),t($,null,{default:r(()=>[p("Valor dos Servi\xE7os")]),_:1})])]),_:2},1024)]),_:2},1024),t(u,{side:"",center:""},{default:r(()=>[y("div",ia,[t(R,{icon:l!=null&&l.showPreviewDetail?"keyboard_arrow_up":"keyboard_arrow_down",class:"gt-xs",clickable:"",color:"tertiary",dense:"",flat:"",round:"",size:"12px",onClick:b=>l.showPreviewDetail=!(l!=null&&l.showPreviewDetail)},null,8,["icon","onClick"]),t(R,{class:"gt-xs",color:"tertiary",dense:"",flat:"",icon:"edit",round:"",size:"12px",onClick:b=>n.mostrarNfse(l.id)},null,8,["onClick"]),l.situacao==="Rascunho"?(v(),N(R,{key:0,class:"gt-xs",color:"tertiary",icon:"delete",size:"12px",onClick:b=>n.confirmarExclusaoNfse(l.id),dense:"",flat:"",round:""},null,8,["onClick"])):_("",!0),l.situacao==="Enviada"?(v(),N(R,{key:1,dense:"",flat:"",icon:"more_vert",round:"",size:"12px"},{default:r(()=>[t(M,null,{default:r(()=>[F((v(),N(j,{link:"",separator:""},{default:r(()=>{var b;return[t(S,{clickable:"",onClick:x=>n.solicitarURLImpressao(l.id)},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"print"})]),_:1}),t(u,null,{default:r(()=>[t(w,null,{default:r(()=>[p("Imprimir")]),_:1})]),_:1})]),_:2},1032,["onClick"]),(b=l.rps)!=null&&b.plugNotasConsulta?(v(),N(S,{key:0,clickable:"",onClick:x=>n.downloadPDF(l.id)},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"download_for_offline"})]),_:1}),t(u,null,{default:r(()=>[t(w,null,{default:r(()=>[p("Download PDF")]),_:1})]),_:1})]),_:2},1032,["onClick"])):_("",!0),t(S,{clickable:"",onClick:x=>n.recarregarPDF(l.id)},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"download_for_offline"})]),_:1}),t(u,null,{default:r(()=>[t(w,null,{default:r(()=>[p("Recarregar PDF")]),_:1})]),_:1})]),_:2},1032,["onClick"]),l.rps.numero&&l.situacao==="Enviada"?(v(),N(S,{key:1,clickable:"",onClick:x=>n.abrirModalDeCancelamento(l)},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"delete"})]),_:1}),t(u,null,{default:r(()=>[t(w,null,{default:r(()=>[p("Cancelar")]),_:1})]),_:1})]),_:2},1032,["onClick"])):_("",!0),l.rps.xml?(v(),N(S,{key:2,clickable:"",onClick:x=>n.baixarXml(l)},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"mdi-download"})]),_:1}),t(u,null,{default:r(()=>[t(w,null,{default:r(()=>[p("Baixar XML")]),_:1})]),_:1})]),_:2},1032,["onClick"])):_("",!0),l.rps.xml?(v(),N(S,{key:3,clickable:"",onClick:x=>n.enviarEmailNfse(l)},{default:r(()=>[t(u,{avatar:""},{default:r(()=>[t(C,{name:"mail"})]),_:1}),t(u,null,{default:r(()=>[t(w,null,{default:r(()=>[p("Enviar por email")]),_:1})]),_:1})]),_:2},1032,["onClick"])):_("",!0)]}),_:2},1024)),[[k]])]),_:2},1024)]),_:2},1024)):_("",!0)])]),_:2},1024)]),_:2},1024),l!=null&&l.showPreviewDetail?(v(),N(S,{key:0,align:"left",class:"collumnOnMobile q-px-md q-py-xs"},{default:r(()=>[y("div",sa,[t(u,null,{default:r(()=>[t(w,{caption:"",class:"text-tertiary"},{default:r(()=>[p("Emitente")]),_:1}),t(w,{class:"text-tertiary"},{default:r(()=>[p(E(l.xNomeEmitente),1)]),_:2},1024)]),_:2},1024),t(u,{avatar:""},{default:r(()=>[t(C,{name:"event",class:"text-h5 text-tertiary"})]),_:1}),t(u,null,{default:r(()=>[t(w,{caption:"",class:"text-tertiary"},{default:r(()=>[p("Cria\xE7\xE3o RPS")]),_:1}),t(w,{class:"text-tertiary"},{default:r(()=>[p(E(o.$filters.dataHora(l.rps.dataHoraCriacao)),1)]),_:2},1024)]),_:2},1024),t(u,{avatar:""},{default:r(()=>[t(C,{name:"today",class:"text-h5 text-tertiary"})]),_:1}),t(u,null,{default:r(()=>[t(w,{caption:"",class:"text-tertiary"},{default:r(()=>[p("Emiss\xE3o NFS-e")]),_:1}),t(w,{class:"text-tertiary"},{default:r(()=>[p(E(o.$filters.dataHora(l.rps.dataEmissao)),1)]),_:2},1024)]),_:2},1024)])]),_:2},1024)):_("",!0),t(U,{spaced:""})]))),128))]),_:1})):_("",!0)]),_:1},8,["checkboxModel","buscaCampo","onCriar_click","onFiltro_change","onLimparFiltros_click","onAbrirTodosPreview","onExportarXLSX_click","lista","tabs","tabSelecionada","paginacao","filtros"]),t(g,{ref:"modalNfse",onAtualizar:n.atualizar},null,8,["onAtualizar"]),t(f,{ref:"jsonViewer"},null,512),t(Z,{modelValue:s.dialogoSincronizarLote.visivel,"onUpdate:modelValue":a[18]||(a[18]=l=>s.dialogoSincronizarLote.visivel=l),"content-css":{minWidth:"50vw"}},{default:r(()=>[t(J,null,{default:r(()=>[t(I,{class:"bg-primary text-white"},{default:r(()=>[t(X,null,{default:r(()=>[p("Sincronizar Lote")]),_:1}),F(t(R,{dense:"",flat:"",icon:"close",round:""},null,512),[[k]])]),_:1}),t(Q,null,{default:r(()=>[t(H,{onSubmit:n.sincronizarLote},{default:r(()=>[t(h,{class:"q-col-gutter-md"},{default:r(()=>[y("div",la,[t(B,{modelValue:s.dialogoSincronizarLote.empresa,"onUpdate:modelValue":a[15]||(a[15]=l=>s.dialogoSincronizarLote.empresa=l),label:"Empresa",options:s.dialogoSincronizarLote.listaEmpresas,"option-value":"id","option-label":"label","emit-value":"","map-options":""},null,8,["modelValue","options"])]),y("div",ra,[t(c,{modelValue:s.dialogoSincronizarLote.periodoInicial,"onUpdate:modelValue":a[16]||(a[16]=l=>s.dialogoSincronizarLote.periodoInicial=l),tipo:"data",dense:"",outlined:""},null,8,["modelValue"])]),na,y("div",ca,[t(c,{modelValue:s.dialogoSincronizarLote.periodoFinal,"onUpdate:modelValue":a[17]||(a[17]=l=>s.dialogoSincronizarLote.periodoFinal=l),tipo:"data",dense:"",outlined:""},null,8,["modelValue"])])]),_:1}),y("div",da,[F(t(R,{color:"tertiary",flat:"",label:"Cancelar"},null,512),[[k]]),t(R,{color:"primary",class:"q-ml-sm no-shadow",unelevated:"",label:"Sincronizar",type:"submit"})])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var Na=A(Y,[["render",ua]]);export{Na as default};
