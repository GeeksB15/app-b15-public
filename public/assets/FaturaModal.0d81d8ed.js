import{_ as Va,M as Oa,p as S,o as y,d as Q,f as l,w as c,x as m,B as na,E as ca,e as O,t as x,i as k,bc as Ka,l as I,j as J,k as Ca,D as H,v as Za,aF as Aa,C as wa,ai as Ba,F as ua,r as xa,aj as la,ak as K,ah as da,L as _a,am as Wa,s as Sa,z as La,y as Ma,n as Xa,a as Ya,cM as j,cT as ao,cU as oo,cV as to,cW as eo,K as io,A as no,G as ro,H as so,I as lo,b5 as co,aQ as uo,aK as mo}from"./index.de1453f2.js";import{D as fo,C as po}from"./DocumentosFiscais.09b2cfcb.js";import{e as vo}from"./emitirNFe.de0f28dd.js";import{V as ho}from"./VendaCard.87a2f291.js";const go={components:{Avatar:Oa},computed:{mostrarMenuTresPontos(){return this.mostrarOpcaoMigrarFatura}},data(){return{titulo:{},tituloOriginal:{},detalhes:!1,contatos:{},documento:{},fatura:{},faturasAbertas:[],mostrarOpcaoMigrarFatura:!1,visibilidade:{botao:{remover:!1,editar:!1}},modalEditar:{visivel:!1,erroCalculo:!1,rules:[]},tema:["TituloCard","bg-white","rounded-borders"]}},emits:["executar"],methods:{irParaAtendimentoFatura(o){this.$router.push({name:"AtendimentoFatura",params:{id:o}})},async migrarFatura(o){try{await new Promise((t,s)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar esta venda para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{t()}).onCancel(()=>{s()})})}catch{return}if(!o&&this.titulo.idContato&&this.titulo.idEmpresa){const t=await $erp().contato.get(this.titulo.idContato)||{};let s=await $erp().contatoEndereco.where({idContato:this.titulo.idContato}).toArray(),p=await $erp().contatoTelefone.where({idContato:this.titulo.idContato}).toArray();s=s.find(M=>(M.grupo||"").trim().toLowerCase()==="Principal")||s[0]||{},p=p.find(M=>(M.tipoTelefone||"").trim().toLowerCase()==="Principal")||p[0]||{};const a=await $erp().contato.get(this.titulo.idEmpresa)||{};let g=await $erp().contatoEndereco.where({idContato:this.titulo.idEmpresa}).toArray();g=g.find(M=>M.grupo.trim().toLowerCase()==="Principal")||g[0]||{},o=$db.fatura.criar({idEmpresa:a.id,idEmpresaEndereco:g.id||"",descricaoEmpresa:a.nome||"",numeroDocumentoEmpresa:a.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:a.numeroDocumentoMunicipal||"",optanteSimplesNacional:a.regime==="SimplesNacional"?"1":"0",idContato:t.id,idContatoEndereco:s.id||"",numeroDocumentoContato:t.numeroDocumentoNacional||"",descricaoContato:t.nome||"",descricaoContatoEndereco:"".concat(s.logradouro||"",", ",s.numero||""," ",s.complemento||""," - ",s.bairro||""," - ",s.cep||""," - ",s.municipio||"","/",s.uf||""),telefoneContato:p.telefone||"",emailContato:t.email||"",regimeContato:t.regime||"",observacaoFaturamento:""}),await $db.fatura.grava({fatura:o})}o.id?(await $db.financeiroTitulo.grava({atual:{id:this.titulo.id,idFatura:o.id},original:this.titulo}),localStorage.setItem("idFatura",o.id),this.titulo.idContato&&(this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(this.titulo.idContato))):this.$q.notify("N\xE3o foi poss\xEDvel realizar a opera\xE7\xE3o")},async salvar(){if(!this.titulo.valorDesconto){this.modalEditar.visivel=!1;return}try{await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.tituloOriginal=$utils.clonar(this.titulo),this.modalEditar.visivel=!1,this.$q.notifyPositive("T\xEDtulo salvo."),this.$emit("executar","recalcular")}catch{this.$q.notifyPositive("N\xE3o foi poss\xEDvel salvar o t\xEDtulo. Por favor, tente novamente.")}},editar(){this.modalEditar.visivel=!0},async permissaoEditar(){return await $db.permissao.objeto("Diretiva_Caixa_DescontoTitulo")},async desconto(){const o=$utils.arredondar((this.titulo.valorMulta||0)+(this.titulo.valorJuros||0)*(this.titulo.diasEmAtraso||0));if(this.titulo.valorDesconto<0||this.titulo.valorDesconto>o){this.modalEditar.rules=[()=>"Desconto n\xE3o permitido"],this.modalEditar.erroCalculo=!0,this.titulo.valorTotal=this.tituloOriginal.valorTotal,this.titulo.valorARealizar=this.tituloOriginal.valorARealizar,this.titulo.percentualDesconto=this.tituloOriginal.percentualDesconto;return}this.modalEditar.rules=[()=>!0],this.titulo.valorTotal=$utils.arredondar((this.titulo.valor||0)-(this.titulo.valorDesconto||0)+(this.titulo.valorMulta||0)+(this.titulo.valorJuros||0)*(this.titulo.diasEmAtraso||0)),this.titulo.valorARealizar=this.titulo.valorTotal,this.titulo.percentualDesconto=$utils.arredondar((this.titulo.valorDesconto||0)*100/(this.titulo.valor||1)),this.modalEditar.erroCalculo=!1},alternarDetalhes(){this.detalhes=!this.detalhes},async remover(){try{await new Promise((o,t)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este t\xEDtulo da fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{o()}).onCancel(()=>{t()})})}catch{return}this.titulo.idFatura="",await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.visibilidade.botao.remover=!1,this.$q.notifyPositive("T\xEDtulo removido da fatura."),this.$emit("executar","remover")}},props:{dados:{required:!0,type:Object}},async mounted(){const o=new Date(this.dados.dataVencimento).setHours(0,0,0,0),t=new Date().setHours(0,0,0,0);o<t?this.tema.push("vencido"):this.tema=$lodash.remove(this.tema,p=>p!=="vencido"),this.tituloOriginal=$utils.clonar(this.dados),this.titulo=$utils.clonar(this.dados),this.titulo.documentoId&&(this.documento=await $erp().documento.get(this.titulo.documentoId)),this.visibilidade.botao.remover=!1,this.permissaoEditar().then(p=>this.visibilidade.botao.editar=p&&!this.tituloOriginal.valorRealizado),this.contatos={};const s={};if(this.titulo.idContato){const p=await $db.contato.le({id:this.titulo.idContato});p&&(s[this.titulo.idContato]=p)}if(this.titulo.idEmpresa){const p=await $db.contato.le({id:this.titulo.idEmpresa});p&&(s[this.titulo.idEmpresa]=p)}this.contatos=s,this.mostrarOpcaoMigrarFatura=!0,this.titulo.idFatura&&$db.fatura.leNew({id:this.titulo.idFatura}).then(p=>{this.fatura=p,p.status==="Aberta"&&$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(a=>{a.data.find(M=>M.id===this.titulo.idEmpresa)&&(this.visibilidade.botao.remover=!0)})})}},Co={class:"col-12 col-md-6 q-pl-none"},bo=m("br",null,null,-1),$o={class:"col-4 col-md"},Fo={key:0,class:"q-my-none"},Do={class:"q-my-none"},wo={class:"q-my-none"},_o={class:"col-4 col-md text-right"},Eo={class:"col-4 col-md text-right"},To={class:"col-12 col-md"},Po={class:"text-right text-h5 text-positive text-weight-bold q-my-none"},qo={class:"text-right text-weight-normal text-tertiary text-body2 q-my-none"},yo={class:"col-6"},xo={class:"text-body2"},Mo={class:"col-6 text-right"},Vo={class:"col-12 col-md-6"},Io={class:"text-body2 q-my-none q-mb-md"},zo={class:"col-12 col-sm-4 col-md-2"},No={class:"text-left q-my-none"},ko={class:"col-6 col-md-1"},Ro={class:"text-left q-my-none"},Oo={class:"col-6 col-md-1"},Ao={class:"text-left q-my-none"},Bo={class:"col-12 col-sm-4 col-md-2 text-right"},So=m("p",{class:"text-subtitle1 text-weight-bold q-ma-none"}," Desconto ",-1),Lo={class:"q-ma-none"},jo={class:"q-mt-xs"},Ho=m("small",{class:"block text-caption"},"Multa",-1),Qo={class:"q-mt-xs"},Uo=m("small",{class:"block text-caption"},"Juros",-1),Jo={class:"layout-padding"},Go={class:"horizontal"},Ko=m("dt",{style:{"text-align":"left"}},"Valor",-1),Zo={class:"text-right"},Wo={class:"horizontal"},Xo=m("dt",{style:{"text-align":"left"}},"Dias em Atraso",-1),Yo={class:"text-right"},at={class:"horizontal"},ot=m("dt",{style:{"text-align":"left"}},"Multa",-1),tt={class:"text-right"},et={class:"horizontal"},it=m("dt",{style:{"text-align":"left"}},"Juros",-1),nt={class:"text-right"},rt={class:"horizontal"},st=m("dt",{style:{"text-align":"left"}},"Desconto",-1),lt={class:"text-right"},dt={class:"horizontal"},ct=m("dt",{style:{"text-align":"left"}},"Total",-1),ut={class:"text-right"},mt={class:"q-mt-lg text-right"};function ft(o,t,s,p,a,g){const M=S("avatar"),b=S("row"),T=S("campo");return y(),Q("div",{class:Xa([a.tema,"extratoItem bg-white q-pa-sm no-shadow"])},[l(b,{class:"items-center q-mx-none q-px-none q-mb-sm text-tertiary"},{default:c(()=>{var P;return[m("div",Co,[l(na,{class:"q-pa-none"},{default:c(()=>[l(M,{imagem:(a.contatos[a.titulo.idContato]||{}).imagem,rotulo:(a.contatos[a.titulo.idContato]||{}).apelido,tamanho:"30"},null,8,["imagem","rotulo"]),l(ca,null,{default:c(()=>[O(x((a.contatos[a.titulo.idContato]||{}).apelido)+" ",1),bo]),_:1}),a.titulo.parcela?(y(),k(Ka,{key:0,rounded:"",color:"tertiary",small:""},{default:c(()=>[O(x(a.titulo.parcela),1)]),_:1})):I("",!0)]),_:1})]),m("div",$o,[a.titulo.documentoCodigo?(y(),Q("p",Fo,x(a.titulo.documentoTipo)+" #"+x((P=a.documento)==null?void 0:P.numero),1)):I("",!0),m("p",Do,x(a.titulo.formaDePagamento),1),m("p",wo,x(a.titulo.descricaoPlanoConta),1)]),m("div",_o,[a.titulo.dataVencimentoOriginal?(y(),k(J,{key:0,name:"mdi-calendar-today"})):I("",!0),O(" "+x(o.$filters.data(a.titulo.dataVencimentoOriginal))+" ",1),l(Ca,null,{default:c(()=>[O("Vencimento original")]),_:1})]),m("div",Eo,[a.titulo.dataVencimento?(y(),k(J,{key:0,name:"mdi-calendar-check"})):I("",!0),O(" "+x(o.$filters.data(a.titulo.dataVencimento))+" ",1),l(Ca,null,{default:c(()=>[O("Vencimento")]),_:1})]),m("div",To,[m("p",Po,x(o.$filters.numero(a.titulo.valorTotal,2)),1),m("p",qo,x(o.$filters.numero(a.titulo.valor,2)),1)])]}),_:1}),l(b,{class:"items-center justify-end"},{default:c(()=>[m("div",yo,[m("div",xo,x(a.titulo.descricao),1)]),m("div",Mo,[l(H,{rounded:"",dense:"",flat:"",icon:`keyboard_arrow_${a.detalhes?"up":"down"}`,color:"tertiary",onClick:g.alternarDetalhes},null,8,["icon","onClick"]),a.visibilidade.botao.editar?(y(),k(H,{key:0,rounded:"",dense:"",flat:"",icon:"edit",color:"primary",onClick:g.editar},null,8,["onClick"])):I("",!0),a.visibilidade.botao.remover?(y(),k(H,{key:1,rounded:"",dense:"",flat:"",icon:"clear",color:"tertiary",onClick:g.remover},{default:c(()=>[l(Ca,null,{default:c(()=>[O(" Remover da Fatura #"+x(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):I("",!0),Za(o.$slots,"default"),g.mostrarMenuTresPontos?(y(),k(H,{key:2,rounded:"",dense:"",flat:"",icon:"more_vert",color:"tertiary"},{default:c(()=>[l(Aa,null,{default:c(()=>[wa((y(),k(Ba,{link:"",separator:""},{default:c(()=>[a.mostrarOpcaoMigrarFatura?(y(),Q(ua,{key:0},[(y(!0),Q(ua,null,xa(a.faturasAbertas,P=>(y(),k(la,{clickable:"",key:P.id,onClick:B=>g.migrarFatura(P)},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"mdi-folder-move"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O(x("Migrar para fatura #"+(P.numero||P.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),l(la,{clickable:"",onClick:t[0]||(t[0]=P=>g.migrarFatura())},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"mdi-folder-move"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O("Migrar para nova fatura")]),_:1})]),_:1})]),_:1})],64)):I("",!0)]),_:1})),[[_a]])]),_:1})]),_:1})):I("",!0)])]),_:3}),a.detalhes?(y(),k(Wa,{key:0,class:"hideondesktop q-my-sm"})):I("",!0),a.detalhes?(y(),k(b,{key:1,class:"items-start q-mx-none q-px-none q-mt-md"},{default:c(()=>[m("div",Vo,[l(na,{class:"u-autoHeight q-pa-none",color:"none",dark:""},{default:c(()=>[l(J,{name:"business"}),l(ca,null,{default:c(()=>[O(x((a.contatos[a.titulo.idEmpresa]||{}).apelido),1)]),_:1})]),_:1}),m("p",Io,x(a.titulo.observacao),1)]),m("div",zo,[m("p",No,x(a.titulo.descricaoCentroCusto),1)]),m("div",ko,[m("p",Ro,[a.titulo.dataEmissao?(y(),k(J,{key:0,name:"mdi-calendar-check"})):I("",!0),O(" "+x(o.$filters.data(a.titulo.dataEmissao))+" ",1),l(Ca,null,{default:c(()=>[O("Emiss\xE3o")]),_:1})])]),m("div",Oo,[m("p",Ao,[a.titulo.dataCompetencia?(y(),k(J,{key:0,name:"mdi-calendar-check"})):I("",!0),O(" "+x(o.$filters.data(a.titulo.dataCompetencia))+" ",1),l(Ca,null,{default:c(()=>[O("Compet\xEAncia")]),_:1})])]),m("div",Bo,[So,m("p",Lo,x(o.$filters.numero(a.titulo.valorDesconto||0,2)),1),a.titulo.diasEmAtraso?(y(),Q(ua,{key:0},[m("div",jo,[Ho,m("strong",null,x(o.$filters.numero(a.titulo.valorMulta||0,2))+" ("+x(o.$filters.numero(a.titulo.percentualMulta||0,2))+"%) ",1)]),m("div",Qo,[Uo,m("strong",null,x(o.$filters.numero(a.titulo.valorTotalJuros||0,2))+" ("+x(o.$filters.numero(a.titulo.percentualJuros||0,2))+"% dia) ",1)])],64)):I("",!0)])]),_:1})):I("",!0),l(Ma,{modelValue:a.modalEditar.visivel,"onUpdate:modelValue":t[2]||(t[2]=P=>a.modalEditar.visivel=P),"content-css":{minWidth:"30vw"}},{default:c(()=>[l(Sa,{class:"q-dialog-plugin"},{default:c(()=>[l(na,{class:"bg-primary text-white"},{default:c(()=>[l(ca,null,{default:c(()=>[O("Editar T\xEDtulo")]),_:1}),wa(l(H,{dense:"",flat:"",icon:"close",round:""},null,512),[[_a]])]),_:1}),m("div",Jo,[l(La,{onSubmit:g.salvar,class:"q-pa-md q-gutter-md"},{default:c(()=>[m("dl",Go,[Ko,m("dd",Zo,x(o.$filters.numero(a.titulo.valor,2)),1)]),m("dl",Wo,[Xo,m("dd",Yo,x(o.$filters.numero(a.titulo.diasEmAtraso,0)),1)]),m("dl",at,[ot,m("dd",tt,x(o.$filters.numero(a.titulo.valorMulta,2)),1)]),m("dl",et,[it,m("dd",nt,x(o.$filters.numero(a.titulo.valorTotalJuros,2)),1)]),m("dl",rt,[st,m("dd",lt,[l(T,{modelValue:a.titulo.valorDesconto,"onUpdate:modelValue":[t[1]||(t[1]=P=>a.titulo.valorDesconto=P),g.desconto],dense:"",tipo:"decimal",decimals:"2",rules:a.modalEditar.rules},null,8,["modelValue","onUpdate:modelValue","rules"])])]),m("dl",dt,[ct,m("dd",ut,x(o.$filters.numero(a.titulo.valorTotal,2)),1)]),m("div",mt,[l(H,{color:"primary",unelevated:"",label:"Salvar",type:"submit"})])]),_:1},8,["onSubmit"])])]),_:1})]),_:1},8,["modelValue"])],2)}var pt=Va(go,[["render",ft]]),vt={async enviar(o,t){var s,p;try{const a=t.nome.replace("enviaemail.fatura.",""),g=(s=t.valor)!=null?s:"Impresso",M=(p=t.texto)!=null?p:`Voc\xEA est\xE1 recebendo o ${g} da empresa ${o.descricaoEmpresa}.`,b=await $db.contato.le({id:o.idContato}),T=await $utils.impressaoObterHtml(a,o),P={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:String(b==null?void 0:b.email).trim().toLowerCase(),assunto:`${g}`,mensagem:`${M}`},B=`${g} enviado para ${P.para}, com sucesso!.`,D=`Erro ao enviar e-mail. ${g} n\xE3o enviado.`;$q.loading.show({message:`Enviando ${g} por e-mail...`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const V=[{name:`${g}.pdf`,content:T,method:"html2pdf"}],i={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:P.de,to:P.para,subject:P.assunto,text:P.mensagem,attachments:V},z=await Ya({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:i});$q.notifyPositive((z==null?void 0:z.status)===200&&B?B:z.data.message)}catch(a){$q.notifyError(errorMsg||"Erro ao enviar e-mail",a)}finally{$q.loading.hide()}}},ht={async finalizar(o,t){var g,M,b,T,P,B,D,V;const s=(g=t==null?void 0:t.tef)!=null?g:!1,{cpfCnpjNoCupom:p,valorDinheiro:a}=t!=null?t:{};try{if($utils.verificarErro(this.erroCalculo,"Erro de c\xE1lculo encontrado."),!o&&!s)try{await new Promise((e,n)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar esta fatura",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{e()}).onCancel(()=>{n()})})}catch{return!1}this.$q.loading.show({message:"Processando..."});const i=$utils.clonar(this.fatura),z=$utils.clonar(this.vendas),q=$utils.clonar(this.carnes);if(q.length>0){const e=q.reduce((n,f)=>(f.idFinanceiroBoleto&&f.codigoFinanceiroTitulo&&(n+=String(f.codigoFinanceiroTitulo)+";"),n),"");if(e)try{$q.loading.show({message:"Baixando boletos..."});const n=`exec sp_Financeiro_BoletoBaixar '${e.slice(0,-1)}'`,f=await $utils.executarSql(n)}catch(n){$q.notifyError("N\xE3o foi poss\xEDvel baixar boletos",n);return}finally{$q.loading.hide()}}const u=o?i.dataHoraFinalizado:$utils.dataAtual(),C=u,r=await $db.documento.ler({id:this.$refs.faturamento.idDocumentoCaixa});if(this.documentoStatus=[],s){let e,n;if(e=await $erp().caixa.where({idEmpresa:i.idEmpresa}).toArray(),n=e.some(f=>f.ativo),n&&!(r!=null&&r.id)){$q.notify({message:"Opera\xE7\xE3o negada. \xC9 necess\xE1rio abertura de caixa.",type:"negative"});return}if(await this.$refs.faturamento.checarCaixa(),this.fatura.totalDocumento-a<0){$q.notify({message:"Opera\xE7\xE3o negada. Valor em dinheiro acima do total do documento.",type:"negative"});return}if(a<0){$q.notify({message:"Opera\xE7\xE3o negada. Valor em dinheiro n\xE3o permitido.",type:"negative"});return}if(e=await j.oper("crt",{idTransacao:`1${this.fatura.id}`,idLoja:(M=this.fatura.numeroDocumentoEmpresa)==null?void 0:M.replace(/\D/g,""),idAutomacao:$utils.sistemaPai()==="b15"?"07660198000189":"09492015000199",valorTransacao:$utils.arredondar(this.fatura.totalDocumento-a,2).toLocaleString("pt-BR",{minimumFractionDigits:2}),nroDocFiscal:(b=this.fatura.numero)!=null?b:this.fatura.id.replace(/\D/g,"").slice(-6)}),!(e!=null&&e.fileContent))return;if(e!=null&&e.fileContent){let f,h,_,v,w=!1;if(f=j.extrairCampo("mensagemOperador",e.fileContent),h=j.extrairComprovante(e.fileContent),_=j.extrairCampo("codigoAutorizacao",e.fileContent),v=j.extrairCampo("nsu",e.fileContent),w=h&&_&&v,f&&$q.notify({message:f,type:w?"positive":"negative"}),!w)return;w&&await this.$refs.faturamento.tef({fatura:i,tefRetorno:e.fileContent,valorDinheiro:a})}}await this.$refs.faturamento.validar();let d=$lodash.orderBy(this.$refs.faturamento.condicaoPagamento.filter(e=>e.valor),["idFormaPagamento","autorizacao","dataVencimento"]);$utils.verificarErro(z.find(e=>!e.dataHoraFinalizado),"Existe pedido de venda sem data de finaliza\xE7\xE3o.");const N=$utils.arredondar(this.carnes.reduce((e,n)=>e+(n.valorARealizar||0),0)),A=$utils.arredondar(d.reduce((e,n)=>e+(n.valor||0),0));let ra=0;if(o&&(d=d.filter(e=>!this.$refs.faturamento.condicaoPagamentoOriginal.find(n=>n.id===e.id))),i.totalDocumento>=0){if(this.carnes.length){if(A<N)return this.$q.notify("Valor pago menor que a soma dos t\xEDtulos \xE0 faturar!"),!1;if(!await $db.permissao.objeto("Diretiva_Caixa_PagarCarneCartao")){const n=d.reduce((f,h)=>{const _=`${h.autorizacao||""}${h.documento||""}${h.idFormaPagamento}`;return f[_]||(f[_]={parcelas:0,formaPagamento:h.formaPagamento}),f[_].parcelas++,f},{});for(const f in n)if(n[f].parcelas>this.carnes.length)return this.$q.notify(`Quantidade de parcelas da forma de pagamento ${n[f].formaPagamento} acima do permitido.`),!1}}A<i.totalDocumento&&(ra=1)}let Z=ra===1?"Aguardando Pagamento":"Finalizada";if(!o){this.documentoStatus.push({id:$utils.uuid(),idDocumento:i.id,operacao:"Fatura",statusOriginal:i.status,statusFinalizado:Z,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:r.id||""}),i.status=Z,i.dataHoraFinalizado=u;let e=0;for(const w of z)e=(await $db.documentoItem.ler({idDocumento:w.id})).reduce((E,F)=>(F.total>0&&(E+=F.total),E),e);e=$utils.arredondar(e),Z="Faturado";const n=parseInt(await $db.configuracoes.leValorComFiltroEmpresa("vendas.usaExpedicao",i.idEmpresa,0))||0;let f=0,h=0,_=!1,v=!0;n&&(this.$q.loading.hide(),await new Promise((w,$)=>{this.$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},message:"Gostaria de dar baixa na(s) venda(s), removendo-a(s) do processo de expedi\xE7\xE3o?",noRefocus:!0,preventClose:!0,persistent:!0,title:"Confirma?"}).onOk(()=>{v=!0,w()}).onCancel(()=>{v=!1,w()})}),this.$q.loading.show({message:"Processando..."}));for(const w of z)h+=(await $db.documento.ler({tipo:"Envelope",documentoId:w.id,documentoTipo:"Venda"})||[]).filter(E=>E.status!=="Entregue").length;if(h){let w="Nesta Fatura h\xE1 1 envelope aguardando entrega, deseja mudar o status deste para Entregue?";h>1&&(w=`Nesta Fatura h\xE1 ${h} envelopes aguardando entrega, deseja mudar o status destes para Entregue?`),this.$q.loading.hide();try{await new Promise(($,E)=>{this.$q.dialog({cancel:"N\xE3o",message:w,noRefocus:!0,ok:"Sim",preventClose:!0,title:"Confirma?"}).onOk(()=>{_=!0,$()}).onCancel(()=>{E()})})}catch{}this.$q.loading.show({message:"Processando..."})}for(const w of z){Z=v?"Faturado":w.status,v&&this.documentoStatus.push({id:$utils.uuid(),idDocumento:w.id,operacao:"Venda de Mercadoria",statusOriginal:w.status,statusFinalizado:Z,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:r.id||""}),w.status=Z;const $=await $db.documento.ler({tipo:"Envelope",documentoId:w.id,documentoTipo:"Venda"});if(this.envelopesOriginal=this.envelopesOriginal.concat($utils.clonar($)),_)for(const F of $.filter(L=>L.status!=="Entregue"))this.documentoStatus.push({id:$utils.uuid(),idDocumento:F.id,operacao:"Envelope",statusOriginal:F.status,statusFinalizado:"Entregue",dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),F.status="Entregue",F.dataHoraFinalizado=$utils.dataAtual();this.envelopes=this.envelopes.concat($);const E=await $db.documentoItem.ler({idDocumento:w.id});this.documentoItensOriginal=this.documentoItensOriginal.concat($utils.clonar(E));for(const F of E)if(F.status=Z,F.total>0){F.quantidade=F.quantidade||1,F.valorItem=F.valorItem||0,F.descontoItem=F.descontoItem||0,F.descontoTotalRateado=F.descontoTotalRateado||0;let L=(F.valorItem-F.descontoItem)*F.quantidade-F.descontoTotalRateado;const X=$utils.arredondar((i.totalDesconto||0)*L/(e||1)||0);F.descontoFaturaRateado=$utils.arredondar(X),F.valorRealTotal=$utils.arredondar(L-X),F.valorReal=$utils.arredondar(F.valorRealTotal/F.quantidade),f+=X}this.documentoItens=this.documentoItens.concat(E)}if(i.totalDesconto!==$utils.arredondar(f)){const w=$utils.arredondar((i.totalDesconto||0)-(f||0));let $,E=0;for(const F of this.documentoItens)F.total>E&&(E=F.total,$=F);if($){const F=($.descontoFaturaRateado||0)+(w||0),L=(($.valorItem||0)-($.descontoItem||0))*($.quantidade||1)-($.descontoTotalRateado||0)-(F||0),X=(L||0)/($.quantidade||1);$.descontoFaturaRateado=$utils.arredondar(F),$.valorReal=$utils.arredondar(X),$.valorRealTotal=$utils.arredondar(L)}}}const Ea=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.renegociacao"}))[0].valor),ea=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ea}),ma=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatareceber"}))[0].valor);let Y=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ma});const ba=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatapagar"}))[0].valor),aa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ba}),fa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cheque"}))[0].valor),pa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:fa}),Ta=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.faturamentogeral"}))[0].valor),U=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ta}),ja=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0].valor),Ia=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ja}),Ha=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.frete"}))[0].valor),za=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ha}),Qa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cmv"}))[0].valor),$a=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Qa}),Ua=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.creditoclientes"}))[0].valor),Ja=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ua}),Ga=await $db.formaPagamento.le(),Pa=(T=this.contatos[i.idContato])==null?void 0:T.descontoCondicionadoPercentual;let va=$utils.arredondar(z.reduce((e,n)=>e+n.totalDocumento,0));va=$utils.arredondar(va-i.totalDesconto);let ia=i.totalDocumento,W=[];const R=[],Na=[],Fa=[],ka=[];let ha=1,qa="",Da=1,oa="";for(const e of d.filter(n=>!n.sinal)){e.sinal=e.sinal||ra;const n=Ga.filter(f=>f.id===e.idFormaPagamento)[0];if(ia<0)oa=$utils.uuid(),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:U.id,dataEmissao:u,valorCredito:0,valorDebito:$utils.arredondar(ia*-1),descricao:U.descricao,observacao:`Movimenta\xE7\xE3o de d\xE9bito da devolu\xE7\xE3o de clientes no(s) pedido(s) da fatura c\xF3digo (${i.id})`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Ja.id,dataEmissao:u,valorCredito:$utils.arredondar(ia*-1),valorDebito:0,descricao:`Cr\xE9dito proveniente de produtos devolvidos no(s) pedido(s) da fatura c\xF3digo (${i.id})`,observacao:"Movimenta\xE7\xE3o de cr\xE9dito na conta de clientes",automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id});else{if(qa!==e.idFormaPagamento+e.autorizacao&&(qa=e.idFormaPagamento+e.autorizacao,ha=1,Da=d.reduce((f,h)=>h.idFormaPagamento+h.autorizacao===qa?f+1:f,0)),n.tipoFinanceiro==="T\xEDtulo Liquidado"&&(oa=$utils.uuid()),N>0){const f=$utils.uuid(),h=$utils.arredondar(e.valor*(N/ia));let _=0,v=0,w=0,$=0;if(n.tipo===5){let E=(await $erp().financeiroBanco.toArray()).find(F=>F.codigoBanco===122);E&&(v=E.percentualMulta||0,$=E.percentualJuros||0,_=$utils.arredondar(v/100*h),w=$utils.arredondar($/100*h))}W.push({id:f,idFinanceiroPlanoConta:ea.id,idContato:i.idContato,dataEmissao:u,dataCompetencia:C,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:h,valorTotal:h,valorARealizar:h,valorMulta:_,percentualMulta:v,valorJuros:w,percentualJuros:$,documentoId:i.id,documentoTipo:"Fatura",parcela:ha+"/"+Da,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${e.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:n.descricao,carne:n.tipo===5?1:0,dataEmissaoCarne:n.tipo===5?u:"",idDocumentoCaixa:r.id,idFinanceiroMovimentacaoAgrupamento:n.tipoFinanceiro==="T\xEDtulo Liquidado"?oa:""}),e.idFinanceiroTitulo=f,n.tipo===2&&Fa.push({idTitulo:f,idDocumentoCondicaoPagamento:e.id,valor:h,dataVencimento:e.dataVencimento,idBanco:e.idBanco,agencia:e.agencia,conta:e.conta,numeroCheque:e.numeroCheque,formaPagamento:n}),ka.push({idTitulo:f,valor:h,desconto:0})}if(va>0){const f=$utils.uuid(),h=$utils.arredondar(e.valor*(va/ia));let _=0,v=0,w=0,$=0;if(n.tipo===5){let E=(await $erp().financeiroBanco.toArray()).find(F=>F.codigoBanco===122);E&&(v=E.percentualMulta||0,$=E.percentualJuros||0,_=$utils.arredondar(v/100*h),w=$utils.arredondar($/100*h))}W.push({id:f,idFinanceiroPlanoConta:U.id,idContato:i.idContato,dataEmissao:u,dataCompetencia:C,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:h,valorTotal:h,valorARealizar:h,valorMulta:_,percentualMulta:v,valorJuros:w,percentualJuros:$,documentoId:i.id,documentoTipo:"Fatura",parcela:ha+"/"+Da,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${e.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:n.descricao,carne:n.tipo===5?1:0,dataEmissaoCarne:n.tipo===5?u:"",idDocumentoCaixa:r.id,idFinanceiroMovimentacaoAgrupamento:n.tipoFinanceiro==="T\xEDtulo Liquidado"?oa:"",descontoCondicionadoValor:Pa>0?Pa/100*h:0,descontoCondicionadoPercentual:Pa}),e.idFinanceiroTitulo=f,n.tipo===2&&Fa.push({idTitulo:f,idDocumentoCondicaoPagamento:e.id,valor:h,dataVencimento:e.dataVencimento,idBanco:e.idBanco,agencia:e.agencia,conta:e.conta,numeroCheque:e.numeroCheque,formaPagamento:n})}if(n.tipoFinanceiro==="T\xEDtulo Liquidado"&&va>=0){R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:Y.id,idFinanceiroTitulo:e.idFinanceiroTitulo,dataEmissao:u,valorCredito:e.valor,valorDebito:0,descricao:Y.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id});let f=n.idFinanceiroPlanoConta;n.tipo===1&&(r||{}).idFinanceiroPlanoContaCaixa&&(f=r.idFinanceiroPlanoContaCaixa);let h=await $db.financeiroPlanoConta.le({id:f});R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:h.id,idFinanceiroTitulo:e.idFinanceiroTitulo,dataEmissao:u,valorCredito:0,valorDebito:e.valor,descricao:h.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id});for(const _ of W)_.idFinanceiroMovimentacaoAgrupamento===oa&&(_.valorRealizado=_.valorARealizar,_.dataPagamento=e.dataVencimento,_.dataMovimento=e.dataVencimento,_.idDocumentoCaixaLiquidacao=r.id)}if(n.aliquota){const f=$utils.uuid(),h=$utils.arredondar(e.valor*(n.aliquota/100));if(W.push({id:f,idFinanceiroPlanoConta:n.idFinanceiroPlanoContaAliquota,idContato:n.idContatoOperadoraCartao,dataEmissao:u,dataCompetencia:C,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:h,valorTotal:h,valorARealizar:h,valorMulta:0,percentualJuros:0,documentoId:i.id,documentoTipo:"Fatura",parcela:ha+"/"+Da,descricao:`T\xEDtulo referente a al\xEDquota da forma de pagamento: ${n.descricao}`,observacao:`T\xEDtulo referente a al\xEDquota. ${this.$refs.faturamento.observacaoFaturamento||""} ${e.observacao||""}`.trim(),documentoVinculado:1,receberPagar:0,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:n.descricao,idDocumentoCaixa:r.id}),e.idFinanceiroTituloPagar=f,n.tipoFinanceiro==="T\xEDtulo Liquidado"){const _=$utils.uuid();R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:_,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:u,valorCredito:0,valorDebito:h,descricao:aa.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:f,idContato:n.idContatoOperadoraCartao,idDocumentoCaixa:r.id});let v=n.idFinanceiroPlanoConta;n.tipo===1&&(r||{}).idFinanceiroPlanoContaCaixa&&(v=r.idFinanceiroPlanoContaCaixa);let w=await $db.financeiroPlanoConta.le({id:v});R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:_,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:w.id,dataEmissao:u,valorCredito:h,valorDebito:0,descricao:w.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:f,idContato:n.idContatoOperadoraCartao,idDocumentoCaixa:r.id});for(const $ of W)$.id===f&&($.idFinanceiroMovimentacaoAgrupamento=_,$.valorRealizado=h,$.dataPagamento=e.dataVencimento,$.dataMovimento=e.dataVencimento,$.idDocumentoCaixaLiquidacao=r.id)}}ha++}}const Ra=[];for(const e of Fa){const n=$utils.uuid(),f=$utils.uuid();for(const _ of W)_.id===e.idTitulo&&(_.idFinanceiroMovimentacaoAgrupamento=f,_.valorRealizado=_.valorARealizar,_.dataPagamento=u,_.dataMovimento=u,_.dataVencimento=u,_.dataVencimentoOriginal=u,_.idDocumentoCaixaLiquidacao=r.id);if(Ra.includes(e.idDocumentoCondicaoPagamento))continue;Ra.push(e.idDocumentoCondicaoPagamento);const h=$utils.arredondar(Fa.reduce((_,v)=>v.idDocumentoCondicaoPagamento===e.idDocumentoCondicaoPagamento?_+(v.valor||0):_,0));W.push({id:n,idFinanceiroPlanoConta:pa.id,idContato:i.idContato,dataEmissao:u,dataCompetencia:C,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:h,valorTotal:h,valorARealizar:h,valorMulta:0,percentualJuros:0,receberPagar:1,valorDesconto:0,percentualDesconto:0,documentoId:i.id,documentoTipo:"Fatura",idEmpresa:i.idEmpresa,formaDePagamento:e.formaPagamento.descricao,idDocumentoCaixa:r.id,cheque:1,idBanco:e.idBanco,agencia:e.agencia,conta:e.conta,numeroCheque:e.numeroCheque,observacao:`Liquida\xE7\xE3o de Cheques da Fatura #${i.id} - C\xF3digoN #${f}`,descricao:"Cheque"}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:f,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:pa.id,idFinanceiroTitulo:n,dataEmissao:u,valorCredito:0,valorDebito:h,descricao:"Cheque - Cr\xE9dito de t\xEDtulos a receber",observacao:"Cr\xE9dito de t\xEDtulos a receber",automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,idFinanceiroCheque:n,idDocumentoCaixa:r.id,documentoId:i.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:f,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:Y.id,idFinanceiroTitulo:n,dataEmissao:u,valorCredito:h,valorDebito:0,descricao:Y.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,idFinanceiroCheque:n,idDocumentoCaixa:r.id,documentoId:i.id})}if(N>0){const e=$utils.uuid();R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:Y.id,dataEmissao:u,valorCredito:N,valorDebito:0,descricao:Y.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:1,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:ea.id,dataEmissao:u,valorCredito:0,valorDebito:N,descricao:ea.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica - Complemento",automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:"Renegocia\xE7\xE3o",documentoId:e,idDocumentoCaixa:r.id});for(const n of ka)Na.push({idFinanceiroMovimentacaoN:e,idFinanceiroTitulo:n.idTitulo,dataVencimento:u,valorOriginal:n.valor,valorDesconto:n.desconto,valorTotal:$utils.arredondar(n.valor-n.desconto)});for(const n of q){if(n.idFinanceiroMovimentacaoAgrupamento=e,n.idDocumentoCaixaLiquidacao=r.id,n.dataPagamento=u,n.dataMovimento=u,n.renegociado=1,n.cheque===1){n.valorRealizado=n.valor;continue}if(!n.valorARealizar){n.valorRealizado=n.valorTotal;continue}n.valorRealizado=n.valorARealizar}W=W.concat(q)}if(ra===0){let e=$utils.uuid();const n=i.valorFrete||0;let f=0,h=0;const _=[];if(n>0&&(R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:U.id,dataEmissao:u,valorCredito:0,valorDebito:n,descricao:U.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:za.id,dataEmissao:u,valorCredito:n,valorDebito:0,descricao:za.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id})),!o){e=$utils.uuid();for(const v of this.documentoItens){let w="",$={},E="",F={},L="",X={};const sa=await $db.item.leNew({id:v.idItem});if(w=v.idPlanoContaEstoque,!w){const G=await $db.perfilContabilItem.le({idPerfilContabil:sa.idPerfilContabil,idCfop:v.idCfop,and:{idPerfilContabil:sa.idPerfilContabil,idCfop:v.idCfop}});G.length&&G[0].idPlanoContaEstoque&&(w=G[0].idPlanoContaEstoque)}if(!w&&Ia.id&&(w=Ia.id),!w&&v.idCfop&&(w=(await $db.cfop.le({id:v.idCfop})).idPlanoContaEstoque),$=await $db.financeiroPlanoConta.le({id:w}),!$.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Estoque.");return}if(E="",!E){const G=await $db.perfilContabilItem.le({idPerfilContabil:sa.idPerfilContabil,idCfop:v.idCfop,and:{idPerfilContabil:sa.idPerfilContabil,idCfop:v.idCfop}});G.length&&G[0].idPlanoContaDespesa&&(E=G[0].idPlanoContaDespesa)}if(!E&&$a.id&&(E=$a.id),!E&&v.idCfop&&(E=(await $db.cfop.le({id:v.idCfop})).idPlanoContaDestino),F=await $db.financeiroPlanoConta.le({id:E}),!F.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Despesa.");return}const ya=$utils.arredondar(v.total-(v.descontoTotalRateado||0)-(v.descontoFaturaRateado||0)),ga=$utils.arredondar(v.valorCustoMedio*v.quantidade);if(ga){if(v.operacaoFator<0?(R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:$.id,dataEmissao:v.dataHoraFinalizado||u,valorCredito:ga,valorDebito:0,descricao:$.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:F.id,dataEmissao:v.dataHoraFinalizado||u,valorCredito:0,valorDebito:ga,descricao:F.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:r.id})):(R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:$.id,dataEmissao:v.dataHoraFinalizado||u,valorCredito:0,valorDebito:ga,descricao:$.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:F.id,dataEmissao:v.dataHoraFinalizado||u,valorCredito:ga,valorDebito:0,descricao:F.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:r.id})),L=v.idPlanoContaDestino,!L){const ta=await $db.perfilContabilItem.le({idPerfilContabil:sa.idPerfilContabil,idCfop:v.idCfop,and:{idPerfilContabil:sa.idPerfilContabil,idCfop:v.idCfop}});ta.length&&ta[0].idPlanoContaDespesa&&(L=ta[0].idPlanoContaDespesa)}if(!L&&$a.id&&(L=$a.id),!L&&v.idCfop&&(L=(await $db.cfop.le({id:v.idCfop})).idPlanoContaDestino),X=await $db.financeiroPlanoConta.le({id:L}),!X.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Receita.");return}let G=!0;for(const ta of _)if(ta.idPlanoContaDestino===X.id&&ta.idPlanoContaEstoque===$.id){ta.valor=$utils.arredondar(ta.valor+ya),G=!1;break}G&&_.push({idPlanoContaDestino:X.id,idPlanoContaEstoque:$.id,valor:ya}),f+=ya}}for(const v of _)v.valor<0&&(h+=v.valor);for(const v of _)if(v.valor>0){const w=await $db.financeiroPlanoConta.le({id:v.idPlanoContaDestino}),$=$utils.arredondar(h*(v.valor/(f||1)));if($>0){R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:U.id,dataEmissao:u,valorCredito:0,valorDebito:$,descricao:U.descricao,observacao:`Lan\xE7amento entrada faturamento geral da devolu\xE7\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:w.id,dataEmissao:u,valorCredito:$,valorDebito:0,descricao:w.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de destino referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id});for(const E of d)R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:U.id,dataEmissao:u,valorCredito:0,valorDebito:$utils.arredondar((v.valor-$)*(E.valor/(ia||1))),descricao:U.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:E.dataVencimento,dataMovimento:E.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:w.id,dataEmissao:u,valorCredito:$utils.arredondar((v.valor-$)*(E.valor/(ia||1))),valorDebito:0,descricao:w.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:E.dataVencimento,dataMovimento:E.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id})}else for(const E of d){const F=$utils.arredondar(v.valor*(E.valor/(ia||1)));R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:U.id,dataEmissao:u,valorCredito:0,valorDebito:F,descricao:U.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:E.dataVencimento,dataMovimento:E.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:w.id,dataEmissao:u,valorCredito:F,valorDebito:0,descricao:w.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:C,dataVencimento:E.dataVencimento,dataMovimento:E.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:r.id})}}}}if(this.financeiroTitulo=W,this.financeiroMovimentacao=R,this.financeiroRenegociacao=Na,this.fatura=i,this.vendas=z,this.carnes=q,!o){await this.salvarFatura(),$utils.emitter.emit("desativarBotoesFaturaModal");try{let n,f,h,_;if(n=await $db.configuracoes.porNome("integracao.bten.business"),f=(B=(P=n[0])==null?void 0:P.valor)!=null?B:!1,n=await $db.configuracoes.porNome("integracao.bten.authorization"),h=(V=(D=n[0])==null?void 0:D.valor)!=null?V:!1,_=f&&h,_){const v=[],w=this.contatos[i.idContato],$=await $api.bten.send(w,i);for(let E=0;E<$.length;E++){const F=$[E];F.status?v.push(F.telefone):this.$q.notifyError(`Falha ao enviar NPS para ${F.telefone}!`)}v.length&&this.$q.notifyPositive(`NPS enviado para ${v.join(",")}!`)}}catch(n){n.name==="GeeksException"&&this.$q.notifyAlert(`N\xE3o foi poss\xEDvel enviar NPS: ${n.message}`),n.name!=="GeeksException"&&this.$q.notifyError("N\xE3o foi possivel enviar NPS para o contato.",n)}let e;if(r!=null&&r.idCaixa){const n=await $erp().caixa.get(r==null?void 0:r.idCaixa);n!=null&&n.id&&(e=$db.caixa.tiposCaixa[Number(n.tipo)])}if(this.vendas.length&&~["SAT","NFCe"].indexOf(e))try{const n=s;await this.$refs.documentosFiscais.emitirCupom(this.fatura.id,n)}catch(n){console.error(n)}finally{if(s){const n=[];for(const f of this.$refs.faturamento.condicaoPagamento)!f.tefRetorno||n.some(h=>h.tefRetorno===f.tefRetorno)||n.push(f);for(const f of n){let h;!f.tefRetorno||(h=j.extrairComprovante(f.tefRetorno),h&&await j.oper("print",{content:h,opts:{txt:!0}}))}}}if(this.$q.notifyPositive("Fatura finalizada"),this.fatura.status==="Finalizada"){const n=await $db.configuracoes.le({prefixoNome:"enviaemail.fatura"});let f=n.find(h=>h.idEmpresa===this.fatura.idEmpresa);console.log("filtroEnviaEmail 1: ",f),f||(f=n.find(h=>!h.idEmpresa),console.log("filtroEnviaEmail 2: ",f)),f&&(console.log("enviando..."),await vt.enviar(this.fatura,f))}}return!0}catch(i){this.$q.notifyError("N\xE3o foi poss\xEDvel finalizar a fatura",i)}finally{this.$q.loading.hide()}}};const gt={components:{Avatar:Oa,DocumentoCodigo:ao,DocumentoMetas:oo,DocumentosFiscais:fo,Faturamento:to,TituloCard:pt,VendaCard:ho},computed:{config(){return $db.configuracoes.valores},descontoSomenteLeitura(){let o=!1;return o=this.fatura.status==="Aberta",o||(o=this.fatura.status==="Aguardando Pagamento"&&this.permissaoDescontoFaturaSinal),!o}},data(){return{contatos:{},faturaOriginal:{},fatura:{totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0},vendas:[],vendasOriginal:[],envelopes:[],envelopesOriginal:[],documentoItens:[],documentoItensOriginal:[],carnes:[],carnesOriginal:[],documentoStatus:[],erroCalculo:!1,erroCalculoMsg:"",sistemaPai:"",configImpressaoCarne:[],configImpressaoConvenio:[],configImpressaoFatura:[],configImpressaoEnvelope:[],permissaoDesconto:!1,permissaoDescontoFaturaSinal:!1,pesoTotal:null,pesoBrutoTotal:null,metroCubicoTotal:null}},emits:["executar"],mixins:[vo],methods:{async calcularPesoTotal(){var g,M;const o=await $erp().documento.where({idFatura:this.fatura.id}).toArray(),t=[],s={};let p=0,a=0;for(const b of o){const T=await $erp().documentoItem.where({idDocumento:b.id}).toArray();for(const P of T)t.push(P)}for(const b of t)if(b.operacaoFator===-1){if(b.idItem&&!s[b.idItem]){const T=await $erp().item.get(b.idItem);T&&(s[b.idItem]=T)}p+=(((g=s[b.idItem])==null?void 0:g.peso)||0)*(b.quantidade||0),a+=(((M=s[b.idItem])==null?void 0:M.pesoBruto)||0)*(b.quantidade||0)}p=$utils.arredondar(p,4),a=$utils.arredondar(a,4),this.pesoTotal=p?$filters.numeroZerosDireita(p,4,2):null,this.pesoBrutoTotal=a?$filters.numeroZerosDireita(a,4,2):null},async calcularMetroCubicoTotal(){var a,g,M;const o=await $erp().documento.where({idFatura:this.fatura.id}).toArray(),t=[],s={};let p=0;for(const b of o){const T=await $erp().documentoItem.where({idDocumento:b.id}).toArray();for(const P of T)t.push(P)}for(const b of t){if(b.operacaoFator!==-1||b.tipoItem!=="Produto")continue;if(b.idItem&&!s[b.idItem]){const B=await $erp().item.get(b.idItem);B&&(s[b.idItem]=B)}const T=((a=s[b.idItem])==null?void 0:a.altura)*((g=s[b.idItem])==null?void 0:g.largura)*((M=s[b.idItem])==null?void 0:M.comprimento)||0,P=b.quantidade||0;p+=T>0?T*P:0}p=$utils.arredondar(p,4),this.metroCubicoTotal=p?$filters.numeroZerosDireita(p,4,2):null},atualizarDocumentoMetas(){!this.$refs.documentoMetas||(this.$refs.documentoMetas.documento=$utils.clonarV2(this.fatura))},...ht,async atualizar(){let o=!1;if(this.permissaoDesconto=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura"),this.permissaoDescontoFaturaSinal=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura_Sinal"),this.vendas=[],this.envelopes=[],this.envelopesOriginal=[],this.documentoItens=[],this.documentoitensOriginal=[],this.carnes=[],this.carnesOriginal=[],this.documentoStatus=[],this.contatos={},this.erroCalculo=!1,this.erroCalculoMsg="",this.prop.id){const t=await $db.fatura.leCompleto(this.prop.id);this.faturaOriginal=$utils.clonar(t.fatura),this.fatura=t.fatura,this.$refs.faturamento&&(this.$refs.faturamento.condicaoPagamentoOriginal=$utils.clonar(t.condicaoPagamento),this.$refs.faturamento.condicaoPagamento=t.condicaoPagamento),this.vendasOriginal=$utils.clonar(t.vendas),this.vendas=t.vendas.sort((p,a)=>new Date(p.dataHoraFinalizado)<new Date(a.dataHoraFinalizado)?-1:1),this.receberTitulo.id&&!t.carnes.find(p=>p.id===this.receberTitulo.id)&&(t.carnes.push(await $db.financeiroTitulo.le({id:this.receberTitulo.id})),o=!0),this.carnesOriginal=$utils.clonar(t.carnes),this.carnes=t.carnes.sort((p,a)=>new Date(p.dataVencimento)<new Date(a.dataVencimento)?-1:1);const s={};if(t.fatura.idContato){const p=t.fatura.idContato;s[p]||(s[p]=await $db.contato.le({id:p}))}this.configuraImpressaoCarne(t.fatura.idEmpresa),this.configuraImpressaoConvenio(t.fatura.idEmpresa),this.configuraImpressaoEnvelope(t.fatura.idEmpresa),this.configuraImpressaoFatura(t.fatura.idEmpresa),this.contatos=s,await this.atualizarDocumentoMetas(),await this.calculaTotais(),await this.calcularPesoTotal(),await this.calcularMetroCubicoTotal(),o&&await this.salvarFatura()}},async executar(o){if(o==="recalcular"){if(this.prop.id){const t=await $db.fatura.leCompleto(this.prop.id);this.carnesOriginal=$utils.clonar(t.carnes),this.carnes=t.carnes,await this.calculaTotais()}}else await this.atualizar(),this.$emit("executar",o)},async calculaTotais(o){const t=$utils.arredondar(this.vendas.reduce((p,a)=>p+a.totalDocumento||0,0)),s=$utils.arredondar(this.carnes.reduce((p,a)=>p+a.valorARealizar||0,0));o||(this.fatura.subTotal=$utils.arredondar(t+s),o="desconto"),o==="descontoPercentual"&&(this.fatura.totalDesconto=$utils.arredondar((this.fatura.totalPercentualDesconto||0)/100*this.fatura.subTotal)),o==="desconto"&&(this.fatura.totalPercentualDesconto=$utils.arredondar((this.fatura.totalDesconto||0)/this.fatura.subTotal*100)),this.fatura.totalDocumento=$utils.arredondar(this.fatura.subTotal-(this.fatura.totalDesconto||0)),this.erroCalculo=!1,this.erroCalculoMsg="",this.fatura.totalDesconto!==0&&(t===0&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto n\xE3o permitido para fatura sem venda"),t>0&&this.fatura.totalDesconto>t&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto maior que o total das vendas")),this.fatura.totalDesconto!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculo=!0);try{await this.$refs.faturamento.resumeCondicaoPagamento(),await this.$refs.faturamento.atualizaValorRestante(),await this.$refs.faturamento.redefinirCampos()}catch{}},async configuraImpressaoConvenio(o){const t=await $db.configuracoes.porNome("impressao.convenio",o);this.configImpressaoConvenio=[...t.length?t.map(s=>({texto:"Imprimir Conv\xEAnio",...s})):[{valor:"convenio",texto:"Imprimir Conv\xEAnio"}]]},async configuraImpressaoCarne(o){const t=await $db.configuracoes.porNome("impressao.carne",o);this.configImpressaoCarne=[...t.length?t.map(s=>({texto:"Imprimir Carn\xEA",...s})):[{valor:"carne-crediario",texto:"Reimprimir carn\xEA e notas promiss\xF3rias da fatura"}]]},async configuraImpressaoEnvelope(o){const t=await $db.configuracoes.porNome("impressao.envelope",o);this.configImpressaoEnvelope=[...t.length?t.map(s=>({texto:"Imprimir Envelope",...s})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoFatura(o){const t=await $db.configuracoes.porNome("impressao.fatura",o);this.configImpressaoFatura=[...t.length?t.map(s=>({texto:"Imprimir Fatura",...s})):[{valor:"invoice",texto:"Fatura (Invoice)"},{valor:"fatura-recibo",texto:"Recibo"},this.sistemaPai==="optisoul"?{valor:"termoGarantia",texto:"Termo de Garantia"}:{}]]},async reabrir(o){var t;if(!((t=this.fatura)!=null&&t.id)){this.$q.notifyError("N\xE3o foi poss\xEDvel encontrar o ID da fatura");return}if(!o)try{$q.loading.show(),await eo({idDocumento:this.fatura.id})}catch(s){this.$q.notifyError(s.message);return}finally{$q.loading.hide()}if(!o)try{await new Promise((s,p)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 reabrir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{s()}).onCancel(()=>{p()})})}catch{return}try{this.$q.loading.show({message:"Processando..."});const s=$utils.clonar(this.fatura),p=$utils.clonar(this.vendas),a=$utils.clonar(this.envelopes),g=$utils.clonar(this.documentoItens),M=this.$refs.faturamento.condicaoPagamento.filter(D=>D.valor);if(!o){const D=[];M.reduce((V,i)=>(i.idDocumentoCaixa&&!V[i.idDocumentoCaixa]&&(V[i.idDocumentoCaixa]=!0,D.push($db.documento.ler({id:i.idDocumentoCaixa}))),V),{});for await(const V of D)if(V.status!=="Aberto")return this.$q.notify({message:"N\xE3o \xE9 poss\xEDvel reabrir fatura de caixas fechados!"}),!1}try{await $db.fatura.checarTitulosLiquidados({condicoesPagamento:this.$refs.faturamento.condicaoPagamentoOriginal})}catch(D){$q.notifyError(D.message);return}let b=[],T=[],P=[];if(!o){b=await $db.financeiroTitulo.le({documentoId:s.id});for(const r of b)if(r.idFinanceiroBoleto){const d=await $erp().financeiroBoleto.get(r.idFinanceiroBoleto),N=await $db.financeiroBanco.le({id:d.idFinanceiroBanco}),A=await $db.banco.le({id:N.idBanco}),ra=d.revisao,Z=A.baixa,Ea=A.registro;if(d.remessaOperacao!==Z){const ea=r.idFinanceiroBoleto,ma=$utils.uuid(),Y={id:ma,idFinanceiroBanco:d.idFinanceiroBanco,nossoNumero:d.nossoNumero,nossoNumeroDv:d.nossoNumeroDv,revisao:ra+1,idEmpresa:d.idEmpresa,idContato:d.idContato,empresaNome:d.empresaNome,empresaNumeroDocumento:d.empresaNumeroDocumento,contatoNome:d.contatoNome,contatoNumeroDocumento:d.contatoNumeroDocumento,contatoLogradouro:d.contatoLogradouro,contatoCEP:d.contatoCEP,contatoBairro:d.contatoBairro,contatoCidade:d.contatoCidade,contatoUF:d.contatoUF,dataEmissao:$utils.dataAtual(),dataVencimento:d.dataVencimento,dataImpressao:d.dataImpressao,valor:d.valor,valorJuros:d.valorJuros,tipoJuros:d.tipoJuros,valorMulta:d.valorMulta,valorDesconto:d.valorDesconto,valorTotal:d.valorTotal,codigoBarras:d.codigoBarras,linhaDigitavel:d.linhaDigitavel,mensagem1:d.mensagem1,mensagem2:d.mensagem2,mensagem3:d.mensagem3,mensagem4:d.mensagem4,mensagem5:d.mensagem5,gerarRemessa:1,remessaOperacao:Z};await $db.financeiroBoleto.grava({atual:Y});let ba=[];ea&&(ba=await $db.financeiroTitulo.le({idFinanceiroBoleto:ea}));for(const aa of ba){const fa=$utils.clonar(aa);aa.idFinanceiroBoleto=ma;let pa=[];ea&&(pa=await $db.financeiroBoletoTitulo.le({idFinanceiroBoleto:ea}));for(const Ta of pa){const U={id:$utils.uuid(),idFinanceiroBoleto:ma,idFinanceiroTitulo:Ta.idFinanceiroTitulo};await $db.financeiroBoletoTitulo.grava({atual:U})}await $db.financeiroTitulo.grava({atual:aa,original:fa})}if(d.remessaOperacao===Ea&&d.gerarRemessa===1)for(const aa of[d,Y]){const fa={...aa,gerarRemessa:0};await $db.financeiroBoleto.grava({original:aa,atual:fa})}}}let D=[];this.$refs.faturamento.idDocumentoCaixa&&(D=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa})),b=await $db.financeiroTitulo.le({idFatura:s.id});let V=await $db.financeiroTitulo.le({idFatura:s.id});for(const r of $utils.clonar(b)){if(!r.idFinanceiroMovimentacaoAgrupamento)continue;const d=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento});for(const N of d){const A=await $db.financeiroTitulo.le({id:N.idFinanceiroTitulo});A.idDocumentoCaixa===this.$refs.faturamento.idDocumentoCaixa&&(b=b.concat(A))}}let i=!1;for(const r of M){const d=await $db.financeiroTitulo.le({id:r.idFinanceiroTitulo});if(Object.keys(d).length){let N=[];N=D.filter(A=>A.idFinanceiroMovimentacaoN===d.idFinanceiroMovimentacaoAgrupamento),T=T.concat(N),N=D.filter(A=>A.idFinanceiroTitulo===d.id),T=T.concat(N),N=D.filter(A=>A.idFinanceiroCheque===d.id),T=T.concat(N),b=b.concat(d)}r.idFinanceiroTitulo="",r.sinal===1&&(i=!0)}V=await $db.financeiroTitulo.le({idFatura:s.id,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const r of V){if(!r.idFinanceiroMovimentacaoAgrupamento)continue;const d=await $db.financeiroMovimentacao.le({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento});T=T.concat(d);const N=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento});P=P.concat(N)}if(V=await $db.financeiroTitulo.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:s.id}),b=b.concat(V),s.id){let r=await $db.financeiroMovimentacao.lerV2({documentoTipo:"Devolu\xE7\xE3o",documentoId:s.id});T=T.concat(r),r=await $db.financeiroMovimentacao.lerV2({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:s.id}),T=T.concat(r),r=await $db.financeiroMovimentacao.lerV2({documentoId:s.id});for(const d of r)(await $db.financeiroTitulo.le({id:d.idFinanceiroTitulo})).id||(T=T.concat(d))}const z=await $db.documento.ler({idFatura:s.id});for(const r of z){const d=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:r.id});T=T.concat(d)}let q=[];for(const r in b){const d=b[r].id;q.includes(d)?delete b[r]:q.push(d)}b=b.filter(r=>r),q=[];for(const r in T){const d=T[r].id;q.includes(d)?delete T[r]:q.push(d)}T=T.filter(r=>r),q=[];for(const r in P){const d=P[r].id;q.includes(d)?delete P[r]:q.push(d)}P=P.filter(r=>r);let u=$utils.dataAtual(),C=i?"Aguardando Pagamento":"Aberta";this.documentoStatus=[{id:$utils.uuid(),idDocumento:s.id,operacao:"Fatura",statusOriginal:s.status,statusFinalizado:C,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}],s.status=C,C==="Aberta"&&(s.dataHoraFinalizado=""),C=i?"Aguardando Pagamento":"Aguardando Faturamento";for(const r of p)this.documentoStatus.push({id:$utils.uuid(),idDocumento:r.id,operacao:"Venda de Mercadoria",statusOriginal:r.status,statusFinalizado:C,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),r.status=C;for(const r of g)r.status=C;this.fatura=s,this.vendas=p,this.envelopes=a,this.documentoItens=g}if(this.$q.loading.hide(),o&&await this.finalizar(o),this.$q.loading.show({message:"Processando..."}),o){let D=[],V=[],i=[],z=[],q=[],u=[];D=this.$refs.faturamento.condicaoPagamento.map(C=>C.id),V=this.$refs.faturamento.condicaoPagamentoOriginal.filter(C=>!D.includes(C.id));for(const C of V)if(C.idFinanceiroTitulo&&i.push(C.idFinanceiroTitulo),C.idFormaPagamento){let r;r=await $erp().formaPagamento.get(C.idFormaPagamento),(r||{}).aliquota&&(C.idFinanceiroTituloPagar?i.push(C.idFinanceiroTituloPagar):this.$q.notify("N\xE3o foi poss\xEDvel excluir as movimenta\xE7\xF5es referentes \xE0 aliquota. Exclua-as manualmente."))}for(const C of i){let r;if(r=await $erp().financeiroTitulo.get(C),r.id&&z.push(r),r.idFinanceiroMovimentacaoAgrupamento){let d,N;if(d=await $erp().financeiroMovimentacao.where({idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento}).toArray(),N=(d.find(A=>A.idFinanceiroCheque)||{}).idFinanceiroCheque,N){let A=await $erp().financeiroTitulo.get(N);A.id&&z.push(A)}q.push(...d)}}for(let C of this.carnes){if(!C.id||(C=await $erp().financeiroTitulo.get(C.id),!(C||{}).idFinanceiroMovimentacaoAgrupamento))continue;let r,d;r=await $erp().financeiroMovimentacao.where({idFinanceiroMovimentacaoN:C.idFinanceiroMovimentacaoAgrupamento}).toArray(),d=await $erp().financeiroRenegociacao.where({idFinanceiroMovimentacaoN:C.idFinanceiroMovimentacaoAgrupamento}).toArray(),q.push(...r),u.push(...d)}await $db.financeiroTitulo.remove(z),await $db.financeiroMovimentacao.remove(q),await $db.financeiroRenegociacao.remove(u)}else{await $db.financeiroTitulo.remove(b.filter(D=>!(D.carne&&D.idFatura===s.id))),await $db.financeiroMovimentacao.remove(T),await $db.financeiroRenegociacao.remove(P);for(const D of b.filter(V=>V.carne&&V.idFatura===s.id))await $db.financeiroTitulo.grava({original:D,atual:{valorRealizado:0,receberPagar:1,dataPagamento:""}})}const B=[];for(const D of M)!D.tefRetorno||B.some(V=>V.tefRetorno===D.tefRetorno)||B.push(D);for(const D of B){let V,i,z;if(V=j.extrairCampo("valorTransacao",D.tefRetorno),i=j.extrairCampo("dataTransacao",D.tefRetorno),z=j.extrairCampo("nsu",D.tefRetorno),V&&i&&z){const q=await j.oper("cnc",{idTransacao:`2${this.fatura.id}`,tefRetorno:D.tefRetorno});let u,C,r,d=!1;if(u=j.extrairCampo("mensagemOperador",q.fileContent),C=j.extrairComprovante(q.fileContent),r=j.extrairCampo("codigoAutorizacao",q.fileContent),z=j.extrairCampo("nsu",q.fileContent),d=C&&r&&z,u&&$q.notify({message:u,type:d?"positive":"negative"}),!d)return;d&&(this.$refs.faturamento.condicaoPagamento=[],await j.oper("print",{content:C,opts:{txt:!0}}))}}return await this.salvarFatura(),await this.atualizar(),o?this.$q.notifyPositive("Fatura corrigida."):this.$q.notifyPositive("Fatura reaberta."),!0}catch{this.$q.notify("N\xE3o foi poss\xEDvel reabrir a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async corrigir(){let o,t,s,p;if(o=this.$refs.faturamento.condicaoPagamentoOriginal,t=this.$refs.faturamento.condicaoPagamento,p=$utils.arredondar(this.fatura.totalDocumento||0),s=$utils.arredondar(t.reduce((a,g)=>a+g.valor||0,0)),s!==p){this.$q.notify("Total das condi\xE7\xF5es de pagamento difere do total da fatura");return}if(o.length){let a=!1;t.length||(a=!0);for(const g of t)if(!o.find(M=>M.id===g.id)){a=!0;break}if(!a){this.$q.notify("N\xE3o h\xE1 corre\xE7\xE3o a ser realizada");return}}try{return await new Promise((a,g)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 corrigir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{g()})}),await this.reabrir(!0),!0}catch{return!1}},async salvarFatura(){try{this.$q.loading.show({message:"Processando..."});let o=$utils.clonar(this.$refs.faturamento.condicaoPagamento.filter(s=>s.valor));for(let s in o)delete o[s].idDocumentoCondicaoPagamento,delete o[s].parcelas,delete o[s].formaPagamento,delete o[s].edicao,delete o[s].codigoDocumento,delete o[s].codigoDocumentoCaixa;this.fatura.observacaoFaturamento=this.$refs.faturamento.observacaoFaturamento;const t=(this.carnesOriginal||[]).filter(s=>(this.financeiroTitulo||[]).find(p=>p.id===s.id));if(await $db.fatura.grava({faturaOriginal:this.faturaOriginal,fatura:this.fatura,vendasOriginal:this.vendasOriginal,vendas:this.vendas,envelopesOriginal:this.envelopesOriginal,envelopes:this.envelopes,documentoItensOriginal:this.documentoItensOriginal,documentoItens:this.documentoItens,condicaoPagamentoOriginal:this.$refs.faturamento.condicaoPagamentoOriginal,condicaoPagamento:o,documentoStatus:this.documentoStatus,financeiroTitulo:this.financeiroTitulo,financeiroTituloOriginal:t,financeiroMovimentacao:this.financeiroMovimentacao,financeiroRenegociacao:this.financeiroRenegociacao}),this.receberTitulo.id){let s=this.carnes.find(p=>p.id===this.receberTitulo.id);s.id&&await $db.financeiroTitulo.grava({original:s,atual:{idFatura:this.fatura.id}})}}catch{this.$q.notify("N\xE3o foi poss\xEDvel salvar a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}}},props:{prop:{default:()=>({}),required:!0,type:Object},receberTitulo:{default:()=>({}),type:Object}},mounted(){this.sistemaPai=$utils.sistemaPai(),this.atualizar()}},Ct={class:"Fatura round-borders bg-grey-2 q-pb-sm"},bt={class:"row items-center"},$t={class:"col q-ma-sm q-title"},Ft=m("div",{class:"text-h5"},null,-1),Dt={class:"bg-grey-2"},wt={class:"q-ma-sm"},_t={key:0,class:"q-item-label",style:{color:"#0c0c0c"}},Et={key:1,class:"q-item-label q-mt-md",style:{color:"#0c0c0c"}},Tt={class:"col-12 col-md-4 border-1 q-ma-md"},Pt=m("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Subtotal",-1),qt={class:"col-8 text-right"},yt=m("div",{class:"col-4 col-lg-3",style:{"line-height":"50px"}},"Desconto",-1),xt={class:"col-3"},Mt={class:"col-5"},Vt=m("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Total",-1),It={class:"col-8 q-mt-sm text-right"},zt=m("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Total",-1),Nt={class:"col-8 q-mt-sm text-right"},kt=m("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Bruto Total",-1),Rt={class:"col-8 q-mt-sm text-right"},Ot=m("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Metro C\xFAbico Total",-1),At={class:"col-8 q-mt-sm text-right"},Bt={class:"Fatura-faturamento round-borders q-ma-sm q-pa-md"},St={class:"round-borders q-ma-sm q-pa-md"};function Lt(o,t,s,p,a,g){const M=S("avatar"),b=S("documento-codigo"),T=S("documento-metas"),P=S("venda-card"),B=S("titulo-card"),D=S("row"),V=S("campo"),i=S("faturamento"),z=S("documentos-fiscais");return y(),Q("div",Ct,[l(na,{class:"Fatura-barra bg-grey-2 q-py-md",color:"black",dark:""},{default:c(()=>[l(ca,null,{default:c(()=>[m("div",bt,[l(M,{imagem:(a.contatos[a.fatura.idContato]||{}).imagem,rotulo:a.fatura.descricaoContato,tamanho:"60"},null,8,["imagem","rotulo"]),m("div",$t,x(a.fatura.descricaoContato),1)]),Ft]),_:1}),a.fatura.id?(y(),k(b,{key:0,documento:a.fatura},null,8,["documento"])):I("",!0),l(H,{color:"tertiary",flat:"",icon:"more_vert",round:""},{default:c(()=>[l(Aa,null,{default:c(()=>[l(Ba,{link:"",separator:""},{default:c(()=>[a.fatura.id?(y(),k(la,{key:0,clickable:"",onClick:t[0]||(t[0]=q=>o.$refs.documentosFiscais.emitirCupom(a.fatura.id))},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O("Emitir cupom")]),_:1})]),_:1})]),_:1})):I("",!0),a.fatura.id&&o.$utils.mapearStatus(a.fatura).permiteNota?(y(),Q(ua,{key:1},[l(la,{clickable:"",onClick:t[1]||(t[1]=q=>o.emitirNFeV2({idFatura:a.fatura.id},1,"Venda"))},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O("NFe de Sa\xEDda/Venda")]),_:1})]),_:1})]),_:1}),l(la,{clickable:"",onClick:t[2]||(t[2]=q=>o.emitirNFeV2({idFatura:a.fatura.id},0,"Devolu\xE7\xE3o"))},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O("NFe de Entrada/Devolu\xE7\xE3o")]),_:1})]),_:1})]),_:1}),l(la,{clickable:"",onClick:t[3]||(t[3]=q=>o.emitirNFeV2({idFatura:a.fatura.id},1,"Remessa"))},{default:c(()=>[l(K,{avatar:""},{default:c(()=>[l(J,{name:"account_balance"})]),_:1}),l(K,null,{default:c(()=>[l(da,null,{default:c(()=>[O("NFe de Remessa")]),_:1})]),_:1})]),_:1})],64)):I("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),m("div",Dt,[l(T,{ref:"documentoMetas"},null,512)]),m("div",wt,[a.vendas.length>0?(y(),Q("p",_t,[l(J,{name:"shopping_cart",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),O(" Vendas ")])):I("",!0),(y(!0),Q(ua,null,xa(a.vendas,q=>(y(),Q("div",{key:q.id,class:"bg-white q-mt-sm round-borders"},[l(P,{id:q.id,onAtualizar:g.atualizar,onExecutar:g.executar},null,8,["id","onAtualizar","onExecutar"])]))),128)),a.carnes.length>0?(y(),Q("p",Et,[l(J,{name:"attach_money",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),O(" Carn\xEAs ")])):I("",!0),(y(!0),Q(ua,null,xa(a.carnes,q=>(y(),Q("div",{key:q.id,class:"bg-white q-mt-sm round-borders"},[l(B,{dados:q,class:"q-mt-md",onExecutar:g.executar},null,8,["dados","onExecutar"])]))),128))]),l(D,{class:"justify-end"},{default:c(()=>[m("div",Tt,[l(D,{class:"q-col-gutter-md q-mb-sm"},{default:c(()=>[Pt,m("strong",qt,x(o.$filters.numero(a.fatura.subTotal,2)),1)]),_:1}),a.permissaoDesconto?(y(),k(D,{key:0,class:"q-col-gutter-x-sm"},{default:c(()=>[yt,m("div",xt,[l(V,{modelValue:a.fatura.totalPercentualDesconto,"onUpdate:modelValue":[t[4]||(t[4]=q=>a.fatura.totalPercentualDesconto=q),t[5]||(t[5]=q=>g.calculaTotais("descontoPercentual"))],tipo:"decimal",decimals:"2",suffix:"%","somente-leitura":g.descontoSomenteLeitura,error:a.erroCalculo},null,8,["modelValue","somente-leitura","error"])]),m("div",Mt,[l(V,{modelValue:a.fatura.totalDesconto,"onUpdate:modelValue":[t[6]||(t[6]=q=>a.fatura.totalDesconto=q),t[7]||(t[7]=q=>g.calculaTotais("desconto"))],tipo:"decimal",decimals:"2","somente-leitura":g.descontoSomenteLeitura,error:a.erroCalculo,errorMessage:a.erroCalculoMsg},null,8,["modelValue","somente-leitura","error","errorMessage"])])]),_:1})):I("",!0),l(D,{class:"q-col-gutter-x-sm q-mt-sm"},{default:c(()=>[Vt,m("strong",It,x(o.$filters.numero(a.fatura.totalDocumento,2)),1)]),_:1}),a.pesoTotal?(y(),k(D,{key:1,class:"q-col-gutter-x-sm q-mt-sm"},{default:c(()=>[zt,m("span",Nt,x(a.pesoTotal),1)]),_:1})):I("",!0),a.pesoBrutoTotal?(y(),k(D,{key:2,class:"q-col-gutter-x-sm q-mt-sm"},{default:c(()=>[kt,m("span",Rt,x(a.pesoBrutoTotal),1)]),_:1})):I("",!0),a.metroCubicoTotal?(y(),k(D,{key:3,class:"q-col-gutter-x-sm q-mt-sm"},{default:c(()=>[Ot,m("span",At,x(a.metroCubicoTotal),1)]),_:1})):I("",!0)])]),_:1}),m("div",Bt,[l(i,{documento:a.fatura,ref:"faturamento"},null,8,["documento"])]),m("div",St,[l(z,{ref:"documentosFiscais",idFatura:a.fatura.id},null,8,["idFatura"])])])}var jt=Va(gt,[["render",Lt]]);const Ht={components:{CpfCnpjNoCupom:po,Fatura:jt},data(){return{fatura:{},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:"",tipoCaixa:""},dinheiroTef:{mostrar:!1,valor:0},permissaoTef:!1,visivel:!1,visibilidade:{botao:{finalizar:!1,reabrir:!1,corrigir:!1}},temPermissaoCorrigir:!1}},emits:["executar"],methods:{async atualizar(){let o;try{o=setTimeout(()=>{$q.loading.show({message:"Carregando informa\xE7\xF5es...",boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})},500);let t=this.id?await $db.documento.ler({id:this.id}):{};this.fatura=t,await this.verificarPermissoes(),this.desativarBotoes(),t.status==="Aberta"&&(this.visibilidade.botao.salvar=!0),t.status==="Finalizada"||t.status!=="Aguardando Pagamento"&&t.dataHoraFinalizado?this.visibilidade.botao.reabrir=!0:this.visibilidade.botao.finalizar=!0,await $db.contato.exibirCondutaObservacao(t.idContato,$q.notify)}finally{clearTimeout(o),$q.loading.hide()}},desativarBotoes(){this.visibilidade.botao.finalizar=!1,this.visibilidade.botao.reabrir=!1,this.visibilidade.botao.salvar=!1},desativarEsc(){this.lockEsc=!0},reativarEsc(){this.lockEsc=!1},async reabrir(){await this.$refs.fatura.reabrir(),await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"))},voltar(o){o.stopPropagation(),!this.lockEsc&&this.fechar()},async finalizarTef(o){o==="dinheiro"&&(this.dinheiroTef.valor=0,this.dinheiroTef.mostrar=!0),o==="cpfCnpj"&&(this.dinheiroTef.mostrar=!1,this.cpfCnpjNoCupom={visivel:!0,incluirCpfCnpjNoCupom:!1,idEmpresa:this.fatura.idEmpresa,cpfCnpj:this.fatura.numeroDocumentoContato,nomeCliente:this.fatura.descricaoContato,tipoCaixa:""})},async finalizar(o){var a;const{tef:t}=o!=null?o:{},s=!1,p={tef:t,cpfCnpjNoCupom:this.cpfCnpjNoCupom,valorDinheiro:(a=this.dinheiroTef.valor)!=null?a:0};if(this.lockEsc=!0,!await this.$refs.fatura.finalizar(s,p)){this.lockEsc=!1;return}this.$emit("executar","finalizar"),this.fechar()},async executar(o){switch(o){case"finalizar":if(!await this.$refs.fatura.finalizar())return;break;case"retornarOrcamento":case"remover":await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"));return}this.$emit("executar",o),this.fechar()},fechar(){this.visivel=!1},async mostrar(o={}){this.id=o.id,await this.atualizar(),this.visivel=!0},onHide(){this.fatura={},this.visibilidade={botao:{finalizar:!1,reabrir:!1,corrigir:!1}},this.temPermissaoCorrigir=!1,this.runOnHide.forEach(o=>o()),this.runOnHide=[]},async salvar(){try{await new Promise((o,t)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 salvar esta fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{o()}).onCancel(()=>{t()})})}catch{return}await this.$refs.fatura.salvarFatura(),this.$emit("executar","atualizar"),this.fechar()},corrigir(){this.$refs.fatura.corrigir().then(()=>{this.$emit("executar","atualizar"),this.fechar()})},async verificarPermissoes(){const o=await $erp().formaPagamento.toArray();this.temPermissaoCorrigir=await $db.permissao.objeto("caixa/tesouraria"),this.permissaoTef=o.some(t=>t.idContatoEmpresa===this.fatura.idEmpresa&&t.ativo&&t.tef)}},props:{receberTitulo:{default:()=>({}),type:Object}},created(){this.runOnHide=[]},mounted(){$utils.emitter.on("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.on("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.on("reativarVoltarEscModal",this.reativarEsc)},beforeUnmount(){$utils.emitter.off("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.off("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.off("reativarVoltarEscModal",this.reativarEsc)}};function Qt(o,t,s,p,a,g){const M=S("fatura"),b=S("campo"),T=S("g-col"),P=S("g-row"),B=S("CpfCnpjNoCupom");return y(),Q("div",null,[l(Ma,{modelValue:a.visivel,"onUpdate:modelValue":t[1]||(t[1]=D=>a.visivel=D),onKeyup:uo(g.voltar,["esc"]),onHide:g.onHide,maximized:"",persistent:""},{default:c(()=>[l(io,{view:"hHh LpR fFf",container:"",class:"bg-grey-4"},{default:c(()=>[l(no,null,{default:c(()=>[l(na,null,{default:c(()=>[wa(l(H,{icon:"arrow_back",round:"",flat:"",dense:""},null,512),[[_a]]),l(ca,null,{default:c(()=>[O("Fatura")]),_:1}),a.visibilidade.botao.salvar?(y(),k(H,{key:0,onClick:g.salvar,label:"Salvar",color:"white","text-color":"primary",unelevated:""},null,8,["onClick"])):I("",!0),a.visibilidade.botao.reabrir&&a.temPermissaoCorrigir?(y(),k(H,{key:1,onClick:g.corrigir,label:"Corrigir",color:"white","text-color":"negative",unelevated:""},null,8,["onClick"])):I("",!0)]),_:1})]),_:1}),l(ro,null,{default:c(()=>[l(so,{class:"u-container q-py-md"},{default:c(()=>[a.fatura.id?(y(),k(M,{key:0,onExecutar:g.executar,prop:{id:a.fatura.id},receberTitulo:s.receberTitulo,ref:"fatura"},null,8,["onExecutar","prop","receberTitulo"])):I("",!0)]),_:1})]),_:1}),l(lo,{class:"bg-light",bordered:""},{default:c(()=>[l(na,{class:"q-pa-sm u-container"},{default:c(()=>[l(co),a.visibilidade.botao.reabrir?(y(),k(H,{key:0,onClick:g.reabrir,label:"Reabrir",color:"negative",flat:"",class:"q-ml-sm"},null,8,["onClick"])):I("",!0),a.visibilidade.botao.reabrir?I("",!0):(y(),k(H,{key:1,onClick:g.finalizar,disabled:!a.visibilidade.botao.finalizar,label:"Finalizar",color:"primary",dark:"",unelevated:"",class:"q-ml-sm"},null,8,["onClick","disabled"])),!a.visibilidade.botao.reabrir&&a.permissaoTef?(y(),k(H,{key:2,onClick:t[0]||(t[0]=D=>g.finalizarTef("dinheiro")),dark:"",unelevated:"",disabled:!a.visibilidade.botao.finalizar,label:"Finalizar TEF",color:"primary",class:"q-ml-sm"},null,8,["disabled"])):I("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup","onHide"]),l(Ma,{modelValue:a.dinheiroTef.mostrar,"onUpdate:modelValue":t[4]||(t[4]=D=>a.dinheiroTef.mostrar=D)},{default:c(()=>[l(Sa,{style:{width:"425px"}},{default:c(()=>[l(na,{class:"bg-primary text-white"},{default:c(()=>[l(ca,null,{default:c(()=>[O("Dinheiro")]),_:1})]),_:1}),l(mo,{class:"no-padding"},{default:c(()=>[l(La,{onSubmit:t[3]||(t[3]=D=>g.finalizarTef("cpfCnpj"))},{default:c(()=>[l(P,{gutter:"md"},{default:c(()=>[l(T,{col:"12",class:"q-my-lg"},{default:c(()=>[l(b,{modelValue:a.dinheiroTef.valor,"onUpdate:modelValue":t[2]||(t[2]=D=>a.dinheiroTef.valor=D),before:[{icon:"attach_money"}],rotulo:"Valor",tipo:"decimal",decimals:"2"},null,8,["modelValue"])]),_:1}),l(T,{col:"12",text:"right",bordered:"top"},{default:c(()=>[wa(l(H,{label:"Cancelar",color:"tertiary",flat:"",class:"q-ml-sm"},null,512),[[_a]]),l(H,{type:"submit",label:"Ok",color:"primary",unelevated:"",class:"q-ml-sm q-px-xl"})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(B,{modelValue:a.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":t[5]||(t[5]=D=>a.cpfCnpjNoCupom.visivel=D),onConfirmar:t[6]||(t[6]=D=>g.finalizar({tef:!0})),dados:a.cpfCnpjNoCupom},null,8,["modelValue","dados"])])}var Zt=Va(Ht,[["render",Qt]]);export{Zt as F,pt as T};
