import{_ as k,p as V,o as m,i as A,w as l,f as d,K as z,A as U,B as y,C as B,D as T,L as M,E as w,e as f,G as O,x as a,t as r,j as C,k as Q,d as p,F,r as q,l as E,y as j}from"./index.de1453f2.js";const J={computed:{recebimentos(){return $utils.arredondar((this.campos.fechamento||0)-(this.campos.abertura||0)+(this.campos.despesas||0)-(this.campos.suprimentos||0)+(this.campos.sangrias||0))}},data(){return{visivel:!1,idDocumentoCaixa:"",campos:{sangrias:0,despesas:0,suprimentos:0,sangriaFinal:0,fundoCaixa:0,abertura:0,dataHoraAbertura:"",nomeUsuarioAbertura:"",caixaDescricao:"",caixaEmpresaNome:"",observacao:""},sangrias:[],despesas:[],suprimentos:[],condicaoPagamento:[],condicaoPagamentoDinheiro:[]}},emits:["fechado","update:modelValue"],methods:{calculaSangriaFinal(){let t=$utils.arredondar(this.campos.fechamento-this.campos.fundoCaixa);t<0&&(this.$q.notify({message:"Sangria final n\xE3o pode ser maior do que o recebimento",type:"warning"}),this.campos.fundoCaixa=0,t=$utils.arredondar(this.campos.fechamento)),this.campos.sangriaFinal=t},async atualizar(){var t;try{$q.loading.show({message:"Processando..."});let o=$db.usuario.logado.numeroDocumentoNacional,c;if(o){let i;i=await $erp().contato.where({numeroDocumentoNacional:o}).toArray(),c=i[0],c||(o=o.replace(/\D/g,""),i=await $erp().contato.where({numeroDocumentoNacional:o}).toArray(),c=i[0])}if(!(c!=null&&c.id))throw new Error("GError:Usu\xE1rio n\xE3o cadastrado.");if(this.campos.sangrias=0,this.campos.despesas=0,this.campos.suprimentos=0,this.campos.sangriaFinal=0,this.campos.fundoCaixa=0,this.campos.abertura=0,this.campos.dataHoraAbertura="",this.campos.nomeUsuarioAbertura="",this.campos.caixaDescricao="",this.campos.caixaEmpresaNome="",this.campos.observacao="",this.documentoCaixa={},this.idDocumentoCaixa){const i=await $db.documento.ler({id:this.idDocumentoCaixa});i.tipo==="Caixa"&&["Aberto","Reaberto"].includes(i.status)&&(this.documentoCaixa=i)}if(!this.documentoCaixa||!this.documentoCaixa.id){$q.notify({message:"Selecione um caixa aberto",type:"warning"});return}const D=await $db.documentoCondicaoPagamento.ler({idDocumentoCaixa:this.idDocumentoCaixa}),s={};for(const i of D)if(i.idDocumento&&!s[i.idDocumento]&&(s[i.idDocumento]=await $db.documento.ler({id:i.idDocumento}),!s[i.idDocumento].dataHoraFinalizado)){this.$q.notify({message:"Existem faturas abertas com condi\xE7\xE3o de pagamento lan\xE7ada. N\xE3o \xE9 poss\xEDvel finalizar o caixa sem finalizar ou excluir essas faturas!",type:"warning"});return}this.caixa=await $db.caixa.le({id:this.documentoCaixa.idCaixa});const h=await $db.financeiroTitulo.le({idDocumentoCaixa:this.documentoCaixa.id}),u=await $db.empresa.le({idContato:this.documentoCaixa.idEmpresa});u.length&&(this.empresa=u[0]);const b=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.documentoCaixa.id,documentoTipo:"Sangria"});this.sangrias=b.filter(i=>i.valorCredito>0),this.campos.sangrias=$utils.arredondar(this.sangrias.reduce((i,v)=>(i+=v.valorCredito,i),0)),this.despesas=h.filter(i=>i.documentoTipo==="DespesaSimples");let e=0;for(const i of this.despesas)e+=i.valorTotal,i.contato=await $db.contato.le({id:i.idContato}),i.financeiroPlanoConta=await $db.financeiroPlanoConta.le({id:i.idFinanceiroPlanoConta});this.campos.despesas=$utils.arredondar(e);const $=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.documentoCaixa.id,documentoTipo:"Suprimento"});this.suprimentos=$.filter(i=>i.valorDebito>0),this.campos.suprimentos=$utils.arredondar(this.suprimentos.reduce((i,v)=>(i+=v.valorDebito,i),0));let x=(await $db.formaPagamento.le()).filter(i=>(!i.idContatoEmpresa||i.idContatoEmpresa===this.documentoCaixa.idEmpresa)&&!!i.ativo).map(i=>({id:i.id,tipo:i.tipo,descricao:i.descricao,valor:0,idFinanceiroPlanoConta:i.idFinanceiroPlanoConta}));for(const i in s){const v=D.filter(g=>g.idDocumento===i);for(const g of v)for(const n of x)n.id===g.idFormaPagamento&&[5,97,99].includes(n.tipo)&&(n.valor=$utils.arredondar(n.valor+g.valor))}this.condicaoPagamento=$lodash.orderBy(x.filter(i=>i.idFinanceiroPlanoConta!==this.caixa.idPlanoConta),"descricao","asc"),this.condicaoPagamentoDinheiro=x.filter(i=>i.idFinanceiroPlanoConta===this.caixa.idPlanoConta),this.campos.abertura=this.documentoCaixa.valorAbertura,this.campos.dataHoraAbertura=this.documentoCaixa.dataHoraEmissao,this.campos.observacao=this.documentoCaixa.observacao;let _;this.documentoCaixa.idContato&&(_=await $erp().contato.get(this.documentoCaixa.idContato)),this.campos.nomeUsuarioAbertura=(t=_==null?void 0:_.nome)!=null?t:"",this.campos.caixaDescricao=this.caixa.descricao,this.campos.caixaEmpresaNome=this.empresa.nome,this.calculaSangriaFinal(),$q.loading.hide(),this.visivel=!0,this.$emit("update:modelValue",!0)}catch(o){let c="N\xE3o \xE9 poss\xEDvel realizar o fechamento de caixa.";/^GError:.+$/.test(o.message)&&(c=o.message.slice(7)),$q.notifyError(c,o)}finally{$q.loading.hide()}},async fecharCaixa(){try{if($q.loading.show({message:"Processando..."}),this.campos.sangriaFinal<0){this.$q.notify({message:"Sangria final n\xE3o pode ser negativa.",type:"warning"});return}const t=$utils.dataAtual();let o=$utils.clonar(this.documentoCaixa);o.status="Aguardando Confer\xEAncia",o.dataHoraFinalizado=t,o.observacao=this.campos.observacao,o.valorAbertura=this.campos.abertura,$utils.verificarErro(new Date(o.dataHoraFinalizado)<new Date(o.dataHoraEmissao),`
            A abertura do caixa foi registrada em ${this.$filters.dataHora(o.dataHoraEmissao)},
            sua data agora \xE9 ${this.$filters.dataHora(o.dataHoraFinalizado)},
            como ela \xE9 menor que a abertura, n\xE3o podemos continuar, confira a data e hora do seu dispositivo.
          `);let c=await $db.caixa.le({id:o.idCaixa});$utils.verificarErro(!c.id,"Caixa n\xE3o existe");let D=await $db.financeiroPlanoConta.le({id:c.idPlanoConta}),s=await $db.financeiroPlanoConta.le({id:c.idPlanoContaSangria}),h=await $db.documentoStatus.le({idDocumento:o.id});if(h=h.filter(n=>n.operacao==="Fechamento Caixa"&&n.statusFinalizado==="Aguardando Confer\xEAncia"&&n.statusOriginal==="Aberto"),this.campos.sangriaFinal>0){const n=h.length?h[0].dataHoraEmissao:t,S=$db.usuario.logado.id,P=$utils.uuid(),H={id:$utils.uuid(),idFinanceiroMovimentacaoN:P,idEmpresa:o.idEmpresa,idContato:S,idFinanceiroPlanoConta:D.id,dataEmissao:t,dataCompetencia:n,dataVencimento:n,dataMovimento:n,valorDebito:0,valorCredito:this.campos.sangriaFinal,descricao:`Sangria final de ${$db.usuario.logado.nome} no Caixa #${o.id}`,observacao:"Transfer\xEAncia entre contas",documentoTipo:"Sangria Final",documentoId:o.id,idDocumentoCaixa:o.id},N={id:$utils.uuid(),idFinanceiroMovimentacaoN:P,idEmpresa:o.idEmpresa,idContato:S,idFinanceiroPlanoConta:s.id,dataEmissao:t,dataCompetencia:n,dataVencimento:n,dataMovimento:n,valorDebito:this.campos.sangriaFinal,valorCredito:0,descricao:`Sangria final de ${$db.usuario.logado.nome} no Caixa #${o.id}`,observacao:"Transfer\xEAncia entre contas",documentoTipo:"Sangria Final",documentoId:o.id,idDocumentoCaixa:o.id};$db.financeiroMovimentacaoN.grava({atual:{id:P}}),$db.financeiroMovimentacao.grava({atual:H}),$db.financeiroMovimentacao.grava({atual:N})}let u=await $db.documentoStatus.le({idDocumento:o.id}),b="";u.length&&(u=$lodash.orderBy(u,"dataHoraEmissao","desc"),b=u[0].statusFinalizado);const e=$utils.uuid(),$={id:e,idDocumento:o.id,operacao:"Fechamento Caixa",statusOriginal:b,statusFinalizado:"Aguardando Confer\xEAncia",dataHoraEmissao:t,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:o.id};let x=[];for(let n of this.condicaoPagamento)x.push({id:$utils.uuid(),idDocumento:o.id,idFormaPagamento:n.id,dataVencimento:t,valor:n.valor,ordem:e});for(let n of this.condicaoPagamentoDinheiro)x.push({id:$utils.uuid(),idDocumento:o.id,idFormaPagamento:n.id,dataVencimento:t,valor:this.campos.fechamento,ordem:e});let _=await $db.documentoCondicaoPagamento.ler({idDocumentoCaixa:o.id}),i=await $db.financeiroTitulo.le({idDocumentoCaixa:o.id,idDocumentoCaixaLiquidacao:o.id}),v=await $db.financeiroMovimentacao.le({idDocumentoCaixa:o.id}),g=[];for(let n of _)g.push({id:$utils.uuid(),idDocumentoCaixa:o.id,idDocumentoStatus:e,tabela:"documentoCondicaoPagamento",idTabela:n.id,json:JSON.stringify(n),dataHoraEmissao:t});for(let n of x)g.push({id:$utils.uuid(),idDocumentoCaixa:o.id,idDocumentoStatus:e,tabela:"documentoCondicaoPagamento",idTabela:n.id,json:JSON.stringify(n),dataHoraEmissao:t});for(let n of i)g.push({id:$utils.uuid(),idDocumentoCaixa:o.id,idDocumentoStatus:e,tabela:"financeiroTitulo",idTabela:n.id,json:JSON.stringify(n),dataHoraEmissao:t});for(let n of v)g.push({id:$utils.uuid(),idDocumentoCaixa:o.id,idDocumentoStatus:e,tabela:"financeiroMovimentacao",idTabela:n.id,json:JSON.stringify(n),dataHoraEmissao:t});await $db.caixa.fecha({documentoCaixa:o,documentoCaixaOriginal:this.documentoCaixa,documentoStatus:[$],caixaConsolidacao2:g}),$q.loading.hide(),this.visivel=!1,this.$emit("update:modelValue",!1),this.$emit("fechado"),this.$imprimir("fechamento-de-caixa",this.documentoCaixa.id),$q.notifyPositive("Caixa fechado com sucesso")}catch(t){this.$q.notifyError("N\xE3o foi poss\xEDvel realizar o Fechamento de Caixa.",t)}finally{$q.loading.hide()}},async mostrar(t){const{idDocumentoCaixa:o}=t!=null?t:{};this.idDocumentoCaixa=o,await this.atualizar()}}},L={class:"layout-padding q-pa-none q-pb-md"},G={class:"u-container q-pt-md"},I={class:"col-12"},R={class:"bg-white round-borders q-px-md q-pb-md"},K={class:"q-px-sm text-tertiary"},W=a("small",null,"Abertura",-1),X=a("br",null,null,-1),Y={class:"q-px-sm text-tertiary hideonmobile"},Z=a("small",null,"Usu\xE1rio",-1),aa=a("br",null,null,-1),oa={class:"q-px-sm text-tertiary hideonmobile"},ia=a("small",null,"Empresa",-1),ea=a("br",null,null,-1),ta={class:"col-6 text-tertiary hideondesktop"},sa=a("small",null,"Usu\xE1rio",-1),na=a("br",null,null,-1),da={class:"col-6 text-tertiary hideondesktop"},ra=a("small",null,"Empresa",-1),la=a("br",null,null,-1),ca={class:"col-12"},ma={class:"col-12 col-md-6"},ua={class:"bg-white fit round-borders q-px-md q-pb-md"},pa={class:"col-12 items-center q-col-gutter-sm text-body2 row"},ha=a("div",{class:"col-5"},"Abertura",-1),fa={class:"col-7"},ga=a("div",{class:"col-5"},"Recebimentos",-1),ba={class:"col-7 text-right"},xa=a("strong",null,"Recebimentos",-1),va=a("div",{class:"col-5"},"Sangrias",-1),Ca={class:"col-7 text-right"},_a={key:0,class:"col-12"},Da={class:"Tabela q-ma-sm q-pa-md full-width"},$a=a("div",{class:"col-5"},"Suprimentos",-1),ya={class:"col-7 text-right"},wa={key:1,class:"col-12"},Fa={class:"Tabela q-ma-sm q-pa-md full-width"},qa=a("div",{class:"col-5"},"Despesas",-1),Pa={class:"col-7 text-right"},Ea={key:2,class:"col-12"},Sa={class:"Tabela q-ma-sm q-pa-md full-width"},Va=a("div",{class:"col-5"},"Fechamento",-1),Aa={class:"col-7"},Ta=a("div",{class:"col-5"},"Fundo de caixa",-1),Ha={class:"col-7"},Na=a("div",{class:"col-5"},"Sangria Final",-1),ka={class:"col-7 text-right"},za={class:"col-12 col-md-6"},Ua={class:"bg-white fit round-borders q-px-md q-pb-md"},Ba={class:"q-mt-sm"},Ma={class:"col-7"},Oa={class:"col-5"},Qa={key:1,class:"text-right",style:{"padding-top":"6px","padding-right":"8px"}};function ja(t,o,c,D,s,h){const u=V("campo"),b=V("row");return m(),A(j,{id:"caixaFechar",modelValue:s.visivel,"onUpdate:modelValue":o[4]||(o[4]=e=>s.visivel=e),maximized:""},{default:l(()=>[d(z,{container:"",class:"bg-light"},{default:l(()=>[d(U,null,{default:l(()=>[d(y,null,{default:l(()=>[B(d(T,{dense:"",flat:"",icon:"arrow_back",round:"",clikable:""},null,512),[[M]]),d(w,null,{default:l(()=>[f("Fechar caixa")]),_:1}),d(T,{color:"white",class:"text-primary",label:"Concluir",onClick:h.fecharCaixa,unelevated:""},null,8,["onClick"])]),_:1})]),_:1}),d(O,null,{default:l(()=>[a("div",L,[a("div",G,[d(b,{class:"q-col-gutter-md"},{default:l(()=>[a("div",I,[a("div",R,[d(y,{class:"q-px-none"},{default:l(()=>[d(w,{class:"text-tertiary"},{default:l(()=>[f(r(s.campos.caixaDescricao),1)]),_:1}),a("div",K,[a("div",null,[W,X,d(C,{name:"calendar_today",class:"q-mr-sm"}),f(" "+r(t.$filters.dataHora(s.campos.dataHoraAbertura)),1)])]),a("div",Y,[a("div",null,[Z,aa,d(C,{name:"person",class:"q-mr-sm"}),f(" "+r(s.campos.nomeUsuarioAbertura),1)])]),a("div",oa,[ia,ea,d(C,{name:"business"}),f(" "+r(s.campos.caixaEmpresaNome),1)])]),_:1}),d(b,{class:"items-center q-col-gutter-x-md"},{default:l(()=>[a("div",ta,[a("p",null,[sa,na,d(C,{name:"person"}),f(" "+r(s.campos.nomeUsuarioAbertura),1)])]),a("div",da,[a("p",null,[ra,la,d(C,{name:"business"}),f(" "+r(s.campos.caixaEmpresaNome),1)])]),a("div",ca,[d(u,{modelValue:s.campos.observacao,"onUpdate:modelValue":o[0]||(o[0]=e=>s.campos.observacao=e),rotulo:"Observa\xE7\xE3o",rows:"2",tipo:"textoArea"},null,8,["modelValue"])])]),_:1})])]),a("div",ma,[a("div",ua,[a("form",null,[d(y,{class:"q-px-none"},{default:l(()=>[d(C,{name:"mdi-cash-multiple",size:"24px",class:"text-tertiary"}),d(w,{class:"text-tertiary"},{default:l(()=>[f("Dinheiro")]),_:1})]),_:1}),d(b,{class:"q-col-gutter-md"},{default:l(()=>[a("div",pa,[ha,a("div",fa,[d(u,{modelValue:s.campos.abertura,"onUpdate:modelValue":o[1]||(o[1]=e=>s.campos.abertura=e),class:"bg-grey-2",tipo:"decimal",decimals:"2"},null,8,["modelValue"])]),ga,a("div",ba,[f(r(t.$filters.numero(h.recebimentos,2))+" ",1),d(Q,null,{default:l(()=>[f("Fechamento - Abertura + Despesas - Suprimentos + Sangrias = "),xa]),_:1})]),va,a("div",Ca,r(t.$filters.numero(s.campos.sangrias,2)),1),s.campos.sangrias>0?(m(),p("div",_a,[a("table",Da,[a("tbody",null,[(m(!0),p(F,null,q(s.sangrias,e=>(m(),p("tr",{key:e.id},[a("td",null,r(t.$filters.data(e.dataEmissao)),1),a("td",null,r(e.observacao),1),a("td",null,r(t.$filters.numero(e.valorCredito,2)),1)]))),128))])])])):E("",!0),$a,a("div",ya,r(t.$filters.numero(s.campos.suprimentos,2)),1),s.campos.suprimentos>0?(m(),p("div",wa,[a("table",Fa,[a("tbody",null,[(m(!0),p(F,null,q(s.suprimentos,e=>(m(),p("tr",{key:e.id},[a("td",null,r(t.$filters.data(e.dataEmissao)),1),a("td",null,r(e.observacao),1),a("td",null,r(t.$filters.numero(e.valorDebito,2)),1)]))),128))])])])):E("",!0),qa,a("div",Pa,r(t.$filters.numero(s.campos.despesas,2)),1),s.campos.despesas>0?(m(),p("div",Ea,[a("table",Sa,[a("tbody",null,[(m(!0),p(F,null,q(s.despesas,e=>(m(),p("tr",{key:e.id},[a("td",null,r(t.$filters.data(e.dataEmissao)),1),a("td",null,r((e.contato||{}).nome),1),a("td",null,r(((e.financeiroPlanoConta||{}).descricao||"").trim()),1),a("td",null,r(t.$filters.numero(e.valorTotal,2)),1)]))),128))])])])):E("",!0),Va,a("div",Aa,[d(u,{modelValue:s.campos.fechamento,"onUpdate:modelValue":o[2]||(o[2]=e=>s.campos.fechamento=e),class:"bg-grey-2",tipo:"decimal",decimals:"2",onBlur:h.calculaSangriaFinal},null,8,["modelValue","onBlur"])]),Ta,a("div",Ha,[d(u,{modelValue:s.campos.fundoCaixa,"onUpdate:modelValue":o[3]||(o[3]=e=>s.campos.fundoCaixa=e),class:"bg-grey-2",tipo:"decimal",decimals:"2",onBlur:h.calculaSangriaFinal},null,8,["modelValue","onBlur"])]),Na,a("div",ka,r(t.$filters.numero(s.campos.sangriaFinal,2)),1)])]),_:1})])])]),a("div",za,[a("div",Ua,[a("form",null,[d(y,{class:"q-px-none"},{default:l(()=>[d(C,{name:"mdi-credit-card-multiple",size:"24px",class:"text-tertiary"}),d(w,{class:"text-tertiary"},{default:l(()=>[f("Outras formas de pagamento")]),_:1})]),_:1}),a("div",Ba,[(m(!0),p(F,null,q(s.condicaoPagamento,e=>(m(),p("div",{class:"q-col-gutter-x-sm items-center q-mt-sm row",key:e.id},[a("div",Ma,r(e.descricao),1),a("div",Oa,[[5,99].includes(e.tipo)?(m(),p("div",Qa,r(t.$filters.numero(e.valor,2)),1)):(m(),A(u,{key:0,modelValue:e.valor,"onUpdate:modelValue":$=>e.valor=$,tipo:"decimal",decimals:"2",class:"bg-grey-2"},null,8,["modelValue","onUpdate:modelValue"]))])]))),128))])])])])]),_:1})])])]),_:1})]),_:1})]),_:1},8,["modelValue"])}var La=k(J,[["render",ja]]);export{La as C};
