<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Receita</title>
        <link rel="stylesheet" type="text/css" href="optidados.framework.css"/>
		<link href="/Content/Plugins/kendo/kendo.common.min.css" rel="stylesheet" />
		<link href="/Content/Plugins/kendo/kendo.dataviz.silver.min.css" rel="stylesheet" />
		<link href="/Content/Plugins/kendo/kendo.rtl.min.css" rel="stylesheet" />
		<link href="/Content/Plugins/kendo/kendo.silver.min.css" rel="stylesheet" />
		<link href="/Content/Plugins/kendo/kendo.silver.mobile.min.css" rel="stylesheet" />
		
		<script src="/Scripts/jquery-2.1.4.js"></script>
		<script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
		<script src="/Scripts/paper-full.js"></script>
		<script src="/Scripts/jquery-2.1.4.min.js"></script>
		<script src="/Content/Plugins/kendo/kendo.all.min.js"></script>

		<style type="text/css">
            h5 { font-size: 13px; }
            h6 { font-size: 12px; }
            p { font-size: 11px; }
		</style>

        <style type="text/css" media="print">
            @page{
                margin:6mm;
            }
        </style>
    </head>

	<body>
		<div class="container">

            <!--cabeçalho do impresso-->
            <div class="row w100 linef pf10 mb15">
                <div class="col w47-2 pf10" style="height: 160px;">
                    <div class="row w100 logo" style="height: 100%;">
                        <img class="img-responsive" src="optsoul-exemplo.png"/>
                    </div>
                </div>

                <div class="col w47-2 pf10" style="height: 160px;">
                    <div class="row w100 linef pf05" style="height: 120px;">
                        <!-- <h2> Cód. Paciente: <span id="CodigoContato">-</span> </h2> -->
                        <h1 style="font-size: 18px"><span id="nomePaciente"></span> - <span id="idadePaciente"></span> </h1>
                        <!-- <h5>Endereço: <span id="enderecoPaciente">-</span>  </h5> -->
                        <!-- <h5>Telefone: <span id="telefonePaciente">-</span> </h5> -->
                    </div>
                    <div class="row w100 txt-ac">
                        <h1 class="b" style="font-size: 18px; color: rgb(187,0,0);">Departamento de Optometria</h1>
                    </div>
                </div>

                <div class="row w100 pt03">
                    <h2 class="b" style="font-size: 18px;"> <span id="fantasiaEmissor">Carregando impressão</span> </h2>
                    <h4> <span id="enderecoEmissor">-</span> </h4>
                    <h4> <span id="telefoneEmissor"></span> </h4>
                    <h4> <span id="emailEmissor">-</span> </h4>
                    <h4> <span id="siteEmissor">-</span> </h4>
                </div>
            </div>
            <!--.end cabeçalho do impresso-->

            <!--prescricao-->
            <div class="row w100 linef pf10 mb15">
                <div class="row w100 float-r">
                    <h3 class="float-l col w50">Prescrição de: <span id="nomeMedico"></span></h3>
                    <h3 class="float-r col w50">Data Presc.: <span id="dataPrevista"></span></h3>
                    <!-- <h5>Valida até <span id="dataValidade"></span></h5> -->
                </div>

                <!--relogio eixo direito-->
                <div class="col w49-3">
                    <div id="eixoDireito" style="width: 100%; height: 300px;"></div>
                </div>
				
                <!--relogio eixo esquerdo-->
                <div class="col w49-3">
                    <div id="eixoEsquerdo" style="width: 100%; height: 300px;"></div>
                </div>

                <!--olho direito-->                     
                <div class="col w49-3 linel lineb liner" style="margin-top: -110px;">
                    <ul class="list-col txt-ac">
                        <li class="w10"> <h5 class="b linef">O.D.</h5> </li>
                        <li class="w12-8 lineb"> <h5> Adc. </h5> </li>
                        <li class="w12-8 lineb"> <h5> Esf. </h5> </li>
                        <li class="w12-8 lineb"> <h5> Cil. </h5> </li>
                        <li class="w12-8 lineb"> <h5> Eixo </h5> </li>
                        <li class="w12-8 lineb"> <h5> Pris. </h5> </li>
                        <li class="w12-8 lineb"> <h5> Base </h5> </li>
                        <li class="w12-8 lineb"> <h5> DNP  </h5> </li>
                    </ul>

                    <ul class="list-col txt-ac linhaDireitoLonge">
                        <li class="w10"> <h5 class="txt-al"> Longe </h5> </li>
                        <li class="w12-8"> <h5>.</h5> </li>
                        <li class="w12-8"> <h5 id="odLongeEsf"> </h5> </li>
                        <li class="w12-8"> <h5 id="odLongeCil"> </h5> </li>
                        <li class="w12-8"> <h5 id="odLongeEixo"> </h5> </li>
                        <li class="w12-8"> <h5 id="odLongePris"> </h5> </li>
                        <li class="w12-8"> <h5 id="odLongeBase"> </h5> </li>
                        <li class="w12-8"> <h5 id="odLongeDNP"> </h5> </li>
                    </ul>

                    <ul class="medio list-col txt-ac linhaDireitoMedio">
                        <li class="w10"> <h5 class="txt-al"> Medio </h5> </li>
                        <li class="w12-8"> <h5 id="odMedioAdc"> </h5> </li>
                        <li class="w12-8"> <h5 id="odMedioEsf"> </h5> </li>
                        <li class="w12-8"> <h5 id="odMedioCil"> </h5> </li>
                        <li class="w12-8"> <h5 id="odMedioEixo"> </h5> </li>
                        <li class="w12-8"> <h5 id="odMedioPris"> </h5> </li>
                        <li class="w12-8"> <h5 id="odMedioBase"> </h5> </li>
                        <li class="w12-8"> <h5 id="odMedioDNP"> </h5> </li>
                    </ul>

                    <ul class="perto list-col txt-ac linhaDireitoPerto">
                        <li class="w10"> <h5 class="txt-al"> Perto </h5> </li>
                        <li class="w12-8"> <h5 id="odPertoAdc"> </h5> </li>
                        <li class="w12-8"> <h5 id="odPertoEsf"> </h5> </li>
                        <li class="w12-8"> <h5 id="odPertoCil"> </h5> </li>
                        <li class="w12-8"> <h5 id="odPertoEixo"> </h5> </li>
                        <li class="w12-8"> <h5 id="odPertoPris"> </h5> </li>
                        <li class="w12-8"> <h5 id="odPertoBase"> </h5> </li>
                        <li class="w12-8"> <h5 id="odPertoDNP"> </h5> </li>
                    </ul>
                </div>

                <!--olho esquerdo-->
                <div class="col w49-3 linel lineb liner float-r" style="margin-top: -110px;">
                    <ul class="list-col txt-ac">
                        <li class="w10"> <h5 class="b linef">O.E.</h5> </li>
                        <li class="w12-8 lineb"> <h5> Adc. </h5> </li>
                        <li class="w12-8 lineb"> <h5> Esf. </h5> </li>
                        <li class="w12-8 lineb"> <h5> Cil. </h5> </li>
                        <li class="w12-8 lineb"> <h5> Eixo </h5> </li>
                        <li class="w12-8 lineb"> <h5> Pris. </h5> </li>
                        <li class="w12-8 lineb"> <h5> Base </h5> </li>
                        <li class="w12-8 lineb"> <h5> DNP  </h5> </li>
                    </ul>

                    <ul class="list-col txt-ac linhaEsquerdoLonge">
                        <li class="w10"> <h5 class="txt-al"> Longe </h5> </li>
                        <li class="w12-8"> <h5>.</h5> </li>
                        <li class="w12-8"> <h5 id="oeLongeEsf"> </h5> </li>
                        <li class="w12-8"> <h5 id="oeLongeCil"> </h5> </li>
                        <li class="w12-8"> <h5 id="oeLongeEixo"> </h5> </li>
                        <li class="w12-8"> <h5 id="oeLongePris"> </h5> </li>
                        <li class="w12-8"> <h5 id="oeLongeBase"> </h5> </li>
                        <li class="w12-8"> <h5 id="oeLongeDNP"> </h5> </li>
                    </ul>

                    <ul class="medio list-col txt-ac linhaEsquerdoMedio">
                        <li class="w10"> <h5 class="txt-al"> Medio </h5> </li>
                        <li class="w12-8 "> <h5 id="oeMedioAdc"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oeMedioEsf"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oeMedioCil"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oeMedioEixo"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oeMedioPris"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oeMedioBase"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oeMedioDNP"> </h5> </li>
                    </ul>

                    <ul class="perto list-col txt-ac linhaEsquerdoPerto">
                        <li class="w10"> <h5 class="txt-al"> Perto </h5> </li>
                        <li class="w12-8 "> <h5 id="oePertoAdc"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oePertoEsf"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oePertoCil"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oePertoEixo"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oePertoPris"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oePertoBase"> </h5> </li>
                        <li class="w12-8 "> <h5 id="oePertoDNP"> </h5> </li>
                    </ul>
                </div>
            </div>

            <!--observação-->
            <div class="row w100 linef pf10 mb15" style="height: 140px">
                <h3><span class="row w100 lineb b">Observação:</span></br> <span class="ml2" id="observacao"></span></h3>
            </div>

            <!--optometrista-->
            <div class="row w100" style="padding: 4cm 0 4cm 0;">
                <h5 class="float-r w48 linet pt03 txt-ac">Ass. especialista<span id="nomeMedico"></span></h5>
            </div>

            <!--frase alerta-->
            <div class="row w100">
            	<h4 class="txt-ac">
            		O estabelecimento comercial para a aquisição dos óculos é de livre escolha do usuário.<br>
					É importante trazer os seus óculos para conferência.
				</h4>
            </div>

		</div>
	
		<script>
			$(document).ready(function(){
				var cod = getParameterByName("CodigoDocumento");
				var banco = getParameterByName("BancoDeDados");
				var url = decodeURIComponent(getParameterByName("URLServidor"));
				var usuario = getParameterByName("CodigoUsuario");
				var codPrescricao = "";
				var CodigoDocumento = "";
						
				if(getParameterByName("codPrescricao").length == 0 && getParameterByName("codigoDocumento").length > 0){
					CodigoDocumento = getParameterByName("codigoDocumento");
					codPrescricao = GeeksSQL("SELECT * from DocumentoItem where CodigoDocumento = 0" + getParameterByName("CodigoDocumentoAdicional"), false, url, banco, usuario);
					codPrescricao = codPrescricao.Records[0].CodigoDocumentoAdicional;
				}else{
					codPrescricao = getParameterByName("codPrescricao");
					CodigoDocumento = GeeksSQL("SELECT DISTINCT CodigoDocumento from DocumentoItem where CodigoDocumentoAdicional = 0" + codPrescricao, false, url, banco, usuario).Records[0].CodigoDocumento;
				}
				

						
    			//Dados da Loja	
    				var oculto = getParameterByName("Oculto");
    				var dadosEmissor = GeeksSQL("select C.Nome, C.[Site], C.Email, CT.Telefone, IsNull((CE.Logradouro + ' ' + CE.Numero + ', '  + CE.Bairro + ' - ' + CE.Municipio + '/' + CE.UF + ' ' + CE.CEP), '') as Endereco, IsNull(C.Imagem, 'Não informado') Imagem from Contato C left join ContatoTelefone CT on CT.CodigoContato = C.CodigoContato and CT.TipoTelefone = 'Principal' left join ContatoEndereco CE on CE.CodigoContato = C.CodigoContato and CE.Grupo = 'Principal' where C.CodigoContato = (select CodigoEmpresa from Documento where CodigoDocumento = 0" + CodigoDocumento + ")", false, url, banco, usuario);

    			//Dados Emissor
    				$("#fantasiaEmissor").html(dadosEmissor.Records[0].Nome);
    				$("#emailEmissor").html(dadosEmissor.Records[0].Email);
    				$("#enderecoEmissor").html(dadosEmissor.Records[0].Endereco);
    				$("#siteEmissor").html(dadosEmissor.Records[0].Site);
    				$("#telefoneEmissor").html(dadosEmissor.Records[0].Telefone);
		
    			//Dados do Medico 
    			try {
    			
    				var dadosMedicoPaciente = GeeksSQL("select d.CodigoDocumento, DescricaoContato Paciente, d.CodigoContato CodigoContato, IsNull((Select Nome from Contato where CodigoContato = dc.CodigoContato),'Não informado') DescricaoMedico, isnull(d.DescricaoContatoEndereco, '') Endereco, isnull(d.DescricaoContatoEnderecoEntrega, '') EnderecoEntrega, isnull(d.TelefoneContato, '') Telefone, isnull(Convert(varchar(10), d.DataHoraEmissao, 103), '') DataPrevista, isnull(Convert(varchar(10), d.DataHoraFinalizado, 103), '') as DataValidade, d.Observacao from Documento d left join DocumentoContato dc on d.CodigoDocumento = dc.CodigoDocumento and dc.Descricao = 'Medico' where d.CodigoDocumento = 0" + codPrescricao, false, url, banco, usuario).Records[0];

                        var dadosPaciente = GeeksSQL("SELECT (CASE WHEN( (Month(DataAbertura)) < (Month(GetDate())) ) THEN( Year(GetDate()) - Year(DataAbertura) ) ELSE( (Year(GetDate()) - Year(DataAbertura)) -1 ) END) AS Idade FROM Contato WHERE CodigoContato = 0"+dadosMedicoPaciente.CodigoContato, false, url, banco, usuario).Records[0];
                        console.log('codigo cliente')
                        console.log()

    				
    					if(dadosMedicoPaciente.CodigoContato != undefined && dadosMedicoPaciente.CodigoContato > 0) {
    									
    				//Dados do Cliente
    					$("#CodigoContato").html(Number(dadosMedicoPaciente.CodigoContato));
    					$("#nomePaciente").html(dadosMedicoPaciente.Paciente);
                        $("#idadePaciente").html(dadosPaciente.Idade);
    					
    					if(dadosMedicoPaciente.Endereco && dadosMedicoPaciente.Endereco.length > 0)
    					{				
    						$("#enderecoPaciente").html(dadosMedicoPaciente.Endereco);
    					}else{
    						$("#enderecoPaciente").html(dadosMedicoPaciente.EnderecoEntrega);
    					}				

    					$("#telefonePaciente").html(dadosMedicoPaciente.Telefone); 
    					$("#nomeMedico").html(dadosMedicoPaciente.DescricaoMedico);
    					
    					
    						$("#dataPrevista").html(dadosMedicoPaciente.DataPrevista == '01/01/1900' ? " " : dadosMedicoPaciente.DataPrevista);
    						$("#dataValidade").html(dadosMedicoPaciente.DataValidade == '01/01/1900' ? " " : dadosMedicoPaciente.DataValidade);
    						$("#observacao").html(dadosMedicoPaciente.Observacao);
    					}
    				}
    			catch(err) {
    						
    						$("#observacao").html(err.message);
    						$("#nomeMedico").html("Não encontrado.");
    						}
			
    			//Informações da Receita
    			
                var OdLonge = GeeksSQL("Select Esferico, Cilindrico, Eixo, Prisma, Base, DIOD, DIOE from DocumentoItem where CodigoDocumento = 0" + codPrescricao + " and TipoItem = 'Prescrição' and Operacao = 'Olho Direito' and [Status] = 'Longe'", false, url, banco, usuario).Records[0];

                var OdMedio = GeeksSQL("Select Adicao, Esferico, Cilindrico, Eixo, Prisma, Base, DIOD, DIOE from DocumentoItem where CodigoDocumento = 0" + codPrescricao + " and TipoItem = 'Prescrição' and Operacao = 'Olho Direito' and [Status] = 'Medio'", false, url, banco, usuario).Records[0];

                var OdPerto = GeeksSQL("Select Adicao, Esferico, Cilindrico, Eixo, Prisma, Base, DIOD, DIOE from DocumentoItem where CodigoDocumento = 0" + codPrescricao + " and TipoItem = 'Prescrição' and Operacao = 'Olho Direito' and [Status] = 'Perto'", false, url, banco, usuario).Records[0];

                var OeLonge = GeeksSQL("Select Esferico, Cilindrico, Eixo, Prisma, Base from DocumentoItem where CodigoDocumento = 0" + codPrescricao + " and TipoItem = 'Prescrição' and Operacao = 'Olho Esquerdo' and [Status] = 'Longe'", false, url, banco, usuario).Records[0];

                var OeMedio = GeeksSQL("Select Adicao, Esferico, Cilindrico, Eixo, Prisma, Base from DocumentoItem where CodigoDocumento = 0"+ codPrescricao + " and TipoItem = 'Prescrição' and Operacao = 'Olho Esquerdo' and [Status] = 'Medio'", false, url, banco, usuario).Records[0];

                var OePerto = GeeksSQL("Select Adicao, Esferico, Cilindrico, Eixo, Prisma, Base from DocumentoItem where CodigoDocumento = 0" + codPrescricao + " and TipoItem = 'Prescrição' and Operacao = 'Olho Esquerdo' and [Status] = 'Perto'", false, url, banco, usuario).Records[0];
    			
    			// Longe

                $("#oeLongeEsf").html(Number(OeLonge.Esferico).toFixed(2).replace(".", ","));
                $("#oeLongeCil").html(Number(OeLonge.Cilindrico).toFixed(2).replace(".", ","));
                $("#oeLongeEixo").html(OeLonge.Eixo);
                $("#oeLongePris").html(OeLonge.Prisma);
                $("#oeLongeBase").html(OeLonge.Base);
                $("#oeLongeDNP").html(Number(OdLonge.DIOE).toFixed(2).replace(".", ","));

                $("#odLongeEsf").html(Number(OdLonge.Esferico).toFixed(2).replace(".", ","));
                $("#odLongeCil").html(Number(OdLonge.Cilindrico).toFixed(2).replace(".", ","));
                $("#odLongeEixo").html(OdLonge.Eixo);
                $("#odLongePris").html(OdLonge.Prisma);
                $("#odLongeBase").html(OdLonge.Base);
                $("#odLongeDNP").html(Number(OdLonge.DIOD).toFixed(2).replace(".", ","));

    			$("#eixoEsquerdo").kendoRadialGauge({
    				pointer: {
    					value: OeLonge.Eixo,
    					color: "#c20000",
    					cap: { size: 0.03 }
    				},
    				scale: {
    					minorUnit: 5,
    					minorTicks : { width: 2 },
    					majorUnit: 10,
    					majorTicks : { width: 2 },
    					startAngle: 180,
    					endAngle: 0,
    					max: 180,
    					labels: {
    					  position: "outinside",
    					  template: "#= ((value%30) == 0 ? value : '' )#" 
    					}
    				},
    			});	

    			$("#eixoDireito").kendoRadialGauge({
    				pointer: {
    					value: OdLonge.Eixo,
    					color: "#c20000",
    					cap: { size: 0.03 }
    				},
    				scale: {
    					minorUnit: 5,
    					minorTicks : { width: 2 },
    					majorUnit: 10,
    					majorTicks : { width: 2 },
    					startAngle: 180,
    					endAngle: 0,
    					max: 180,
    					labels: {
    					  position: "outinside",
    					  template: "#= ((value%30) == 0 ? value : '' )#"
    					}
    				},
    			});				
                // Médio

                $("#odMedioAdc").html(Number(OdMedio.Adicao).toFixed(2).replace(".", ","));
                $("#odMedioEsf").html(Number(OdMedio.Esferico).toFixed(2).replace(".", ","));
                $("#odMedioCil").html(Number(OdMedio.Cilindrico).toFixed(2).replace(".", ","));
                $("#odMedioEixo").html(OdMedio.Eixo);
                $("#odMedioPris").html(OdMedio.Prisma);
                $("#odMedioBase").html(OdMedio.Base);
                $("#odMedioDNP").html(Number(OdMedio.DIOD).toFixed(2).replace(".", ","));

                $("#oeMedioAdc").html(Number(OeMedio.Adicao).toFixed(2).replace(".", ","));
                $("#oeMedioEsf").html(Number(OeMedio.Esferico).toFixed(2).replace(".", ","));
                $("#oeMedioCil").html(Number(OeMedio.Cilindrico).toFixed(2).replace(".", ","));
                $("#oeMedioEixo").html(OeMedio.Eixo);
                $("#oeMedioPris").html(OeMedio.Prisma);
                $("#oeMedioBase").html(OeMedio.Base);
                $("#oeMedioDNP").html(Number(OdMedio.DIOE).toFixed(2).replace(".", ","));

                // Perto

                $("#odPertoAdc").html(Number(OdPerto.Adicao).toFixed(2).replace(".", ","));
                $("#odPertoEsf").html(Number(OdPerto.Esferico).toFixed(2).replace(".", ","));
                $("#odPertoCil").html(Number(OdPerto.Cilindrico).toFixed(2).replace(".", ","));
                $("#odPertoEixo").html(OdPerto.Eixo);
                $("#odPertoPris").html(OdPerto.Prisma);
                $("#odPertoBase").html(OdPerto.Base);
                $("#odPertoDNP").html(Number(OdPerto.DIOD).toFixed(2).replace(".", ","));

                $("#oePertoAdc").html(Number(OePerto.Adicao).toFixed(2).replace(".", ","));
                $("#oePertoEsf").html(Number(OePerto.Esferico).toFixed(2).replace(".", ","));
                $("#oePertoCil").html(Number(OePerto.Cilindrico).toFixed(2).replace(".", ","));
                $("#oePertoEixo").html(OePerto.Eixo);
                $("#oePertoPris").html(OePerto.Prisma);
                $("#oePertoBase").html(OePerto.Base);
                $("#oePertoDNP").html(Number(OdPerto.DIOE).toFixed(2).replace(".", ","));      


    			//Oculta campos se vazio
    			if(OdMedio.Adicao == 0 || OeMedio.Adicao == 0 ){
    			$('.medio').hide();
    			}
    			
    			if(OdPerto.Adicao == 0 || OePerto.Adicao == 0){
    			$('.perto').hide();
    			}

                //Logo
                if (dadosEmissor.Records[0].Imagem != "Não informado")
                    $(".logo").each(function() {
                        $( this ).html('<img style="width: auto; height: 100%;" class="img-responsive" src="' + dadosEmissor.Records[0].Imagem.split("#")[0] + '" />');
                });
    	});
    	</script>

	</body>	

</html>