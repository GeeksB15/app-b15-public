<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Crediário Renegociação</title>
        <link rel="stylesheet" type="text/css" href="optidados.framework.css"/>
        <script src="/Scripts/jquery-2.1.4.js"></script>
        <script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
        <script src="/Scripts/codigobarras.js"></script>
        <script src="/Plugins/html2canvas.js"></script>

        <style type="text/css">
            h1, h2, h3, h4, h5, h6, p {
                white-space: nowrap;
            }
        
            .botao-apagar-parte {
                position: relative;
                float: left;
                background-color: #E64949;
                box-shadow: 2px 2px 2px grey;
                padding: 10px;
                border-radius: 5px;
                color: #FFF;
                width: 200px;
                height: 20px;
                margin-top: 4px;
                margin-bottom: 25px;
                text-align: center;
                cursor: pointer;
            }
        
            .botao-apagar-parte:hover {
                background-color: #5BBDBC;
            }
        </style>

        <style type="text/css" media="print">
            @page {
                margin-top: 0.25cm;
                margin-left: 0.25cm;
            }

            .botao-apagar-parte {
                display: none;
            }
        </style>
        
        <script type="linhaHistoricoParcelas" id="linhaHistoricoParcelas">
        	<div class="row w100">
                <div class="col w14 txt-ac linel lineb liner mb02 mr02"> <p>[parcela]</p> </div>
                <div class="col w15 txt-ac linel lineb liner mb02 mr02"> <p>[dataVencimento]</p> </div>
                <div class="col w12 txt-ar linel lineb liner mb02 mr02"> <p>[valorParcela]</p> </div>
                <div class="col w12 txt-ar linel lineb liner mb02 mr02"> <p>[multaJuros]</p> </div>
                <div class="col w12 txt-ar linel lineb liner mb02 mr02"> <p>[desconto]</p> </div>
                <div class="col w12 txt-ar linel lineb liner mb02 mr02"> <p>[valorPago]</p> </div>
                <div class="col w17-9 txt-ac linel lineb liner mb02"> <p>[dataPagamento]</p> </div>
            </div>
        </script>

        <script type="carne" id="carne">
            <div class="row pf04 mb08 linef" style='page-break-inside: avoid !important;' id="zzzzzidDoCarnezzzzz">
                
                <div class="col pf02 liner" style="width: 7cm; height: 6.9cm;">
                    <div class="row w100 lineb">
                        <div style="height: 2cm;">
                            <div class="logo">
                                <img class="img-responsive logo-loja" src="optsoul-exemplo.png" />
                            </div>
                        </div>
                        <h6 class="hidden nomeLoja">- </h6>
                        <h6 class="hidden enderecoLoja" style="white-space: normal;">-</h6>
                        <h6 class="hidden cidadeCepLoja">-</h6>
                        <h6 class="hidden telefoneLoja">-</h6>
                        <h6 class="hidden emailLoja">-</h6>
                        <h6 class="hidden siteLoja">-</h6>
                    </div>

                    <div class="row w100">
                        <h6 class="nomeCliente">-</h6>

                        <p>Data compra: <span>[dataCompra]</span></p>
                        <p>Venc. parcela: <span>[dataVencimentoParcela]</span></p>

                        <p><span>Parcelas: <span>[totalParcelas]</span></span> <span class="float-r">Nº Parcela: <span>[numeroParcela]</span></span></p>

                        <p>Valor total da compra: <span>R$ [valorTotalCompra]</span></p>
                        <!--<h6>Outras formas pgto.: <span>R$ [valorOutros]</span></h6>-->

                        <p>Valor da parcela: <span>R$ [valorParcela]</span></p>

                        <p><span>[valorMultaJuros]</span> <span>[valorDesconto]</span></p>
                    </div>
                </div>

                <div class="col pt02 pr02 pb02 pl10" style="width:11.2cm; height:6.9cm;">
                    <div class="row w100 lineb">
                        <div style="height: 2cm;">
                            <div class="logo">
                                <img class="img-responsive logo-loja" src="optsoul-exemplo.png"/>
                            </div>
                        </div>

                        <div class="col w70">
                            <h6 class="nomeLoja">-</h6>
                            <h6 class="enderecoLoja" style="white-space: normal;">-</h6>
                            <h6 class="cidadeCepLoja">-</h6>
                            <h6 class="telefoneLoja">-</h6>
                            <h6 class="emailLoja">-</h6>
                            <h6 class="siteLoja">-</h6>
                        </div>

                        <div class="col w30">
                            <h6>[codParcela]</h6>
                            <h6 style="height: 0.80cm;" id="[codigoBarrasN]">-</h6>
                        </div>
                    </div>

                    <div class="col w60">
                        <h6 class="nomeCliente">-</h6>
                        <h6>Parcelas: <span>[totalParcelas]</span></h6>
                        <h6>Valor total da compra: <span>R$ [valorTotalCompra]</span></h6>
                        <!--<h6>Outras formas pgto.: <span>R$ [valorOutros]</span></h6>-->
                        <h6>[valorMultaJuros]</h6>
                    </div>

                    <div class="col w40">
                        <h6 class="telefoneCliente">-</h6>
                        <h6>Venc. parcela: <span>[dataVencimentoParcela]</span></h6>
                        <h6>Nº Parcela: <span>[numeroParcela]</span></h6>
                        <h6>Valor da parcela: <span>R$ [valorParcela]</span></h6>
                        <h6>[valorDesconto]</h6>
                    </div>
                </div>

            </div>
        </script>

        <script type="notaPromissoria" id="notaPromissoria">
            <div class="row w100 pf04 linef" style='page-break-inside: avoid !important;' id="zzzzzidDoCarnezzzzz">
                <div class="row w100 txt-ac mb03">
                    <h5 class="linel lineb liner">Nota Promissória</h5>
                </div>

                <div class="row w100 lineb mb03">
                    <div class="col w33"> <h6>Nº Parcela: <span>[numeroParcela]</span></h6> </div>
                    <div class="col w33 txt-ac"> <h6>Vencimento Parcela: <span>[vencimentoParcela]</span></h6> </div>
                    <div class="col w33 txt-ac"> <h6>[codigoParcela]</h6> </div>
                </div>

                <div class="row w100 mb03">
                    <p style="white-space: normal;">
                        Ao(s) <span>[dataExtenso]</span> pagarei por esta única via de NOTA PROMISSÓRIA a <span>[nomeEmpresa]</span>, CNPJ: <span>[cnpjEmpresa]</span>, ou a sua ordem, o valor de [valorNumerico] (<span>[valorExtenso]</span>) em moeda corrente deste país, pagável na praça de [cidadeEmpresa].
                    </p>
                </div>

                <div class="row w100 mb2">
                    <h6>Emitente: <span>[nomeCliente]</span></h6>
                    <h6>CPF: <span>[cpfCliente]</span></h6>
                    <h6>End: <span>[enderecoCliente]</span></h6>
                </div>

                <div class="row w100 mb03">
                    <div class="col w50 txt-ac"> <h6>Data da impressão: [dataImpressao]</h6> </div>
                    <div class="col w50 linet txt-ac"> <p>Assinatura</p> </div>
                </div>
            </div>
        </script>
    </head>

    <body>
        <!--Container-->
        <div class="container">

            <!-- Histórico de parcelas pagas -->
            <div class="row w100 pf04 linef mb1" id="tabelaHistoricoParcelas">
                <div class="row w100">
                    <h5><span class="codigoCliente">- </span> <span class="nomeCliente">Carregando carnês...</span></h5>
                    <h6 class="enderecoCliente">-</h6>
                    <h6> <span class="w50">Tel: <span class="telefoneCliente">-</span></span> <span class="w50">Email: <span class="emailCliente">-</span></span></h6>
                </div>

                <div class="row w100">
                    <div class="col txt-ac w14 linef mb02 mr02"> <h6 class="b7">Parcelas</h6> </div>
                    <div class="col txt-ac w15 linef mb02 mr02"> <h6 class="b7">Data Venc.</h6> </div>
                    <div class="col txt-ac w12 linef mb02 mr02"> <h6 class="b7">Valor Parc. (R$)</h6> </div>
                    <div class="col txt-ac w12 linef mb02 mr02"> <h6 class="b7">Multa/Juros (R$)</h6> </div>
                    <div class="col txt-ac w12 linef mb02 mr02"> <h6 class="b7">Desconto (R$)</h6> </div>
                    <div class="col txt-ac w12 linef mb02 mr02"> <h6 class="b7">Valor Pago (R$)</h6> </div>
                    <div class="col txt-ac w17-9 linef mb02"> <h6 class="b7">Data do pagamento</h6> </div>
                </div>
            </div>

            <!--Nostas promissórias-->
            <div class="row w100">
                <div id="notasPromissorias"></div>
            </div>

            <!--Carnês (serão inseridos aqui embaixo)-->
            <div class="row w100">
                <!--quebra de pagina-->
                <h1 style="page-break-after: always; opacity: 0;">Quebra paina</h1>
                <div id="carneContent"></div>
            </div>
            
        </div><!--.end Container-->
        
        <script type="text/javascript">

            //Não quero imprimir isso!
            function apagar(id){
                $("#" + id.replace("b", "")).remove();
                $("#" + id).remove();
            }

            //Print Dados In HTML
            $(document).ready(function()
            {             
            	// GeeksSQL("", false, url, banco, usuario);

            	var NumeroCarne = getParameterByName("NumeroCarne");

                var banco = getParameterByName("BancoDeDados");
                var url = decodeURIComponent(getParameterByName("URLServidor"));
                var usuario = getParameterByName("CodigoUsuario");

                var ImprimePagos = getParameterByName("ImprimePagos");
                var ImprimeNotaPromissoria = getParameterByName("ImprimeNP");

                var DadosFatura = GeeksSQL("SELECT Convert(varchar(10), getDate(), 103) Agora, FT.CodigoFinanceiroTitulo, Convert(varchar(10), FT.DataVencimento, 103) DataVencimento, Convert(varchar(10), FT.DataEmissao, 103) DataRenegociacao, IsNull(Convert(varchar(10), FT.DataPagamento, 103), '-') DataPagamento, FT.Valor, FT.ValorRealizado, FT.ValorTotalJuros, FT.ValorDesconto, FT.Parcela, FT.ValorMulta, FT.ValorMulta + FT.ValorTotalJuros MultaJuros, C.CodigoContato CodigoCliente, C.Nome NomeCliente, IsNull(C.NumeroDocumentoNacional, '') CNPJCliente, IsNull(C.Email, '') EmailCliente, IsNull(CE.Logradouro, '') + ', ' + IsNull(CE.Numero, 's/n') + ' ' + IsNull(CE.Complemento, '') +', ' + IsNull(CE.Bairro, '') + ' - ' + IsNull(CE.Municipio, '') +'/'+ IsNull(CE.UF, '') + ' ' + IsNull(CE.CEP, '')  EnderecoCliente, IsNull(CT.Telefone, '') TelefoneCliente, E.CodigoContato CodigoEmpresa, IsNull(E.Imagem, '-') Imagem, E.Nome NomeEmpresa, IsNull(E.NumeroDocumentoNacional, '') CNPJEmpresa, IsNull(E.Email, '') EmailEmpresa, IsNull(E.[Site], '-') SiteEmpresa, IsNull(EE.Logradouro, '') + ', ' + IsNull(EE.Numero, 's/n') EnderecoEmpresa, IsNull(EE.Municipio + ' / ' + EE.UF + ' ' + EE.CEP, '') CidadeEmpresa, IsNull(ET.Telefone, '') TelefoneEmpresa, IsNull(EE.Municipio, '(cidade não informada no cadastro do emitente)') Praca FROM FinanceiroTitulo FT inner join Contato E on E.CodigoContato = FT.CodigoEmpresa inner join Contato C on C.CodigoContato = FT.CodigoContato left join ContatoEndereco EE on EE.CodigoContato = E.CodigoContato and EE.Grupo = 'Principal' left join ContatoEndereco CE on CE.CodigoContato = C.CodigoContato and CE.Grupo = 'Principal' left join ContatoTelefone ET on ET.CodigoContato = E.CodigoContato and ET.TipoTelefone = 'Principal' left join ContatoTelefone CT on CT.CodigoContato = C.CodigoContato and CT.TipoTelefone = 'Principal' WHERE FT.CodigoFinanceiroTitulo in (select CodigoFinanceiroTitulo from FinanceiroCarneTitulo where Numero = " + NumeroCarne + ") ORDER BY Cast(DataVencimento AS DateTime)", false, url, banco, usuario);

                var numeroLinhaDocumento = 0;

                var TotalDocumento = 0;

                $(DadosFatura.Records).each(function(index, row){
                    TotalDocumento += row.Valor;
                });

                $(DadosFatura.Records).each(function(index, row) {

                	if (row.DataPagamento == '-' && ImprimeNotaPromissoria == "1") { // Notas promissórias para parcelas não pagas

                	numeroLinhaDocumento++;

                		var textoExtensoData = "";
                		var dataVencimentoCompleto = row.DataVencimento.split(' ');
                		var dataVencimento = dataVencimentoCompleto[0].split('/');

                		textoExtensoData = getExtensive(dataVencimento[0]) + " de " + getMonth(dataVencimento[1]) + " de " + getExtensive(dataVencimento[2]);
                		var textoExtensoValor = getExtensive(String(row.Valor), true);

                		$("#notasPromissorias").append(

                			$("#notaPromissoria").html()
                				.replaceAll("[numeroParcela]", row.Parcela)
    							.replaceAll("[vencimentoParcela]", row.DataVencimento)
    							.replaceAll("[codigoParcela]", "Cód.: " + row.CodigoFinanceiroTitulo)
    							.replaceAll("[dataExtenso]", textoExtensoData)
    							.replaceAll("[nomeEmpresa]", row.NomeEmpresa)
                                .replaceAll("[cnpjEmpresa]", row.CNPJEmpresa)
                                .replaceAll("[cidadeEmpresa]", row.Praca)
    							.replaceAll("[valorExtenso]", textoExtensoValor)
    							.replaceAll("[valorNumerico]", "R$ " + row.Valor.toFixed(2).replaceAll(".", ","))
    							.replaceAll("[nomeCliente]", row.NomeCliente)
    							.replaceAll("[cpfCliente]", row.CNPJCliente)
    							.replaceAll("[enderecoCliente]", row.EnderecoCliente)
    							.replaceAll("[dataImpressao]", row.Agora)
    							.replaceAll("zzzzzidDoCarnezzzzz", "linha" + numeroLinhaDocumento)
                		);

                		$("#notasPromissorias").append("<div class='botao-apagar-parte' id='blinha" + numeroLinhaDocumento + "' onclick='apagar(this.id)'>Não quero imprimir isso! ⤴</div>");

                	}
    				
                	$("#tabelaHistoricoParcelas").append(

                		$("#linhaHistoricoParcelas").html()
                			.replaceAll("[parcela]", row.Parcela)
                			.replaceAll("[dataVencimento]", row.DataVencimento)
                			.replaceAll("[valorParcela]", (row.Valor == 0.0000 ? '.' : row.Valor.toFixed(2).replaceAll(".", ",")))
                			.replaceAll("[multaJuros]", (row.MultaJuros == 0.0000 ? '.' : row.MultaJuros.toFixed(2).replaceAll(".", ",")))
                			.replaceAll("[desconto]", (row.ValorDesconto == 0.0000 ? '.' : row.ValorDesconto.toFixed(2).replaceAll(".", ",")))
                			.replaceAll("[valorPago]", (row.ValorRealizado == 0.0000 ? '.' : row.ValorRealizado.toFixed(2).replaceAll(".", ",")))
                			.replaceAll("[dataPagamento]", row.DataPagamento)
                	);

                	if (row.DataPagamento == "" || ImprimePagos == "1") {

                		numeroLinhaDocumento++;

                		var totalParcelas = row.Parcela.split("/");

                		$("#carneContent").append(

                			$("#carne").html()
                				.replaceAll("[dataCompra]", row.DataRenegociacao)
                				.replaceAll("[dataVencimentoParcela]", row.DataVencimento)
                				.replaceAll("[totalParcelas]", totalParcelas[1])
                				.replaceAll("[numeroParcela]", row.Parcela)
                				.replaceAll("[valorTotalCompra]", TotalDocumento.toFixed(2).replaceAll(".", ","))
                				.replaceAll("[valorParcela]", row.Valor.toFixed(2).replaceAll(".", ","))
                				.replaceAll("[valorMultaJuros]", row.MultaJuros == 0 ? "&nbsp;" : "Multa/Juros: <span>R$ " + row.MultaJuros.toFixed(2).replaceAll(".", ",") + "</span>")
                				.replaceAll("[valorDesconto]", row.ValorDesconto == 0 ? "&nbsp;" : "Desconto: <span>R$ "+ row.ValorDesconto.toFixed(2).replaceAll(".", ",") + "</span>")
                				.replaceAll("[codParcela]", "Parcela Cód.: " + row.CodigoFinanceiroTitulo)
                				.replaceAll("[codigoBarrasN]", "codigoBarras" + index)
                				.replaceAll("[textoRecebimento]", row.DataPagamento == "" ? "<p>Autenticação ou Carimbo<br> de Recebimento</p>" : "<p><span style='font-size:20pt'>PAGO</span><br>" + row.DataPagamento + "</p>")            				
    							.replaceAll("zzzzzidDoCarnezzzzz", "linha" + numeroLinhaDocumento)

                		);

                		$("#carneContent").append("<div class='botao-apagar-parte' id='blinha" + numeroLinhaDocumento + "' onclick='apagar(this.id)'>Não quero imprimir isso! ⤴</div>");

                		var numero = String(row.CodigoFinanceiroTitulo);
    					var zeros = 13 - Number(numero.length);

    					for (var i = 0; i < zeros; i++) 
    						numero = '0' + numero;

    					$("#codigoBarras" + index).css("white-space", "nowrap");
    					$("#codigoBarras" + index).css("background-color", "#fff");

    					$("#codigoBarras" + index).html(fbarcode(numero));

    					var bc = document.getElementById("codigoBarras" + index);
    					html2canvas(bc, {
    					  onrendered: function(canvas) {
    						var img = canvas.toDataURL("image/jpeg");
    							$("#codigoBarras" + index).html("");
    							$("#codigoBarras" + index).append('<img src="' + img + '"></img>');
    					    }
    					});

                	}

                });

                $(".nomeCliente").html(DadosFatura.Records[0].NomeCliente);
                $(".codigoCliente").html("Cliente Cód.: " + DadosFatura.Records[0].CodigoCliente);
                $(".enderecoCliente").html(DadosFatura.Records[0].EnderecoCliente);
                $(".telefoneCliente").html(DadosFatura.Records[0].TelefoneCliente);
                $(".emailCliente").html(DadosFatura.Records[0].EmailCliente);
                $(".nomeLoja").html(DadosFatura.Records[0].NomeEmpresa);
                $(".enderecoLoja").html(DadosFatura.Records[0].EnderecoEmpresa);
                $(".cidadeCepLoja").html(DadosFatura.Records[0].CidadeEmpresa);
                $(".telefoneLoja").html(DadosFatura.Records[0].TelefoneEmpresa);
                $(".emailLoja").html(DadosFatura.Records[0].EmailEmpresa);
                $(".siteLoja").html(DadosFatura.Records[0].SiteEmpresa);

                if (DadosFatura.Records[0].Imagem != "-")
                    $(".logo").each(function()
                    {
                        $( this ).html('<img class="img-responsive" src="' + DadosFatura.Records[0].Imagem.split("#")[0] + '" />');
                    });

                //Botão não que imprimir isso do contrato
                $("#btContrato").click(function () {
                    $("#TabHistoricoParcelasExcluir").remove();
                }); 
            });

        </script>

    </body>
</html>