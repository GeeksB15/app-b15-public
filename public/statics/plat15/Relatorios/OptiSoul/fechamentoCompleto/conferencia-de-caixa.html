<!DOCTYPE HTML>
<html lang="pt-br">
  <head>
    <meta charset="utf-8"/>
    <title>Conferência de Caixa</title>
    <link rel="stylesheet" type="text/css" href="../optidados.framework.css"/>    
    <script src="/Scripts/jquery-2.1.4.js"></script>
    <script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
    <script src="/Scripts/codigobarras.js"></script>
    <script src="/Plugins/html2canvas.js"></script>

    <style type="text/css" media="print">
      @page {
        margin-top: 5mm;
        margin-right: 6mm;
        margin-bottom: 5mm;
        margin-left: 6mm;
      }
    </style>

    <script type="linhaResumoVendas" id="linhaResumoVendas">
      <h4 class="col w36">[nomeVendedor]</h4>
      <h4 class="col w16 txt-ar">[valorVendido]</h4>
      <h4 class="col w16 txt-ar">[numeroVendas]</h4>
      <h4 class="col w16 txt-ar">[numeroPecas]</h4>
      <h4 class="col w16 txt-ar">[ticketMedio]</h4>
    </script>

    <script type="linha2Colunas" id="linha2Colunas">
    	<h4>[descricao]<span class="float-right">[valor]</span></h4>
    </script>

    <script type="linhaVendasDetalhado" id="linhaVendasDetalhado">
	    <div class="row w100">
        [Data]
        [Fatura]
        [Vendedor]
        [Cliente]
        [Parcela]
        [Valor]
	    </div>
    </script>

    <script id="linhaRecebimentosDetalhado" type="linhaRecebimentosDetalhado">
      <div class="row w100">
        [Data]
        [DataEmissao]
        [DataVencimento]
        [Fatura]
        [Cliente]
        [Valor]
      </div>
    </script>
  </head>

  <body>
    <div class="container">

      <div class="row w100 lineb">
        <h1 class="row w100 txt-ac b pf05">Conferência de Caixa</h1>
      </div>

      <!--Abertura de caixa-->
      <div class="row w100 mt2">
        <h4 class="col w33 txt-ac b lineb liner">Caixa</h4>
        <h4 class="col w33 txt-ac b lineb liner">Data Abertura</h4>
        <!--<h4 class="col w24-8 txt-ac b lineb liner">Data Fechamento</h4>-->
        <h4 class="col w33 txt-ac b lineb">Valor Abertura Caixa</h4>

        <h3 id="DescricaoCaixa" class="col w33 txt-ac liner">.</h3>
        <h3 id="DataAbertura" class="col w33 txt-ac liner">.</h3>
        <!--<h3 id="DataFechamento" class="col w24-8 txt-ac liner">.</h3>-->
        <h3 id="ValorAberturaCaixa" class="col w33 txt-ac">.</h3>
      </div>

      <!--Resumo vendas Operadores-->
      <div class="row w100 mt2">
        <h2 class="row w100 b">&#8618; Resumo de vendas por Operadores</h2>

        <div class="row w98 float-r lineb pb02">
          <h4 class="col w36 b">Operador</h4>
          <h4 class="col w16 b txt-ar">Valor Vendido R$</h4>
          <h4 class="col w16 b txt-ar">Nº Vendas</h4>
          <h4 class="col w16 b txt-ar">Nº Itens</h4>
          <h4 class="col w16 b txt-ar">Ticket Médio R$</h4>
        </div>

        <div id="linhasResumoVendas" class="row w98 float-r"></div>

        <div class="row w98 float-r linet pt02">
          <h3 class="col w36 txt-ar b">Total Operadores:</h3>
          <h3 id="somaValorVendido" class="col w16 txt-ar"></h3>
          <h3 id="somaNumeroVendas" class="col w16 txt-ar"></h3>
          <h3 id="somaNumeroPecas" class="col w16 txt-ar" style="margin-right: 16%;"></h3>
        </div>
      </div>

      <!--Resumo Caixa-->
      <div class="row w100 mt2">
        <h2 class="row w100 b">&#8618;Resumo Caixa</h2>

        <div class="row w98 float-r lineb">
          <h4 class="b">Descrição <span class="float-r">Valor R$</span></h4>
        </div>

        <div class="row w98 float-r">
          <h4>Abertura de caixa: <span id="resumoAberturaCaixa" class="float-r b">-</span></h4>
          <!--<h6>Total Vendas (dinheiro): <span class="float-r" id="resumoVendasDinheiro">-</span></h6>-->
          <h4>Total Recebimentos (dinheiro): <span id="resumoRecebimentosDinheiro" class="float-r b">-</span></h4>
          <h4>Total Abastecimentos de Caixa: <span id="resumoAbastecimentosCaixa" class="float-r b">-</span></h4>
          <h4>Total Despesas Simples: <span id="resumoDespesasSimples" class="float-r b">-</span></h4>
          <h4>Total Sangrias: <span id="resumoSangrias" class="float-r b">-</span></h4>

          <h2 class="linet mt02 pt02 b">Fundo de caixa para <span id="amanha"></span> <span id="valorParaAmanha" class="float-r b">-</span></h2>
        </div>
      </div>

      <!--Abastecimentos de caixa-->
      <div class="row w100 mt2">
        <h2 class="row w100 b">&#8618; Abastecimentos de caixa</h2>
        
        <div class="row w98 float-r lineb">
          <h4 class="b">Descrição <span class="float-r b">Valor R$</span></h4>
        </div>

        <div id="linhasAbastecimentoCaixa" class="row w98 float-r"></div>

        <div class="row w98 float-r">
          <h2 class="b">Total: <span id="totalAbastecimentoCaixa" class="float-r b">-</span></h2>
        </div>
      </div>

      <!--Despesas Simples-->
      <div class="row w100 mt2">
        <h2 class="row w100 b">&#8618; Despesas Simples</h2>
        
        <div class="row w98 float-r lineb">
          <h4 class="b">Descrição <span class="float-r b">Valor R$</span></h4>
        </div>

        <div id="linhasDespesaSimples" class="row w98 float-r"></div>

        <div class="row w98 float-r">
          <h2 class="b">Total: <span id="totalDespesaSimples" class="float-r b">-</span></h2>
        </div>
      </div>

      <!--Sangrias-->
      <div class="row w100 mt2">
        <h2 class="row w100 b">&#8618; Sangrias</h2>

        <div class="row w98 float-r lineb">
          <h4 class="b">Descrição <span class="float-r b">Valor R$</span></h4>
        </div>

        <div id="linhasSangria" class="row w98 float-r"></div>

        <div class="row w98 float-r">
          <h2 class="b">Total: <span id="totalSangria" class="float-r b">-</span></h2>
        </div>
      </div>

      <!--Detalhamento-->
      <div id="tblDetalhamentoVendas" class="row w100 mt2">
        <h1 class="row w100 b lineb">&#8618; Detalhamento</h1>

        <div class="row w98 float-r">
          <h2 class="row w100 b lineb">&#8618; Vendas</h2>
          <div id="linhasVendasDetalhado" class="row w98 float-r"></div>  
        </div>
        <div class="row w98 float-r linet">
          <h2 class="b">Total Vendas: <span id="totalVendasDetalhado" class="float-r b">-</span></h2>
        </div>
        
        <div class="row w98 float-r mt25">
          <h2 class="row w100 b lineb">&#8618; Recebimentos</h2>
          <div id="linhasRecebimentosDetalhado" class="row w98 float-r"></div>
        </div>
        <div class="row w98 float-r linet">
          <h2 class="b">Total Recebimentos: <span id="totalRecebimentosDetalhado" class="float-r b">-</span></h2>
        </div>
      </div>

    </div><!--container-->

    <script>
        $(document).ready(function() {

            //Connect DB
            var banco = getParameterByName("BancoDeDados");
            var url = decodeURIComponent(getParameterByName("URLServidor"));
            var usuario = getParameterByName("CodigoUsuario");

            //Get Filter's
            var CodigoDocumento = getParameterByName("CodigoDocumento");
            var ImprimeDetalhamento = getParameterByName("Detalhamento");

            //Executa SQL
            function ExecSQL(sql) {
              return GeeksSQL(sql, false, url, banco, usuario);
            };

            //Informação caixa
            var InfCaixa = ExecSQL(
              " SELECT"
                +" CodigoCaixa,"
                +" Descricao"
              +" FROM Caixa"
              +" WHERE"
                +" CodigoCaixa = (Select CodigoCaixa from Documento where CodigoDocumento = "+CodigoDocumento+")"
            );

            //Dados Abertura
            var DadosAbertura = ExecSQL(
              " SELECT"
                +" IsNull( (Convert(varchar(10), DataHoraEmissao, 103) + ' ' + Convert(varchar(10), DataHoraEmissao, 108)), '' ) as DataAbertura,"
                +" IsNull( (Convert(varchar(10), DataHoraFinalizado, 103) + ' ' + Convert(varchar(10), DataHoraFinalizado, 108)), '' ) as DataFechamento,"
                +" IsNull(ValorAbertura, '') as ValorAbertura"
              +" FROM Documento"
              +" WHERE CodigoDocumento = 0"+CodigoDocumento
            );

            //Vendas por vendedor
            var VendasPorVendedor = ExecSQL(
              " SELECT"
                +" Dv.CodigoContatoVendedor,"
                +" V.Nome Vendedor,"
                +" SUM(Dv.TotalDocumento) TotalVendas,"
                +" Count(*) NumeroVendas,"
                +" (IsNull(SUM(EnvIt.Itens),0) + IsNull(SUM(EnvItOut.Itens),0)) NumeroPecas,"
                +" ( (SUM(Dv.TotalDocumento)) / (Count(*)) ) TicketMedio"
              +" FROM Documento Dv"
                +" INNER JOIN Contato V ON(V.CodigoContato = Dv.CodigoContatoVendedor)"
                +" INNER JOIN("
                  +" SELECT Dv.CodigoDocumento, COUNT(*) Itens"
                  +" FROM DocumentoItem Ditem"
                    +" INNER JOIN("
                      +" SELECT CodigoDocumento, CodigoDocumentoAdicional FROM Documento Div WHERE Div.Tipo='Item Venda' AND Div.CodigoDocumentoAdicional IN"
                        +" (SELECT CodigoDocumento FROM Documento WHERE Tipo='Venda' AND CodigoFatura IN (SELECT DocumentoCodigo FROM FinanceiroTitulo WHERE CodigoDocumentoCaixa = "+CodigoDocumento+"))"
                    +" ) Di"
                    +" ON(Di.CodigoDocumento = Ditem.CodigoDocumento)"
                    +" INNER JOIN"
                    +" ("
                      +" SELECT CodigoDocumento FROM Documento WHERE Tipo='Venda' AND CodigoFatura IN"
                        +" (SELECT DocumentoCodigo FROM FinanceiroTitulo WHERE CodigoDocumentoCaixa = "+CodigoDocumento+")"
                    +" ) Dv"
                    +" ON(Dv.CodigoDocumento = Di.CodigoDocumentoAdicional)"
                  +" GROUP BY Dv.CodigoDocumento"
                +" ) EnvIt"
                +" ON(EnvIt.CodigoDocumento = Dv.CodigoDocumento)"
                +" LEFT JOIN("
                  +" SELECT CodigoDocumento, Count(*) Itens FROM DocumentoItem WHERE CodigoDocumento IN"
                    +" (SELECT CodigoDocumento FROM Documento WHERE Tipo='Venda' AND CodigoFatura IN"
                      +" (SELECT DocumentoCodigo FROM FinanceiroTitulo WHERE CodigoDocumentoCaixa = "+CodigoDocumento+")"
                    +" )"
                  +" GROUP BY CodigoDocumento"
                +" ) EnvItOut"
                +" ON(EnvItOut.CodigoDocumento = Dv.CodigoDOcumento)"
              +" WHERE"
                +" Dv.Tipo = 'Venda' AND"
                +" Dv.CodigoFatura IN (SELECT DocumentoCodigo FROM FinanceiroTitulo WHERE CodigoDocumentoCaixa = "+CodigoDocumento+")"
              +" GROUP BY"
                +" Dv.CodigoContatoVendedor, V.Nome"
            );            

            //Formas de Pagamento
            var FormasPgto = ExecSQL(
              " SELECT"
                +" F.Descricao,"
                +" D.Valor"
              +" FROM DocumentoCondicaoPagamento D"
                +" INNER JOIN FormaPagamento F on(F.CodigoFormaPagamento = D.CodigoFormaPagamento)"
              +" WHERE"
                +" D.CodigoDocumento = "+CodigoDocumento
                +" AND D.Ordem = (SELECT Max(CodigoDocumentoStatus) FROM DocumentoStatus WHERE CodigoDocumento ="+CodigoDocumento+" AND (Operacao = 'Fechamento Caixa' OR Operacao = 'Correção Caixa'))"
            );

            //A pagar
            var APagar = ExecSQL(
              " SELECT"
              +" IsNull("
                +" ("
                  +" SELECT SUM(ValoraRealizar) FROM FinanceiroTitulo WHERE ReceberPagar = 'true' AND CodigoDocumentoCaixa ="+CodigoDocumento
                  +" ) - ("
                  +" SELECT SUM(Valor) FROM DocumentoCondicaoPagamento WHERE CodigoDocumento IN (SELECT DocumentoCodigo FROM FinanceiroTitulo WHERE ReceberPagar = 'true' AND CodigoDocumentoCaixa ="+CodigoDocumento+")"
                +" )"
              +" , 0) Diferenca"
            );

            //A bastecimentos do Caixa
            var AbastecimentosCaixa = ExecSQL(
              " SELECT"
                +" (Convert(varchar(10), DataEmissao, 103) + ' ' + Convert(varchar(10), DataEmissao, 108)) as DataHora,"
                +" (ValorDebito - ValorCredito) as Valor"
              +" FROM FinanceiroMovimentacao"
              +" WHERE"
                +" CodigoFinanceiroPlanoConta = (SELECT CodigoPlanoConta FROM Caixa WHERE CodigoCaixa = (SELECT CodigoCaixa FROM Documento WHERE CodigoDocumento = "+CodigoDocumento+"))"
                +" AND DataEmissao >= (SELECT DataHoraEmissao FROM Documento WHERE CodigoDocumento = "+CodigoDocumento+")"
                +" AND DataEmissao <= (SELECT IsNull(DataHoraFinalizado, (Convert(Datetime, (Convert(varchar(10), DataHoraEmissao, 111)+' 23:59:59 '), 121))) FROM Documento WHERE CodigoDocumento = "+CodigoDocumento+")"
                +" AND DocumentoTipo = ''"
                +" AND Observacao = 'Transferência entre contas'"
            );

            //Despesas Simples
            var DespesasSimples = ExecSQL(
              " SELECT"
                +" Ft.ValoraRealizar TituloValor,"
                +" Ltrim(Fpc.Descricao) Conta"
              +" FROM FinanceiroTitulo Ft"
                +" INNER JOIN FinanceiroPlanoConta Fpc ON(Fpc.CodigoFinanceiroPlanoConta = Ft.CodigoFinanceiroPlanoConta)"
              +" WHERE"
                +" Ft.ReceberPagar = 'false' AND"
                +" Ft.DocumentoTipo = 'DespesaSimples' AND"
                +" Ft.CodigoDocumentoCaixa ="+CodigoDocumento
            );

            //Sangrias
            var Sangrias = ExecSQL(
              " SELECT"
                +" Sng.Operacao DocumentoTipo,"
                +" Sng.TotalDocumento DocumentoValor,"
                +" (Convert(varchar(10), Sng.DataHoraEmissao, 103) +' '+ Convert(varchar(10), Sng.DataHoraEmissao, 108)) DataEmissao,"
                +" Sng.Observacao Observacao"
              +" FROM Documento Sng"
              +" WHERE"
                +" Sng.Tipo = 'Financeiro' AND"
                +" Sng.Operacao = 'Sangria' AND"
                +" Sng.Status = 'Finalizado' AND"
                +" Sng.CodigoCaixa ="+CodigoDocumento
            );

            //Vendas em Dinehiro
            var VendasDinheiro = ExecSQL(
              " SELECT"
                +" IsNull(SUM(Ft.ValoraRealizar), 0) Valor"
              +" FROM FinanceiroTitulo Ft"
              +" WHERE"
                +" Ft.ReceberPagar = 'true' AND"
                +" Ft.FormadePagamento = 'Dinheiro' AND"
                +" Ft.CodigoDocumentoCaixa ="+CodigoDocumento
            );

            //Recebimentos em Dinheiro
            var RecebimentosEmDinheiro = ExecSQL(
              " SELECT"
                +" IsNull((SUM(DCP.Valor)), 0) as Valor"
              +" FROM DocumentoCondicaoPagamento as DCP"
              +" WHERE"
                +" DCP.CodigoDocumento IN (SELECT DC.CodigoDocumento FROM Documento DC WHERE DC.CodigoCaixa ="+CodigoDocumento+")"
                +" AND DCP.CodigoFormaPagamento IN (SELECT FP.CodigoFormaPagamento FROM FormaPagamento as FP WHERE FP.Tipo = 1)"
                +" AND Convert(Date, DCP.DataVencimento, 103) IN (SELECT Convert(Date, DataHoraEmissao, 103) FROM Documento WHERE CodigoDocumento = "+CodigoDocumento+")"
            );

            //Dia seguinte
            var Amanha = ExecSQL(
              " SELECT"
                +" Convert(varchar(10), DateAdd(d, 1, (SELECT DataHoraEmissao FROM Documento WHERE CodigoDocumento = "+CodigoDocumento+")), 103) as Amanha"
            );


            //Informação caixa
            var TotalAbastecimentoCaixa = 0.0;
            var TotalDespesaSimples = 0.0;
            var TotalSangria = 0.0;

            if (InfCaixa.RecordsAffected > 0) {
            	$("#DescricaoCaixa").html(InfCaixa.Records[0].CodigoCaixa + ' - ' + InfCaixa.Records[0].Descricao);
            }

            if (DadosAbertura.RecordsAffected > 0) {          	
              $("#DataAbertura").html(DadosAbertura.Records[0].DataAbertura && DadosAbertura.Records[0].DataAbertura != null && DadosAbertura.Records[0].DataAbertura != "null" ? DadosAbertura.Records[0].DataAbertura : ".");
              /*$("#DataFechamento").html(DadosAbertura.Records[0].DataFechamento && DadosAbertura.Records[0].DataFechamento != null && DadosAbertura.Records[0].DataFechamento != "null" ? DadosAbertura.Records[0].DataFechamento : ".");*/
              $("#ValorAberturaCaixa").html(DadosAbertura.Records[0].ValorAbertura && DadosAbertura.Records[0].ValorAbertura != null && DadosAbertura.Records[0].ValorAbertura != "null" ? ("R$ " + DadosAbertura.Records[0].ValorAbertura.toFixed(2).replace('.', ',')) : ".");
            }


            //Vendas por vendedor
            var SomaValorVendido = 0.0;
            var SomaNumeroPecas = 0;
            var SomaNumeroVendas = 0;

            $(VendasPorVendedor.Records).each(function(index, row){
            	$("#linhasResumoVendas").append(
            		$("#linhaResumoVendas").html()
            			.replace("[nomeVendedor]", row.Vendedor)
            			.replace("[valorVendido]", "R$ " + row.TotalVendas.toFixed(2).replace('.', ','))
            			.replace("[numeroVendas]", row.NumeroVendas)
            			.replace("[numeroPecas]", row.NumeroPecas)
            			.replace("[ticketMedio]", "R$ " + row.TicketMedio.toFixed(2).replace('.', ','))	
            	);
            	SomaNumeroVendas += row.NumeroVendas;
            	SomaNumeroPecas += row.NumeroPecas;
            	SomaValorVendido += row.TotalVendas;
            });

            $("#somaNumeroPecas").html(SomaNumeroPecas);
            $("#somaNumeroVendas").html(SomaNumeroVendas);
            $("#somaValorVendido").html("R$ " + SomaValorVendido.toFixed(2).replace('.', ','));


            //Formas de pagamento
            var TotalVendasFormaPgto = 0.0;

            $(FormasPgto.Records).each(function (index, row) {
            	$("#linhasVendasPorFormaPgto").append(
            		$("#linha2Colunas").html()
            			.replace("[descricao]", row.Descricao)
            			.replace("[valor]", "R$ " + row.Valor.toFixed(2).replace('.', ',') + " (+)")
            	);
            	TotalVendasFormaPgto += row.Valor;
            });

            $("#totalVendasFormaPgto").html("R$ " + TotalVendasFormaPgto.toFixed(2).replace('.', ','));
            $("#totalAPagar").html("R$ " + APagar.Records[0].Diferenca.toFixed(2).replace('.', ',') + " (-)");
            $("#totalRecebido").html("R$ " + (TotalVendasFormaPgto - APagar.Records[0].Diferenca).toFixed(2).replace('.', ',') + " (+)");


            //Abastecimento Caixa
            $(AbastecimentosCaixa.Records).each(function (index, row) {
            	$("#linhasAbastecimentoCaixa").append(
            		$("#linha2Colunas").html()
            			.replace("[descricao]", row.DataHora)
            			.replace("[valor]", "R$ " + String(row.Valor.toFixed(2).replace('.', ',')) + (row.Valor >= 0 ? " (+)" : " (-)"))
            	);
            	TotalAbastecimentoCaixa += row.Valor;
            });

            $("#totalAbastecimentoCaixa").html("R$ " + String(TotalAbastecimentoCaixa.toFixed(2).replace('.', ',')) + (TotalAbastecimentoCaixa >= 0 ? " (+)" : " (-)"));


            //Despesas Simples
            $(DespesasSimples.Records).each(function (index, row) {
            	$("#linhasDespesaSimples").append(
            		$("#linha2Colunas").html()
            			.replace("[descricao]", row.Conta)
            			.replace("[valor]", "R$ " + row.TituloValor.toFixed(2).replace('.', ',') + " (-)")
            	);
            	TotalDespesaSimples += row.TituloValor;
            });

            $("#totalDespesaSimples").html("R$ " + TotalDespesaSimples.toFixed(2).replace('.', ',') + " (+)");


            //Sangrias
            $(Sangrias.Records).each(function (index, row) {
            	$("#linhasSangria").append(
            		$("#linha2Colunas").html()
            			.replace("[descricao]", row.Observacao + " - " + row.DataEmissao)
            			.replace("[valor]", "R$ " + row.DocumentoValor.toFixed(2).replace('.', ',') + " (-)")
            	);
            	TotalSangria += row.DocumentoValor;
            });

            $("#totalSangria").html("R$ " + TotalSangria.toFixed(2).replace('.', ',') + " (-)");


            //Resumo caixa
            $("#resumoAberturaCaixa").html("R$ " + DadosAbertura.Records[0].ValorAbertura.toFixed(2).replace('.', ','));
            $("#resumoVendasDinheiro").html("R$ " + VendasDinheiro.Records[0].Valor.toFixed(2).replace('.', ','));
            $("#resumoRecebimentosDinheiro").html("R$ " + RecebimentosEmDinheiro.Records[0].Valor.toFixed(2).replace('.', ',') + " (+)");
            $("#resumoAbastecimentosCaixa").html("R$ " + String(TotalAbastecimentoCaixa.toFixed(2).replace('.', ',')) + (TotalAbastecimentoCaixa >= 0 ? " (+)" : " (-)"));
            $("#resumoDespesasSimples").html("R$ " + TotalDespesaSimples.toFixed(2).replace('.', ',') + " (-)");
            $("#resumoSangrias").html("R$ " + TotalSangria.toFixed(2).replace('.', ',') + " (-)");


            //Fundo de Caixa (Amanhã)
            var FundoCaixaAmanha = DadosAbertura.Records[0].ValorAbertura + RecebimentosEmDinheiro.Records[0].Valor + TotalAbastecimentoCaixa - TotalDespesaSimples - TotalSangria;

            $("#amanha").html(Amanha.Records[0].Amanha)
            $("#valorParaAmanha").html("R$ " + FundoCaixaAmanha.toFixed(2).replace('.', ','));


            //Todas as formas de pagamento Detalhado
            var TodasFormasPgtoDetalhado = ExecSQL(
              " SELECT"
                +" Distinct Ft.FormaDePagamento as FormaPgto"
              +" FROM FinanceiroTitulo Ft"
              +" WHERE"
                +" Ft.CodigoDocumentoCaixa = "+CodigoDocumento
            );

            //IF Imprime detalhamento
            if (ImprimeDetalhamento != '1'){
              $("#tblDetalhamentoVendas").remove();
            } 
            else{

            	var
                //Declare Totalizadores
                TotalVendasDetalhado = 0.0
                TotalRecebimentosDetalhado = 0.0
              ;

            	$(TodasFormasPgtoDetalhado.Records).each(function(index, row) {

                /*VENDAS*/
                var VendasDestaFormaPgto = ExecSQL(
                  " SELECT"
                    +" IsNull(Ft.FormadePagamento, '') as FormaPagamento,"
                    +" IsNull((Convert(varchar, Ft.DataEmissao, 103) + ' ' + Convert(varchar, Ft.DataEmissao, 108)), '') as DataFinalizado,"
                    +" IsNull(Ft.DocumentoCodigo, '') as Fatura,"
                    +" IsNull(C.Nome, '') as NomeCliente,"
                    +" Count(*) as EmParcelas,"
                    +" SUM(IsNull(Ft.ValoraRealizar, 0)) as ValorPago,"
                    +" STUFF(("
                      +" SELECT DISTINCT ',  '+ V.Nome"
                      +" FROM Documento Dv"
                        +" INNER JOIN Contato V ON(V.CodigoContato = Dv.CodigoContatoVendedor)"
                      +" WHERE"
                        +" Dv.Tipo='Venda' AND"
                        +" Dv.CodigoFatura = Ft.DocumentoCodigo"
                      +" FOR XML PATH('')), 1, 2, ''"
                    +" ) AS NomeVendedor"
                  +" FROM FinanceiroTitulo Ft"
                    +" LEFT JOIN Contato C ON(Ft.CodigoContato = C.CodigoContato)"
                  +" WHERE"
                    +" Ft.ReceberPagar <> 'false' AND"
                    +" Ft.CodigoFinanceiroPlanoConta = 139 AND"
                    +" IsNull(Ft.CodigoFatura, '') = '' AND"
                    +" Ft.FormadePagamento ='"+row.FormaPgto+"' AND"
                    +" Ft.CodigoDocumentoCaixa ="+CodigoDocumento
                  +" GROUP BY"
                    +" Ft.CodigoFinanceiroPlanoConta,"
                    +" Ft.FormadePagamento,"
                    +" Ft.DataEmissao,"
                    +" Ft.DocumentoCodigo,"
                    +" C.Nome"
                  +" ORDER BY"
                    +" Ft.DataEmissao, C.Nome"
                );

                if(VendasDestaFormaPgto.RecordsAffected > 0) {
              		$("#linhasVendasDetalhado").append(
              			$("#linhaVendasDetalhado").html()
              			.replace("[Data]", "<h5 class='col w100 b pt05 pb02'>Forma de Pagamento: "+ row.FormaPgto +"</h5>")
              			.replace("[Fatura]", "")
                    .replace("[Vendedor]", "")
                    .replace("[Cliente]", "")
              			.replace("[Parcela]", "")
              			.replace("[Valor]", "")
              		);

              		$("#linhasVendasDetalhado").append(
              			$("#linhaVendasDetalhado").html()
              			.replace("[Data]", "<h5 class='col w17 lineb pb02 mb02 b'>Data/Hora</h5>")
              			.replace("[Fatura]", "<h5 class='col w13 lineb pb02 mb02 b'>Nº Fatura</h5>")
                    .replace("[Vendedor]", "<h5 class='col w17 lineb pb02 mb02 b'>Vendedor</h5>")
                    .replace("[Cliente]", "<h5 class='col w28 lineb pb02 mb02 b'>Cliente</h5>")
              			.replace("[Parcela]", "<h5 class='col w7 txt-ac lineb pb02 mb02 b'>Em Parcela</h5>")
              			.replace("[Valor]", "<h5 class='col w17-3 lineb pb02 mb02 b txt-ar float-r'>Valor R$</h5>")
              		);

              		var TotalFormaPgtoVenda = 0.0;
              		$(VendasDestaFormaPgto.Records).each(function(index, row2) {
              			$("#linhasVendasDetalhado").append(
    	          			$("#linhaVendasDetalhado").html()
    	          			.replace("[Data]", "<h5 class='col w17'>" + row2.DataFinalizado + "</h5>")
              				.replace("[Fatura]", "<h5 class='col w13'>" + row2.Fatura + "</h5>")
                      .replace("[Vendedor]", "<h5 class='col w17'>" + row2.NomeVendedor + "</h5>")
                      .replace("[Cliente]", "<h5 class='col w28'>" + row2.NomeCliente + "</h5>")
    	          			.replace("[Parcela]", "<h5 class='col w7 txt-ac'>" + row2.EmParcelas + "</h5>")
    	          			.replace("[Valor]", "<h5 class='col w17-5 txt-ar float-r'>R$ " + row2.ValorPago.toFixed(2).replace('.', ',') + "</h5>")
                    );
    	          		
                    TotalFormaPgtoVenda += row2.ValorPago;
              		});

              		$("#linhasVendasDetalhado").append(
              			$("#linhaVendasDetalhado").html()
              			.replace("[Data]", "<h5 class='col w60 linet pb08 b'>Total "+row.FormaPgto+"</h5>")
              			.replace("[Fatura]", "")
                    .replace("[Vendedor]", "")
                    .replace("[Cliente]", "")
              			.replace("[Parcela]", "")
              			.replace("[Valor]", "<h4 class='col w40 linet pb08 b txt-ar'> R$ "+ TotalFormaPgtoVenda.toFixed(2).replace('.', ',') +"</h4>")
              		);

              		TotalVendasDetalhado += TotalFormaPgtoVenda;
                }//if vendas


                /*RECEBIMENTOS*/
                var RecebimentosDestaFormaPgto = ExecSQL(
                  " SELECT"
                    +" IsNull(Ft.FormadePagamento, '') as FormaDePagamento,"
                    +" IsNull((Convert(varchar, Ft.DataPagamento, 103) + ' ' + Convert(varchar, Ft.DataPagamento, 108)), '') as DataFinalizado,"
                    +" IsNull((Convert(varchar, Ft.DataEmissao, 103)), '') as DataEmissao,"
                    +" IsNull((Convert(varchar, Ft.DataVencimento, 103)), '') as DataVencimento,"
                    +" IsNull(Ft.DocumentoCodigo, '') as Fatura,"
                    +" IsNull(C.Nome, '') as NomeCliente,"
                    +" IsNull(Ft.ValoraRealizar, 0) as ValorPago"
                  +" FROM FinanceiroTitulo Ft"
                    +" LEFT JOIN Contato C ON(Ft.CodigoContato = C.CodigoContato)"
                  +" WHERE"
                    +" Ft.ReceberPagar <> 'false' AND"
                    +" Ft.CodigoFinanceiroPlanoConta = 152 AND"
                    +" IsNull(Ft.CodigoFatura, '') = '' AND"
                    +" Ft.FormadePagamento = '"+row.FormaPgto+"' AND"
                    +" Ft.CodigoDocumentoCaixa = "+CodigoDocumento
                );

                if(RecebimentosDestaFormaPgto.RecordsAffected > 0) {
                  $("#linhasRecebimentosDetalhado").append(
                    $("#linhaRecebimentosDetalhado").html()
                    .replace("[Data]", "<h5 class='col w100 b pt05 pb02'>Forma de Pagamento: "+ row.FormaPgto +"</h5>")
                    .replace("[DataEmissao]", "")
                    .replace("[DataVencimento]", "")
                    .replace("[Fatura]", "")
                    .replace("[Cliente]", "")
                    .replace("[Valor]", "")
                  );

                  $("#linhasRecebimentosDetalhado").append(
                    $("#linhaRecebimentosDetalhado").html()
                    .replace("[Data]", "<h5 class='col w17 lineb pb02 mb02 b'>Data/Hora</h5>")
                    .replace("[DataEmissao]", "<h5 class='col w10 lineb pb02 mb02 b'>Data Emissão</h5>")
                    .replace("[DataVencimento]", "<h5 class='col w10 lineb pb02 mb02 b'>Data Venc.</h5>")
                    .replace("[Fatura]", "<h5 class='col w11 lineb pb02 mb02 b'>Nº Fatura</h5>")
                    .replace("[Cliente]", "<h5 class='col w36 lineb pb02 mb02 b'>Cliente</h5>")
                    .replace("[Valor]", "<h5 class='col w14-7 lineb pb02 mb02 b txt-ar float-r'>Valor R$</h5>")
                  );

                  var TotalFormaPgtoRecebimentos = 0.0;
                  $(RecebimentosDestaFormaPgto.Records).each(function(index, row3) {
                    $("#linhasRecebimentosDetalhado").append(
                      $("#linhaRecebimentosDetalhado").html()
                      .replace("[Data]", "<h5 class='col w17'>" + row3.DataFinalizado + "</h5>")
                      .replace("[DataEmissao]", "<h5 class='col w10'>" + row3.DataEmissao + "</h5>")
                      .replace("[DataVencimento]", "<h5 class='col w10'>" + row3.DataVencimento + "</h5>")
                      .replace("[Fatura]", "<h5 class='col w11'>" + row3.Fatura + "</h5>")
                      .replace("[Cliente]", "<h5 class='col w36'>" + row3.NomeCliente + "</h5>")
                      .replace("[Valor]", "<h5 class='col w15 txt-ar float-r'>R$ " + row3.ValorPago.toFixed(2).replace('.', ',') + "</h5>")
                    );
                    
                    TotalFormaPgtoRecebimentos += row3.ValorPago;
                  });

                  $("#linhasRecebimentosDetalhado").append(
                    $("#linhaRecebimentosDetalhado").html()
                    .replace("[Data]", "<h5 class='col w60 linet pb08 b'>Total "+row.FormaPgto+"</h5>")
                    .replace("[DataEmissao]", "")
                    .replace("[DataVencimento]", "")
                    .replace("[Fatura]", "")
                    .replace("[Cliente]", "")
                    .replace("[Valor]", "<h4 class='col w40 linet pb08 b txt-ar'> R$ "+ TotalFormaPgtoRecebimentos.toFixed(2).replace('.', ',') +"</h4>")
                  );

                  TotalRecebimentosDetalhado += TotalFormaPgtoRecebimentos;
                }//if recebimentos

            	});//TodasFormasPgtoDetalhado

              $("#totalVendasDetalhado").html("R$ " + TotalVendasDetalhado.toFixed(2).replace('.', ','));
            	$("#totalRecebimentosDetalhado").html("R$ " + TotalRecebimentosDetalhado.toFixed(2).replace('.', ','));

            }

        });
    </script>
  </body>
</html>