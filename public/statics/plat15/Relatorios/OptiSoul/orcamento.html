<html>
	<head>
		<meta charset="utf-8"/>
		<title>Orçamento</title>
		<link rel="stylesheet" type="text/css" href="optidados.framework.css"/>
		<script src="/Scripts/jquery-2.1.4.js"></script>
		<script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
		<script src="/Scripts/codigobarras.js"></script>
		<script src="/Plugins/html2canvas.js"></script>

		<script id="descricaoOculosGrau" type="descricaoOculosGrau">
			<div class="row w100">
				<h5 class="row w100 mb03 b">[descricao]</h5>
			</div>
		</script>

		<script id="linha" type="linha">
			<div class="row w100">
				<h5 class="col w55 txt-hidden">&nbsp;&nbsp;&nbsp;&nbsp;[descricao]</h5>
				<h5 class="col w20 txt-hidden">[marca]</h5>
				<h5 class="col w08 txt-hidden txt-ar">[qtd]</h5>
				<h5 class="col w17 txt-hidden txt-ar">[valor]</h5>
			</div>
		</script>

		<script type="formaPgto" id="formaPgto">
			<div class="row w100">
				<h5 class="col w54 txt-hidden">[descricao]</h5>
				<h5 class="col w23 txt-ar txt-hidden">[data]</h5>
				<h5 class="col w23 txt-ar txt-hidden">[valor]</h5>
			</div>
		</script>

	</head>
	<body>
		<div class="container">
			<!--Cabeçalho-->
			<div class="row w100 mb15">
				<h1 class="w100 txt-ac lineb" id="tituloDocumento">Orçamento</h1>
			</div>

			<!--Cabeçalho-->
			<div class="row w100 lineb pb07 mb07">
				<div class="col w22">
					<div class="logo">
						<img class="img-responsive" src="optsoul-exemplo.png"/>
					</div>
				</div>

				<div class="col w54-7 pl05 pr05">
					<h5> <span id="fantasiaEmissor">Carregando impressão</span> </h5>
					<h5> <span id="enderecoEmissor"></span> </h5>
					<h5> <span id="telefoneEmissor"></span> </h5>
					<h5> <span id="emailEmissor"></span> </h5>
					<h5> <span id="siteEmissor"></span> </h5>
				</div>

				<div class="col w22 txt-ac">
					<h5 class="row w100 txt-ac"> <span id="codBarras"></span> </h5>
					<h3 class="row w100 txt-ac"> <span id="codPedido" class="b"></span> </h3>
				</div>
			</div>

			<!--Dados Cliente-->
			<div class="row w100 pb05 mb2">
				<div class="col w75-6 pl05 pr05">
					<h5> <span id="codCliente"> </span> <span id="nomeCliente"></span> </h5>
					<h5> <span id="enderecoCliente"></span> </h5>
					<h5> <span id="telefoneCliente"></span> </h5>
				</div>

				<div class="col w23">
					<h5><span id="dataHoraOrcamento"></span></h5>
				</div>
			</div>

			<!--Produtos-->
			<div class="row w100 lineb pb03 mb1">
				<h3 class="w100 txt-ac">Produtos</h3>
			</div>

			<div id="ItensOG" class="row w100 mb05">
				<div class="row w100 lineb pb03 mb03">
					<h5 id="tipoExibicao" class="col w55 i"> Descrição </h5>
					<h5 id="tipoExibicao2" class="col w20 i"> Marca </h5>
					<h5 class="col w08 i txt-ar"> Qtd. </h5>
					<h5 class="col w17 i txt-ar"> Preço </h5>
				</div>
			</div>

			<!--Total Produtos-->
			<div class="row w100 linet pt03 mb15">
				<h5 class="col w75 b">TOTAL:</h5>
				<h5 class="col w08 b txt-ar"><span id="qtdTotal"></span></h5>
				<h5 class="col w17 b txt-ar"><span id="valorTotal"></span></h5>
			</div>

			<!--formas de pagamento (Pedido de Venda)-->
	        <div id="tbFormasPgto" class="row w100 mb15">
	        </div>

			<div class="row w100 linel lineb liner mb15">
				<h5 class="row w100">Observação:</h5>
				<h5 id="observacao" class="row w100 pt05 pl05"></h5>
			</div>

			<div class="row w100 mt45">
				<h5 class="txt-ac">Orçamento valido por tempo limitado.</h5>
				<h5 class="txt-ac">Aguardamos seu contato!</h5>
			</div>
		</div><!--container-->

		<script>
			$(document).ready(function(){

				//Connect DB
			    var banco = getParameterByName("BancoDeDados");
			    var url = decodeURIComponent(getParameterByName("URLServidor"));
			    var usuario = getParameterByName("CodigoUsuario");

			    //Get Var's
				var cod = getParameterByName("CodigoDocumento");
			    var oculto = getParameterByName("Oculto");

			    //Declare Var's
			    var qtdTotal = 0;


			    //Dados do Emissor
			    var dadosEmissor = GeeksSQL(
					" SELECT"
				        +" IsNull(C.Nome, '') as Nome"
				        +" ,IsNull(C.[Site], '') as Site"
				        +" ,IsNull(C.Email, '') as Email"
				        +" ,IsNull(STUFF(("
				            +" SELECT ',  '+Ct.Telefone"
				            +" FROM ContatoTelefone Ct"
				            +" WHERE Ct.CodigoContato = C.CodigoContato"
				        +" FOR XML PATH('')), 1, 2, ''), '') as Telefone"
				        +" ,(IsNull(Ce.Logradouro+' ', '')+ IsNull(Ce.Numero+', ', '')+ IsNull(Ce.Complemento+', ', '')+ IsNull(Ce.Bairro+' - ', '')+ IsNull(Ce.Municipio+'/', '')+ IsNull(Ce.UF+' ', '')+ IsNull(Ce.CEP, '')) as Endereco"
				        +" ,IsNull(C.Imagem, 'Não informado') as Imagem"
				    +" FROM Contato C"
				        +" LEFT JOIN ContatoEndereco Ce ON(Ce.CodigoContato = C.CodigoContato) AND(Ce.Grupo = 'Principal')"
				    +" WHERE"
				        +" C.CodigoContato = (SELECT CodigoEmpresa FROM Documento WHERE CodigoDocumento ="+cod+")"
			    ,false ,url ,banco ,usuario);


			    //Dados do Cliente
			    var dadosCliente = GeeksSQL(
			    	" SELECT"
						+" IsNull(C.CodigoContato, '') as CodigoContato"
				        +" ,IsNull(C.Nome, '') as Nome"
				        +" ,IsNull(STUFF(("
				            +" SELECT ',  '+Ct.Telefone"
				            +" FROM ContatoTelefone Ct"
				            +" WHERE Ct.CodigoContato = C.CodigoContato"
				        +" FOR XML PATH('')), 1, 2, ''), '') as Telefone"
				        +" ,(IsNull(Ce.Logradouro+' ', '')+ IsNull(Ce.Numero+', ', '')+ IsNull(Ce.Complemento+', ', '')+ IsNull(Ce.Bairro+' - ', '')+ IsNull(Ce.Municipio+'/', '')+ IsNull(Ce.UF+' ', '')+ IsNull(Ce.CEP, '')) as Endereco"
				    +" FROM Contato C"
				        +" LEFT JOIN ContatoEndereco Ce ON(Ce.CodigoContato = C.CodigoContato) AND(Ce.Grupo = 'Principal')"
				    +" WHERE"
				        +" C.CodigoContato = (SELECT CodigoContato FROM Documento WHERE CodigoDocumento ="+cod+")"
			    ,false ,url ,banco ,usuario);


			    //Dados Gerais do Pedido
			    var dadosGeraisPedido = GeeksSQL(
			    	"SELECT"
				    	+" IsNull(D.[Status], '') as TipoDocumento"
				    	+" ,Convert(Varchar(10), DataHoraEmissao, 103)+' '+ Convert(Varchar(10), DataHoraEmissao, 108) as DataHoraEmissao"
				    	+" ,Convert(Varchar(10), CURRENT_TIMESTAMP, 103)+' '+ Convert(Varchar(10), CURRENT_TIMESTAMP, 108) as DataHoraImpresso"
				    	+" ,IsNull(TotalDocumento, '') as TotalDocumento"
				    	+" ,IsNull(Observacao, '') as Observacao"
				    +" FROM Documento D"
				    +" WHERE D.CodigoDocumento ="+cod
			    ,false ,url ,banco ,usuario);


			    switch(dadosGeraisPedido.Records[0].TipoDocumento) {
			    	case "Orçamento":
				    	$("#tituloDocumento").html("Orçamento");
				    	break;

			    	case "Não Aprovado": 
				    	$("#tituloDocumento").html("Pedido (não aprovado)");
				    	break;

			    	default:
				    	$("#tituloDocumento").html("Pedido de Venda");
				    	break;	
			    }//switch


			    //Print Código Documento
			    $("#codPedido").html("N° " + cod);

			    //Print Dados Emissor
			    $("#fantasiaEmissor").html(dadosEmissor.Records[0].Nome);
			    $("#emailEmissor").html(dadosEmissor.Records[0].Email);
			    $("#enderecoEmissor").html(dadosEmissor.Records[0].Endereco);
			    $("#siteEmissor").html(dadosEmissor.Records[0].Site);
			    $("#telefoneEmissor").html(dadosEmissor.Records[0].Telefone);

			    //Print Dados Cliente
			    $("#codCliente").html(dadosCliente.Records[0].CodigoContato);
			    $("#nomeCliente").html(dadosCliente.Records[0].Nome);
			    $("#enderecoCliente").html(dadosCliente.Records[0].Endereco);
			    $("#telefoneCliente").html(dadosCliente.Records[0].Telefone);

			    //Print Informações do Documento
			    $("#dataHoraOrcamento").html("Data: "+ dadosGeraisPedido.Records[0].DataHoraEmissao + "<br>Impresso: " + dadosGeraisPedido.Records[0].DataHoraImpresso);
			    $("#valorTotal").html(dadosGeraisPedido.Records[0].TotalDocumento.toFixed(2).replace('.', ','));
			    $("#observacao").html(dadosGeraisPedido.Records[0].Observacao);


			    //Cabeçalho Descrição dos Produtos (Operacao = 'Óculos de Grau')
			    if (oculto != '1') {
			    	//Mostrar Descrição
			    	var oculosGrau = GeeksSQL(
			    		" SELECT"
			    			+" IsNull(CodigoDocumento, '') as CodigoDocumento"
			    			+" ,IsNull(Descricao, '') as Descricao"
			    		+" FROM Documento"
			    		+" WHERE"
			    			+" Operacao = 'Óculos de Grau'"
			    			+" AND CodigoDocumentoAdicional ="+cod
			    	,false ,url ,banco ,usuario);
			    } else {
			    	//Ocultar Descrição
					var oculosGrau = GeeksSQL(
						" SELECT"
							+" IsNull(CodigoDocumento, '') as CodigoDocumento"
							+" ,'Óculos de Grau' as Descricao"
						+" FROM Documento"
						+" WHERE"
							+" Operacao = 'Óculos de Grau'"
							+" AND CodigoDocumentoAdicional ="+cod
					,false ,url ,banco ,usuario);
					
					$("#tipoExibicao").html("Produto");
					$("#tipoExibicao2").html("&nbsp;");
				}//if


			    if(oculosGrau.RecordsAffected > 0) {

			    	$(oculosGrau.Records).each(function(index, row){

			    		$("#ItensOG").append($("#descricaoOculosGrau").html().replace("[descricao]", row.Descricao));

			    		//Descrição dos Itens (Operacao = 'Óculos de Grau')
			    		if (oculto != '1') {
			    			//Mostrar Descrição
			    			var itensOculosGrau = GeeksSQL(
			    				" SELECT"
			    					+" IsNull(I.Descricao, '') as Descricao"
			    					+" ,IsNull(I.Marca, '-') as Marca"
			    					+" ,IsNull(Ditem.Quantidade, 0) as Quantidade"
			    					+" ,IsNull(Ditem.Total, 0) as Total"
			    				+" FROM DocumentoItem Ditem"
			    					+" INNER JOIN Item I ON(Ditem.CodigoItem = I.CodigoItem)"
			    				+" WHERE Ditem.CodigoDocumento ="+row.CodigoDocumento
			    			,false ,url ,banco ,usuario);
			    		} else {
			    			//Ocultar Descrição
				    		var itensOculosGrau = GeeksSQL(
				    			"Select"
				    				+" IsNull(Ditem.TipoItem) as Descricao"
				    				+" ,'' as Marca"
				    				+" ,IsNull(Ditem.Quantidade, 0) as Quantidade"
				    				+" ,IsNull(Ditem.Total, 0) as Total"
				    			+" FROM DocumentoItem Ditem"
				    				+" INNER JOIN Item I ON(Ditem.CodigoItem = I.CodigoItem)"
				    			+" WHERE Ditem.CodigoDocumento ="+row.CodigoDocumento
				    		,false ,url ,banco ,usuario);
			    		}//if

			    		for (i = 0; i < itensOculosGrau.RecordsAffected; i++) {
			    			$("#ItensOG").append($("#linha").html()
			    				.replace("[marca]", (itensOculosGrau.Records[i].Marca != "" ? itensOculosGrau.Records[i].Marca : "&nbsp;") )
			    				.replace("[descricao]", (itensOculosGrau.Records[i].Descricao != "" ? itensOculosGrau.Records[i].Descricao : "&nbsp;") )
			    				.replace("[qtd]", (itensOculosGrau.Records[i].Quantidade != 0 ? itensOculosGrau.Records[i].Quantidade : "&nbsp;") )
			    				.replace("[valor]", (itensOculosGrau.Records[i].Total != 0 ? itensOculosGrau.Records[i].Total.toFixed(2).replace('.', ',') : "&nbsp;") )
			    			);

			    			qtdTotal += itensOculosGrau.Records[i].Quantidade;
			    		}//for

			    	});//row

			    }//if


			    $("#ItensOG").append($("#linha").html()				    				
    				.replace("[marca]", "")
    				.replace("[descricao]", "")
    				.replace("[qtd]", "")
    				.replace("[valor]", "")
    				.replace("R$", "")
			    );

			    //Descrição dos Produtos (Operacao <> 'Óculos de Grau')
				if (oculto != '1') {
					//Mostrar Descrição
			    	var produtos = GeeksSQL(
			    		" SELECT"
			    			+" IsNull(D.CodigoDocumento, '') as CodigoDocumento"
			    			+" ,IsNull(I.Descricao, '') as Descricao"
			    			+" ,IsNull(I.Marca, '') as Marca"
			    			+" ,IsNull(Ditem.Quantidade, 0) as Quantidade"
			    			+" ,IsNull(Ditem.Total, 0) as Total"
			    		+" FROM Documento D"
			    			+" INNER JOIN DocumentoItem Ditem ON(D.CodigoDocumento = Ditem.CodigoDocumento)"
			    			+" INNER JOIN Item I ON(I.CodigoItem = Ditem.CodigoItem)"
			    		+" WHERE"
			    			+" D.Operacao <> 'Óculos de Grau'"
			    			+" AND D.CodigoDocumentoAdicional ="+cod
			    		,false ,url ,banco ,usuario);
				} else {
					//Ocultar Descrição
			    	var produtos = GeeksSQL(
			    		" SELECT"
			    			+" IsNull(D.CodigoDocumento, '') as CodigoDocumento"
			    			+" ,IsNull(Ditem.TipoItem, '') as Descricao"
			    			+" ,'' as Marca"
			    			+" ,IsNull(Ditem.Quantidade, '') as Quantidade"
			    			+" ,IsNull(Ditem.Total, '') as Total"
			    		+" FROM Documento D"
			    			+" INNER JOIN DocumentoItem Ditem ON(D.CodigoDocumento = Ditem.CodigoDocumento)"
			    			+" INNER JOIN Item I ON(I.CodigoItem = Ditem.CodigoItem)"
			    		+" WHERE"
			    			+" D.Operacao <> 'Óculos de Grau'"
			    			+" AND D.CodigoDocumentoAdicional ="+cod
			    	,false ,url ,banco ,usuario);
				}//if

				//Print Descrição dos Produtos (Operacao <> 'Óculos de Grau')
			    if (produtos.RecordsAffected > 0) {

			    	$(produtos.Records).each(function(index, row){
						$("#ItensOG").append($("#linha").html()
							.replace("[marca]", (row.Marca != "" ? row.Marca : "&nbsp;") )
							.replace("[descricao]", (row.Descricao != "" ? row.Descricao : "&nbsp;") )
							.replace("[qtd]", (row.Quantidade != 0 ? row.Quantidade : "&nbsp;") )
							.replace("[valor]", (row.Total != 0 ? row.Total.toFixed(2).replace('.', ',') : "&nbsp;") )
							.replace("&nbsp;&nbsp;&nbsp;&nbsp;", "")
						);

						qtdTotal += row.Quantidade;
			    	});

			    }//if

			    //Print Quantidade Total
			    $("#qtdTotal").html((qtdTotal != 0 ? qtdTotal : "&nbsp;"));


				//Formas de Pagamento
				if (dadosGeraisPedido.Records[0].TipoDocumento != "Orçamento" && dadosGeraisPedido.Records[0].TipoDocumento != "Não Aprovado") {

					var FormasPagamentoFatura = GeeksSQL("select D.CodigoFormaPagamento, Convert(varchar(10), D.DataVencimento, 103) + ' ' + Convert (varchar(10), D.DataVencimento, 108) DataVencimento, D.Valor, D.Sinal, F.Descricao from DocumentoCondicaoPagamento D inner join FormaPagamento F on D.CodigoFormaPagamento = F.CodigoFormaPagamento where D.CodigoDocumento = (select CodigoFatura from Documento where CodigoDocumento = 0" + cod + ")", false, url, banco, usuario);

					var TotalFatura = GeeksSQL("Select SubTotal SubTotalDocumento, TotalDesconto from Documento where CodigoDocumento = (select top 1 CodigoFatura from Documento where CodigoDocumento = 0" + cod + ")", false, url, banco, usuario)

						$("#tbFormasPgto").append(
							$("#formaPgto").html()
								.replace("[descricao]", "<span class='row w100 lineb mb05 pb02 b'>Formas de Pagamento</span>")
								.replace("[data]", "<span class='row w100 lineb mb05 pb02 b'>&nbsp;</span>")
								.replace("[valor]", "<span class='row w100 lineb mb05 pb02 b'>&nbsp;</span>")
						);

					var totalFormas = 0;

					$(FormasPagamentoFatura.Records).each(function (index2, row2) {

						$("#tbFormasPgto").append(
							$("#formaPgto").html()
								.replace("[descricao]", row2.Descricao)
								.replace("[data]", row2.DataVencimento)
								.replace("[valor]", row2.Valor.toFixed(2).replace(".", ","))
						);

						totalFormas += row2.Valor;
					});

					$("#tbFormasPgto").append(
						$("#formaPgto").html()
							.replace("[descricao]", "<span class='row w100 lineb mb05 mt06 pb02 b'>Total Fatura</span>")
							.replace("[data]", "<span class='row w100 lineb mb05 mt06 pb02 b'>&nbsp;</span>")
							.replace("[valor]", "<span class='row w100 lineb mb05 mt06 pb02 b'>"+TotalFatura.Records[0].SubTotalDocumento.toFixed(2).replace(".", ",")+"</span>" )
					);

					$("#tbFormasPgto").append(
						$("#formaPgto").html()
							.replace("[descricao]", "<span class='row w100 lineb mb04 pb02 b'>Total Formas Pagamento da Fatura</span>")
							.replace("[data]", "<span class='row w100 lineb mb05 pb02 b'>&nbsp;</span>")
							.replace("[valor]", "<span class='row w100 lineb mb05 pb02 b'>"+totalFormas.toFixed(2).replace(".", ",")+"</span>" )
					);

					$("#tbFormasPgto").append(
						$("#formaPgto").html()
							.replace("[descricao]", "<span class='row w100 lineb mb04 pb02 b'>Total Descontos</span>")
							.replace("[data]", "<span class='row w100 lineb mb05 pb02 b'>&nbsp;</span>")
							.replace("[valor]", "<span class='row w100 lineb mb05 pb02 b'>"+TotalFatura.Records[0].TotalDesconto.toFixed(2).replace(".", ",")+"</span>" )
					);

					var outrosPedidos = TotalFatura.Records[0].SubTotalDocumento - dadosGeraisPedido.Records[0].TotalDocumento - TotalFatura.Records[0].TotalDesconto;
					$("#tbFormasPgto").append(
						$("#formaPgto").html()
							.replace("[descricao]", "<span class='row w100 lineb mb04 pb02 b'>Total Outros Pedidos na Fatura</span>")
							.replace("[data]", "<span class='row w100 lineb mb05 pb02 b'>&nbsp;</span>")
							.replace("[valor]", "<span class='row w100 lineb mb05 pb02 b'>"+outrosPedidos.toFixed(2).replace(".", ",")+"</span>" )
					);

					var aReceber = TotalFatura.Records[0].SubTotalDocumento - totalFormas;
					$("#tbFormasPgto").append(
						$("#formaPgto").html()
							.replace("[descricao]", "<span class='row w100 lineb mb04 pb02 b'>Valor a Receber</span>")
							.replace("[data]", "<span class='row w100 lineb mb05 pb02 b'>&nbsp;</span>")
							.replace("[valor]", "<span class='row w100 lineb mb05 pb02 b'>"+aReceber.toFixed(2).replace(".", ",")+"</span>" )
					);
				}//if


				//Logo Loja
				if(dadosEmissor.Records[0].Imagem != "Não informado") {
					$(".logo").each(function() {
						$( this ).html('<img class="img-responsive" src="' + dadosEmissor.Records[0].Imagem.split("#")[0] + '" />');
					});
				}//if


				//Codigo de Barras
				var numero = String(cod);
				var zeros = 13 - Number(numero.length);

				for (var i = 0; i < zeros; i++) {
					numero = '0' + numero;
				}

				$("#codBarras").css("white-space", "nowrap");
				$("#codBarras").css("background-color", "#fff");
				$("#codBarras").html(fbarcode(numero,32));
			});
		</script>
	</body>
</html>