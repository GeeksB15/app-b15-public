<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Fatura Detalhadas</title>
        <link rel="stylesheet" type="text/css" href="../optidados.framework.css"/>
        <script src="/Scripts/jquery-2.1.4.js"></script>
        <script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
        <script src="/Scripts/codigobarras.js"></script>
        <script src="/Plugins/html2canvas.js"></script>

        <style type="text/css" media="print">
            @page {
                margin-top: 0.50cm;
                margin-right: 0.50cm;
                margin-bottom: 0.50cm;
                margin-left: 0.50cm;
            }

            .botao-apagar-parte {
                display: none;
            }

            .container {
                margin: 0;
            }
        </style>

        <style type="text/css">
            .container {
                margin: 0 auto;
            }

            .DrillDownExpand {
                display: none;
            }

            .btn-faturas {
                margin-left: -2px;
                background-color: rgb(230,230,230);
                cursor: pointer;
                -webkit-transition: all 220ms ease-in;
                -webkit-transform: scale(1); 
                -ms-transition: all 220ms ease-in;
                -ms-transform: scale(1); 
                -moz-transition: all 220ms ease-in;
                -moz-transform: scale(1);
                transition: all 220ms ease-in;
                transform: scale(1);
            }

            .btn-faturas:hover {
                box-shadow: 0px 0px 20px rgba(80,80,80,.5);
                z-index: 2;
                -webkit-transition: all 220ms ease-in;
                -webkit-transform: scale(1.03);
                -ms-transition: all 220ms ease-in;
                -ms-transform: scale(1.03);   
                -moz-transition: all 220ms ease-in;
                -moz-transform: scale(1.03);
                transition: all 220ms ease-in;
                transform: scale(1.03);
            }

            /*Visualizar Sintetico/Analitico*/
            .btn-viewer {
                position: relative;
                float: left;
                border: 1px solid rgb(210,210,210);
                margin: 0;
                padding: 5px 10px;
                cursor: pointer;
                -webkit-transition: all 190ms ease-in;
                -webkit-transform: scale(1); 
                -ms-transition: all 190ms ease-in;
                -ms-transform: scale(1); 
                -moz-transition: all 190ms ease-in;
                -moz-transform: scale(1);
                transition: all 190ms ease-in;
                transform: scale(1);
            }

            .btn-viewer:hover {
                box-shadow: 0px 0px 5px rgba(80,80,80,.3);
                z-index: 2;
                -webkit-transition: all 190ms ease-in;
                -webkit-transform: scale(1.02);
                -ms-transition: all 190ms ease-in;
                -ms-transform: scale(1.02);   
                -moz-transition: all 190ms ease-in;
                -moz-transform: scale(1.02);
                transition: all 190ms ease-in;
                transform: scale(1.02);
            }
        </style>


        <script id="tempEmpresa" type="tempEmpresa">
            <!--empresa-->
            <div class="row w100 mt15 lineb linel">
                <h4 style="margin-left: -2px; border-left: 10px solid rgb(210,210,210);">Empresa: <span class="b">[NomeEmpresa]</span></h4>
        </script>

            <script id="tempFatura" type="tempFatura">
                <!--fatura-->
                <div class="row w98 float-r mt15 mb1 lineb linel" style="border-width: 3px; border-color: rgb(230,230,230);">
                    <div onClick="DrillDown(this.id)" id="DrillDown[CodigoFatura]" class="btn-faturas row w100 pr02">
                        <div class="col w05">
                            <h1 class="txt-ac mt2">▼</h1>
                        </div>

                        <div class="col w90 pf10">
                            <h4 class="mb05">
                                Fatura <span class="ml03 b">Nº: [NumeroFatura]</span> <span class="ml05 mr05"> / </span> <span class="b">Cód.: [CodigoFatura]</span> <span class="float-r">Data: <span class="b">[DataFatura]</span></span>
                            </h4>
                            
                            <h4>
                                <span class="b">[CodigoCliente]</span>
                                <span class="b">[NomeCliente]</span>
                            </h4>
                        </div>
                    </div>
            </script>

                <script id="tempVenda" type="tempVenda">
                    <!--venda-->
                    <div class="DrillDown[ID_fatura] DrillDownExpand row w98 float-r mt1 mb1 linel lineb">
                        <h5 class="mb03">Venda <span class="b">Nº: [NumeroVenda]</span> <span class="ml05 mr05">/</span> <span class="b">Cód.: [CodigoVenda]</span></h5>

                        <!--cabeçalho-->
                        <div class="row w96 float-r mt01 mb02">
                            <ul class="list-col lineb">
                                <li class="col w15"> <p class="b i">Cód. Barras</p> </li>
                                <li class="col w50"> <p class="b i">Descrição</p> </li>
                                <li class="col w05"> <p class="b i txt-ac">Qtd.</p> </li>
                                <li class="col w10"> <p class="b i txt-ar">Valor R$</p> </li>
                                <li class="col w10"> <p class="b i txt-ar">Desconto R$</p> </li>
                                <li class="col w10"> <p class="b i txt-ar">Total R$</p> </li>
                            </ul>
                        </div>
                </script>


                    <script id="tempDeven" type="tempDeven">
                        <!--Devolução Venda-->
                        <div class="row w98 float-r mt05 mb05">
                            <h5>&#8627; Devolução <span class="ml05 b">[CodigoDevolucao]</span></h5>
                    </script>

                    <script id="tempDevenItens" type="tempDevenItens">
                        [#OpenTag]
                            <li class="col w15"> <h6 class="w100 txt-hidden"> [CodigoBarras] </h6> </li>
                            <li class="col w50"> <h6 class="w100 txt-hidden"> [DescricaoItem] </h6> </li>
                            <li class="col w05"> <h6 class="w100 txt-hidden txt-ac"> [Quantidade] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [SubTotal] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [DescontoSubTotal] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [Total] </h6> </li>
                        [#CloseTag]
                    </script>


                    <script id="tempEnvelope" type="tempEnvelope">
                        <!--envelopes-->
                        <div class="row w98 float-r mt05 mb05">
                            <h5>&#8627; Envelope <span class="b">Nº: [NumeroEnvelope]</span> <span class="ml05 b">[CodigoEnvelope]</span></h5>
                    </script>

                    <script id="tempEnvItens" type="tempEnvItens">
                        [#OpenTag]
                            <li class="col w15"> <h6 class="w100 txt-hidden"> [CodigoBarras] </h6> </li>
                            <li class="col w50"> <h6 class="w100 txt-hidden"> [DescricaoItem] </h6> </li>
                            <li class="col w05"> <h6 class="w100 txt-hidden txt-ac"> [Quantidade] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [SubTotal] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [DescontoSubTotal] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [Total] </h6> </li>
                        [#CloseTag]
                    </script>

                    <script id="tempOutItens" type="tempOutItens">
                        [#OpenTag]
                            <li class="col w15"> <h6 class="w100 txt-hidden"> [CodigoBarras] </h6> </li>
                            <li class="col w50"> <h6 class="w100 txt-hidden"> [DescricaoItem] </h6> </li>
                            <li class="col w05"> <h6 class="w100 txt-hidden txt-ac"> [Quantidade] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden txt-ar">    [SubTotal] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [DescontoSubTotal] </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [Total] </h6> </li>
                        [#CloseTag]
                    </script>


                    <script id="tempTotalizadorVenda" type="tempTotalizadorVenda">
                        <!--totalizador venda-->
                        <div class="row w96 float-r pt03 mb05">
                            <ul class="list-col linet">
                                <li class="col w65"> <h6 class="w100 txt-hidden b txt-ar">Total Venda <span class="ml03 b">Nº: [NumeroVenda]</span> <span class="ml05 mr05">/</span> <span class="b">Cód.: [CodigoVenda]</span> :</h6> </li>
                                <li class="col w05"> <h6 class="w100 txt-hidden b txt-ac"> [QuantidadeVenda] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [SubTotalVenda] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [DescontoVenda] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [TotalVenda] </h6> </li>
                            </ul>
                        </div>
                    </script>


                <script id="tempFormaPgto" type="tempFormaPgto">
                    [#OpenTag]
                        <h6 class="lineb mb03 mt03" style="border-left: 6px solid rgb(210,210,210);">
                            <span>[FormaDePgto]</span>
                            <span>[FormaDePgtoQtd]</span>
                            <span class="float-r b">[FormaDePgtoValor]</span>
                        </h6>
                    [#CloseTag]
                </script>


            <script id="tempTotalizadorFatura" type="tempTotalizadorFatura">
                <!--totalizador fatura-->
                <div class="row w95 float-r mt1 mb02">
                    <ul class="list-col">
                        <li class="col w65"> <h6 class="w100 txt-hidden b txt-ar">Total Fatura <span class="ml03 b">Nº: [NumeroFatura]</span> <span class="ml05 mr05"> / </span> <span class="b">Cód.: [CodigoFatura]</span>:</h6> </li>
                        <li class="col w05"> <h6 class="w100 txt-hidden b txt-ac"> [Quantidade] </h6> </li>
                        <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [SubTotal] </h6> </li>
                        <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [Desconto] </h6> </li>
                        <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [Total] </h6> </li>
                    </ul>
                </div>
            </script>

        <!--</div> tempEmpresa-->
    </head>

    <body>
        <div class="container">
            <!--titulo relatório-->
            <div class="row w100 txt-ac">
                <h4 class="b">Vendas Faturadas</h4>
            </div>

            <!--visualização-->
            <div class="col w78 pb02 pt02 lineb">
                <h5>Data de: <span id="data_de" class="b"></span> a <span id="data_ate" class="b"></span></h5>
            </div>
            <div class="col w22">
                <div class="float-r">
                    <h5 onClick="ViewerOFF(this.id)" class="btn-viewer">Sintético</h5>
                    <h5 onClick="ViewerON(this.id)" class="btn-viewer">Analitico</h5>
                </div>
            </div>


            <div id="PrintTemp"></div>

        </div><!--.end container-->

        <script>
            //Função DrillDown
            function DrillDown(id){
                $("."+id).stop().slideToggle("220ms");
            }//function

            function ViewerON(id){
                $(".DrillDownExpand").slideDown("220ms");
            }//ViewerON

            function ViewerOFF(id){
                $(".DrillDownExpand").slideUp("220ms");
            }//ViewerOFF


            $(document).ready(function() {

                //Connect DB
                var banco = getParameterByName("BancoDeDados");
                var usuario = getParameterByName("CodigoUsuario");
                var url = decodeURIComponent(getParameterByName("URLServidor"));

                //Get Filters
                var data_de = getParameterByName("DataDe").replaceAll('/', '-');
                var data_ate = getParameterByName("DataAte").replaceAll('/', '-');

                //Filtro Empresas
                var CodigoEmpresa = getParameterByName("CodigoEmpresa");
                if ((CodigoEmpresa == '') || (CodigoEmpresa == null) || (CodigoEmpresa == "null")) {
                    CodigoEmpresa = '%';
                }//if

                //Filtro Clientes
                var CodigoCliente = getParameterByName("CodigoCliente");
                if ((CodigoCliente == '') || (CodigoCliente == null) || (CodigoCliente == "null")) {
                    CodigoCliente = '%';
                }//if

                //Print Data de / Data ate
                $("#data_de").html(data_de.replaceAll('-','/'));
                $("#data_ate").html(data_ate.replaceAll('-','/'));


                //Empresas
                var dadosEmpresa = GeeksSQL(
                    " SELECT"
                        +" IsNull(C.CodigoContato, '') as CodigoEmpresa"
                        +" ,IsNull(C.Apelido, '') as NomeFantasia"
                    +" FROM Documento as Dfat"
                        +" LEFT JOIN FinanceiroTitulo as Ft ON(Ft.DocumentoCodigo = Dfat.CodigoDocumento) AND(isnull(Ft.ReceberPagar, 1) = 1)"
                        +" LEFT JOIN Contato as C ON(C.CodigoContato = Dfat.CodigoEmpresa)"
                    +" WHERE"
                        +" (Dfat.Tipo = 'Fatura')"
                        +" AND (Dfat.Status = 'Finalizada')"
                        +" AND ( (Convert(Date, Dfat.DataHoraFinalizado, 103) >= '"+data_de+"') AND (Convert(Date, Dfat.DataHoraFinalizado, 103) <= '"+data_ate+"') )"
                        +" AND (IsNull(Ft.CodigoFinanceiroPlanoConta, 139) = 139)"
                        +" AND (Dfat.CodigoEmpresa LIKE '"+CodigoEmpresa+"')"
                    +" GROUP BY C.CodigoContato, C.Apelido"
                , false, url, banco, usuario);

                $(dadosEmpresa.Records).each(function(index, rowEmp) {

                    //Recebe Estrutura HTML
                    var PrintTemplate = '';

                    //Template Empresa
                    var tempEmpresa = $("#tempEmpresa").html();
                
                    PrintTemplate += (
                        tempEmpresa
                            .replaceAll("[NomeEmpresa]", rowEmp.NomeFantasia)
                    );


                    //Fatura
                    var dadosFatura = GeeksSQL(
                        " SELECT"
                            +" IsNull(Dfat.CodigoDocumento, '') as CodigoFatura"
                            +" ,IsNull(Dfat.Numero, 0) as NumeroFatura"
                            +" ,IsNull(Convert(varchar(10), Dfat.DataHoraFinalizado, 103), '') as DataFinalizado"
                            +" ,IsNull(Convert(varchar(10), Dfat.DataHoraFinalizado, 103)+ ' ' + Convert(varchar(10), Dfat.DataHoraFinalizado, 108), '') as DataHoraFinalizado"
                            +" ,IsNull(Dfat.CodigoContato, '') as CodigoContato"
                            +" ,IsNull(Dfat.DescricaoContato, '') as NomeCliente"
                            +" ,IsNull(Dfat.SubTotal, 0) as SubTotal"
                            +" ,IsNull(Dfat.TotalDesconto, 0) as TotalDesconto"
                            +" ,IsNull(Dfat.TotalDocumento, 0) as TotalDocumento"
                        +" FROM Documento as Dfat"
                            +" LEFT JOIN FinanceiroTitulo as Ft ON(Ft.DocumentoCodigo = Dfat.CodigoDocumento) AND(isnull(Ft.ReceberPagar, 1) = 1)"
                        +" WHERE"
                            +" (Dfat.Tipo = 'Fatura')"
                            +" AND (Dfat.Status = 'Finalizada')"
                            +" AND ( (Convert(Date, Dfat.DataHoraFinalizado, 103) >= '"+data_de+"') AND (Convert(Date, Dfat.DataHoraFinalizado, 103) <= '"+data_ate+"') )"
                            +" AND (IsNull(Ft.CodigoFinanceiroPlanoConta, 139) = 139)"
                            +" AND (Dfat.CodigoEmpresa = "+rowEmp.CodigoEmpresa+")"
                            +" AND (Dfat.CodigoContato LIKE '"+CodigoCliente+"')"
                        +" GROUP BY"
                            +" Dfat.CodigoDocumento, Dfat.Numero, Dfat.DataHoraFinalizado, Dfat.CodigoContato, Dfat.DescricaoContato, Dfat.SubTotal, Dfat.TotalDesconto, Dfat.TotalDocumento"
                        +" ORDER BY"
                            +" Dfat.DataHoraFinalizado DESC, Dfat.Numero ASC"
                    , false, url, banco, usuario);

                    $(dadosFatura.Records).each(function(index, rowFat) {

                        //Template Fatura
                        var tempFatura = $("#tempFatura").html();

                        PrintTemplate += (
                            tempFatura
                                .replaceAll("[NumeroFatura]", (rowFat.NumeroFatura != "" ? rowFat.NumeroFatura : "&nbsp;"))
                                .replaceAll("[CodigoFatura]", (rowFat.CodigoFatura != "" ? rowFat.CodigoFatura : "&nbsp;"))
                                .replaceAll("[DataFatura]", (rowFat.DataHoraFinalizado != "" ? rowFat.DataHoraFinalizado : "&nbsp;"))
                                .replaceAll("[CodigoCliente]", '#'+(rowFat.CodigoContato != "" ? rowFat.CodigoContato : "$nbsp;"))
                                .replaceAll("[NomeCliente]", (rowFat.NomeCliente != "" ? rowFat.NomeCliente : "&nbsp;"))
                        );


                        //Venda
                        var dadosVenda = GeeksSQL(
                            " SELECT"
                                +" IsNull(Dv.CodigoFatura, '') as CodigoFatura"
                                +" ,IsNull(Dv.CodigoDocumento, '') as CodigoVenda"
                                +" ,IsNull(convert(varchar, Dv.Numero), '') as NumeroVenda"
                                +" ,IsNull(SubTotal, 0) as SubTotal"
                                +" ,IsNull(TotalDesconto, 0) as TotalDesconto"
                                +" ,IsNull(TotalDocumento, 0) as TotalDocumento"
                            +" FROM Documento as Dv"
                            +" WHERE"
                                +" (Dv.CodigoFatura = "+rowFat.CodigoFatura+")"
                                +" AND (Dv.Tipo = 'Venda')"
                            +" ORDER BY NumeroVenda"
                        , false, url, banco, usuario);

                        //Total Vendas
                        var 
                            QuantidadeVendas = 0
                            QuantidadeTotalVendas = 0
                            TotalVendas = 0
                        ;

                        $(dadosVenda.Records).each(function(index, rowVen) {

                            //Template Venda
                            var tempVenda = $("#tempVenda").html();

                            PrintTemplate += (
                                tempVenda
                                    .replaceAll("[ID_fatura]", (rowVen.CodigoFatura != "" ? rowVen.CodigoFatura : ""))
                                    .replaceAll("[NumeroVenda]", (rowVen.NumeroVenda != "" ? rowVen.NumeroVenda : "&nbsp;"))
                                    .replaceAll("[CodigoVenda]", (rowVen.CodigoVenda != "" ? rowVen.CodigoVenda : "&nbsp;"))
                            );


                                //Devolução (Dentro da venda)
                                var dadosDeven = GeeksSQL(
                                    " SELECT"
                                        +" IsNull(Dev.CodigoDocumentoAdicional, '') as CodigoVinculoDevolucao"
                                        +" ,IsNull(Dev.CodigoDocumento, '') as CodigoDevolucao"
                                    +" FROM Documento Dev"
                                    +" WHERE"
                                        +" Dev.Tipo='Devolução'"
                                        +" AND Dev.CodigoDocumentoAdicional = "+rowVen.CodigoVenda
                                , false, url, banco, usuario);

                                if(dadosDeven != null || dadosDeven != undefined) {

                                    $(dadosDeven.Records).each(function(index, rowDeven) {

                                        //Itens Devolução
                                        var dadosDevenItens = GeeksSQL(
                                            " SELECT"
                                                +" IsNull(It.CodigoItem, '') as CodigoItem,"
                                                +" IsNull(It.CodigoBarras, '') as CodigoBarras,"
                                                +" IsNull(It.Tipo, '') as Tipo,"
                                                +" IsNull(It.Marca, '') as Marca,"
                                                +" IsNull(It.Modelo, '') as Modelo,"
                                                +" IsNull(convert(varchar, It.Tamanho), '') as Tamanho,"
                                                +" IsNull(It.AmarcaoCor, '') as ArmacaoCor,"
                                                +" IsNull(It.Cor, '') as LenteCor,"
                                                +" (CASE"
                                                    +" WHEN((It.Tipo = 'Armação') OR(It.Tipo = 'Óculos Sol') OR(It.Tipo = 'Óculos Pronto'))"
                                                    +" THEN(CASE"
                                                            +" WHEN((IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.Tamanho), '')+' '+ IsNull(It.AmarcaoCor, '')) = '')"
                                                            +" THEN(IsNull(It.Marca, '')+' '+ IsNull(It.Descricao, ''))"
                                                            +" ELSE(IsNull(It.Marca, '')+' '+ IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.Tamanho), '')+' '+ IsNull(It.AmarcaoCor, ''))"
                                                        +" END)"
                                                    +" ELSE(CASE"
                                                            +" WHEN(IsNull(It.Descricao, '') = '')"
                                                            +" THEN(IsNull(It.Marca, '')+' '+ IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.IndiceRefracao), '')+' '+ IsNull(It.Cor, ''))"
                                                            +" ELSE(IsNull(It.Descricao, ''))"
                                                        +" END)"
                                                +" END) as DescricaoItem,"
                                                +" IsNull(Ditem.Quantidade, 0) as Quantidade,"
                                                +" IsNull(It.ValorVenda, 0) as ValorVendaUnitario,"
                                                +" IsNull(Ditem.SubTotal, 0) as Subtotal,"
                                                +" IsNull(Ditem.DescontoItem, 0) as DescontoSubTotal,"
                                                +" IsNull(Ditem.Total, 0) as Total"
                                            +" FROM DocumentoItem as Ditem"
                                                +" JOIN Item as It ON(Ditem.CodigoItem = It.CodigoItem)"
                                            +" WHERE"
                                                +" Ditem.CodigoDocumento ="+rowDeven.CodigoDevolucao
                                        ,false, url, banco, usuario);

                                        if(dadosDevenItens != null || dadosDevenItens != undefined) {

                                            //Temp Dev. Venda
                                            var tempDeven = $("#tempDeven").html();

                                            PrintTemplate += (
                                                tempDeven
                                                    .replaceAll("[CodigoDevolucao]", (rowDeven.CodigoDevolucao != '' ? ('Cód.: '+rowDeven.CodigoDevolucao) : ""))
                                            );


                                            //Temp Dev. Venda Itens
                                            var tempDevenItens = $("#tempDevenItens").html();

                                            PrintTemplate += (
                                                tempDevenItens
                                                    .replaceAll("[#OpenTag]", '<!--dev. itens--><div class="row w98 float-r"> <!--dev. produtos--><ul class="list-col mb01">')
                                                    .replaceAll("[CodigoBarras]", '')
                                                    .replaceAll("[DescricaoItem]", '')
                                                    .replaceAll("[Quantidade]", '')
                                                    .replaceAll("[SubTotal]", '')
                                                    .replaceAll("[DescontoSubTotal]",'')
                                                    .replaceAll("[Total]", '')
                                                    .replaceAll("[#CloseTag]", '')
                                            );

                                            $(dadosDevenItens.Records).each(function(index, rowDevenIt) {
                                                PrintTemplate += (
                                                    tempDevenItens
                                                        .replaceAll("[#OpenTag]", '')
                                                        .replaceAll("[CodigoBarras]", (rowDevenIt.CodigoBarras != "" ? rowDevenIt.CodigoBarras : "&nbsp;"))
                                                        .replaceAll("[DescricaoItem]", (rowDevenIt.DescricaoItem != "" ? rowDevenIt.DescricaoItem : "&nbsp;"))
                                                        .replaceAll("[Quantidade]", (rowDevenIt.Quantidade != 0 ? (rowDevenIt.Quantidade * -1) : "&nbsp;"))
                                                        .replaceAll("[SubTotal]", (rowDevenIt.Subtotal != 0 ? (rowDevenIt.Subtotal.toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                        .replaceAll("[DescontoSubTotal]", (rowDevenIt.DescontoSubTotal != 0 ? (rowDevenIt.DescontoSubTotal.toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                        .replaceAll("[Total]", (rowDevenIt.Total != 0 ? (rowDevenIt.Total.toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                        .replaceAll("[#CloseTag]", '')
                                                );

                                                //Total Venda Quantidade
                                                QuantidadeTotalVendas += (rowDevenIt.Quantidade * -1);
                                                QuantidadeVendas = (rowDevenIt.Quantidade * -1);
                                                TotalVendas += rowDevenIt.Total;

                                            });//Row Dev. Vendas Itens

                                            PrintTemplate += (
                                                tempDevenItens
                                                    .replaceAll("[#OpenTag]", '')
                                                    .replaceAll("[CodigoBarras]", '')
                                                    .replaceAll("[DescricaoItem]", '')
                                                    .replaceAll("[Quantidade]", '')
                                                    .replaceAll("[SubTotal]", '')
                                                    .replaceAll("[DescontoSubTotal]",'')
                                                    .replaceAll("[Total]", '')
                                                    .replaceAll("[#CloseTag]", '</ul><!--dev. itens--> </div><!--dev. produtos-->')
                                            );

                                            //Fecha Bloco Envelope
                                            PrintTemplate += ('</div><!--tempDeven-->');

                                        }//If Dev. Vendas Itens

                                    });//Row Dev. Vendas

                                }//If Dev. Vendas


                                //Envelope
                                var dadosEnvelope = GeeksSQL(
                                    " SELECT"
                                        +" IsNull(Di.CodigoDocumento, '') as CodigoDocumento"
                                        +" ,IsNull(Convert(Varchar, De.Numero), '') as NumeroEnvelope"
                                        +" ,IsNull(Convert(Varchar, De.CodigoDocumento), '') as CodigoEnvelope"
                                    +" FROM Documento Di"
                                        +" JOIN Documento De ON(De.CodigoDocumentoAdicional = Di.CodigoDocumento) AND (De.Tipo='Envelope')"
                                    +" WHERE"
                                        +" Di.Tipo='Item Venda'"
                                        +" AND Di.CodigoDocumentoAdicional = "+rowVen.CodigoVenda
                                    +" ORDER BY De.Numero Desc"
                                , false, url, banco, usuario);

                                if(dadosEnvelope != null || dadosEnvelope != undefined) {

                                    $(dadosEnvelope.Records).each(function(index, rowEnv) {

                                        //Itens Envelope
                                        var dadosEnvItens = GeeksSQL(
                                            " SELECT"
                                                +" IsNull(It.CodigoItem, '') as CodigoItem,"
                                                +" IsNull(It.CodigoBarras, '') as CodigoBarras,"
                                                +" IsNull(It.Tipo, '') as Tipo,"
                                                +" IsNull(It.Marca, '') as Marca,"
                                                +" IsNull(It.Modelo, '') as Modelo,"
                                                +" IsNull(convert(varchar, It.Tamanho), '') as Tamanho,"
                                                +" IsNull(It.AmarcaoCor, '') as ArmacaoCor,"
                                                +" IsNull(It.Cor, '') as LenteCor,"
                                                +" (CASE"
                                                    +" WHEN((It.Tipo = 'Armação') OR(It.Tipo = 'Óculos Sol') OR(It.Tipo = 'Óculos Pronto'))"
                                                    +" THEN(CASE"
                                                            +" WHEN((IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.Tamanho), '')+' '+ IsNull(It.AmarcaoCor, '')) = '')"
                                                            +" THEN(IsNull(It.Marca, '')+' '+ IsNull(It.Descricao, ''))"
                                                            +" ELSE(IsNull(It.Marca, '')+' '+ IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.Tamanho), '')+' '+ IsNull(It.AmarcaoCor, ''))"
                                                        +" END)"
                                                    +" ELSE(CASE"
                                                            +" WHEN(IsNull(It.Descricao, '') = '')"
                                                            +" THEN(IsNull(It.Marca, '')+' '+ IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.IndiceRefracao), '')+' '+ IsNull(It.Cor, ''))"
                                                            +" ELSE(IsNull(It.Descricao, ''))"
                                                        +" END)"
                                                +" END) as DescricaoItem,"
                                                +" IsNull(Ditem.Quantidade, 0) as Quantidade,"
                                                +" IsNull(It.ValorVenda, 0) as ValorVendaUnitario,"
                                                +" IsNull(Ditem.SubTotal, 0) as Subtotal,"
                                                +" IsNull(Ditem.DescontoItem, 0) as DescontoSubTotal,"
                                                +" IsNull(Ditem.Total, 0) as Total"
                                            +" FROM DocumentoItem as Ditem"
                                                +" JOIN Item as It ON(Ditem.CodigoItem = It.CodigoItem)"
                                            +" WHERE"
                                                +" Ditem.CodigoDocumento ="+rowEnv.CodigoDocumento
                                        , false, url, banco, usuario);

                                        if(dadosEnvItens != null || dadosEnvItens != undefined){

                                            //Temp Envelope
                                            var tempEnvelope = $("#tempEnvelope").html();

                                            PrintTemplate += (
                                                tempEnvelope
                                                    .replaceAll("[NumeroEnvelope]", (rowVen.NumeroVenda + (rowEnv.NumeroEnvelope != "" ? ('-'+rowEnv.NumeroEnvelope) : "")))
                                                    .replaceAll("[CodigoEnvelope]", (rowEnv.CodigoEnvelope != "" ? ('<span class="mr05">/</span> Cód.: '+rowEnv.CodigoEnvelope) : ""))
                                            );


                                            //Temp Env. Itens
                                            var tempEnvItens = $("#tempEnvItens").html();

                                            PrintTemplate += (
                                                tempEnvItens
                                                    .replaceAll("[#OpenTag]", '<!--itens--><div class="row w98 float-r"> <!--produtos--><ul class="list-col mb01">')
                                                    .replaceAll("[CodigoBarras]", '')
                                                    .replaceAll("[DescricaoItem]", '')
                                                    .replaceAll("[Quantidade]", '')
                                                    .replaceAll("[SubTotal]", '')
                                                    .replaceAll("[DescontoSubTotal]",'')
                                                    .replaceAll("[Total]", '')
                                                    .replaceAll("[#CloseTag]", '')
                                            );

                                            $(dadosEnvItens.Records).each(function(index, rowEnvIt) {
                                                PrintTemplate += (
                                                    tempEnvItens
                                                        .replaceAll("[#OpenTag]", '')
                                                        .replaceAll("[CodigoBarras]", (rowEnvIt.CodigoBarras != "" ? rowEnvIt.CodigoBarras : "&nbsp;"))
                                                        .replaceAll("[DescricaoItem]", (rowEnvIt.DescricaoItem != "" ? rowEnvIt.DescricaoItem : "&nbsp;"))
                                                        .replaceAll("[Quantidade]", (rowEnvIt.Quantidade != 0 ? rowEnvIt.Quantidade : "&nbsp;"))
                                                        .replaceAll("[SubTotal]", (rowEnvIt.Subtotal != 0 ? (rowEnvIt.Subtotal.toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                        .replaceAll("[DescontoSubTotal]", (rowEnvIt.DescontoSubTotal != 0 ? ((rowEnvIt.DescontoSubTotal * -1).toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                        .replaceAll("[Total]", (rowEnvIt.Total != 0 ? (rowEnvIt.Total.toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                        .replaceAll("[#CloseTag]", '')
                                                );

                                                //Total Venda Quantidade
                                                QuantidadeTotalVendas += rowEnvIt.Quantidade;
                                                QuantidadeVendas = rowEnvIt.Quantidade;
                                                TotalVendas += rowEnvIt.Total;

                                            });//Row Envelope Itens

                                            PrintTemplate += (
                                                tempEnvItens
                                                    .replaceAll("[#OpenTag]", '')
                                                    .replaceAll("[CodigoBarras]", '')
                                                    .replaceAll("[DescricaoItem]", '')
                                                    .replaceAll("[Quantidade]", '')
                                                    .replaceAll("[SubTotal]", '')
                                                    .replaceAll("[DescontoSubTotal]",'')
                                                    .replaceAll("[Total]", '')
                                                    .replaceAll("[#CloseTag]", '</ul><!--itens--> </div><!--produtos-->')
                                            );

                                            //Fecha Bloco Envelope
                                            PrintTemplate += ('</div><!--tempEnvelope-->');

                                        }//If Itens Envelope

                                    });//Row Envelopes

                                }//If Envelope


                                //Itens Avulsos
                                var dadosItensAvulsos = GeeksSQL(
                                    " SELECT"
                                        +" IsNull(It.CodigoItem, '') as CodigoItem,"
                                        +" IsNull(It.CodigoBarras, '') as CodigoBarras,"
                                        +" IsNull(It.Tipo, '') as Tipo,"
                                        +" IsNull(It.Marca, '') as Marca,"
                                        +" IsNull(It.Modelo, '') as Modelo,"
                                        +" IsNull(convert(varchar, It.Tamanho), '') as Tamanho,"
                                        +" IsNull(It.AmarcaoCor, '') as ArmacaoCor,"
                                        +" IsNull(It.Cor, '') as LenteCor,"
                                        +" (CASE"
                                            +" WHEN((It.Tipo = 'Armação') OR(It.Tipo = 'Óculos Sol') OR(It.Tipo = 'Óculos Pronto'))"
                                            +" THEN(CASE"
                                                    +" WHEN((IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.Tamanho), '')+' '+ IsNull(It.AmarcaoCor, '')) = '')"
                                                    +" THEN(IsNull(It.Marca, '')+' '+ IsNull(It.Descricao, ''))"
                                                    +" ELSE(IsNull(It.Marca, '')+' '+ IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.Tamanho), '')+' '+ IsNull(It.AmarcaoCor, ''))"
                                                +" END)"
                                            +" ELSE(CASE"
                                                    +" WHEN(IsNull(It.Descricao, '') = '')"
                                                    +" THEN(IsNull(It.Marca, '')+' '+ IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.IndiceRefracao), '')+' '+ IsNull(It.Cor, ''))"
                                                    +" ELSE(IsNull(It.Descricao, ''))"
                                                +" END)"
                                        +" END) as DescricaoItem,"
                                        +" IsNull(Ditem.Quantidade, 0) as Quantidade,"
                                        +" IsNull(It.ValorVenda, 0) as ValorVendaUnitario,"
                                        +" IsNull(Ditem.SubTotal, 0) as Subtotal,"
                                        +" IsNull(Ditem.DescontoItem, 0) as DescontoSubTotal,"
                                        +" IsNull(Ditem.Total, 0) as Total"
                                    +" FROM DocumentoItem as Ditem"
                                        +" JOIN Item as It ON(Ditem.CodigoItem = It.CodigoItem)"
                                        +" LEFT JOIN Documento Di ON(Di.CodigoDocumento = Ditem.CodigoDocumento)"
                                        +" LEFT JOIN Documento De ON(De.CodigoDocumentoAdicional = Di.CodigoDocumento) AND (De.Tipo='Envelope')"
                                    +" WHERE"
                                        +" De.CodigoDocumentoAdicional IS NULL"
                                        +" AND Di.Tipo='Item Venda'"
                                        +" AND Di.CodigoDocumentoAdicional = "+rowVen.CodigoVenda
                                , false, url, banco, usuario);

                                //Outros Itens
                                var dadosOutItens = GeeksSQL(
                                    " SELECT"
                                        +" 'OutrosItens' as DescricaoBloco,"
                                        +" IsNull(It.CodigoItem, '') as CodigoItem,"
                                        +" IsNull(It.CodigoBarras, '') as CodigoBarras,"
                                        +" IsNull(It.Tipo, '') as Tipo,"
                                        +" IsNull(It.Descricao, '') as DescricaoItem,"
                                        +" IsNull(Ditem.Quantidade, 0) as Quantidade,"
                                        +" IsNull(It.ValorVenda, 0) as ValorVendaUnitario,"
                                        +" IsNull(Ditem.SubTotal, 0) as Subtotal,"
                                        +" IsNull(Ditem.DescontoItem, 0) as DescontoSubTotal,"
                                        +" IsNull(Ditem.Total, 0) as Total"
                                    +" FROM DocumentoItem as Ditem"
                                        +" JOIN Item as It ON(Ditem.CodigoItem = It.CodigoItem)"
                                    +" WHERE"
                                        +" (Ditem.CodigoDocumento = "+rowVen.CodigoVenda+")"
                                , false, url, banco, usuario);

                                if((dadosOutItens.RecordsAffected > 0) || (dadosItensAvulsos.RecordsAffected > 0)){
                                    //Temp Outros Itens
                                    var tempOutItens = $("#tempOutItens").html();

                                    PrintTemplate += (
                                        tempOutItens
                                            .replaceAll("[#OpenTag]", '<!--tempOutItens--><div class="row w98 float-r mt05 mb05"> <h5>&#8627; Produtos contidos na venda</h5> <!--itens--><div class="row w98 float-r"> <!--produtos--><ul class="list-col mb01">')
                                            .replaceAll("[CodigoBarras]", '')
                                            .replaceAll("[DescricaoItem]", '')
                                            .replaceAll("[Quantidade]", '')
                                            .replaceAll("[SubTotal]", '')
                                            .replaceAll("[DescontoSubTotal]", '')
                                            .replaceAll("[Total]", '')
                                            .replaceAll("[#CloseTag]", '')
                                    );

                                    //Produtos que possuem Doc 'Item Venda' (Armação, Oc Sol, Oc Pronto...)
                                    if(dadosItensAvulsos != null || dadosItensAvulsos != undefined) {
                                        $(dadosItensAvulsos.Records).each(function(index, rowItAvu) {

                                            PrintTemplate += (
                                                tempOutItens
                                                    .replaceAll("[#OpenTag]", '')
                                                    .replaceAll("[CodigoBarras]", (rowItAvu.CodigoBarras != "" ? rowItAvu.CodigoBarras : "&nbsp;"))
                                                    .replaceAll("[DescricaoItem]", (rowItAvu.DescricaoItem != "" ? rowItAvu.DescricaoItem : "&nbsp;"))
                                                    .replaceAll("[Quantidade]", (rowItAvu.Quantidade != 0 ? rowItAvu.Quantidade : '.'))
                                                    .replaceAll("[SubTotal]", (rowItAvu.Subtotal != 0 ? (rowItAvu.Subtotal.toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                    .replaceAll("[DescontoSubTotal]", (rowItAvu.DescontoSubTotal != 0 ? ((rowItAvu.DescontoSubTotal * -1).toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                    .replaceAll("[Total]", (rowItAvu.Total != 0 ? (rowItAvu.Total.toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                    .replaceAll("[#CloseTag]", '')
                                            );

                                            //Total Venda Quantidade
                                            QuantidadeTotalVendas += rowItAvu.Quantidade;
                                            QuantidadeVendas = rowItAvu.Quantidade;
                                            TotalVendas += rowItAvu.Total;

                                        });//Row Itens Avulsos
                                    }//if Itens Avulsos

                                    //Produtos que estão somente na DocumentoItem
                                    if(dadosOutItens != null || dadosOutItens != undefined) {
                                        $(dadosOutItens.Records).each(function(index, rowOutIt) {

                                            PrintTemplate += (
                                                tempOutItens
                                                    .replaceAll("[#OpenTag]", '')
                                                    .replaceAll("[CodigoBarras]", (rowOutIt.CodigoBarras != 0 ? rowOutIt.CodigoBarras : "&nbsp;"))
                                                    .replaceAll("[DescricaoItem]", (rowOutIt.DescricaoItem != 0 ? rowOutIt.DescricaoItem : "&nbsp;"))
                                                    .replaceAll("[Quantidade]", (rowOutIt.Quantidade != 0 ? rowOutIt.Quantidade : '.'))
                                                    .replaceAll("[SubTotal]", (rowOutIt.Subtotal != 0 ? (rowOutIt.Subtotal.toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                    .replaceAll("[DescontoSubTotal]", (rowOutIt.DescontoSubTotal != 0 ? ((rowOutIt.DescontoSubTotal * -1).toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                    .replaceAll("[Total]", (rowOutIt.Total != 0 ? (rowOutIt.Total.toFixed(2).replace('.', ',')) : "&nbsp;"))
                                                    .replaceAll("[#CloseTag]", '')
                                            );

                                            //Total Venda Quantidade
                                            QuantidadeTotalVendas += rowOutIt.Quantidade;
                                            QuantidadeVendas = rowOutIt.Quantidade;
                                            TotalVendas += rowOutIt.Total;

                                        });//Row Outros Itens
                                    }//If Outros Itens

                                    PrintTemplate += (
                                        tempOutItens
                                            .replaceAll("[#OpenTag]", '')
                                            .replaceAll("[CodigoBarras]", '')
                                            .replaceAll("[DescricaoItem]", '')
                                            .replaceAll("[Quantidade]", '')
                                            .replaceAll("[SubTotal]", '')
                                            .replaceAll("[DescontoSubTotal]", '')
                                            .replaceAll("[Total]", '')
                                            .replaceAll("[#CloseTag]", '</ul><!--produtos--> </div><!--itens--> </div><!--tempOutItens-->')
                                    );
                                }//If Outros Itens


                            //Temp Totalizador das vendas
                            var tempTotalizadorVenda = $("#tempTotalizadorVenda").html();

                            PrintTemplate += (
                                tempTotalizadorVenda
                                    .replaceAll("[NumeroVenda]", (rowVen.NumeroVenda != 0 ? (rowVen.NumeroVenda) : ""))
                                    .replaceAll("[CodigoVenda]", (rowVen.CodigoVenda != 0 ? (rowVen.CodigoVenda) : ""))
                                    .replaceAll("[QuantidadeVenda]", (QuantidadeVendas != 0 ? (QuantidadeVendas) : "&nbsp;"))
                                    .replaceAll("[SubTotalVenda]", (rowVen.SubTotal != 0 ? (rowVen.SubTotal.toFixed(2).replace('.',',')) : "&nbsp;"))
                                    .replaceAll("[DescontoVenda]", (rowVen.TotalDesconto != 0 ? ((rowVen.TotalDesconto * -1).toFixed(2).replace('.',',')) : "&nbsp;"))
                                    .replaceAll("[TotalVenda]", (rowVen.TotalDocumento != 0 ? (rowVen.TotalDocumento.toFixed(2).replace('.',',')) : "&nbsp;"))
                            );

                            //Fecha Bloco Venda
                            PrintTemplate += ("</div><!--tempVenda-->");

                        });//Row Vendas


                        //Formas de Pagamento
                        var dadosFormasPgto = GeeksSQL(
                            " SELECT"
                                +" IsNull(Ft.DocumentoCodigo, '') CodigoFatura"
                                +" ,IsNull(Dfat.Numero, '') NumeroFatura"
                                +" ,IsNull(Ft.FormaDePagamento, '') FormaPagamento"
                                +" ,(CASE WHEN(count(*) > 1) THEN(convert(varchar, count(*)) +'x') ELSE('') END) as Parcelas"
                                +" ,SUM(IsNull(Ft.Valor, 0)) ValorPagamento"
                            +" FROM FinanceiroTitulo Ft"
                                +" INNER JOIN Documento as DFat ON(DFat.CodigoDocumento = Ft.DocumentoCodigo)"
                            +" WHERE"
                                +" DFat.Tipo = 'Fatura'"
                                +" AND Dfat.Status = 'Finalizada'"
                                +" AND Ft.CodigoFinanceiroPlanoConta = 139"
                                +" AND Ft.ReceberPagar = 1"
                                +" AND Ft.DocumentoCodigo = "+rowFat.CodigoFatura
                            +" GROUP BY Ft.DocumentoCodigo, Dfat.Numero, Ft.FormaDePagamento"
                        , false, url, banco, usuario);

                        if(dadosFormasPgto != null || dadosFormasPgto != undefined){
                            //Temp Fomra de Pagamento
                            var tempFormaPgto = $("#tempFormaPgto").html();

                            PrintTemplate += (
                                tempFormaPgto
                                    .replaceAll("[#OpenTag]", "<!--formas de pagamento--> <div class='DrillDown"+rowFat.CodigoFatura+" DrillDownExpand row w98 float-r mt1'> <h5 class='b mb05'>Formas de pagamento</h5> <div>")
                                    .replaceAll('class="lineb mb03 mt03" style="border-left: 6px solid rgb(210,210,210);"', '')
                                    .replaceAll("[FormaDePgto]",  '')
                                    .replaceAll("[FormaDePgtoQtd]", '')
                                    .replaceAll("[FormaDePgtoValor]", '')
                                    .replaceAll("[#CloseTag]", '')
                            );

                            //Crédito Cliente
                            if (TotalVendas < 0) {
                                PrintTemplate += (
                                    tempFormaPgto
                                        .replaceAll("[#OpenTag]", '')
                                        .replaceAll("[FormaDePgto]",  "Crédito acumulado pelo cliente")
                                        .replaceAll("[FormaDePgtoQtd]", "&nbsp;")
                                        .replaceAll("[FormaDePgtoValor]", (TotalVendas * -1).toFixed(2).replace('.', ','))
                                        .replaceAll("[#CloseTag]", '')
                                );
                            }//If Crédito Cliente

                            //Formas de pagamento
                            $(dadosFormasPgto.Records).each(function(index, rowFpgto){
                                PrintTemplate += (
                                    tempFormaPgto
                                        .replaceAll("[#OpenTag]", '')
                                        .replaceAll("[FormaDePgto]",  (rowFpgto.FormaPagamento != 0 ? rowFpgto.FormaPagamento : "&nbsp;"))
                                        .replaceAll("[FormaDePgtoQtd]", (rowFpgto.Parcelas != 0 ? rowFpgto.Parcelas : "&nbsp;"))
                                        .replaceAll("[FormaDePgtoValor]", (rowFpgto.ValorPagamento != 0 ? (rowFpgto.ValorPagamento.toFixed(2).replace('.', ',')) : "&nbsp;"))
                                        .replaceAll("[#CloseTag]", '')
                                );
                            });//Row Formas Pagamento

                            PrintTemplate += (
                                tempFormaPgto
                                    .replaceAll("[#OpenTag]", '')
                                    .replaceAll('class="lineb mb03 mt03" style="border-left: 6px solid rgb(210,210,210);"', '')
                                    .replaceAll("[FormaDePgto]",  '')
                                    .replaceAll("[FormaDePgtoQtd]", '')
                                    .replaceAll("[FormaDePgtoValor]", '')
                                    .replaceAll("[#CloseTag]", "</div> </div>")
                            );
                        }//If Formas Pgto


                        //Temp Totalizador da Fatura
                        var tempTotalizadorFatura = $("#tempTotalizadorFatura").html();

                        PrintTemplate += (
                            tempTotalizadorFatura
                                .replaceAll("[NumeroFatura]", rowFat.NumeroFatura)
                                .replaceAll("[CodigoFatura]", rowFat.CodigoFatura)
                                .replaceAll("[Quantidade]", (QuantidadeTotalVendas != 0 ? QuantidadeTotalVendas : "&nbsp;"))
                                .replaceAll("[SubTotal]", (rowFat.SubTotal != 0 ? (rowFat.SubTotal.toFixed(2).replace('.',',')) : "&nbsp;"))
                                .replaceAll("[Desconto]", (rowFat.TotalDesconto != 0 ? ((rowFat.TotalDesconto * -1).toFixed(2).replace('.',',')) : "&nbsp;"))
                                .replaceAll("[Total]", (rowFat.TotalDocumento != 0 ? (rowFat.TotalDocumento.toFixed(2).replace('.', ',')) : "&nbsp;"))
                        );


                        //Fecha Bloco Fatura
                        PrintTemplate += ("</div><!--tempFatura-->");

                    });//Row Fatura


                    //Fecha Bloco Empresa
                    PrintTemplate += ("<!--</div> tempEmpresa-->");

                    //Imprime na tela bloco a bloco
                    $("#PrintTemp").append(PrintTemplate);

                });//Row Empresa

            });//Script
        </script>
    </body>
</html>