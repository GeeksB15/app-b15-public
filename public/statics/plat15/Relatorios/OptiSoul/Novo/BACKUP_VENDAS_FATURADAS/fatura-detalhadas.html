<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Fatura Detalhadas</title>
	    <link rel="stylesheet" type="text/css" href="../optidados.framework.css"/>
		<script src="/Scripts/jquery-2.1.4.js"></script>
	    <script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
	    <script src="/Scripts/codigobarras.js"></script>
	    <script src="/Plugins/html2canvas.js"></script>

        <style type="text/css" media="print">
            @page {
                margin-top: 0.50cm;
                margin-right: 0.50cm;
                margin-bottom: 0.50cm;
                margin-left: 0.50cm;
            }

            .botao-apagar-parte {
                display: none;
            }
        </style>

        <style type="text/css">
            /*Visualizar Sintetico/Analitico*/
            #menu-sintetic-analitic,
            #menu-sintetic-analitic-item h6 {
                border-bottom: 1px solid rgb(210,210,210);
                border-left: 6px solid rgba(0,0,0,0);
                padding:  2px 5px 2px 5px;
                text-align: center;
                cursor: pointer;
                margin-bottom: 2px;
            }
            #menu-sintetic-analitic-item { display: none; }
            #menu-sintetic-analitic-item h6 { border-left: 6px solid rgb(210,210,210); }
        </style>

        <script type="text/javascript">
            //Visualizar Sintético/Analitico
            $(document).ready(function (){
                $("#menu-sintetic-analitic").click(function (){
                    $("#menu-sintetic-analitic-item").slideToggle("slow");
                })
            });
        </script>

        <script id="tempEmpresa" type="tempEmpresa">
            <!--empresa-->
            <div class="row w100 mt15">
                <h5 class="lineb" style="border-right: 10px solid rgb(210,210,210);">Empresa: <span class="b">[NomeEmpresa]</span></h5>
        </script>

            <script id="tempCliente" type="tempCliente">
                <!--cliente-->
                <div class="row w98 float-r linel lineb mt1 mb1">
                    <h5 class="lineb" style="margin-left: -1px;">
                        <span style="background-color: rgb(210,210,210); border: 2px solid rgb(210,210,210);">▼▲</span>
                        <span class="b">#[CodigoCliente]</span>
                        <span>[NomeCliente]</span>
                    </h5>
            </script>

                <script id="tempFatura" type="tempFatura">
                    <!--fatura-->
                    <div class="row w98 float-r mt15 mb1 linel lineb">
                        <h5 class="mb04">Fatura <span class="ml03 b">Nº: [NumeroFatura]</span> <span class="ml05 mr05"> / </span> <span class="b">Cód.: [CodigoFatura]</span> <span class="float-r b">Data: [DataFatura]</span> </h5>
                </script>

                    <script id="tempVenda" type="tempVenda">
                        <!--venda-->
                        <div class="row w98 float-r mt05 linel lineb">
                            <h5 class="mb03">Venda <span class="b">Nº: [NumeroVenda]</span> <span class="ml05 mr05">/</span> <span class="b">Cód.: [CodigoVenda]</span></h5>

                            <!--cabeçalho-->
                            <div class="row w96 float-r mt01 mb02">
                                <ul class="list-col lineb">
                                    <li class="col w15"> <p class="b i">Cód. Barras</p> </li>
                                    <li class="col w50"> <p class="b i">Descrição</p> </li>
                                    <li class="col w05"> <p class="b i txt-ac">Qtd.</p> </li>
                                    <li class="col w10"> <p class="b i txt-ar">Valor R$</p> </li>
                                    <li class="col w10"> <p class="b i txt-ar">Desconto R$</p> </li>
                                    <li class="col w10"> <p class="b i txt-ar">Total R$</p> </li>
                                </ul>
                            </div>
                    </script>


                        <script id="tempEnvelope" type="tempEnvelope">
                            <!--envelopes-->
                            <div class="row w98 float-r mt02 mb03">
                                <h5>&#8627; Envelope <span class="b">Nº: [NumeroEnvelope]</span> <span class="ml05 b">[CodigoEnvelope]</span></h5>
                        </script>

                        <script id="tempEnvItens" type="tempEnvItens">
                            [#OpenTag]
                                <li class="col w15"> <h6 class="w100 txt-hidden"> [CodigoBarras] </h6> </li>
                                <li class="col w50"> <h6 class="w100 txt-hidden"> [DescricaoItem] </h6> </li>
                                <li class="col w05"> <h6 class="w100 txt-hidden txt-ac"> [Quantidade] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [SubTotal] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [DescontoSubTotal] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [Total] </h6> </li>
                            [#CloseTag]
                        </script>

                        <script id="tempOutItens" type="tempOutItens">
                            [#OpenTag]
                                <li class="col w15"> <h6 class="w100 txt-hidden"> [CodigoBarras] </h6> </li>
                                <li class="col w50"> <h6 class="w100 txt-hidden"> [DescricaoItem] </h6> </li>
                                <li class="col w05"> <h6 class="w100 txt-hidden txt-ac"> [Quantidade] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden txt-ar">    [SubTotal] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [DescontoSubTotal] </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden txt-ar"> [Total] </h6> </li>
                            [#CloseTag]
                        </script>


                        <script id="tempTotalizadorVenda" type="tempTotalizadorVenda">
                            <!--totalizador itens-->
                            <div class="row w96 float-r pt02 mb05">
                                <ul class="list-col linet">
                                    <li class="col w65"> <h6 class="w100 txt-hidden b txt-ar">Total Itens:</h6> </li>
                                    <li class="col w05"> <h6 class="w100 txt-hidden b txt-ac"> [QtdProdutos] </h6> </li>
                                    <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [SubTotalProdutos] </h6> </li>
                                    <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [DescontoProdutos] </h6> </li>
                                    <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [TotalProdutos] </h6> </li>
                                </ul>
                            </div>

                            <!--totalizador venda-->
                            <div class="row w96 float-r pt02 mb04">
                                <ul class="list-col linet">
                                    <li class="col w65"> <h6 class="w100 txt-hidden b txt-ar">Total Venda <span class="ml03 b">Nº: [NumeroVenda]</span> <span class="ml05 mr05">/</span> <span class="b">Cód.: [CodigoVenda]</span> :</h6> </li>
                                    <li class="col w05"> <h6 class="w100 txt-hidden b txt-ac"> [QtdProdutos] </h6> </li>
                                    <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [SubTotalVenda] </h6> </li>
                                    <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [DescontoVenda] </h6> </li>
                                    <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [TotalVenda] </h6> </li>
                                </ul>
                            </div>
                        </script>


                    <script id="tempFormaPgto" type="tempFormaPgto">
                        [#OpenTag]
                            <h6 class="lineb mb04 pl03" style="border-left: 6px solid rgb(210,210,210);">
                                <span>[FormaDePgto]</span>
                                <span>[FormaDePgtoQtd]</span>
                                <span class="float-r b">[FormaDePgtoValor]</span>
                            </h6>
                        [#CloseTag]
                    </script>


                    <script id="tempTotalizadorFatura" type="tempTotalizadorFatura">
                        <!--totalizador fatura-->
                        <div class="row w95 float-r mt1 mb02">
                            <ul class="list-col">
                                <li class="col w65"> <h6 class="w100 txt-hidden b txt-ar">Total Fatura <span class="ml03 b">Nº: [NumeroFatura]</span> <span class="ml05 mr05"> / </span> <span class="b">Cód.: [CodigoFatura]</span>:</h6> </li>
                                <li class="col w05"> <h6 class="w100 txt-hidden b txt-ac"> [Quantidade] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [SubTotal] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [Desconto] </h6> </li>
                                <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [Total] </h6> </li>
                            </ul>
                        </div>
                    </script>


                <script id="tempTotalizadorCliente" type="tempTotalizadorCliente">
                    <!--totalizador cliente-->
                    <div class="row w93 float-r mt1 mb02">
                        <ul class="list-col">
                            <li class="col w65"> <h6 class="w100 txt-hidden b txt-ar">Total Cliente <span class="ml03 b">#[CodigoCliente]</span>:</h6> </li>
                            <li class="col w05"> <h6 class="w100 txt-hidden b txt-ac"> [Quantidade] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [SubTotal] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [Desconto] </h6> </li>
                            <li class="col w10"> <h6 class="w100 txt-hidden b txt-ar"> [Total] </h6> </li>
                        </ul>
                    </div>
                </script>
        <!--</div> tempCliente-->
        <!--</div> tempEmpresa-->
	</head>

	<body>
		<div class="container">

            <!--abertura-->
            <div class="col w50">
                <img style="width: 40px; height: 20px;" src="optsoul-exemplo.png">
            </div>
            <div class="row w50 txt-ar">
                <h6>20/02/2018</h6>
            </div>

            <!--titulo relatório-->
            <div class="row w100 txt-ac">
                <h4 class="b">Fatura Detalhadas</h4>
            </div>

            <!--visualização-->
            <div class="col w20">
                <h5 class="" id="menu-sintetic-analitic">Visualizar</h5>
                <div id="menu-sintetic-analitic-item">
                    <h6>Sintético</h6>
                    <h6>Analitico</h6>
                </div>
            </div>
            <div class="col w80 pb02 pt02 lineb txt-ar">
                <h5>Data de: <span>01/01/2018</span> á: <span>31/01/2018</span></h5>
            </div>

            <div id="PrintTemp"></div>

		</div><!--.end container-->

		<script>
			$(document).ready(function() {

                //Connect DB
                var banco = getParameterByName("BancoDeDados");
                var usuario = getParameterByName("CodigoUsuario");
                var url = decodeURIComponent(getParameterByName("URLServidor"));

                //Get Filters
                var data_de = '19/07/2018';
                var data_ate = '19/07/2018';
                var Empresa = '%';
                var Contato = '%';
                var CodigoFatura = '%';
                /*NumeroFatura = '%';*/

                /*
                	//FILTROS DO SQL
					
					DECLARE @data_de DATE;
					SET @data_de = '01-01-2018';

					DECLARE @data_ate DATE;
					SET @data_ate = '26-02-2018';

					DECLARE @Empresa Varchar(10);
					SET @Empresa = '%';

					DECLARE @Contato Varchar(10);
					SET @Contato = '%';

					DECLARE @CodigoFatura Varchar(10);
					SET @CodigoFatura = '%';

					DECLARE @NumeroFatura Varchar(10);
					SET @NumeroFatura = '%';
				*/



                //Template
                // var tempEmpresa = $("#tempEmpresa").html();
                // PrintTemplate += (
                //     tempEmpresa
                //         .replaceAll("[NomeEmpresa]", rowFil.NomeEmpresa)
                // );

                //Clientes
                var dadosCliente = GeeksSQL(
                    " SELECT"
                        +" IsNull(C.CodigoContato, '') CodigoContato"
                        +" ,IsNull(C.Nome, '') NomeCliente"
                    +" FROM Documento as Dfat"
                        +" LEFT JOIN FinanceiroTitulo Ft ON(Ft.DocumentoCodigo = Dfat.CodigoDocumento)"
                        +" LEFT JOIN Contato C ON(C.CodigoContato = Dfat.CodigoContato)"
                    +" WHERE"
                        +" (Dfat.Tipo = 'Fatura')"
                        +" AND (Dfat.Status = 'Finalizada')"
                        +" AND (Ft.CodigoFinanceiroPlanoConta = 139)"
                        +" AND ( (Convert(Date, Dfat.DataHoraFinalizado, 103) >= '"+data_de+"') AND (Convert(Date, Dfat.DataHoraFinalizado, 103) <= '"+data_ate+"') )"
                        +" AND (Dfat.CodigoEmpresa LIKE '%')"
                        +" AND (Dfat.CodigoContato LIKE '%')"
                    +" GROUP BY C.CodigoContato, C.Nome"
                , false, url, banco, usuario);

                $(dadosCliente.Records).each(function(index, rowCli) {

                    //Recebe Estrutura HTML
                    var PrintTemplate = '';

                    //Template Cliente
                    var tempCliente = $("#tempCliente").html();

                    PrintTemplate += (
                        tempCliente
                            .replaceAll("[CodigoCliente]", rowCli.CodigoContato)
                            .replaceAll("[NomeCliente]", rowCli.NomeCliente)
                    );

                    //Totalizadores das Faturas do Cliente
                    var QuantidadeFaturas = 0;
                    var SubTotalFaturas = 0;
                    var DescontoFaturas = 0;
                    var TotalFaturas = 0;


    				//Filtro
                    var dadosFiltro = GeeksSQL(
                        " SELECT"
                            +" IsNull(Dfat.CodigoDocumento, '') as CodigoFatura"
                        +" FROM Documento as Dfat"
                            +" LEFT JOIN FinanceiroTitulo Ft ON(Ft.DocumentoCodigo = Dfat.CodigoDocumento)"
                        +" WHERE"
                            +" (Dfat.Tipo = 'Fatura')"
                            +" AND (Dfat.Status = 'Finalizada')"
                            +" AND (Ft.CodigoFinanceiroPlanoConta = 139)"
                            +" AND ( (Convert(Date, Dfat.DataHoraFinalizado, 103) >= '"+data_de+"') AND (Convert(Date, Dfat.DataHoraFinalizado, 103) <= '"+data_ate+"') )"
                            +" AND (Dfat.CodigoEmpresa LIKE '%')"
                            +" AND (Dfat.CodigoContato = "+rowCli.CodigoContato+")"
                            +" AND (Dfat.CodigoDocumento LIKE '%')"
                        +" GROUP BY Dfat.CodigoDocumento"
                	, false, url, banco, usuario);

                    $(dadosFiltro.Records).each(function(index, rowFil) {

        				//Fatura
        				var dadosFatura = GeeksSQL(
                            " SELECT"
                                +" IsNull(Dfat.CodigoDocumento, '') as CodigoFatura"
                                +" ,IsNull(Dfat.Numero, 0) as NumeroFatura"
                                +" ,IsNull(Convert(varchar(10), Dfat.DataHoraFinalizado, 103), '') as DataFinalizado"
                                +" ,IsNull(Convert(varchar(10), Dfat.DataHoraFinalizado, 103)+ ' ' + Convert(varchar(10), Dfat.DataHoraFinalizado, 108), '') as DataHoraFinalizado"
                                +" ,SUM(IsNull(Ft.ValorARealizar, 0)) as TotalFatura"
                            +" FROM Documento as Dfat"
                                +" LEFT JOIN FinanceiroTitulo Ft ON(Ft.DocumentoCodigo = DFat.CodigoDocumento)"
                            +" WHERE"
                                +" (Dfat.Tipo = 'Fatura')"
                                +" AND (Dfat.Status = 'Finalizada')"
                                +" AND (Ft.CodigoFinanceiroPlanoConta = 139)"
                                +" AND (Ft.ReceberPagar = 1)"
                                +" AND (IsNull(Ft.CodigoFatura, '') = '')"
                                +" AND (Dfat.CodigoDocumento = "+rowFil.CodigoFatura+")"
                            +" GROUP BY"
                                +" Dfat.CodigoDocumento, Dfat.Numero, Dfat.DataHoraFinalizado"
                            +" ORDER BY"
                                +" Dfat.DataHoraFinalizado DESC, Dfat.Numero ASC"
        				, false, url, banco, usuario);

                        $(dadosFatura.Records).each(function(index, rowFat) {

                            //Template Fatura
                            var tempFatura = $("#tempFatura").html();

                            PrintTemplate += (
                                tempFatura
                                    .replaceAll("[NumeroFatura]", rowFat.NumeroFatura)
                                    .replaceAll("[CodigoFatura]", rowFat.CodigoFatura)
                                    .replaceAll("[DataFatura]", rowFat.DataHoraFinalizado)
                            );


            				//Venda
            				var dadosVenda = GeeksSQL(
            					" SELECT"
                                    +" IsNull(Dv.CodigoFatura, '') as CodigoFatura,"
                                    +" IsNull(Dv.CodigoDocumento, '') as CodigoVenda,"
                                    +" IsNull(convert(varchar, Dv.Numero), '') as NumeroVenda,"
                                    +" IsNull(SUM_Dv.SUMQuantidade, 0) + IsNull(SUM_Outros.SUMQuantidade, 0) as QuantidadeProdutos,"
                                    +" IsNull(SUM_Dv.SUMSubTotal, 0.000) + IsNull(SUM_Outros.SUMSubTotal, 0.000) as SubTotalProdutos,"
                                    +" IsNull(SUM_Dv.SUMDescontoSubTotal, 0.000) + IsNull(SUM_Outros.SUMDescontoSubTotal, 0.000) as DescontoProdutos,"
                                    +" IsNull(SUM_Dv.SUMTotal, 0.000) + IsNull(SUM_Outros.SUMTotal, 0.000) as TotalProdutos,"
                                    +" IsNull(Dv.SubTotal, 0) as SubTotalVenda,"
                                    +" IsNull(Dv.TotalDesconto, 0) as DescontoVenda,"
                                    +" IsNull(Dv.TotalDocumento,0) as TotalVenda"
                                +" FROM Documento as Dv"
                                    +" LEFT JOIN("
                                        +" SELECT"
                                            +" IsNull(Dv.CodigoDocumento, '') as CodigoDocumento,"
                                            +" SUM(IsNull(Ditem.Quantidade, 0)) as SUMQuantidade,"
                                            +" SUM(IsNull(Ditem.SubTotal, 0)) as SUMSubTotal,"
                                            +" SUM(IsNull(Ditem.DescontoItem, 0)) as SUMDescontoSubTotal,"
                                            +" SUM(IsNull(Ditem.Total, 0)) as SUMTotal"
                                        +" FROM Documento as Dv"
                                            +" JOIN Documento as Di ON(Di.CodigoDocumentoAdicional = Dv.CodigoDocumento) "
                                            +" JOIN DocumentoItem as Ditem ON(Di.CodigoDocumento = Ditem.CodigoDocumento)"
                                            +" JOIN Item as It ON(Ditem.CodigoItem = It.CodigoItem)"
                                        +" WHERE"
                                            +" (Dv.CodigoFatura = "+rowFat.CodigoFatura+")"
                                            +" AND(Dv.Tipo = 'Venda')"
                                            +" AND(Di.Tipo = 'Item Venda')"
                                        +" GROUP BY Dv.CodigoDocumento"
                                    +" ) as SUM_Dv ON(Dv.CodigoDocumento = SUM_Dv.CodigoDocumento)"
                                    +" LEFT JOIN("
                                        +" SELECT"
                                            +" IsNull(Dv.CodigoDocumento, '') as CodigoDocumento,"
                                            +" SUM(IsNull(Ditem.Quantidade, 0)) as SUMQuantidade,"
                                            +" SUM(IsNull(Ditem.SubTotal, 0)) as SUMSubtotal,"
                                            +" SUM(IsNull(Ditem.DescontoItem, 0)) as SUMDescontoSubTotal,"
                                            +" SUM(IsNull(Ditem.Total, 0)) as SUMTotal"
                                        +" FROM Documento as Dv"
                                            +" JOIN DocumentoItem as Ditem ON(Ditem.CodigoDocumento = Dv.CodigoDocumento)"
                                            +" JOIN Item as It ON(Ditem.CodigoItem = It.CodigoItem)"
                                        +" WHERE"
                                            +" (Dv.CodigoFatura = "+rowFat.CodigoFatura+")"
                                            +" AND (Dv.Tipo = 'Venda')"
                                        +" GROUP BY Dv.CodigoDocumento"
                                    +" ) as SUM_Outros ON(Dv.CodigoDocumento = SUM_Outros.CodigoDocumento)"
                                +" WHERE"
                                    +" (Dv.CodigoFatura = "+rowFat.CodigoFatura+")"
                                    +" AND (Dv.Tipo = 'Venda')"
                                +" ORDER BY NumeroVenda"
            				, false, url, banco, usuario);

                            //Total Vendas
                            var QuantidadeVendas = 0;
                            var SubTotalVendas = 0;
                            var TotalVendas = 0;

                            $(dadosVenda.Records).each(function(index, rowVen) {

                                //Template Venda
                                var tempVenda = $("#tempVenda").html();

                                PrintTemplate += (
                                    tempVenda
                                        .replaceAll("[NumeroVenda]", rowVen.NumeroVenda)
                                        .replaceAll("[CodigoVenda]", rowVen.CodigoVenda)
                                );


                    				//Envelope
                    				var dadosEnvelope = GeeksSQL(
                    					" SELECT"
                                            +" IsNull(Di.CodigoDocumento, '') as CodigoDocumento"
                                            +" ,IsNull(Convert(Varchar, De.Numero), '') as NumeroEnvelope"
                                            +" ,IsNull(Convert(Varchar, De.CodigoDocumento), '') as CodigoEnvelope"
                                        +" FROM Documento Di"
                                            +" JOIN Documento De ON(De.CodigoDocumentoAdicional = Di.CodigoDocumento) AND (De.Tipo='Envelope')"
                                        +" WHERE"
                                            +" Di.Tipo='Item Venda'"
                                            +" AND Di.CodigoDocumentoAdicional = "+rowVen.CodigoVenda
                                        +" ORDER BY De.Numero Desc"
                    				, false, url, banco, usuario);

                                    $(dadosEnvelope.Records).each(function(index, rowEnv) {

                                        //Itens Envelope
                                        var dadosEnvItens = GeeksSQL(
                                            " SELECT"
                                                +" IsNull(It.CodigoItem, '') as CodigoItem,"
                                                +" IsNull(It.CodigoBarras, '') as CodigoBarras,"
                                                +" IsNull(It.Tipo, '') as Tipo,"
                                                +" IsNull(It.Marca, '') as Marca,"
                                                +" IsNull(It.Modelo, '') as Modelo,"
                                                +" IsNull(convert(varchar, It.Tamanho), '') as Tamanho,"
                                                +" IsNull(It.AmarcaoCor, '') as ArmacaoCor,"
                                                +" IsNull(It.Cor, '') as LenteCor,"
                                                +" (CASE"
                                                    +" WHEN((It.Tipo = 'Armação') OR(It.Tipo = 'Óculos Sol') OR(It.Tipo = 'Óculos Pronto'))"
                                                    +" THEN(CASE"
                                                            +" WHEN((IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.Tamanho), '')+' '+ IsNull(It.AmarcaoCor, '')) = '')"
                                                            +" THEN(IsNull(It.Marca, '')+' '+ IsNull(It.Descricao, ''))"
                                                            +" ELSE(IsNull(It.Marca, '')+' '+ IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.Tamanho), '')+' '+ IsNull(It.AmarcaoCor, ''))"
                                                        +" END)"
                                                    +" ELSE(CASE"
                                                            +" WHEN(IsNull(It.Descricao, '') = '')"
                                                            +" THEN(IsNull(It.Marca, '')+' '+ IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.IndiceRefracao), '')+' '+ IsNull(It.Cor, ''))"
                                                            +" ELSE(IsNull(It.Descricao, ''))"
                                                        +" END)"
                                                +" END) as DescricaoItem,"
                                                +" IsNull(Ditem.Quantidade, 0) as Quantidade,"
                                                +" IsNull(It.ValorVenda, 0) as ValorVendaUnitario,"
                                                +" IsNull(Ditem.SubTotal, 0) as Subtotal,"
                                                +" IsNull(Ditem.DescontoItem, 0) as DescontoSubTotal,"
                                                +" IsNull(Ditem.Total, 0) as Total"
                                            +" FROM DocumentoItem as Ditem"
                                                +" JOIN Item as It ON(Ditem.CodigoItem = It.CodigoItem)"
                                            +" WHERE"
                                                +" Ditem.CodigoDocumento ="+rowEnv.CodigoDocumento
                                        , false, url, banco, usuario);

                                        if(dadosEnvItens.RecordsAffected > 0){

                                            //Temp Envelope
                                            var tempEnvelope = $("#tempEnvelope").html();

                                            PrintTemplate += (
                                                tempEnvelope
                                                    .replaceAll("[NumeroEnvelope]", rowVen.NumeroVenda + (rowEnv.NumeroEnvelope && rowEnv.NumeroEnvelope != null && rowEnv.NumeroEnvelope != "null" ? '-'+rowEnv.NumeroEnvelope : ''))
                                                    .replaceAll("[CodigoEnvelope]", (rowEnv.CodigoEnvelope && rowEnv.CodigoEnvelope != null && rowEnv.CodigoEnvelope != "null" ? '<span class="mr05">/</span> Cód.: '+rowEnv.CodigoEnvelope : ''))

                                            );

                                            //Temp Env. Itens
                                            var tempEnvItens = $("#tempEnvItens").html();

                                            PrintTemplate += (
                                                tempEnvItens
                                                    .replaceAll("[#OpenTag]", '<!--itens--><div class="row w98 float-r"> <!--produtos--><ul class="list-col mb01">')
                                                    .replaceAll("[CodigoBarras]", '')
                                                    .replaceAll("[DescricaoItem]", '')
                                                    .replaceAll("[Quantidade]", '')
                                                    .replaceAll("[SubTotal]", '')
                                                    .replaceAll("[DescontoSubTotal]",'')
                                                    .replaceAll("[Total]", '')
                                                    .replaceAll("[#CloseTag]", '')
                                            );

                                            $(dadosEnvItens.Records).each(function(index, rowEnvIt) {
                                                PrintTemplate += (
                                                    tempEnvItens
                                                        .replaceAll("[#OpenTag]", '')
                                                        .replaceAll("[CodigoBarras]", (rowEnvIt.CodigoBarras && rowEnvIt.CodigoBarras != null && rowEnvIt.CodigoBarras != "null" ? rowEnvIt.CodigoBarras : '.'))
                                                        .replaceAll("[DescricaoItem]", (rowEnvIt.DescricaoItem && rowEnvIt.DescricaoItem != null && rowEnvIt.DescricaoItem != "null" ? rowEnvIt.DescricaoItem : '.'))
                                                        .replaceAll("[Quantidade]", (rowEnvIt.Quantidade && rowEnvIt.Quantidade != null && rowEnvIt.Quantidade != "null" ? rowEnvIt.Quantidade : '.'))
                                                        .replaceAll("[SubTotal]", (rowEnvIt.Subtotal && rowEnvIt.Subtotal != null && rowEnvIt.Subtotal != "null" ? (rowEnvIt.Subtotal.toFixed(2).replace('.', ',')) : '.'))
                                                        .replaceAll("[DescontoSubTotal]", (rowEnvIt.DescontoSubTotal && rowEnvIt.DescontoSubTotal != null && rowEnvIt.DescontoSubTotal != "null" ? ('- '+rowEnvIt.DescontoSubTotal.toFixed(2).replace('.', ',')) : '.'))
                                                        .replaceAll("[Total]", (rowEnvIt.Total && rowEnvIt.Total != null && rowEnvIt.Total != "null" ? (rowEnvIt.Total.toFixed(2).replace('.', ',')) : '.'))
                                                        .replaceAll("[#CloseTag]", '')
                                                );
                                            });//Row Envelope Itens

                                            PrintTemplate += (
                                                tempEnvItens
                                                    .replaceAll("[#OpenTag]", '')
                                                    .replaceAll("[CodigoBarras]", '')
                                                    .replaceAll("[DescricaoItem]", '')
                                                    .replaceAll("[Quantidade]", '')
                                                    .replaceAll("[SubTotal]", '')
                                                    .replaceAll("[DescontoSubTotal]",'')
                                                    .replaceAll("[Total]", '')
                                                    .replaceAll("[#CloseTag]", '</ul><!--itens--> </div><!--produtos-->')
                                            );

                                            //Fecha Bloco Envelope
                                            PrintTemplate += ('</div><!--tempEnvelope-->');

                                        }//If Itens Envelope

                                    });//Row Envelopes


                                    //Itens Avulsos
                                    var dadosItensAvulsos = GeeksSQL(
                                        " SELECT"
                                            +" IsNull(It.CodigoItem, '') as CodigoItem,"
                                            +" IsNull(It.CodigoBarras, '') as CodigoBarras,"
                                            +" IsNull(It.Tipo, '') as Tipo,"
                                            +" IsNull(It.Marca, '') as Marca,"
                                            +" IsNull(It.Modelo, '') as Modelo,"
                                            +" IsNull(convert(varchar, It.Tamanho), '') as Tamanho,"
                                            +" IsNull(It.AmarcaoCor, '') as ArmacaoCor,"
                                            +" IsNull(It.Cor, '') as LenteCor,"
                                            +" (CASE"
                                                +" WHEN((It.Tipo = 'Armação') OR(It.Tipo = 'Óculos Sol') OR(It.Tipo = 'Óculos Pronto'))"
                                                +" THEN(CASE"
                                                        +" WHEN((IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.Tamanho), '')+' '+ IsNull(It.AmarcaoCor, '')) = '')"
                                                        +" THEN(IsNull(It.Marca, '')+' '+ IsNull(It.Descricao, ''))"
                                                        +" ELSE(IsNull(It.Marca, '')+' '+ IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.Tamanho), '')+' '+ IsNull(It.AmarcaoCor, ''))"
                                                    +" END)"
                                                +" ELSE(CASE"
                                                        +" WHEN(IsNull(It.Descricao, '') = '')"
                                                        +" THEN(IsNull(It.Marca, '')+' '+ IsNull(It.Modelo, '')+' '+ IsNull(convert(varchar, It.IndiceRefracao), '')+' '+ IsNull(It.Cor, ''))"
                                                        +" ELSE(IsNull(It.Descricao, ''))"
                                                    +" END)"
                                            +" END) as DescricaoItem,"
                                            +" IsNull(Ditem.Quantidade, 0) as Quantidade,"
                                            +" IsNull(It.ValorVenda, 0) as ValorVendaUnitario,"
                                            +" IsNull(Ditem.SubTotal, 0) as Subtotal,"
                                            +" IsNull(Ditem.DescontoItem, 0) as DescontoSubTotal,"
                                            +" IsNull(Ditem.Total, 0) as Total"
                                        +" FROM DocumentoItem as Ditem"
                                            +" JOIN Item as It ON(Ditem.CodigoItem = It.CodigoItem)"
                                            +" LEFT JOIN Documento Di ON(Di.CodigoDocumento = Ditem.CodigoDocumento)"
                                            +" LEFT JOIN Documento De ON(De.CodigoDocumentoAdicional = Di.CodigoDocumento) AND (De.Tipo='Envelope')"
                                        +" WHERE"
                                            +" De.CodigoDocumentoAdicional IS NULL"
                                            +" AND Di.Tipo='Item Venda'"
                                            +" AND Di.CodigoDocumentoAdicional = "+rowVen.CodigoVenda
                                    , false, url, banco, usuario);

                                    //Outros Itens
                                    var dadosOutItens = GeeksSQL(
                                        " SELECT"
                                            +" 'OutrosItens' as DescricaoBloco,"
                                            +" IsNull(It.CodigoItem, '') as CodigoItem,"
                                            +" IsNull(It.CodigoBarras, '') as CodigoBarras,"
                                            +" IsNull(It.Tipo, '') as Tipo,"
                                            +" IsNull(It.Descricao, '') as DescricaoItem,"
                                            +" IsNull(Ditem.Quantidade, 0) as Quantidade,"
                                            +" IsNull(It.ValorVenda, 0) as ValorVendaUnitario,"
                                            +" IsNull(Ditem.SubTotal, 0) as Subtotal,"
                                            +" IsNull(Ditem.DescontoItem, 0) as DescontoSubTotal,"
                                            +" IsNull(Ditem.Total, 0) as Total"
                                        +" FROM DocumentoItem as Ditem"
                                            +" JOIN Item as It ON(Ditem.CodigoItem = It.CodigoItem)"
                                        +" WHERE"
                                            +" (Ditem.CodigoDocumento = "+rowVen.CodigoVenda+")"
                                    , false, url, banco, usuario);

                                    if((dadosOutItens.RecordsAffected > 0) || (dadosItensAvulsos.RecordsAffected > 0)){
                                        //Temp Outros Itens
                                        var tempOutItens = $("#tempOutItens").html();

                                        PrintTemplate += (
                                            tempOutItens
                                                .replaceAll("[#OpenTag]", '<!--tempOutItens--><div class="row w98 float-r mt02 mb03"> <h5>&#8627; Produtos contidos na venda</h5> <!--itens--><div class="row w98 float-r"> <!--produtos--><ul class="list-col mb01">')
                                                .replaceAll("[CodigoBarras]", '')
                                                .replaceAll("[DescricaoItem]", '')
                                                .replaceAll("[Quantidade]", '')
                                                .replaceAll("[SubTotal]", '')
                                                .replaceAll("[DescontoSubTotal]", '')
                                                .replaceAll("[Total]", '')
                                                .replaceAll("[#CloseTag]", '')
                                        );

                                        //Produtos que possuem Doc 'Item Venda' (Armação, Oc Sol, Oc Pronto...)
                                        $(dadosItensAvulsos.Records).each(function(index, rowItAvu) {
                                            PrintTemplate += (
                                                tempOutItens
                                                    .replaceAll("[#OpenTag]", '')
                                                    .replaceAll("[CodigoBarras]", (rowItAvu.CodigoBarras && rowItAvu.CodigoBarras != null && rowItAvu.CodigoBarras != "null" ? rowItAvu.CodigoBarras : '.'))
                                                    .replaceAll("[DescricaoItem]", (rowItAvu.DescricaoItem && rowItAvu.DescricaoItem != null && rowItAvu.DescricaoItem != "null" ? rowItAvu.DescricaoItem : '.'))
                                                    .replaceAll("[Quantidade]", (rowItAvu.Quantidade && rowItAvu.Quantidade != null && rowItAvu.Quantidade != "null" ? rowItAvu.Quantidade : '.'))
                                                    .replaceAll("[SubTotal]", (rowItAvu.Subtotal && rowItAvu.Subtotal != null && rowItAvu.Subtotal != "null" ? (rowItAvu.Subtotal.toFixed(2).replace('.', ',')) : '.'))
                                                    .replaceAll("[DescontoSubTotal]", (rowItAvu.DescontoSubTotal && rowItAvu.DescontoSubTotal != null && rowItAvu.DescontoSubTotal != "null" ? ('- '+rowItAvu.DescontoSubTotal.toFixed(2).replace('.', ',')) : '.'))
                                                    .replaceAll("[Total]", (rowItAvu.Total && rowItAvu.Total != null && rowItAvu.Total != "null" ? (rowItAvu.Total.toFixed(2).replace('.', ',')) : '.'))
                                                    .replaceAll("[#CloseTag]", '')
                                            );
                                        });//Row Itens Avulsos

                                        //Produtos que estão somente na DocumentoItem
                                        $(dadosOutItens.Records).each(function(index, rowOutIt) {
                                            PrintTemplate += (
                                                tempOutItens
                                                    .replaceAll("[#OpenTag]", '')
                                                    .replaceAll("[CodigoBarras]", (rowOutIt.CodigoBarras && rowOutIt.CodigoBarras != null && rowOutIt.CodigoBarras != "null" ? rowOutIt.CodigoBarras : '.'))
                                                    .replaceAll("[DescricaoItem]", (rowOutIt.DescricaoItem && rowOutIt.DescricaoItem != null && rowOutIt.DescricaoItem != "null" ? rowOutIt.DescricaoItem : '.'))
                                                    .replaceAll("[Quantidade]", (rowOutIt.Quantidade && rowOutIt.Quantidade != null && rowOutIt.Quantidade != "null" ? rowOutIt.Quantidade : '.'))
                                                    .replaceAll("[SubTotal]", (rowOutIt.Subtotal && rowOutIt.Subtotal != null && rowOutIt.Subtotal != "null" ? (rowOutIt.Subtotal.toFixed(2).replace('.', ',')) : '.'))
                                                    .replaceAll("[DescontoSubTotal]", (rowOutIt.DescontoSubTotal && rowOutIt.DescontoSubTotal != null && rowOutIt.DescontoSubTotal != "null" ? ('- '+rowOutIt.DescontoSubTotal.toFixed(2).replace('.', ',')) : '.'))
                                                    .replaceAll("[Total]", (rowOutIt.Total && rowOutIt.Total != null && rowOutIt.Total != "null" ? (rowOutIt.Total.toFixed(2).replace('.', ',')) : '.'))
                                                    .replaceAll("[#CloseTag]", '')
                                            );
                                        });//Row Outros Itens

                                        PrintTemplate += (
                                            tempOutItens
                                                .replaceAll("[#OpenTag]", '')
                                                .replaceAll("[CodigoBarras]", '')
                                                .replaceAll("[DescricaoItem]", '')
                                                .replaceAll("[Quantidade]", '')
                                                .replaceAll("[SubTotal]", '')
                                                .replaceAll("[DescontoSubTotal]", '')
                                                .replaceAll("[Total]", '')
                                                .replaceAll("[#CloseTag]", '</ul><!--produtos--> </div><!--itens--> </div><!--tempOutItens-->')
                                        );
                                    }//If Outros Itens


                                //Temp Totalizador das vendas
                                var tempTotalizadorVenda = $("#tempTotalizadorVenda").html();

                                PrintTemplate += (
                                    tempTotalizadorVenda
                                        .replaceAll("[QtdProdutos]", (rowVen.QuantidadeProdutos && rowVen.QuantidadeProdutos != null && rowVen.QuantidadeProdutos != "null" ? rowVen.QuantidadeProdutos : '.'))
                                        .replaceAll("[SubTotalProdutos]", (rowVen.SubTotalProdutos && rowVen.SubTotalProdutos != null && rowVen.SubTotalProdutos != "null" ? (rowVen.SubTotalProdutos.toFixed(2).replace('.', ',')) : '.'))
                                        .replaceAll("[DescontoProdutos]", (rowVen.DescontoProdutos && rowVen.DescontoProdutos != null && rowVen.DescontoProdutos != "null" ? ('- '+rowVen.DescontoProdutos.toFixed(2).replace('.', ',')) : '.'))
                                        .replaceAll("[TotalProdutos]", (rowVen.TotalProdutos && rowVen.TotalProdutos != null && rowVen.TotalProdutos != "null" ? (rowVen.TotalProdutos.toFixed(2).replace('.', ',')) : '.'))
                                        .replaceAll("[NumeroVenda]", rowVen.NumeroVenda)
                                        .replaceAll("[CodigoVenda]", rowVen.CodigoVenda)
                                        .replaceAll("[SubTotalVenda]", (rowVen.SubTotalVenda && rowVen.SubTotalVenda != null && rowVen.SubTotalVenda != "null" ? (rowVen.SubTotalVenda.toFixed(2).replace('.', ',')) : '.'))
                                        .replaceAll("[DescontoVenda]", (rowVen.DescontoVenda && rowVen.DescontoVenda != null && rowVen.DescontoVenda != "null" ? ('- '+rowVen.DescontoVenda.toFixed(2).replace('.', ',')) : '.'))
                                        .replaceAll("[TotalVenda]", (rowVen.TotalVenda && rowVen.TotalVenda != null && rowVen.TotalVenda != "null" ? (rowVen.TotalVenda.toFixed(2).replace('.', ',')) : '.'))
                                );

                                //Fecha Bloco Venda
                                PrintTemplate += ("</div><!--tempVenda-->");

                                //Total Vendas
                                QuantidadeVendas += rowVen.QuantidadeProdutos;
                                SubTotalVendas += rowVen.SubTotalProdutos;
                                TotalVendas += rowVen.TotalVenda;

                            });//Row Vendas


                            //Formas de Pagamento
                            var dadosFormasPgto = GeeksSQL(
                                " SELECT"
                                    +" IsNull(Ft.DocumentoCodigo, '') CodigoFatura"
                                    +" ,IsNull(Dfat.Numero, '') NumeroFatura"
                                    +" ,IsNull(Ft.FormaDePagamento, '') FormaPagamento"
                                    +" ,(CASE WHEN(count(*) > 1) THEN(convert(varchar, count(*)) +'x') ELSE('') END) as Parcelas"
                                    +" ,SUM(IsNull(Ft.ValorARealizar, 0)) ValorPagamento"
                                +" FROM FinanceiroTitulo Ft"
                                    +" INNER JOIN Documento as DFat ON(DFat.CodigoDocumento = Ft.DocumentoCodigo)"
                                +" WHERE"
                                    +" DFat.Tipo = 'Fatura'"
                                    +" AND Ft.CodigoFinanceiroPlanoConta = 139"
                                    +" AND Ft.ReceberPagar = 1"
                                    +" AND IsNull(Ft.CodigoFatura, '') = ''"
                                    +" AND Ft.DocumentoCodigo = "+rowFat.CodigoFatura
                                +" GROUP BY Ft.DocumentoCodigo, Dfat.Numero, Ft.FormaDePagamento"
                            , false, url, banco, usuario);


                            if(dadosFormasPgto.RecordsAffected > 0){
                                //Temp Fomra de Pagamento
                                var tempFormaPgto = $("#tempFormaPgto").html();

                                PrintTemplate += (
                                    tempFormaPgto
                                        .replaceAll("[#OpenTag]", "<!--formas de pagamento--> <div class='row w98 float-r mt1 linel lineb'> <h5 class='b mb05'>Formas de pagamento</h5> <div>")
                                        .replaceAll('class="lineb mb04 pl03" style="border-left: 6px solid rgb(210,210,210);"', '')
                                        .replaceAll("[FormaDePgto]",  '')
                                        .replaceAll("[FormaDePgtoQtd]", '')
                                        .replaceAll("[FormaDePgtoValor]", '')
                                        .replaceAll("[#CloseTag]", '')
                                );

                                $(dadosFormasPgto.Records).each(function(index, rowFpgto){
                                    PrintTemplate += (
                                        tempFormaPgto
                                            .replaceAll("[#OpenTag]", '')
                                            .replaceAll("[FormaDePgto]",  (rowFpgto.FormaPagamento && rowFpgto.FormaPagamento != null && rowFpgto.FormaPagamento != "null" ? rowFpgto.FormaPagamento : '.'))
                                            .replaceAll("[FormaDePgtoQtd]", (rowFpgto.Parcelas && rowFpgto.Parcelas != null && rowFpgto.Parcelas != "null" ? rowFpgto.Parcelas : '.'))
                                            .replaceAll("[FormaDePgtoValor]", (rowFpgto.ValorPagamento && rowFpgto.ValorPagamento != null && rowFpgto.ValorPagamento != "null" ? (rowFpgto.ValorPagamento.toFixed(2).replace('.', ',')) : '.'))
                                            .replaceAll("[#CloseTag]", '')
                                    );
                                });//Row Formas Pagamento

                                PrintTemplate += (
                                    tempFormaPgto
                                        .replaceAll("[#OpenTag]", '')
                                        .replaceAll('class="lineb mb04 pl03" style="border-left: 6px solid rgb(210,210,210);"', '')
                                        .replaceAll("[FormaDePgto]",  '')
                                        .replaceAll("[FormaDePgtoQtd]", '')
                                        .replaceAll("[FormaDePgtoValor]", '')
                                        .replaceAll("[#CloseTag]", "</div> </div>")
                                );
                            }


                            //Temp Totalizador da Fatura
                            var tempTotalizadorFatura = $("#tempTotalizadorFatura").html();

                            PrintTemplate += (
                                tempTotalizadorFatura
                                    .replaceAll("[NumeroFatura]", rowFat.NumeroFatura)
                                    .replaceAll("[CodigoFatura]", rowFat.CodigoFatura)
                                    .replaceAll("[Quantidade]", QuantidadeVendas)
                                    .replaceAll("[SubTotal]", ((TotalVendas.toFixed(2).replace('.',',')) != "0,00" ? (TotalVendas.toFixed(2).replace('.',',')) : '.'))
                                    .replaceAll("[Desconto]", ((TotalVendas - rowFat.TotalFatura).toFixed(2).replace('.',',') != "0,00" ? '- '+((TotalVendas - rowFat.TotalFatura).toFixed(2).replace('.',',')) : '.'))
                                    .replaceAll("[Total]", (rowFat.TotalFatura && rowFat.TotalFatura != null && rowFat.TotalFatura != "null" ? (rowFat.TotalFatura.toFixed(2).replace('.', ',')) : '.'))
                            );                            

                            //Fecha Bloco Fatura
                            PrintTemplate += ("</div><!--tempFatura-->");

                            //Totalizadores Faturas
                            QuantidadeFaturas += QuantidadeVendas;
                            SubTotalFaturas += SubTotalVendas;
                            DescontoFaturas += (SubTotalVendas - rowFat.TotalFatura);
                            TotalFaturas += rowFat.TotalFatura;

                        });//Row Fatura

                    });//Row Filtro


                    //Temp Totalizador do Cliente
                    var tempTotalizadorCliente = $("#tempTotalizadorCliente").html();

                    PrintTemplate += (
                        tempTotalizadorCliente
                            .replaceAll("[CodigoCliente]", '#'+rowCli.CodigoContato)
                            .replaceAll("[Quantidade]", QuantidadeFaturas)
                            .replaceAll("[SubTotal]", ((SubTotalFaturas.toFixed(2).replace('.',',')) != "0,00" ? (SubTotalFaturas.toFixed(2).replace('.',',')) : '.'))
                            .replaceAll("[Desconto]", ((DescontoFaturas.toFixed(2).replace('.',',')) != "0,00" ? '- '+(DescontoFaturas.toFixed(2).replace('.',',')) : '.'))
                            .replaceAll("[Total]", ((TotalFaturas.toFixed(2).replace('.',',')) != "0,00" ? (TotalFaturas.toFixed(2).replace('.',',')) : '.'))
                    );

                    //Fecha Bloco Cliente
                    PrintTemplate += ("</div><!--tempCliente-->");

                    //Imprime na tela bloco a bloco
                    $("#PrintTemp").append(PrintTemplate);

                });//Row Cliente
			});
		</script>
	</body>
</html>