<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="utf-8">
        <title>Carta Cobrança</title>
        <link rel="stylesheet" type="text/css" href="optidados.framework.css"/>
		<script src="/Scripts/jquery-2.1.4.js"></script>
        <script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
        <script src="/Scripts/codigobarras.js"></script>
        <script src="/Plugins/html2canvas.js"></script>

        <style type="text/css">
        	.layoutCartaCobranca {
        		background-color: rgb(250,250,250);
        		margin: 50px auto;
        	}

        	.container {
        		margin: 0 auto;
        	}
        </style>

        <style type="text/css" media="print">
        	.layoutCartaCobranca {
        		background: none;
        		margin: 0;
        		padding: 0;
        	}

        	@page{
        		margin:6mm;
        	}

        	.container {
        		width: 100%;
        		margin: 0;
        	}
        </style>

		<script id="layoutEmpresaCliente" type="layoutEmpresaCliente">
			<div class="layoutCartaCobranca row w100" style="page-break-inside: avoid !important;">
			<div class="row w100" style="height: 9.5cm;">
				<div class="row w100" style="margin-top: 3.5cm; margin-left: 2.3cm;">
					<h3>[NomeCliente]</h3>
					<h3>[LogradouroCliente]</h3>
					<h3>[CidadeCepCliente]</h3>
				</div>
				<div class="row w100" style="margin-top: 3.6cm;">
					<h4 class="float-r">[EnderecoEmpresa]</h4>
				</div>
			</div>

			<div class="row w100 mt25">
				<h3 class="b mb05 txt-ac lineb"><span>[CidadeEmpresa]</span>, <span>[DataImpresso]</span></h3>

				<h5><span class="b">Nome:</span> <span>[NomeCliente]</span></h5>
				<h5><span class="b">Endereço:</span> <span>[EnderecoCliente]</span></h5>

				<h5 class="mt05">
					Prezado(a) cliente,<br>
					Informamos que encontra-se pendente em nossos registros a(s) fatura(s) abaixo discriminadas.<br>
					Solicitamos o seu comparecimento em nossa empresa a fim de solucionar esta(s) pendência(s).<br>
					<br>
					Obs: Caso esta(s) pendência(s) já tenha sido solucionada, solicitamos desconsiderar este comunicado.<br>
					<br>
					Atenciosamente,
				</h5>

				<p class="float-r w35 linet pt02 mt2 txt-ac">Assinatura Responsável</p>
			</div>

			<div class="row w100 pt05">
				<h5>Dep. Financeiro,</h5>
				<h5>[FantasiaEmpresa]</h5>
				<h5>[EnderecoEmpresa]</h5>
				<h5>[TelefoneEmpresa]</h5>

				<h5 class="mt15 mb04">Relacionamos abaixo suas duplicatas em aberto:</h5>
				<div>
					<div class="row w100 mb04">
						<div class="col w12-2 lineb liner"> <h5 class="b txt-ac">Nº Fatura</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="b txt-ac">Vencimento</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="b txt-ac">Dias em atraso</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="b txt-ac">Parcelas</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="b txt-ac">Valor Parcela</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="b txt-ac">Valor Juros</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="b txt-ac">Valor Multa</h5> </div>
						<div class="col w12-2 lineb"> <h5 class="b txt-ac">Valor Corrigido</h5> </div>
					</div>
					<div class="row w100 mt03">
		</script>

		<script id="layoutFaturas" type="layoutFaturas">
						<div class="col w12-2 lineb liner"> <h5 class="txt-ac">[NumeroFatura]</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="txt-ac">[DataVenciamento]</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="txt-ac">[DiasEmAtraso]</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="txt-ac">[NumeroParcelas]</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="txt-ar">[ValorParcela]</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="txt-ar">[ValorTotalJuros]</h5> </div>
						<div class="col w12-2 lineb liner"> <h5 class="txt-ar">[ValorMulta]</h5> </div>
						<div class="col w12-2 lineb"> <h5 class="txt-ar">[ValoraRealizar]</h5> </div>
		</script>

		<script id="layoutJurosMulta" type="layoutJurosMulta">
					</div>
				</div>
			</div>

			<div class="row w100 pt10">
				<h5> <span class="b">Juros por</span> <span>[TipoJuros]</span> <span class="b ml1">Percetual</span> <span>[PercentualJuros]</span> <span class="b ml1">Valor</span> <span>[ValorJuros]</span> </h5>
				<h5> <span class="b">Total Multa(s)</span> <span>[ValorMulta]</span></h5>
			</div>
			</div>
		</script>
    </head>
    <body>
    	<div class="container">
			<div id="printTemplate" style="page-break-inside: avoid !important;"></div>
		</div>

    	<script>
    		$(document).ready(function(){

				//Connect DB
				var banco = getParameterByName("BancoDeDados");
				var url = decodeURIComponent(getParameterByName("URLServidor"));
				var usuario = getParameterByName("CodigoUsuario");

                //Get Filters
                //data_de = '01/01/2018';
                //data_ate = '26/02/2018';
                //Empresa = '%';
                //Contato = '%';
                //CodigoFatura = '%';

                //SQL Dados Empresa/Cliente
                var dadosEmpresaCliente = GeeksSQL(
                	" SELECT"
                		+" IsNull(Convert(varchar(10), GetDate(), 103), '') as DataImpresso"
						+" ,IsNull(CEmp.CodigoContato, '') as CodigoEmpresa"
						+" ,IsNull(CEmp.Nome, '') as RazaoEmpresa"
						+" ,IsNull(CEmp.Apelido, '') as FantasiaEmpresa"
						+" ,IsNull(CEmp.NumeroDocumentoNacional, '') as CNPJ"
						+" ,IsNull(CEmp.NumeroDocumentoEstadual, '') as InsEstadual"
						+" ,IsNull(CEmp.Email, '') as EmailEmpresa"
						+" ,IsNull(CEmp.Site, '') as SiteEmpresa"
						+" ,(IsNull(CEEmp.Logradouro+' ', ''))+ (IsNull(CEEmp.Numero+', ', ''))+ (IsNull(CEEmp.Bairro, '')) as LogradouroEmpresa"
						+" ,(IsNull(CEEmp.Municipio, '')) as CidadeEmpresa"
						+" ,(IsNull(CEEmp.UF, '')) as UFEmpresa"
						+" ,(IsNull(CEEmp.Cep, '')) as CepEmpresa"
						+" ,IsNull(STUFF(("
						    +" SELECT ',  '+CTEmp.Telefone"
						    +" FROM ContatoTelefone CTEmp"
						    +" WHERE CTEmp.CodigoContato = CEmp.CodigoContato"
						+" FOR XML PATH('')), 1, 2, ''), '') as TelefoneEmpresa"
						+" ,IsNull(CCli.CodigoContato, '') as CodigoCliente"
						+" ,IsNull(CCli.Nome, '') as NomeCliente"
						+" ,IsNull(CCli.NumeroDocumentoNacional, '') as CPF"
						+" ,IsNull(CCli.NumeroDocumentoEstadual, '') as RG"
						+" ,IsNull(CCli.Email, '') as EmailCliente"
						+" ,(IsNull(CECli.Logradouro+' ', ''))+ (IsNull(CECli.Numero+', ', ''))+ (IsNull(CECli.Bairro, '')) as LogradouroCliente"
						+" ,(IsNull(CECli.Municipio+'-', ''))+ (IsNull(CECli.UF+' ', ''))+ (IsNull(CECli.Cep, '')) as CidadeCepCliente"
					+" FROM FinanceiroTitulo FT"
						+" LEFT JOIN Contato as CEmp ON(CEmp.CodigoContato = FT.CodigoEmpresa)"
						+" LEFT JOIN ContatoEndereco as CEEmp ON(CEmp.CodigoContato = CEEmp.CodigoContato) AND(CEEmp.Grupo = 'Principal')"
						+" LEFT JOIN Contato as CCli ON(CCli.CodigoContato = FT.CodigoContato)"
						+" LEFT JOIN ContatoEndereco as CECli ON(CCli.CodigoContato = CECli.CodigoContato) AND(CECli.Grupo = 'Principal')"
					+" WHERE"
						+" FT.DataVencimento < CURRENT_TIMESTAMP"
						+" AND FT.DataPagamento IS NULL"
						+" AND FT.ReceberPagar = 1"
						+" AND ((FT.FormadePagamento = 'Carnê') OR (FT.FormadePagamento = 'Boleto'))"
						+" AND CCli.Nome <> 'CONSUMIDOR'"
					+" GROUP BY"
						+" CEmp.CodigoContato, CEmp.Nome, CEmp.Apelido, CEmp.NumeroDocumentoNacional, CEmp.NumeroDocumentoEstadual, CEmp.Email, CEmp.Site, CEEmp.Logradouro, CEEmp.Numero, CEEmp.Bairro, CEEmp.Municipio, CEEmp.UF, CEEmp.Cep, CCli.CodigoContato, CCli.Nome, CCli.NumeroDocumentoNacional, CCli.NumeroDocumentoEstadual, CCli.Email, CECli.Logradouro, CECli.Numero, CECli.Bairro, CECli.Municipio, CECli.UF, CECli.Cep"
				,false ,url ,banco ,usuario);

                $(dadosEmpresaCliente.Records).each(function(index, rowEC) {

                	//Template Empresa/Cliente
                	var tempEmpCli = $("#layoutEmpresaCliente").html();

                	//Write Dados Empresa/Cliente
                	tempEmpCli = tempEmpCli
						.replaceAll("[NomeCliente]", (rowEC.NomeCliente != "" ? rowEC.NomeCliente : "&nbsp;"))
						.replaceAll("[LogradouroCliente]", (rowEC.LogradouroCliente != "" ? rowEC.LogradouroCliente : "&nbsp;"))
						.replaceAll("[CidadeCepCliente]", (rowEC.CidadeCepCliente != "" ? rowEC.CidadeCepCliente : "&nbsp;"))

						.replaceAll("[EnderecoEmpresa]", ((rowEC.LogradouroEmpresa != "" ? rowEC.LogradouroEmpresa+" - " : "&nbsp;")+ (rowEC.CidadeEmpresa != "" ? rowEC.CidadeEmpresa+"-" : "&nbsp;")+ (rowEC.UFEmpresa != "" ? rowEC.UFEmpresa+" " : "&nbsp;")+ (rowEC.CepEmpresa != "" ? rowEC.CepEmpresa : "&nbsp;")))

						.replaceAll("[CidadeEmpresa]", (rowEC.CidadeEmpresa != "" ? rowEC.CidadeEmpresa : "&nbsp;"))
						.replaceAll("[DataImpresso]", (rowEC.DataImpresso != "" ? rowEC.DataImpresso : "&nbsp;"))

						.replaceAll("[EnderecoCliente]", ((rowEC.LogradouroCliente != "" ? rowEC.LogradouroCliente+" - " : "&nbsp;")+ (rowEC.CidadeCepCliente != "" ? rowEC.CidadeCepCliente : "&nbsp;")))

						.replaceAll("[FantasiaEmpresa]", (rowEC.FantasiaEmpresa != "" ? rowEC.FantasiaEmpresa : "&nbsp;") )
						.replaceAll("[TelefoneEmpresa]", (rowEC.TelefoneEmpresa != "" ? rowEC.TelefoneEmpresa : "&nbsp;") )
					;


					//SQL Dados Fatura
	    			var dadosFatura = GeeksSQL(
						" SELECT"
							+" IsNull(FT.DocumentoCodigo, '') as DocumentoCodigo"
							+" ,IsNull(FT.FormadePagamento, '') as FormadePagamento"
							+" ,IsNull(Convert(varchar(10), FT.DataVencimento, 103), '') as DataVencimento"
							+" ,IsNull(FT.DiasEmAtraso, '') as DiasEmAtraso"
							+" ,IsNull(FT.Parcela, '') as Parcela"
							+" ,IsNull(FT.ValorOriginal, 0) as ValorOriginal"
							+" ,IsNull(FT.ValorTotalJuros, 0) as ValorTotalJuros"
							+" ,IsNull(FT.ValorMulta, 0) as ValorMulta"
							+" ,IsNull(FT.ValoraRealizar, 0) as ValoraRealizar"
							+" ,IsNull(FT.TipoJuros, '') as TipoJuros"
							+" ,IsNull(FT.PercentualJuros, 0) as PercentualJuros"
							+" ,IsNull(FT.ValorJuros, 0) as ValorJuros"
						+" FROM FinanceiroTitulo FT"
						+" WHERE"
							+" FT.CodigoEmpresa ="+rowEC.CodigoEmpresa
							+" AND FT.CodigoContato ="+rowEC.CodigoCliente
							+" AND FT.DataVencimento < CURRENT_TIMESTAMP"
							+" AND FT.DataPagamento IS NULL"
							+" AND FT.ReceberPagar = 1"
							+" AND ((FT.FormadePagamento = 'Carnê') OR (FT.FormadePagamento = 'Boleto'))"
					,false ,url ,banco ,usuario).Records;

					//Declare Var's
					var totalMulta = 0;

					$(dadosFatura).each(function(index, rowFat) {

						//Template Faturas
						var tempFat = $("#layoutFaturas").html();

						//Write Dados Fatura
						tempFat = tempFat
							.replace("[NumeroFatura]", (rowFat.DocumentoCodigo != "" ? rowFat.DocumentoCodigo : "&nbsp;"))
							.replace("[DataVenciamento]", (rowFat.DataVencimento != "" ? rowFat.DataVencimento : "&nbsp;"))
							.replace("[DiasEmAtraso]", (rowFat.DiasEmAtraso != "" ? rowFat.DiasEmAtraso : "&nbsp;"))
							.replace("[NumeroParcelas]", (rowFat.Parcela != "" ? rowFat.Parcela : "&nbsp;"))
							.replace("[ValorParcela]", (rowFat.ValorOriginal != 0 ? (rowFat.ValorOriginal.toFixed(2).replace('.', ',')) : "&nbsp;") )
							.replace("[ValorTotalJuros]", (rowFat.ValorTotalJuros != 0 ? (rowFat.ValorTotalJuros.toFixed(2).replace('.', ',')) : "&nbsp;") )
							.replace("[ValorMulta]", (rowFat.ValorMulta != 0 ? (rowFat.ValorMulta.toFixed(2).replace('.', ',')) : "&nbsp;") )
							.replace("[ValoraRealizar]", (rowFat.ValoraRealizar != 0 ? (rowFat.ValoraRealizar.toFixed(2).replace('.', ',')) : "&nbsp;") )
						;

						//Soma Multa
						totalMulta += rowFat.ValorMulta;

						//Mescla Template
						tempEmpCli += tempFat;
					});//rowFat

					//Tempalte Juros/Multa
					var tempJurosMulta = $("#layoutJurosMulta").html();

					//Write dados Juros/Musta
					tempJurosMulta = tempJurosMulta
						.replace("[TipoJuros]", (dadosFatura[0].TipoJuros != "" ? dadosFatura[0].TipoJuros : "&nbsp;"))
						.replace("[PercentualJuros]", (dadosFatura[0].PercentualJuros != 0 ? dadosFatura[0].PercentualJuros : "&nbsp;"))
						.replace("[ValorJuros]", (dadosFatura[0].ValorJuros != 0 ? dadosFatura[0].ValorJuros.toFixed(2).replace('.',',') : "&nbsp;"))
						.replace("[ValorMulta]", totalMulta.toFixed(2).replace('.', ','))
					;

					//Mescla Template
					tempEmpCli += tempJurosMulta;

					//Print In Screen
					$("#printTemplate").append(tempEmpCli);

                });//rowEC

    		});//Script
    	</script>
    </body>
</html>