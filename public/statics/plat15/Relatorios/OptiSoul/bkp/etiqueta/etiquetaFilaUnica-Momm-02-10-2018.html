<!DOCTYPE html>

<html>

	<head>
		<meta charset="utf-8">
		<title>Etiquetas</title>
	
		<script src="/Scripts/jquery-2.1.4.js"></script>
		<script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
		<script src="/Scripts/jquery-ean13.min.js"></script>

		<style type="text/css" media="print">

			body {
				margin: 0 !important;
				padding: 0 !important;
			}

			body > * {
				max-width: 100%;
				max-height: 100%;
			}

			.barcode-canvas {
				width: 8.60cm;
				height: 1cm;
				margin: 0;
				padding: 0;
				page-break-before: always !important;
				page-break-inside: avoid !important;
			}

			#folha-1 {
				display: none;
			}

		</style>

		<script>
			
			$(document).ready(function () {

				var banco = getParameterByName("Banco");
				var url = decodeURIComponent(getParameterByName("URLServidor"));
				var usuario = getParameterByName("CodigoUsuario");

				var CodigoPedido = getParameterByName("CodigoPedido");
				var CodigoItem = getParameterByName("CodigoItem");
				var Quantidade = getParameterByName("Quantidade");
				var TabelaPreco = getParameterByName("TabelaPreco");

				var lado = GeeksSQL("select Texto from Configuracoes where nome='impressao.etiquetacontinua.lado'", false, url, banco, usuario);
				if (lado != null && lado.Records.length > 0) lado = lado.Records[0].Texto;

				var margemcima = GeeksSQL("select Valor from Configuracoes where nome ='impressao.etiquetacontinua.margemcima'", false, url, banco, usuario);
				if (margemcima != null && margemcima.Records.length > 0) margemcima = margemcima.Records[0].Valor;
				var margemesquerda = GeeksSQL("select Valor from Configuracoes where nome ='impressao.etiquetacontinua.margemesquerda'", false, url, banco, usuario);
				if (margemesquerda != null && margemesquerda.Records.length > 0) margemesquerda = margemesquerda.Records[0].Valor;
				
				var ImprimeEtiqueta = function (Pagina, Produto) {

					// Limpa o canvas do EAN
					document.getElementById("ean").getContext("2d").clearRect(0, 0, document.getElementById("ean").width, document.getElementById("ean").height);

					//Start Canvas
					var canvas = document.getElementById('folha' + Pagina);
					var ctx = canvas.getContext('2d');

					//Limitar tamanho do campo texto
					//Exemplo de utilizaçõa: ctx.fillText(fittingString(ctx, "aqui seu texto ou variável", 100), x, y);
					function fittingString(ctx, str, maxWidth) {
					    var width = ctx.measureText(str).width;
					    var ellipsis = '';
					    var ellipsisWidth = ctx.measureText(ellipsis).width;

					    if (width<=maxWidth || width<=ellipsisWidth) {
					        return str;
					    } else {
					        var len = str.length;
					        while (width>=maxWidth-ellipsisWidth && len-->0) {
					            str = str.substring(0, len);
					            width = ctx.measureText(str).width;
					        }
					        return str+ellipsis;
					    }
					}

					//Quebra campo de texto
					DescricaoCompleta = Produto.DescricaoCompleta
					Desc1 = DescricaoCompleta.substring(0, 14)
					Desc2 = DescricaoCompleta.substring(14, 28)

					var mm = 1;

					var xin = 10;

					if (lado == "e")
						xin = 0;
					else if (lado == "d")
						xin = 250 * mm;

					var yin = (18 * mm);

					var x = xin;
					var y = yin;

					//Desenha codigo de barras
					$("#ean").EAN13(Produto.CodigoBarras);
					ctx.drawImage(ean, 0, 0, 320 * mm, 90 * mm);

					ctx.beginPath();
			        ctx.rect(0, 15 + 45, 325, 50);
					ctx.fillStyle = "white";
					ctx.fill();

					//Codigo numero do desenho
					ctx.font = '27pt "Tahoma"';
					ctx.fillStyle = "black";
					ctx.textAlign = "center";
					ctx.fillText(Produto.CodigoBarras, x + 157, yin + 80 * mm);

					//Descrição em primeira linha
					ctx.textAlign = "start";
					x += 330 * mm;
					y += 11 * mm;
					ctx.fillText(Desc1.trim(), x, y);

					//Descrição em segunda linha
					ctx.textAlign = "start";
					y += 37 * mm;
					ctx.fillText(Desc2.trim(), x, y);

					//Código Produto e Preço
					y += 32 * mm;
					ctx.fillText(Produto.Valor, x, y);
					//ctx.fillText(Produto.CodigoItem + ' ' + Produto.Valor, x, y);
				}

				// Posso imprimir etiqueta de um pedido
				if (CodigoPedido != "")
					var Etiquetas = GeeksSQL(
						"SELECT"
							+" IsNull(I.CodigoItem, '') CodigoItem,"
							+" IsNull(SUBSTRING('000000000000' + Cast(i.CodigoBarras as varchar), LEN('000000000000' + Cast(i.CodigoBarras as varchar))-12, 13), '') CodigoBarras,"
							+" (CASE"
								+" WHEN((I.Tipo = 'Armação') OR(I.Tipo = 'Óculos Sol') OR(I.Tipo = 'Óculos Pronto'))"
								+" THEN(CASE"
										+" WHEN(IsNull(I.Descricao, '') = '')"
										+" THEN(IsNull(I.Marca, '')+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, ''))"
										+" ELSE(IsNull(I.Descricao, ''))"
									+" END)"
								+" ELSE(CASE WHEN(IsNull(I.Descricao, '') = '') THEN(IsNull(I.Marca, '')+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, '')) ELSE(IsNull(I.Descricao, '')) END)"
							+" END) DescricaoCompleta,"
							+" IsNull(I.Marca, '') Marca,"
							+" IsNull(I.Modelo, '') Modelo,"
							+" IsNull(I.AmarcaoCor, I.Cor) Cor,"
							+" IsNull(I.Tamanho, '') Tamanho,"
							+" 'R$ ' + Format(IsNull(" + (TabelaPreco == "" ? 'I.ValorVenda' : "(Select dbo.Fn_TabelaPreco_GetPreco(I.CodigoItem, 6))") + ", 0), 'N2') Valor,"
							+" IsNull(DI.Quantidade, 0) Quantidade"
						+" FROM Item I"
						+" INNER JOIN DocumentoItem DI ON DI.CodigoItem = I.CodigoItem and DI.CodigoDocumento = 0" +CodigoPedido
						+" ORDER BY di.CodigoDocumentoItem", false, url, banco, usuario).Records;

				// Posso imprimir etiqueta de um item, informando a quantidade
				else if (CodigoItem != "")
					var Etiquetas = GeeksSQL(
						"SELECT"
							+" IsNull(I.CodigoItem, '') CodigoItem,"
							+" IsNull(SUBSTRING('000000000000' + Cast(i.CodigoBarras as varchar), LEN('000000000000' + Cast(i.CodigoBarras as varchar))-12, 13), '') CodigoBarras,"
							+" (CASE"
								+" WHEN((I.Tipo = 'Armação') OR(I.Tipo = 'Óculos Sol') OR(I.Tipo = 'Óculos Pronto'))"
								+" THEN(CASE"
										+" WHEN(IsNull(I.Descricao, '') = '')"
										+" THEN(IsNull(I.Marca, '')+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, ''))"
										+" ELSE(IsNull(I.Descricao, ''))"
									+" END)"
								+" ELSE(CASE WHEN(IsNull(I.Descricao, '') = '') THEN(IsNull(I.Marca, '')+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, '')) ELSE(IsNull(I.Descricao, '')) END)"
							+" END) DescricaoCompleta,"
							+" IsNull(I.Marca, '') Marca,"
							+" IsNull(I.Modelo, '') Modelo,"
							+" IsNull(I.AmarcaoCor, I.Cor) Cor,"
							+" IsNull(I.Tamanho, '') Tamanho,"
							+" 'R$ ' + Format(IsNull(" + (TabelaPreco == "" ? 'I.ValorVenda' : "(Select dbo.Fn_TabelaPreco_GetPreco(I.CodigoItem, 6))") + ", 0), 'N2') Valor,"
							+ Quantidade + " Quantidade"
						+" FROM Item I"
						+" WHERE I.CodigoItem = " + CodigoItem, false, url, banco, usuario).Records;

				// Ou posso imprimir etiqueta pela tela de etiquetas
				else
					var Etiquetas = GeeksSQL(
						"SELECT"
							+" IsNull(I.CodigoItem, '') CodigoItem,"
							+" IsNull(SUBSTRING('000000000000' + Cast(i.CodigoBarras as varchar), LEN('000000000000' + Cast(i.CodigoBarras as varchar))-12, 13), '') CodigoBarras,"
							+" (CASE"
								+" WHEN((I.Tipo = 'Armação') OR(I.Tipo = 'Óculos Sol') OR(I.Tipo = 'Óculos Pronto'))"
								+" THEN(CASE"
										+" WHEN(IsNull(I.Descricao, '') = '')"
										+" THEN(IsNull(I.Marca, '')+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, ''))"
										+" ELSE(IsNull(I.Descricao, ''))"
									+" END)"
								+" ELSE(CASE WHEN(IsNull(I.Descricao, '') = '') THEN(IsNull(I.Marca, '')+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, '')) ELSE(IsNull(I.Descricao, '')) END)"
							+" END) DescricaoCompleta,"
							+" IsNull(I.Marca, '') Marca,"
							+" IsNull(I.Modelo, '') Modelo,"
							+" IsNull(I.AmarcaoCor, I.Cor) Cor,"
							+" IsNull(I.Tamanho, '') Tamanho,"
							+" 'R$ ' + Format(IsNull(" + (TabelaPreco == "" ? 'I.ValorVenda' : "(Select dbo.Fn_TabelaPreco_GetPreco(E.CodigoItem, 6))") + ", 0), 'N2') Valor,"
							+" IsNull(E.QuantidadeEtiquetas, 0) Quantidade"
						+" FROM Item I"
						+" INNER JOIN Etiqueta E ON E.CodigoItem = I.CodigoItem"
						+" ORDER BY E.CodigoEtiqueta", false, url, banco, usuario).Records;

				var pagina = 0;

				var ini = {
					CodigoItem : "",
					CodigoBarras : "",
					DescricaoCompleta : "",
					Marca : "",
					Modelo : "",
					Cor : "",
					Tamanho : "",
					Valor : "",
					Quantidade : ""
				}

				$("body").append('<div><canvas id="folha-1" class="barcode-canvas" width=800 height=100></canvas></div>');
				ImprimeEtiqueta( "-1",ini);

				$("body").append('<div><canvas id="folha-1" class="barcode-canvas" width=800 height=' + (margemcima != null ? margemcima : "0") + '></canvas></div>');

				// ' + (margemcima != null ? String(100 + Number(margemcima)) : "100") + '

				for (var i = 0; i < Etiquetas.length; i++) {

					for (var j = 0; j < Etiquetas[i].Quantidade; j++) {
						$("body").append('<div><canvas id="folha' + pagina + '" class="barcode-canvas" style="margin-left: ' + (margemesquerda != null ? margemesquerda : "0") + 'px" width=800 height=100></canvas></div>');
						ImprimeEtiqueta(pagina, Etiquetas[i]);
						pagina++;
					}

				}

				$("#ean").remove();
			});
		</script>
	</head>

	<body>
		<canvas id="ean" width="270" height="100"></canvas>
	</body>

</html>