<!DOCTYPE html>

<html>

	<head>
		<meta charset="utf-8">
		<title>Etiquetas</title>
	
		<script src="/Scripts/jquery-2.1.4.js"></script>
		<script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
		<script src="/Scripts/jquery-ean13.min.js"></script>

		<style type="text/css" media="print">

			@page {
				margin: 0;
			}

			.barcode-canvas {
				page-break-before: always;
			}

		</style>

		<script>
			
			$(document).ready(function () {


				var ImprimeEtiqueta = function (NomeCanvas, Produto, Linha, Coluna) {

					var canvas = document.getElementById(NomeCanvas);
					var ctx = canvas.getContext('2d');

					var mm = 1;

					xin = 260 * mm + (850 * mm * Coluna);
					yin = 145 * mm + (130 * mm * Linha);

					var x = xin + 10;
					var y = yin + 10;

					$("#ean").EAN13(Produto.CodigoBarras);
					ctx.drawImage(ean, x, y, 240 * mm, 90 * mm);

					ctx.beginPath();
			        ctx.rect(xin, yin + 60, 260, 40);
					ctx.fillStyle = "white";
					ctx.fill();

					ctx.font = '16pt "Arial"';
					ctx.fillStyle = "black";
					ctx.textAlign = "center";
					ctx.fillText(Produto.CodigoBarras, x + 130, yin + 80 * mm);

					ctx.font = '12pt "Arial"';
					ctx.textAlign = "start";

					x += 290 * mm;
					ctx.fillText(Produto.Nome + (Produto.Nome == ''? '': ' ') + Produto.Tamanho, x, y + 15 * mm);
					y += 35 * mm;
					ctx.fillText(Produto.Modelo + (Produto.Modelo == ''? '': ' ') + Produto.Cor, x, y);
					y += 20 * mm;
					ctx.fillText(Produto.Valor, x, y);
					y += 20 * mm;
					ctx.fillText((Produto.CodigoProduto == '' ? '' : 'CÃ³d: ') + Produto.CodigoProduto, x, y);

				}

				var banco = getParameterByName("Banco");
				var url = decodeURIComponent(getParameterByName("URLServidor"));
				var usuario = getParameterByName("CodigoUsuario");

				var numeroEtiquetasEmBranco = getParameterByName("EmBranco");

				var Etiquetas = GeeksSQL("Select E.CodigoItem, IsNull(I.CodigoBarras, '') CodigoBarras, IsNull(I.Marca, '') Marca, IsNull(I.Modelo, '') Modelo, IsNull(I.Cor, '') Cor, IsNull(I.Tamanho, '') Tamanho, IsNull(E.NomeProduto, '') Nome, 'R$ ' + Format(IsNull(E.Valor, 0), 'N2') Valor, IsNull(E.QuantidadeEtiquetas, 0) Quantidade From Item I Inner Join Etiqueta E on E.CodigoItem = I.CodigoItem", false, url, banco, usuario);

				var EtiquetasNaFolha = [];

				for (var i = 0; i < numeroEtiquetasEmBranco; i++) {

					var Item = { 
						Nome: '',
						Tamanho: '',
						Modelo: '',
						Cor: '',
						Valor: '',
						CodigoProduto: '',
						CodigoBarras: ''
					}
					
					EtiquetasNaFolha.push(Item);

				}

				$(Etiquetas.Records).each(function(index, row){

					for (var i = 0; i < row.Quantidade; i++) {

						var Item = { 
							Nome: row.Nome,
							Tamanho: row.Tamanho,
							Modelo: row.Modelo,
							Cor: row.Cor,
							Valor: row.Valor,
							CodigoProduto: row.CodigoItem,
							CodigoBarras: row.CodigoBarras
						}
						
						EtiquetasNaFolha.push(Item);

					}

				});

				// Cada folha tem 40 etiquetas
				// Para cada 40 etiquetas, coloca um canvas na tela
				var NumeroFolhas = (((EtiquetasNaFolha.length) / 40) | 0) + 1;

				for (var i = 0; i < NumeroFolhas; i++) {

					$("#folha").append('<canvas id="folha' + i + '" class="barcode-canvas" width="2150" height="2710"></canvas>');

				}

				// Jogar os elementos na etiquetas

				var NumeroFolhaPre = 0;
				var FolhaEmPreenchimento = "folha0";

				var linha = 0;
				var coluna = 0;

				for (var i = 0; i < EtiquetasNaFolha.length; i++) {

					ImprimeEtiqueta(FolhaEmPreenchimento, EtiquetasNaFolha[i], linha, coluna);

					coluna += 1;

					if (coluna == 2) {

						coluna = 0;

						linha += 1;

					}

					if (i % 39 == 0 && i != 0) { 

						debugger;

						NumeroFolhaPre ++;
						FolhaEmPreenchimento = "folha" + NumeroFolhaPre;

					}

				}

				$("#ean").remove();
		
			});

		</script>

	</head>

	<body>

		<div id="folha">
			

		</div>
			
		<canvas id="ean"></canvas>


	</body>

</html>