<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Fechamento de Caixa</title>
        <link rel="stylesheet" type="text/css" href="fechamento-caixa.css"/>
        <link rel="stylesheet" type="text/css" href="impressos.css"/>
        <script src="/Scripts/jquery-2.1.4.js"></script>
        <script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
        <script src="/Scripts/codigobarras.js"></script>
        <script src="/Plugins/html2canvas.js"></script>

        <style type="text/css">
            * {
                white-space: nowrap;
            }
        </style>

        <script type="linhaNome" id="linhaNome">
            <h5>[nome]</h5>
        </script>

        <script type="linhaValor" id="linhaValor">
            <h5> <span>[valor]</span>   </h5>
        </script>

        <script type="via" id="via">
            <div class="container">
                <div class="feccax-picote">
                    <table class="content-table">
                        <!--titulo impresso-->
                        <tr>
                            <td class="titulo-relatorio" colspan="2">Fechamento de Caixa</td>
                        </tr>

                        <!--header-->
                        <tr>
                            <td class="box-bottom ptop-10" colspan="2">
                                <table class="sub-content-table operadoresCaixa">
                                    <tr>
                                        <td> <h5>Empresa: <span class="nomeEmpresa">Carregando fechamento...</span></h5> </td>
                                        <td> <h5><span class="nomeCaixa"></span></h5> </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <h5>Operador: <span class="nomeOperador"></span></h5>
                                        </td>
                                        <td>
                                            <h5>Abertura: <span class="dataHoraAbertura"></span></h5>
                                        </td>
                                        <td>
                                            <h5>Fechamento: <span class="dataHoraFechamento"></span></h5>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr>
                            <td class="box-right" valign="top">
                                <table>
                                    <tr>
                                        <td class="faccax-ven-left pbottom-05"> Formas Pgto. </td>
                                        <td class="faccax-ven-right text-align-right pbottom-05"> R$ </td>
                                    </tr>

                                    <tr>
                                        <td class="faccax-ven-left nomesFormasPgto">
                                        </td>

                                        <td class="faccax-ven-right text-align-right valoresFormasPgto">
                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="faccax-ven-left feccax-total">
                                            <h5>Total</h5>
                                        </td>
                                        <td class="faccax-ven-right feccax-total text-align-right">
                                            <h5> <span class="valorTotalVendasDia"></span> </h5>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="faccax-ven-left nomePedidosPendentes">
                                        </td>

                                        <td class="faccax-ven-right text-align-right valorPedidosPendentes">
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <td valign="top">
                                <table>
                                    <tr>
                                        <td class="feccax-left-caixa pbottom-05">Caixa</td>
                                        <td class="text-align-right pbottom-05">R$</td>
                                    </tr>

                                    <tr>
                                        <td class="feccax-left-caixa nomesCaixa">
                                        </td>

                                        <td class="text-align-right valoresCaixa" style="width: 247px;">
                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="feccax-left-caixa box-top descricoesSangria">
                                            <h5>Total dinheiro em caixa</h5>
                                            <h5></h5>
                                        </td>
                                        <td class="text-align-right box-top valoresSangria" style="width: 247px;">
                                            <h5> <span class="valorTotalDinheiroCaixa"></span> </h5>
                                            <h5></h5>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="feccax-total">
                                            <h5>Fundo de caixa para <span class="dataProxDia"></span></h5>
                                        </td>
                                        <td class="text-align-right feccax-total">
                                            <h5> <span class="valorFundoCaixaProxDia"></span> </h5>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td colspan="2">
                                            <h5 class="box-top text-align-center float-right mtop-45" style="width: 320px;"> Assinatura </h5>
                                        </td>
                                    </tr>

                                </table>

                            </td>

                        </tr>

                    </table>

                </div>
               
            </div>

        </script>

    </head>

    <body>

        <script type="text/javascript">
            
            $(document).ready(function(){

                var CodigoDocumento = getParameterByName("CodigoDocumento");

                var banco = getParameterByName("BancoDeDados");
                var url = decodeURIComponent(getParameterByName("URLServidor"));
                var usuario = getParameterByName("CodigoUsuario");

                var numeroVias = getParameterByName("NumeroVias");

                for (i = 0; i < numeroVias; i++) {
                    $("body").append($("#via").html());
                }

                var infCaixa = GeeksSQL("select CodigoCaixa, Descricao from Caixa where CodigoCaixa = (Select CodigoCaixa from Documento where CodigoDocumento = 0" + CodigoDocumento + ")", false, url, banco, usuario).Records[0];

                var Caixa = GeeksSQL("select DescricaoEmpresa, Convert(varchar(10), DataHoraEmissao, 103) + ' ' + Convert(varchar(10), DataHoraEmissao, 108) DataAbertura, Convert(varchar(10), DataHoraFinalizado, 103) + ' ' + Convert(varchar(10), DataHoraFinalizado, 108) DataFechamento, DescricaoContato, ValorAbertura from Documento where CodigoDocumento =0" + CodigoDocumento, false, url, banco, usuario).Records[0];

                $(".nomeCaixa").html("Caixa Nº " + infCaixa.CodigoCaixa + " - " + infCaixa.Descricao);

                $(".nomeEmpresa").html(Caixa.DescricaoEmpresa);
                $(".nomeOperador").html(Caixa.DescricaoContato);
                $(".dataHoraAbertura").html(Caixa.DataAbertura);                
                $(".dataHoraFechamento").html(Caixa.DataFechamento);

                var FundoDeCaixa = Caixa.ValorAbertura;               

                var FormasPagamento = GeeksSQL("select F.Descricao, D.Valor, F.Tipo from DocumentoCondicaoPagamento D inner join FormaPagamento F on F.CodigoFormaPagamento = D.CodigoFormaPagamento where D.CodigoDocumento = " + CodigoDocumento + " and D.Ordem = (Select Max(CodigoDocumentoStatus) from DocumentoStatus where CodigoDocumento = " + CodigoDocumento + " and (Operacao = 'Fechamento Caixa' or Operacao = 'Correção Caixa'))", false, url, banco, usuario).Records;

                /*var VendasEmDinheiro = GeeksSQL("Select IsNull(sum(TituloValor), 0) Valor from CaixaConsolidacao where DocumentoTipo = 'Fatura' and CodigoFormaPagamento in (Select CodigoFormaPagamento from FormaPagamento where Tipo = 1) and CodigoDocumentoStatus = (Select Max(CodigoDocumentoStatus) from DocumentoStatus where CodigoDocumento = 0" + CodigoDocumento + " and StatusFinalizado = 'Aguardando Conferência') and CodigoDocumentoCaixa = 0" + CodigoDocumento, false, url, banco, usuario).Records[0].Valor;*/

                //var RecebimentosEmDinheiro = GeeksSQL("select sum(valor) Valor from DocumentoCondicaoPagamento where CodigoDocumento =" + CodigoDocumento + " and CodigoFormaPagamento = (select CodigoFormaPagamento from FormaPagamento where Tipo = 1)", false, url, banco, usuario).Records[0].Valor;
								
				var SangriaFinal = GeeksSQL("Select top 1 DC.DocumentoValor Valor from CaixaConsolidacao DC inner join Documento D on DC.DocumentoCodigo = D.CodigoDocumento where DC.CodigoDocumentoCaixa = " + CodigoDocumento + " and DC.Revisao = (Select Max(Revisao) from CaixaConsolidacao where CodigoDocumentoCaixa = " + CodigoDocumento + ") and DC.DocumentoTipo = 'Sangria Final' and D.Observacao like '%Sangria Final%' order by D.DataHoraFinalizado desc", false, url, banco, usuario);
				
				if (SangriaFinal.Records != null && SangriaFinal.Records.length > 0) SangriaFinal = SangriaFinal.Records[0].Valor;
				else SangriaFinal = 0.0;
				
				var DespesasSimples = GeeksSQL("SELECT * FROM (SELECT cc.CodigoDocumentoCaixa, TituloValor, Ltrim(fpc.Descricao) Conta FROM CaixaConsolidacao cc INNER JOIN FinanceiroTitulo ft ON cc.TituloCodigo = ft.CodigoFinanceiroTitulo INNER JOIN FinanceiroPlanoConta fpc ON fpc.CodigoFinanceiroPlanoConta = ft.CodigoFinanceiroPlanoConta WHERE cc.DocumentoTipo = 'DespesaSimples' AND Revisao = (SELECT Max(Revisao) FROM CaixaConsolidacao WHERE CodigoDocumentoCaixa = cc.CodigoDocumentoCaixa)) Despesas where CodigoDocumentoCaixa = 0" + CodigoDocumento, false, url, banco, usuario).Records;

				var TotalDespesas = 0.0;
                $(DespesasSimples).each(function(index, row) {
                    TotalDespesas += row.TituloValor;
				});
				
				var SangriasPrevias = GeeksSQL("Select DC.DocumentoTipo, DC.DocumentoValor, Convert(varchar(10), DC.DocumentoEmissao, 103) + ' ' + Convert(varchar(10), DC.DocumentoEmissao, 108) DataEmissao, D.Observacao from CaixaConsolidacao DC inner join Documento D on DC.DocumentoCodigo = D.CodigoDocumento where DC.CodigoDocumentoCaixa = " + CodigoDocumento + " and DC.Revisao = (Select Max(Revisao) from CaixaConsolidacao where CodigoDocumentoCaixa = " + CodigoDocumento + ") and DC.DocumentoTipo = 'Sangria' and D.Observacao not like '%Sangria Final%'", false, url, banco, usuario).Records;             

				var TotalSangriasPrevias = 0.0;
                $(SangriasPrevias).each(function (index, row) {
                    TotalSangriasPrevias += row.DocumentoValor;
				});
				
				//RecebimentosEmDinheiro = RecebimentosEmDinheiro - SangriaFinal;

                var SomaFormaPgto = 0.0;
				var RecebimentosEmDinheiro = 0.0;
                $(FormasPagamento).each(function(index, row) { 
					if (row.Tipo == "1")
					{
						RecebimentosEmDinheiro = row.Valor;
					}
                    $(".nomesFormasPgto").append(
                        $("#linhaNome").html()
                            .replace("[nome]", row.Descricao)
                    );

                    $(".valoresFormasPgto").append(
                        $("#linhaValor").html()
                            .replace("[valor]", row.Valor.toFixed(2).replace(".", ","))
                    );

                    SomaFormaPgto += row.Valor;
                });

                $(".valorTotalVendasDia").html(SomaFormaPgto.toFixed(2).replace(".", ","));

                /*
                var sentencaSQL = "SELECT CodigoDocumento, DescricaoContato, TotalDocumento FROM Documento d " +
                    "WHERE Tipo = 'Venda'  AND ((CodigoFatura IS NOT NULL AND " + //Esta numa fatura 
                    "(((SELECT DataHoraEmissao FROM Documento WHERE CodigoDocumento = d.CodigoFatura) < (SELECT DataHoraFinalizado FROM Documento WHERE CodigoDocumento = "+CodigoDocumento+") and " +
                    //Pedido com fatura criada antes da finalização do caixa e ainda aberta
                     " (SELECT DataHoraFinalizado FROM Documento WHERE CodigoDocumento = d.CodigoFatura) is null) or " + 
                     //Pedido com fatura fechada após finalização do caixa
                    "((SELECT DataHoraFinalizado FROM Documento WHERE CodigoDocumento = d.CodigoFatura) > (SELECT DataHoraFinalizado FROM Documento WHERE CodigoDocumento = "+CodigoDocumento+"))) " +
                    //Não está em fatura e criado antes da abertura do caixa
                    "OR (CodigoFatura IS NULL AND DataHoraFinalizado < (SELECT DataHoraFinalizado FROM Documento WHERE CodigoDocumento = "+CodigoDocumento+"))))";
                var VendasPendentes = GeeksSQL(sentencaSQL, false, url, banco, usuario);

                if (VendasPendentes.RecordsAffected > 0) {

                    $(".nomePedidosPendentes").append(
                        $("#linhaNome").html()
                            .replace("[nome]", "<span>Vendas Pendentes</span>")
                    );

                    $(".valorPedidosPendentes").append(
                        $("#linhaValor").html()
                            .replace("[valor]", "&nbsp;")
                    );

                    $(VendasPendentes.Records).each(function(index, row){

                        $(".nomePedidosPendentes").append(
                            $("#linhaNome").html()
                                .replace("[nome]", row.DescricaoContato)
                        );

                        $(".valorPedidosPendentes").append(
                            $("#linhaValor").html()
                                .replace("[valor]", "<span>" + row.TotalDocumento.toFixed(2).replace(".", ",") + "</span>")
                        );

                    });

                }

                var TotalVendas = GeeksSQL("select IsNull(Sum(DocumentoValor), 0) TotalVendas from CaixaConsolidacao where CodigoDocumentoCaixa = " + CodigoDocumento + " and DocumentoTipo = 'Venda' and Revisao = (select max (Revisao) from CaixaConsolidacao where CodigoDocumentoCaixa = " + CodigoDocumento + ")", false, url, banco, usuario).Records[0].TotalVendas;

                var TotalCarne = GeeksSQL("select IsNull(Sum(DocumentoValor), 0) TotalCarne from CaixaConsolidacao where CodigoDocumentoCaixa = " + CodigoDocumento + " and DocumentoTipo = 'Fatura' and TituloFormaPagamento = 'Carnê' and Revisao = (select max (Revisao) from CaixaConsolidacao where CodigoDocumentoCaixa = " + CodigoDocumento + ")", false, url, banco, usuario).Records[0].TotalCarne;

                $(".nomePedidosPendentes").append("<br>");
                $(".valorPedidosPendentes").append("<br>");

                $(".nomePedidosPendentes").append(
                    $("#linhaNome").html()
                        .replace("[nome]", "<span> Total vendido (geral): </span>")
                );

                $(".valorPedidosPendentes").append(
                    $("#linhaValor").html()
                        .replace("[valor]", "<span>" + TotalVendas.toFixed(2).replace(".", ",") + "</span>")
                );

                $(".nomePedidosPendentes").append(
                    $("#linhaNome").html()
                        .replace("[nome]", "<span> Total receb. carnê: </span>")
                );

                $(".valorPedidosPendentes").append(
                    $("#linhaValor").html()
                        .replace("[valor]", "<span>" + TotalCarne.toFixed(2).replace(".", ",") + "</span>")
                );*/

                $(".nomesCaixa").append(
                        $("#linhaNome").html()
                            .replace("[nome]", "Abertura de Caixa")
                );

                $(".valoresCaixa").append(
                    $("#linhaValor").html()
                        .replace("[valor]", FundoDeCaixa.toFixed(2).replace(".", ","))
                );

                /*$(".nomesCaixa").append(
                        $("#linhaNome").html()
                            .replace("[nome]", "Vendas em Dinheiro")
                );

                $(".valoresCaixa").append(
                    $("#linhaValor").html()
                        .replace("[valor]", VendasEmDinheiro.toFixed(2).replace(".", ","))
                );*/

                $(".nomesCaixa").append(
                        $("#linhaNome").html()
                            .replace("[nome]", "Recebimentos em Dinheiro")
                );
				
				var EntradasRecebimentos = GeeksSQL("Select Case when DataEmissao > (select DataHoraFinalizado from Documento where CodigoDocumento = " + CodigoDocumento + ") then Convert(varchar(10), DataMovimento, 103) + ' ' + Convert(varchar(10), DataMovimento, 108) else Convert(varchar(10), DataEmissao, 103) + ' ' + Convert(varchar(10), DataEmissao, 108) end DataHora, ValorDebito - ValorCredito Valor from FinanceiroMovimentacao fm where DocumentoTipo <> 'DespesaSimples' and DocumentoTipo <> 'Sangria' and DocumentoTipo <> 'Fatura' and DocumentoTipo <> 'Venda'and CodigoFinanceiroPlanoConta = (select CodigoFinanceiroPlanoContaCaixa from Documento where CodigoDocumento = " + CodigoDocumento + ") and DataMovimento >= (select DateAdd(MS,-Datepart(MS,DataHoraEmissao),DataHoraEmissao) from Documento where CodigoDocumento = " + CodigoDocumento + ") and DataMovimento <= (select DataHoraFinalizado from Documento where CodigoDocumento = " + CodigoDocumento + ") and Observacao = 'Transferência entre contas' order by 1", false, url, banco, usuario).Records;

                var ValorEntradas = 0.0;
                $(EntradasRecebimentos).each(function(index, row) {
					ValorEntradas += row.Valor;
				});
				
				var TotalDinheiro = (RecebimentosEmDinheiro+TotalSangriasPrevias+TotalDespesas+ValorEntradas);

                $(".valoresCaixa").append(
                    $("#linhaValor").html()
                        .replace("[valor]", (RecebimentosEmDinheiro+TotalSangriasPrevias+TotalDespesas-FundoDeCaixa-ValorEntradas).toFixed(2).replace(".", ",") + " (+)")
                );

                $(EntradasRecebimentos).each(function(index, row) {
                    $(".nomesCaixa").append(
                        $("#linhaNome").html()
                            .replace("[nome]", "Abastecimento de Caixa <span>" + row.DataHora + "</span>")
                    );

                    $(".valoresCaixa").append(
                        $("#linhaValor").html()
                            .replace("[valor]", String(row.Valor.toFixed(2).replace(".", ",")) + (row.Valor >= 0 ? " (+)" : " (-)"))
                    );
                    TotalDinheiro -= row.Valor;
                });

                

                $(".valorTotalDinheiroCaixa").html(TotalDinheiro.toFixed(2).replace(".", ","));


                $(DespesasSimples).each(function(index, row) {
                    TotalDinheiro -= row.TituloValor;

                    $(".descricoesSangria").append(
                        $("#linhaNome").html()
                            .replace("[nome]", "Despesa Simples: <span>" + row.Conta + "</span>")
                    );

                    $(".valoresSangria").append(
                        $("#linhaValor").html()
                            .replace("[valor]", (row.TituloValor.toFixed(2).replace(".", ",")) + " (-)")
                    );
                });

                var Sangrias = GeeksSQL("Select DC.DocumentoTipo, DC.DocumentoValor, Convert(varchar(10), DC.DocumentoEmissao, 103) + ' ' + Convert(varchar(10), DC.DocumentoEmissao, 108) DataEmissao, D.Observacao from CaixaConsolidacao DC inner join Documento D on DC.DocumentoCodigo = D.CodigoDocumento where DC.CodigoDocumentoCaixa = " + CodigoDocumento + " and DC.Revisao = (Select Max(Revisao) from CaixaConsolidacao where CodigoDocumentoCaixa = " + CodigoDocumento + ") and (DC.DocumentoTipo = 'Sangria' or DC.DocumentoTipo = 'Sangria Final')", false, url, banco, usuario).Records;             

                $(Sangrias).each(function (index, row) {
                    TotalDinheiro -= row.DocumentoValor;

                    $(".descricoesSangria").append(
                    $("#linhaNome").html()
                        .replace("[nome]", "Sangria: <span>" + row.Observacao + "</span>")
                    );

                    $(".valoresSangria").append(
                        $("#linhaValor").html()
                            .replace("[valor]", (row.DocumentoValor.toFixed(2).replace(".", ",")) + " (-)")
                    );
                });

                var Amanha = GeeksSQL("select Convert(varchar(10), DateAdd(d, 1, (select DataHoraEmissao from Documento where CodigoDocumento = " + CodigoDocumento + ")), 103) Amanha", false, url, banco, usuario).Records[0].Amanha;

                $(".dataProxDia").html(Amanha);
                $(".valorFundoCaixaProxDia").html(TotalDinheiro.toFixed(2).replace(".", ","));

            });

        </script>        

    </body>

</html>