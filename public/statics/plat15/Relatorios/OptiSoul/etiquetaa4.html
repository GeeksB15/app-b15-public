<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Etiquetas</title>
	
		<script src="/Scripts/jquery-2.1.4.js"></script>
		<script src="/Restricted/Geeks.ERP.BasicReport.js"></script>
		<script src="/Scripts/jquery-ean13.min.js"></script>

		<style type="text/css" media="print">
			html, body, div, span, applet, object, iframe,
			h1, h2, h3, h4, h5, h6, p, blockquote, pre,
			a, abbr, acronym, address, big, cite, code,
			del, dfn, em, img, ins, kbd, q, s, samp,
			small, strike, strong, sub, sup, tt, var,
			b, u, i, center,
			dl, dt, dd, ol, ul, li,
			fieldset, form, label, legend,
			table, caption, tbody, tfoot, thead, tr, th, td,
			article, aside, canvas, details, embed, 
			figure, figcaption, footer, header, hgroup, 
			menu, nav, output, ruby, section, summary,
			time, mark, audio, video {
				margin: 0;
				padding: 0;
				border: 0;
				font-size: 100%;
				font: inherit;
				vertical-align: baseline;
			}
			/* HTML5 display-role reset for older browsers */
			article, aside, details, figcaption, figure, 
			footer, header, hgroup, menu, nav, section {
				display: block;
			}
			body {
				line-height: 1;
			}
			ol, ul {
				list-style: none;
			}
			blockquote, q {
				quotes: none;
			}
			blockquote:before, blockquote:after,
			q:before, q:after {
				content: '';
				content: none;
			}
			table {
				border-collapse: collapse;
				border-spacing: 0;
			}

			@page {
				margin: 0;
				padding: 0;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
			}

			.barcode-canvas {
				width: 100%;
				height: 100%;
				page-break-before: always;
			}
		</style>

		<script>
			
			$(document).ready(function () {

				var banco = getParameterByName("Banco");
				var url = decodeURIComponent(getParameterByName("URLServidor"));
				var usuario = getParameterByName("CodigoUsuario");
				var numeroEtiquetasEmBranco = getParameterByName("EmBranco");

				var CodigoPedido = getParameterByName("CodigoPedido");
				var CodigoItem = getParameterByName("CodigoItem");
				var Quantidade = getParameterByName("Quantidade");
				var TabelaPreco = getParameterByName("TabelaPreco");

				var ImprimeEtiqueta = function (Pagina, Produto, Linha, Coluna) {

					//Start Canvas
					var canvas = document.getElementById('folha' + Pagina);
					var ctx = canvas.getContext('2d');

					//Limitar tamanho do campo texto
					//Exemplo de utilizaçõa: ctx.fillText(fittingString(ctx, "aqui seu texto ou variável", 100), x, y);
					function fittingString(ctx, str, maxWidth) {
					    var width = ctx.measureText(str).width;
					    var ellipsis = '…';
					    var ellipsisWidth = ctx.measureText(ellipsis).width;

					    if (width<=maxWidth || width<=ellipsisWidth) {
					        return str;
					    } else {
					        var len = str.length;
					        while (width>=maxWidth-ellipsisWidth && len-->0) {
					            str = str.substring(0, len);
					            width = ctx.measureText(str).width;
					        }
					        return str+ellipsis;
					    }
					}

					//Quebra campo de texto
					DescricaoCompleta = Produto.DescricaoCompleta
					Desc1 = DescricaoCompleta.substring(0, 25)
					Desc2 = DescricaoCompleta.substring(25, 50)

					var mm = 1;

					xin = 275 * mm + (830 * mm * Coluna);
					yin = 130 * mm + (127 * mm * Linha);

					var x = xin + 17;
					var y = yin + 7;

					//Desenha codigo de barras
					$("#ean").EAN13(Produto.CodigoBarras);
					ctx.drawImage(ean, x, y, 240 * mm, 90 * mm);

					ctx.beginPath();
			        ctx.rect(xin, yin + 60, 260, 40);
					ctx.fillStyle = "white";
					ctx.fill();

					//Codigo numero do desenho
					ctx.font = '16pt "Tahoma"';
					ctx.fillStyle = "black";
					ctx.textAlign = "center";
					ctx.fillText(Produto.CodigoBarras, x + 130, yin + 80 * mm);

					//Descrição em primeira linha
					ctx.textAlign = "start";
					ctx.font = '14pt "Tahoma"';
					x += 290 * mm;
					y += 10 * mm;
					ctx.fillText(Desc1.trim(), x, y);

					//Descrição em segunda linha
					ctx.textAlign = "start";
					ctx.font = '14pt "Tahoma"';
					y += 20 * mm;
					ctx.fillText(Desc2.trim(), x, y);

					//Código do item
					y += 20 * mm;
					ctx.fillText(fittingString(ctx, ((Produto.CodigoItem == '' ? '' : 'Cód: ') + Produto.CodigoItem), 260), x, y);

					//Valor do produto
					ctx.font = '21pt "Tahoma"';
					y += 25 * mm;
					ctx.fillText(Produto.Valor, x, y);
				}

				// Posso imprimir etiqueta de um pedido
				if (CodigoPedido != "")
					var Etiquetas = GeeksSQL(
										"Select"
											+" I.CodigoItem,"
											+" IsNull(SUBSTRING('000000000000' + Cast(i.CodigoBarras as varchar), LEN('000000000000' + Cast(i.CodigoBarras as varchar))-12, 13), '') CodigoBarras,"
											+" LEFT((CASE"
												+" WHEN((I.Tipo = 'Armação') OR(I.Tipo = 'Óculos Sol') OR(I.Tipo = 'Óculos Pronto'))"
												+" THEN(CASE"
														+" WHEN(IsNull(I.Descricao, '') = '')"
														+" THEN(IsNull(I.Marca, '')+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, ''))"
														+" ELSE(IsNull(I.Descricao, ''))"
													+" END)"
												+" ELSE(CASE WHEN(IsNull(I.Descricao, '') = '') THEN(IsNull(I.Marca, '')+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, '')) ELSE(IsNull(I.Descricao, '')) END)"
											+" END), 50) DescricaoCompleta,"
											+" IsNull(I.Modelo, '') Modelo,"
											+" IsNull(I.AmarcaoCor, '') AmarcaoCor,"
											+" IsNull(I.Cor, '') Cor,"
											+" IsNull(I.Tamanho, '') Tamanho,"
											+" IsNull(I.Descricao, '') Nome,"
											+" 'R$ '+ Format(IsNull(" + (TabelaPreco == "" ? 'I.ValorVenda' : "(Select dbo.Fn_TabelaPreco_GetPreco(I.CodigoItem, 6))") + ", 0), 'N2') Valor,"
											+" IsNull(DI.Quantidade, 0) Quantidade"
										+" From Item I"
											+" Inner Join DocumentoItem DI on DI.CodigoItem = I.CodigoItem and DI.CodigoDocumento = 0" + CodigoPedido, false, url, banco, usuario).Records;

				// Posso imprimir etiqueta de um item, informando a quantidade
				else if (CodigoItem != "")
					var Etiquetas = GeeksSQL(
										"Select"
											+" I.CodigoItem,"
											+" IsNull(SUBSTRING('000000000000' + Cast(i.CodigoBarras as varchar), LEN('000000000000' + Cast(i.CodigoBarras as varchar))-12, 13), '') CodigoBarras,"
											+" LEFT((CASE"
												+" WHEN((I.Tipo = 'Armação') OR(I.Tipo = 'Óculos Sol') OR(I.Tipo = 'Óculos Pronto'))"
												+" THEN(CASE"
														+" WHEN(IsNull(I.Descricao, '') = '')"
														+" THEN(IsNull(I.Marca, '')+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, ''))"
														+" ELSE(IsNull(I.Descricao, ''))"
													+" END)"
												+" ELSE(CASE WHEN(IsNull(I.Descricao, '') = '') THEN(IsNull(I.Marca, '')+CHAR(13)+CHAR(10)+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, '')) ELSE(IsNull(I.Descricao, '')) END)"
											+" END), 50) DescricaoCompleta,"
											+" IsNull(I.Modelo, '') Modelo,"
											+" IsNull(I.AmarcaoCor, '') AmarcaoCor,"
											+" IsNull(I.Cor, '') Cor,"
											+" IsNull(I.Tamanho, '') Tamanho,"
											+" IsNull(I.Descricao, '') Nome,"
											+" 'R$ '+ Format(IsNull(" + (TabelaPreco == "" ? 'I.ValorVenda' : "(Select dbo.Fn_TabelaPreco_GetPreco(I.CodigoItem, 6))") + ", 0), 'N2') Valor, " + Quantidade + " Quantidade"
										+" From Item I"
										+" Where I.CodigoItem = " + CodigoItem, false, url, banco, usuario).Records;

				// Ou posso imprimir etiqueta pela tela de etiquetas
				else
					var Etiquetas = GeeksSQL(
										"Select"
											+" E.CodigoItem,"
											+" IsNull(SUBSTRING('000000000000' + Cast(i.CodigoBarras as varchar), LEN('000000000000' + Cast(i.CodigoBarras as varchar))-12, 13), '') CodigoBarras,"
											+" LEFT((CASE"
												+" WHEN((I.Tipo = 'Armação') OR(I.Tipo = 'Óculos Sol') OR(I.Tipo = 'Óculos Pronto'))"
												+" THEN(CASE"
														+" WHEN(IsNull(I.Descricao, '') = '')"
														+" THEN(IsNull(I.Marca, '')+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, ''))"
														+" ELSE(IsNull(I.Descricao, ''))"
													+" END)"
												+" ELSE(CASE WHEN(IsNull(I.Descricao, '') = '') THEN(IsNull(I.Marca, '')+CHAR(13)+CHAR(10)+' '+ IsNull(I.Modelo, '')+' '+ IsNull(convert(varchar, I.Tamanho), '')+' '+ IsNull(I.AmarcaoCor, '')) ELSE(IsNull(I.Descricao, '')) END)"
											+" END), 50) DescricaoCompleta,"
											+" IsNull(I.Modelo, '') Modelo,"
											+" IsNull(I.AmarcaoCor, '') AmarcaoCor,"
											+" IsNull(I.Cor, '') Cor,"
											+" IsNull(I.Tamanho, '') Tamanho,"
											+" IsNull(E.NomeProduto, '') Nome,"
											+" 'R$ '+ Format(IsNull(" + (TabelaPreco == "" ? 'I.ValorVenda' : "(Select dbo.Fn_TabelaPreco_GetPreco(E.CodigoItem, 6))") + ", 0), 'N2') Valor,"
											+" IsNull(E.QuantidadeEtiquetas, 0) Quantidade"
										+" From Item I"
											+" Inner Join Etiqueta E on E.CodigoItem = I.CodigoItem", false, url, banco, usuario).Records;
				
				// Cada folha tem 40 etiquetas
				// Para cada 40 etiquetas, coloca um canvas na tela

				// Tratando as etiquetas em branco
				var linha = (numeroEtiquetasEmBranco / 2 | 0);
				var coluna = (numeroEtiquetasEmBranco % 2);
				var pagina = 0;

				$("#folha").append('<div><canvas id="folha' + pagina + '" class="barcode-canvas" width="2150" height="2760"></canvas></div>')

				for (var i = 0; i < Etiquetas.length; i++) {

					for (var j = 0; j < Etiquetas[i].Quantidade; j++) {

						if (linha == 0 && coluna == 0 && pagina > 0) {
							$("#folha").append('<div><canvas id="folha' + pagina + '" class="barcode-canvas" width="2150" height="2700"></canvas></div>');
						}

						ImprimeEtiqueta(pagina, Etiquetas[i], linha, coluna);

						coluna += 1;

						if (coluna == 2) {
							coluna = 0;
							linha += 1;
						}

						if (linha == 20) { 
							pagina += 1;
							linha = 0;
							coluna = 0;
						}

					}

				}

				$("#ean").remove();
		
			});

		</script>

	</head>

	<body>

		<div id="folha" style="margin-top:-5px; margin-left: -10px; top: -5px; left: -10px;">
		</div>
		
		<canvas id="ean" width="270" height="100"></canvas>

	</body>

</html>