"use strict";(globalThis.webpackChunkb15=globalThis.webpackChunkb15||[]).push([[663],{12663:(o,e,t)=>{t.r(e),t.d(e,{default:()=>C});var a=t(34182);const i=(0,a.createElementVNode)("span",{class:"col-12 text-body1 text-dark"},"Período de Emissão",-1),r=(0,a.createElementVNode)("span",{class:"col-12 text-body1 text-dark"},"Período de Finalização",-1);var l=t(77365),s=t(71028),d=t(45794),n=t(32326),c=t(12019),m=t(88603),u=t(92674);const p={components:{lista:l.Z,VendaCard:s.Z,PromptContatoNovo:u.Z,VendaModal:d.Z},data:()=>({tabSelecionada:{valor:"Todas"},tabs:[{rotulo:"Aguardando Faturamento",value:"Aguardando Faturamento"},{rotulo:"Faturado",value:"Faturado"},{rotulo:"Orçamento",value:"Orçamento"},{rotulo:"Aguardando Liberação",value:"Aguardando Liberação"},{rotulo:"Não Aprovado",value:"Não Aprovado"},{rotulo:"Todas",value:"Todas"}],page:{digitacao:{current:1,min:0,max:0},finalizado:{current:1,min:0,max:0},ativa:"Digitação"},entregueInicio:new Date(new Date($utils.dataAtual()).toDateString()),entregueFim:new Date(new Date($utils.dataAtual()).toDateString()),status:[],operacoes:[],pageSize:10,grupos:[],buscaCampo:"",empresas:[],empresa:{},contatosModal:!1,vendedorModal:!1,digitadorModal:!1,filtro:{status:"",operacao:"",grupos:[],empresa:{id:""},cliente:{id:""},vendedor:{id:""},digitador:{id:""},periodo:{emissao:{ini:"",fim:""},finalizado:{ini:"",fim:""}}},paginacao:{atual:1,maximo:1,total:1,limite:25},dbContato:c.db.contato,documentos:null,showFilters:!1,itens:[],documentoItens:[],vendedorDigitadorSelecionado:null,vendedoresDigitadoresOpcoes:[],diretivaContatosAcessaTodosContatos:!1,showAllPreviewDetail:!1,lista:[]}),methods:{async filtrar(){this.documentos=await c.db.venda.ler(),this.empresas=await c.db.empresa.le(),this.documentos.map((o=>{this.status.includes(o.status)||this.status.push(o.status),this.operacoes.includes(o.operacao)||this.operacoes.push(o.operacao)}));let o=[];try{const e=await c.db.venda.leRefatorado({filtros:{periodoEmissao:{ini:this.filtro.periodo.emissao.ini,fim:this.filtro.periodo.emissao.fim},periodoFinalizado:{ini:this.filtro.periodo.finalizado.ini,fim:this.filtro.periodo.finalizado.fim},status:this.filtro.status,operacao:this.filtro.operacao,idEmpresa:this.filtro.empresa.id,idContato:this.filtro.cliente.id,idContatoVendedor:this.filtro.vendedor.id,idContatoDigitador:this.filtro.digitador.id},termoBusca:this.buscaCampo,limit:this.paginacao.limite,page:this.paginacao.atual,sort:""});o=e.data,this.paginacao.total=e.total,this.paginacao.maximo=e.totalPages;let t=[];for(const e of o){const o=await c.db.documentoItem.ler({idDocumento:e.id});t=[...t,...o.filter((o=>o.idItem))]}let a=[];for(const o of t)if(o.idItem&&!a.filter((e=>e.id===o.idItem)).length){const e=await c.db.item.leNew({id:o.idItem});a.push(e)}this.documentos=o}catch(o){this.$q.notify("Erro ao filtrar")}},aoSelecionarEmpresa(){this.filtro.empresa=this.empresas.filter((o=>o.id===this.empresa.id))[0]},aoSelecionarCliente(o,e){o&&(this.filtro.cliente=(0,n.clonarV2)(e),this.contatosModal=!1)},adicionarVenda(){this.$refs.modalVenda.mostrar()},async buscar(){let o=await c.db.venda.ler(),e=[];for(const t of o){const o=await c.db.documentoItem.ler({idDocumento:t.id});e=[...e,...o.filter((o=>o.idItem))]}let t=[],a={};for(const o of e)if(o.idItem&&!t.filter((e=>e.id===o.idItem)).length){const e=await c.db.item.leNew({id:o.idItem});t.push(e)}const i=[(0,n.removerAcentos)(this.buscaCampo)];let r=o.filter((o=>{if(!o.numero)return!1;const e=String(o.numero);for(const o of i){const t=new RegExp(o,"gi");if(e.match(t))return!0}})),l=[],s=e.filter((o=>{if(!o.idItem&&!o.descricaoItem)return!1;const e=(0,n.removerAcentos)(o.descricaoItem);for(const t of i){const a=new RegExp(t,"gi");if(e.match(a))return l.push(o.id),!0}}));a=t.filter((o=>{const e=o.marca||"",t=o.referencia||"",a=o.codigoItem?String(o.codigoItem):"",r=o.codigoBarras||"",l=(0,n.removerAcentos)(e+t+a+r);for(const o of i){const e=new RegExp(o,"gi");if(l.match(e))return!0}}));for(const o of r){const t=e.filter((e=>{if(e.idItem&&e.idDocumento===o.id&&!l.includes(e.id))return l.push(e.id),!0}));s=[...s,...t]}for(const o of a){const t=e.filter((e=>{if(e.idItem===o.id&&!l.includes(e.id))return l.push(e.id),!0}));s=[...s,...t]}s=s.filter((e=>{let a=(0,n.clonarV2)(i),r=o.filter((o=>o.id===e.idDocumento)),l=t.filter((o=>o.id===e.idItem));r=r.length?r[0]:{},l=l.length?l[0]:{};let s=r.numero?String(r.numero):"";if(s+=e.descricaoItem||"",s+=l.marca||"",s+=l.referencia||"",s+=l.codigoItem?String(l.codigoItem):"",s+=l.codigoBarras||"",s)for(const o of i){const e=new RegExp(o,"gi");s.match(e)&&(a=a.filter((e=>e!==o)))}if(!a.length)return!0}));let d=[];r=[],a={};for(const e of s)if(d.includes(e.idDocumento)||(d.push(e.idDocumento),r=[...r,...o.filter((o=>o.id===e.idDocumento))]),!a[e.idItem]){const o=t.filter((o=>o.id===e.idItem));o.length&&(a[e.idItem]=o[0])}o=(0,m.orderBy)(r,["dataHoraFinalizado","dataHoraEmissao"],["desc","desc"]),this.documentos=r.reduce(((o,e)=>(o[e.id]||(o[e.id]=e),o)),{}),this.itens=a,this.documentosItens=(0,m.orderBy)(s,["dataHoraFinalizado","dataHoraEmissao"],["desc","desc"])},async abrirEdicao(o){console.log(o);let e=await c.db.venda.leCompleto({codigoDocumento:o.codigoDocumento});console.log({leCompleto:e})},filtraDebounce(){(0,m.debounce)(this.refazFiltro,700)()},refazFiltro(){n.gconsole.log("FunilVendas","refazFiltro()",this.fraseFiltro,this.empresaSelecionada);const o=(0,n.removerAcentos)((this.fraseFiltro||"").toUpperCase()).split(" ").filter((o=>""!==o)),e={};for(const t in this.listas)for(const a of this.listas[t]){const t=(0,n.removerAcentos)((a.id||"").toUpperCase()+(a.nomeCliente||"").toUpperCase()+(a.nomeDigitador||"").toUpperCase()+(a.nomeVendedor||"").toUpperCase()+" "+String(a.numeroVenda||"")+" ");let i=!0;for(const e of o)i=isNaN(Number(e))?i&&t.includes(e):i&&t.includes(" "+e+" ");this.empresaSelecionada&&(i=i&&this.empresaSelecionada===a.codigoEmpresa),this.vendedorDigitadorSelecionado&&(i=i&&(this.vendedorDigitadorSelecionado.value===a.codigoContatoDigitador||this.vendedorDigitadorSelecionado.value===a.codigoContatoVendedor)),a.mostra=i,a.mostra&&(e[a.crmFunilStatus]=(e[a.crmFunilStatus]||0)+(a.totalDocumento||0))}this.total=e},async atualizar(){try{$q.loading.show();let o="";"Todas"!==this.tabSelecionada.valor&&(o=this.tabSelecionada.valor),null!==this.vendedorDigitadorSelecionado&&(this.filtro.vendedor.id=this.vendedorDigitadorSelecionado.value),this.filtro.status=o,await this.filtrar()}catch(o){$q.notifyError("Erro iniciar",o)}finally{$q.loading.hide()}},abrirTodosPreview(){this.showAllPreviewDetail=!this.showAllPreviewDetail;for(let o of this.documentos)this.$refs[o.id].detalhesVisivel=this.showAllPreviewDetail}},watch:{},created(){n.gconsole.log("FunilVendas","created()"),$db.permissao.objeto("Diretiva_RelatorioVenda_VerTodos").then((o=>{this.diretivaContatosAcessaTodosContatos=o,this.diretivaContatosAcessaTodosContatos&&(this.vendedoresDigitadoresOpcoes=[],$db.crm.leOnlineVendedoresDigitadores({entregueInicio:this.entregueInicio,entregueFim:this.entregueFim}).then((o=>{o.forEach((o=>{o.codigo&&this.vendedoresDigitadoresOpcoes.push({label:o.nome,value:o.codigo})}))})))})),this.atualizar()},refazFiltro(){$utils.gconsole.log("FunilVendas","refazFiltro()",this.fraseFiltro,this.empresaSelecionada);const o=$utils.removerAcentos((this.fraseFiltro||"").toUpperCase()).split(" ").filter((o=>""!==o)),e={};for(const t in this.listas)for(const a of this.listas[t]){const t=$utils.removerAcentos((a.id||"").toUpperCase()+(a.nomeCliente||"").toUpperCase()+(a.nomeDigitador||"").toUpperCase()+(a.nomeVendedor||"").toUpperCase()+" "+String(a.numeroVenda||"")+" ");let i=!0;for(const e of o)i=isNaN(Number(e))?i&&t.includes(e):i&&t.includes(" "+e+" ");this.empresaSelecionada&&(i=i&&this.empresaSelecionada.value===a.codigoEmpresa),this.vendedorDigitadorSelecionado&&(i=i&&(this.vendedorDigitadorSelecionado.value===a.codigoContatoDigitador||this.vendedorDigitadorSelecionado.value===a.codigoContatoVendedor)),a.mostra=i,a.mostra&&(e[a.crmFunilStatus]=(e[a.crmFunilStatus]||0)+(a.totalDocumento||0))}const t={};for(const o in this.listas)this.tamanhoLista[o]=10,t[o]=this.listas[o].filter((o=>o.mostra)).slice(0,this.tamanhoLista[o]),document.getElementById(o);this.listasFiltradas=t,this.$nextTick((()=>{for(const o in this.listasFiltradas)document.getElementById(o).removeEventListener("scroll",this.scrollHandler),document.getElementById(o).addEventListener("scroll",this.scrollHandler)})),this.total=e}};var f=t(74260),h=t(67280),g=t(40320),v=t(25901),V=t(7518),b=t.n(V);const C=(0,f.Z)(p,[["render",function(o,e,t,l,s,d){const n=(0,a.resolveComponent)("q-chips-input"),c=(0,a.resolveComponent)("campo"),m=(0,a.resolveComponent)("q-select"),u=(0,a.resolveComponent)("row"),p=(0,a.resolveComponent)("venda-card"),f=(0,a.resolveComponent)("q-list"),h=(0,a.resolveComponent)("lista"),g=(0,a.resolveComponent)("prompt-contato-novo"),v=(0,a.resolveComponent)("VendaModal");return(0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,null,[(0,a.createElementVNode)("div",null,[(0,a.createVNode)(h,{titulo:"Vendas",onCriar_click:d.adicionarVenda,onCheckBoxGeral_click:o.checkBoxGeral_click,showAdd:"false",icone:"mdi-cart-arrow-up",showToolbar:"false",onFiltro_change:d.atualizar,onLimparFiltros_click:o.limparFiltros_click,onAbrirTodosPreview:d.abrirTodosPreview,onExportarXLSX_click:o.exportarXLSX_click,onRemoverTodos:o.removerTodos,onRestaurarTodos:o.restaurarTodos,tabSelecionada:s.tabSelecionada,tabs:s.tabs,lista:s.lista,listaLayout:o.listaLayout,paginacao:s.paginacao,filtros:s.filtro,opcoesMarca:o.opcoesMarca,opcoesGrupo:o.opcoesGrupo,opcoesSubGrupo:o.opcoesSubGrupo,opcoesTipo:o.opcoesTipo,exportarXLSXVisible:!1,permissaoFicha:!1,buscaCampo:s.buscaCampo,"onUpdate:buscaCampo":e[10]||(e[10]=o=>s.buscaCampo=o),checkboxModel:o.checkboxModel,"onUpdate:checkboxModel":e[11]||(e[11]=e=>o.checkboxModel=e)},{filtroCampos:(0,a.withCtx)((()=>[(0,a.createVNode)(n,{modelValue:s.filtro.grupos,"onUpdate:modelValue":e[0]||(e[0]=o=>s.filtro.grupos=o),color:"tertiary",class:"col-12",placeholder:"Filtre por Produto, Marca, Número..."},null,8,["modelValue","placeholder"]),(0,a.createVNode)(c,{tipo:"seletor",dense:"",modelValue:s.empresa.id,"onUpdate:modelValue":[e[1]||(e[1]=o=>s.empresa.id=o),d.aoSelecionarEmpresa],options:s.empresas.map((o=>({label:o.nome,value:o.id}))),clearable:"",rotulo:"Por empresa"},null,8,["modelValue","options","onUpdate:modelValue"]),(0,a.createVNode)(c,{tipo:"seletor",dense:"",modelValue:s.filtro.operacao,"onUpdate:modelValue":e[2]||(e[2]=o=>s.filtro.operacao=o),options:s.operacoes.map((o=>({label:o,value:o}))),clearable:"",rotulo:"Operação"},null,8,["modelValue","options"]),(0,a.createVNode)(c,{rotulo:"Cliente",tipo:"texto",before:[{icon:"search"}],modelValue:s.filtro.cliente.nome,"onUpdate:modelValue":[e[3]||(e[3]=o=>s.filtro.cliente.nome=o),d.aoSelecionarCliente],onClick:e[4]||(e[4]=o=>s.contatosModal=!0),dense:""},null,8,["modelValue","onUpdate:modelValue"]),s.diretivaContatosAcessaTodosContatos?((0,a.openBlock)(),(0,a.createBlock)(m,{key:0,modelValue:s.vendedorDigitadorSelecionado,"onUpdate:modelValue":[e[5]||(e[5]=o=>s.vendedorDigitadorSelecionado=o),d.atualizar],options:s.vendedoresDigitadoresOpcoes,clearable:"",label:"Vendedor / Digitador"},null,8,["modelValue","options","onUpdate:modelValue"])):(0,a.createCommentVNode)("",!0),(0,a.createVNode)(u,{class:"q-col-gutter-md q-mt-md"},{default:(0,a.withCtx)((()=>[i,(0,a.createVNode)(c,{modelValue:s.filtro.periodo.emissao.ini,"onUpdate:modelValue":e[6]||(e[6]=o=>s.filtro.periodo.emissao.ini=o),tipo:"data",class:"no-shadow full-width",rotulo:"De",col:"12",after:[{icon:"mdi-close-circle",handler(){s.filtro.periodo.emissao.ini=""}}],dense:""},null,8,["modelValue","after"]),(0,a.createVNode)(c,{modelValue:s.filtro.periodo.emissao.fim,"onUpdate:modelValue":e[7]||(e[7]=o=>s.filtro.periodo.emissao.fim=o),tipo:"data",class:"no-shadow full-width",rotulo:"até",col:"12",after:[{icon:"mdi-close-circle",handler(){s.filtro.periodo.emissao.fim=""}}],dense:""},null,8,["modelValue","after"])])),_:1}),(0,a.createVNode)(u,{class:"q-col-gutter-md q-mt-md"},{default:(0,a.withCtx)((()=>[r,(0,a.createVNode)(c,{modelValue:s.filtro.periodo.finalizado.ini,"onUpdate:modelValue":e[8]||(e[8]=o=>s.filtro.periodo.finalizado.ini=o),tipo:"data",class:"no-shadow full-width",rotulo:"De",col:"12",after:[{icon:"mdi-close-circle",handler(){s.filtro.periodo.finalizado.ini=""}}],dense:""},null,8,["modelValue","after"]),(0,a.createVNode)(c,{modelValue:s.filtro.periodo.finalizado.fim,"onUpdate:modelValue":e[9]||(e[9]=o=>s.filtro.periodo.finalizado.fim=o),tipo:"data",class:"no-shadow full-width",rotulo:"até",col:"12",after:[{icon:"mdi-close-circle",handler(){s.filtro.periodo.finalizado.fim=""}}],dense:""},null,8,["modelValue","after"])])),_:1})])),itemLista:(0,a.withCtx)((()=>[(0,a.createVNode)(f,{class:"rounded-borders"},{default:(0,a.withCtx)((()=>[((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)(s.documentos,(o=>((0,a.openBlock)(),(0,a.createElementBlock)("div",{key:o.id,class:"itemHover fullWidth q-px-sm"},[(0,a.createVNode)(p,{id:o.id,ref_for:!0,ref:o.id,class:"q-mb-md"},null,8,["id"])])))),128))])),_:1})])),_:1},8,["onCriar_click","onCheckBoxGeral_click","onFiltro_change","onLimparFiltros_click","onAbrirTodosPreview","onExportarXLSX_click","onRemoverTodos","onRestaurarTodos","tabSelecionada","tabs","lista","listaLayout","paginacao","filtros","opcoesMarca","opcoesGrupo","opcoesSubGrupo","opcoesTipo","buscaCampo","checkboxModel"])]),(0,a.createVNode)(g,{modelValue:s.contatosModal,"onUpdate:modelValue":e[12]||(e[12]=o=>s.contatosModal=o),filtro:{ativo:!0},onSelecionar:d.aoSelecionarCliente},null,8,["modelValue","onSelecionar"]),(0,a.createVNode)(g,{modelValue:s.vendedorModal,"onUpdate:modelValue":e[13]||(e[13]=o=>s.vendedorModal=o),filtro:{ativo:!0,vendedores:!0},onSelecionar:o.aoSelecionarVendedor},null,8,["modelValue","onSelecionar"]),(0,a.createVNode)(g,{modelValue:s.digitadorModal,"onUpdate:modelValue":e[14]||(e[14]=o=>s.digitadorModal=o),filtro:{ativo:!0},onSelecionar:o.aoSelecionarDigitador},null,8,["modelValue","onSelecionar"]),(0,a.createVNode)(v,{ref:"modalVenda",onExecutar:o.executar},null,8,["onExecutar"])],64)}]]);b()(p,"components",{QChip:h.Z,QSelect:g.Z,QList:v.Z})}}]);